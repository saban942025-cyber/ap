<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeliveryMaster v45.3 (Modular)</title>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <style>
        /* CSS remains the same as v45.2 */
        :root { --m3-primary: #0066cc; --m3-surface: #ffffff; --m3-on-surface: #1a1a1a; --m3-surface-container: #f0f4f8; --m3-on-surface-variant: #5f6368; --m3-outline: #d0d0d0; --m3-success: #1e8e3e; --m3-warning: #f9a825; --m3-error: #d93025; --m3-info: var(--m3-primary); }
        body { font-family: 'Rubik', sans-serif; background-color: var(--m3-surface); color: var(--m3-on-surface); margin: 0; padding: 1.5rem; transition: background-color 0.3s ease, color 0.3s ease; }
        .header-container { display: flex; justify-content: space-between; align-items: center; }
        h1 { font-weight: 500; color: var(--m3-on-surface); } h1 span { color: var(--m3-primary); }
        .filters { display: flex; gap: 1rem; margin-bottom: 1.5rem; background-color: var(--m3-surface-container); padding: 1rem; border-radius: 1rem; }
        .form-control { flex-grow: 1; background-color: var(--m3-surface); color: var(--m3-on-surface); border: 1px solid var(--m3-outline); padding: 0.75rem 1rem; border-radius: 0.5rem; font-family: 'Rubik', sans-serif; } .form-control::placeholder { color: var(--m3-on-surface-variant); }
        .log-container { height: 75vh; overflow-y: auto; border: 1px solid var(--m3-outline); border-radius: 1rem; background-color: var(--m3-surface-container); }
        table { width: 100%; border-collapse: collapse; font-family: 'Fira Code', monospace; }
        th, td { padding: 0.75rem 1rem; text-align: right; border-bottom: 1px solid var(--m3-outline); font-size: 0.85rem; vertical-align: top; }
        thead { position: sticky; top: 0; background: var(--m3-surface-container); } th { font-family: 'Rubik'; color: var(--m3-on-surface-variant); }
        tr:hover { background-color: rgba(0,0,0,0.03); }
        .level-INFO { color: var(--m3-info); font-weight: 500; } .level-WARN { color: var(--m3-warning); font-weight: 500; } .level-ERROR { color: var(--m3-error); font-weight: 700; }
        .col-time { color: var(--m3-on-surface-variant); width: 150px; } .col-level { width: 80px; } .col-origin { color: var(--m3-success); width: 120px; } .col-context { color: #888; font-size: 0.75rem; }
    </style>
</head>
<body>

    <div class="header-container">
        <h1>
            <span>[v45.3]</span> צג לוגים בזמן אמת
            <span id="status" style="font-size: 0.9rem; color: var(--m3-warning); margin-right: 10px;">(מתחבר...)</span>
        </h1>
    </div>

    <div class="filters">
        <input type="text" id="filter-text" class="form-control" placeholder="סנן לפי הודעה, מקור...">
        <select id="filter-level" class="form-control">
            <option value="">כל הרמות</option>
            <option value="INFO">INFO</option>
            <option value="WARN">WARN</option>
            <option value="ERROR">ERROR</option>
        </select>
    </div>

    <div class="log-container">
        <table>
            <thead>
                <tr><th>זמן</th><th>רמה</th><th>מקור</th><th>הודעה</th><th>קונטקסט</th></tr>
            </thead>
            <tbody id="logs-table-body"></tbody>
        </table>
    </div>

    <script type="module">
        // --- Import from Shared Module ---
        import { db, authReadyPromise, SmartLog, collection, query, orderBy, limit, onSnapshot } from '../shared/firebase-init.js'; // Adjusted path

        // Use unified LOG_COLLECTION from shared module
        const LOG_COLLECTION = 'system_logs_v3';
        const LOG_LIMIT = 200; // Keep local limit setting

        const DOM = {
            tableBody: document.getElementById('logs-table-body'),
            filterText: document.getElementById('filter-text'),
            filterLevel: document.getElementById('filter-level'),
            status: document.getElementById('status'),
        };

        let allLogs = [];
        let unsubscribe = null;

        function init() {
            SmartLog.info("Log Viewer Initializing.", "LogViewer.Init"); // Use imported SmartLog

            DOM.filterText.addEventListener('input', renderLogs);
            DOM.filterLevel.addEventListener('input', renderLogs);

            listenToLogs();
        }

        function listenToLogs() {
            if (unsubscribe) unsubscribe();

            const q = query(
                collection(db, LOG_COLLECTION), // Use imported db and collection
                orderBy("timestamp", "desc"),
                limit(LOG_LIMIT)
            );

            DOM.status.textContent = '(מאזין לשינויים...)';
            DOM.status.style.color = 'var(--m3-success)';

            unsubscribe = onSnapshot(q, (snapshot) => { // Use imported onSnapshot
                allLogs = snapshot.docs.map(doc => doc.data()); // Simpler mapping
                renderLogs();
            }, (error) => {
                SmartLog.error(error, "LogViewer.Listener"); // Use imported SmartLog
                DOM.status.textContent = `(שגיאת האזנה: ${error.message})`;
                DOM.status.style.color = 'var(--m3-error)';
            });
        }

        function renderLogs() {
            const textFilter = DOM.filterText.value.toLowerCase();
            const levelFilter = DOM.filterLevel.value;

            const filteredLogs = allLogs.filter(log => {
                const levelMatch = !levelFilter || log.level === levelFilter;
                const textMatch = !textFilter ||
                    (log.message && String(log.message).toLowerCase().includes(textFilter)) || // Ensure message is string
                    (log.origin && log.origin.toLowerCase().includes(textFilter));
                return levelMatch && textMatch;
            });

            if (!DOM.tableBody) return; // Guard clause

            if (filteredLogs.length === 0) {
                DOM.tableBody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 2rem;">אין לוגים תואמים...</td></tr>`;
                return;
            }

            DOM.tableBody.innerHTML = filteredLogs.map(log => {
                // Safely access timestamp and format date
                let time = '...';
                if (log.timestamp && typeof log.timestamp.toDate === 'function') {
                    try {
                        time = log.timestamp.toDate().toLocaleString('he-IL', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                    } catch (e) { console.warn("Error formatting timestamp", e); }
                }

                const safeMessage = log.message ? String(log.message).replace(/</g, "&lt;").replace(/>/g, "&gt;") : '---';

                // Context display logic remains the same
                let contextStr = '';
                if (log.context) {
                     try {
                        if (log.context.stack) {
                            // Extract first relevant line of stack, or indicate presence
                            const stackLines = String(log.context.stack).split('\n');
                            contextStr = stackLines[1]?.trim() || (stackLines.length > 0 ? 'Stack trace available' : '');
                        } else {
                            // Stringify other contexts, truncate if too long
                            contextStr = JSON.stringify(log.context);
                            if (contextStr.length > 150) contextStr = contextStr.substring(0, 150) + '...';
                        }
                     } catch (e) { contextStr = '[Error displaying context]';}
                }

                return `
                    <tr class="level-${log.level || 'INFO'}">
                        <td class="col-time">${time}</td>
                        <td class="col-level">${log.level || 'INFO'}</td>
                        <td class="col-origin">[${log.origin || 'N/A'}]</td>
                        <td>${safeMessage}</td>
                        <td class="col-context">${contextStr}</td>
                    </tr>
                `;
            }).join('');
        }

        // --- Start App ---
        authReadyPromise.then(() => { // Use imported promise
            SmartLog.info("Log Viewer Page Loaded (v45.3 Modular)", "LogViewer.Load");
            init();
        }).catch(err => {
            SmartLog.error(err, "LogViewer.AuthFail");
            if (DOM.status) {
                 DOM.status.textContent = `(שגיאת אימות קריטית: ${err.message})`;
                 DOM.status.style.color = 'var(--m3-error)';
            }
        });

    </script>
</body>
</html>
