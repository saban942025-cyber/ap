                <hr>
                <h4 class="font-medium text-gray-700">פרטי הזמנה</h4>
                <div><label for="order-number" class="block text-sm font-medium mb-1">מס' הזמנה (אופציונלי)</label><input type="text" id="order-number" placeholder="ריק = מזהה אוטומטי" class="w-full p-2 border rounded-md text-sm"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="order-date" class="block text-sm font-medium mb-1">תאריך אספקה*</label>
                        <input type="date" id="order-date" class="w-full p-2 border rounded-md text-sm" required>
                    </div>
                    <div>
                        <label for="order-time" class="block text-sm font-medium mb-1">שעת אספקה (אופצ')</label>
                        <input type="time" id="order-time" class="w-full p-2 border rounded-md text-sm">
                    </div>
                </div>
                 <div class="grid grid-cols-2 gap-4">
                     <div>
                         <label for="order-delivery-type" class="block text-sm font-medium mb-1">סוג הובלה*</label>
                         <select id="order-delivery-type" class="w-full p-2 border rounded-md text-sm bg-white" required>
            <input type="hidden" id="customer-edit-id">
            <div class="modal-header">
                <h3 id="customer-edit-title">עריכת לקוח</h3>
                <button type="button" onclick="closeCustomerEditModal()"><i data-feather="x"></i></button>
            </div>
            <div class="modal-content space-y-4">
                 <div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium mb-1">שם*</label><input type="text" id="customer-edit-name" class="w-full p-2 border rounded-md text-sm" required></div><div><label class="block text-sm font-medium mb-1">מס' לקוח</label><input type="text" id="customer-edit-number" class="w-full p-2 border rounded-md text-sm"></div></div>
                 <div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium mb-1">טלפון*</label><input type="tel" id="customer-edit-phone" class="w-full p-2 border rounded-md text-sm" required></div><div><label class="block text-sm font-medium mb-1">איש קשר</label><input type="text" id="customer-edit-contact" class="w-full p-2 border rounded-md text-sm"></div></div>
                 <hr><h4 class="font-medium text-gray-700">כתובת ברירת מחדל*</h4>
                 <div class="grid grid-cols-3 gap-2">
                     <input type="text" id="customer-edit-street" placeholder="רחוב" class="w-full p-2 border rounded-md text-sm col-span-2" required>
                     <input type="text" id="customer-edit-streetnum" placeholder="מס'" class="w-full p-2 border rounded-md text-sm" required>
                 </div>
                 <input type="text" id="customer-edit-city" placeholder="עיר" class="w-full p-2 border rounded-md text-sm" required>
                 <div><label class="block text-sm font-medium mb-1">קואורדינטות (lat, lon)</label><input type="text" id="customer-edit-coords" placeholder="הדבק מ-Google Maps (אופציונלי)" class="w-full p-2 border rounded-md text-sm"><p class="text-xs text-gray-500 mt-1">למיקום מדויק בהזמנות</p></div>
                 <div class="mt-4 border-t pt-3"><h4 class="text-sm font-medium text-gray-600 mb-1">היסטוריית שינויים</h4><ul id="customer-audit-log" class="text-xs text-gray-500 space-y-1 max-h-20 overflow-y-auto bg-gray-50 p-2 rounded border"></ul></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeCustomerEditModal()">ביטול</button>
                <button type="submit" id="customer-save-btn" class="btn-primary">שמור שינויים</button>
            </div>
        </form>
    </dialog>

     <!-- Ping Options Modal -->
    <dialog id="ping-modal">
        <div class="details-modal-handle" style="background-color: #9ca3af;"></div> <!-- Slightly darker handle -->
        <h3 class="text-lg font-semibold p-4 pb-2 text-center">בחר הודעת התראה</h3>
        <div id="ping-options-list">
            <!-- Options added dynamically -->
        </div>
        <div class="ping-option font-medium" onclick="selectPingOption('custom')">
            <i data-feather="edit-3" class="inline-block w-4 h-4 ml-2"></i>הודעה מותאמת אישית...
        </div>
         <div id="ping-modal-footer">
             <button type="button" class="text-sm text-gray-600 hover:text-gray-800" onclick="closePingOptionsModal()">ביטול</button>
         </div>
    </dialog>


    <div id="toast-container"></div>

    <script type="module">
        // --- Import from Shared Module ---
        import {
            db, auth, authReadyPromise, functions, SmartLog, showToast, // Use shared showToast
            collection, doc, onSnapshot, query, orderBy, addDoc, updateDoc,
            serverTimestamp, deleteDoc, arrayUnion, where, getDocs, setDoc, limit, getDoc,
            Timestamp
        } from '/shared/firebase-init.js'; // *** TRYING ABSOLUTE PATH FROM ROOT ***

        // --- State, Config, Icons ---
        // ... (Remain the same as previous version v33.0) ...
        const ISRAEL_CENTER = [32.0853, 34.7818];
        const WAREHOUSE_LOCATIONS = { "החרש": [32.13266165049073, 34.898196599998755], "התלמיד": [32.16303427408473, 34.894926705310006] };
        const ALLOWED_STATUSES = ["חדש", "שויך", "בדרך", "הושלם", "בוטל"];
        let state = { orders: [], drivers: [], liveLocations: {}, customers: [] };
        let map; let driverMarkers = {}; let orderMarkers = {};
        let currentDetailsItem = null; // Store { id, type } of item in details modal
        let customerSearchTimeout = null; // For debouncing customer search

        const driverIconActive = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', shadowSize: [41, 41] });
        const driverIconStuck = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', shadowSize: [41, 41] });
        const orderIconNew = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', shadowSize: [41, 41] });

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            try { feather.replace(); } catch(e) {}
            initializeApplication();
            const orderDateInput = document.getElementById('order-date');
            if(orderDateInput) orderDateInput.value = new Date().toISOString().split('T')[0];
        });

        async function initializeApplication() {
            SmartLog.info("v33.1-FB (Mobile Refined): Initializing...", "Init");
            showLoader('map-loader', true);
            showLoader('orders-list', true);
            showLoader('drivers-list', true);
            try {
                initMap();
                await authReadyPromise;
                SmartLog.info(`Auth successful.`, "Init.Auth");
                // Start listeners
                listenToDrivers(); listenToOrders(); listenToLocations(); listenToCustomers();
                // Attach event listeners after elements exist
                document.getElementById('history-filter-btn')?.addEventListener('click', renderHistoryTable);
                // Placeholder for driver history button
                // document.getElementById('driver-history-filter-btn')?.addEventListener('click', fetchAndDrawDriverRoute);
                 showView('dashboard'); // Ensure correct initial view and nav state
            } catch (error) {
                SmartLog.error(error, "Init.Critical"); showToast(`שגיאת אתחול: ${error.message}`, 'error');
            } finally {
                 showLoader('map-loader', false); showLoader('orders-list', false); showLoader('drivers-list', false);
            }
        }

        // --- initMap, Firestore Listeners (remain the same) ---
        function initMap() { /* ... */ }
        function listenToDrivers() { /* ... */ }
        function listenToOrders() { /* ... */ }
        function listenToLocations() { /* ... */ }
        function listenToCustomers() { /* ... */ }

        // --- RENDER FUNCTIONS (Refined styling, otherwise same logic) ---
        function renderDrivers() {
            const list = document.getElementById('drivers-list'); if (!list) return;
            const hasData = state.drivers.length > 0;
            showLoader('drivers-list', !hasData); // Show loader only if list is truly empty
            if (!hasData) { list.innerHTML = `<div class="p-4 text-center text-gray-500 text-sm">אין נהגים פעילים כעת.</div>`; return; }
            const fragment = document.createDocumentFragment();
            state.drivers.forEach(driver => {
                const location = state.liveLocations[driver.id];
                const assigned = state.orders.filter(o => o.driver?.id === driver.id && !['הושלם', 'בוטל'].includes(o.status)).length;
                fragment.appendChild(createDriverCard(driver, location, assigned));
            });
            list.innerHTML = ''; list.appendChild(fragment); filterLists();
        }
        function createDriverCard(driver, location, assignedCount) { /* ...minor style tweaks if needed... */ }
        function renderOrders() {
            const list = document.getElementById('orders-list'); if (!list) return;
            const unassignedOrders = state.orders.filter(o => o.status === 'חדש');
            const hasData = unassignedOrders.length > 0;
            showLoader('orders-list', !hasData);
            if (!hasData) { list.innerHTML = `<div class="p-4 text-center text-gray-500 text-sm">אין הזמנות חדשות לשיבוץ.</div>`; return; }
            const fragment = document.createDocumentFragment();
            unassignedOrders.sort((a,b)=>(a.createdAt?.toMillis()||0)-(b.createdAt?.toMillis()||0))
                           .forEach(order => fragment.appendChild(createOrderCard(order)));
            list.innerHTML = ''; list.appendChild(fragment); filterLists();
        }
        function createOrderCard(order) { /* ...minor style tweaks if needed... */ }
        function renderMapMarkers() { /* ...logic remains the same... */ }
        function renderHistoryTable() { /* ...logic remains the same, ensure feather.replace called... */ }
        function renderCustomerTable() { /* ...logic remains the same... */ }

        // --- UI INTERACTIONS ---
        function showView(viewName) {
            document.querySelectorAll('.app-view').forEach(v => v.classList.remove('active'));
            const viewEl = document.getElementById(`view-${viewName}`);
            if (viewEl) viewEl.classList.add('active'); // Use class for transition
            document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
            const btnEl = document.querySelector(`.nav-button[onclick*="'${viewName}'"]`);
            if (btnEl) btnEl.classList.add('active');
            if (viewName === 'history') showHistoryTab('orders');
            if (viewName === 'dashboard' && map) setTimeout(() => map.invalidateSize(), 50); // Delay invalidate
            SmartLog.info(`View switched: ${viewName}`, "UI.Nav");
        }
        window.showView = showView; // Make global

        function showHistoryTab(tabName) { /* ...logic remains same... */ }
        window.showHistoryTab = showHistoryTab;

        function showPanelTab(tabName) { // Dashboard tabs
            document.querySelectorAll('#dashboard-lists .panel-list').forEach(p => p.classList.remove('active'));
            const listEl = document.getElementById(tabName + '-list');
            if (listEl) listEl.classList.add('active');
            document.querySelectorAll('.dash-tab-button').forEach(b => b.classList.remove('active'));
            const btnEl = document.getElementById('tab-' + tabName);
            if (btnEl) btnEl.classList.add('active');
            filterLists();
        }
        window.showPanelTab = showPanelTab;

        function filterLists() { /* ...logic remains same... */ }
        window.filterLists = filterLists;

        // --- DETAILS MODAL ---
        function openDetailsModal(id, type) { /* ...logic mostly same, ensure feather.replace called... */ }
        function closeDetailsModal() { /* ...logic remains same... */ }
        window.closeDetailsModal = closeDetailsModal;
        function copyCustomerLinkFromDetails() { /* ...logic remains same... */ }
        window.copyCustomerLinkFromDetails = copyCustomerLinkFromDetails;

        // --- Assign Driver Prompt (simplified for mobile) ---
        function openAssignDriverPrompt(orderId) { /* ...logic remains same... */ }
        window.openAssignDriverPrompt = openAssignDriverPrompt; // For map popup button
        async function assignOrderToDriver(orderId, driverId) { /* ...logic remains same... */ }

        // --- Geocoding (remains the same) ---
        async function geocodeAddress(address) { /* ... */ }

        // --- STATUS UPDATE (remains the same) ---
        function promptForStatusChange(orderId, currentStatus) { /* ... */ }
        window.promptForStatusChange = promptForStatusChange; // For details modal & history table
        async function updateOrderStatus(orderId, newStatus) { /* ... */ }

        // --- NEW ORDER FORM (Improved Search) ---
        function populateCustomerDatalist() { /* ...logic remains same, populates hidden datalist... */ }
        function openNewOrderForm() { /* ...logic remains same... */ }
        window.openNewOrderForm = openNewOrderForm;
        function closeNewOrderForm() {
             document.getElementById('new-order-modal')?.close();
             const form = document.getElementById('new-order-modal')?.querySelector('form');
             if (form) form.reset();
             const dateInput = document.getElementById('order-date');
             if(dateInput) dateInput.value = new Date().toISOString().split('T')[0];
             clearCustomerSelection(); // Also clear selection state
             document.getElementById('customer-suggestions').innerHTML = ''; // Clear suggestions
             document.getElementById('customer-suggestions').classList.add('hidden');
        }
        window.closeNewOrderForm = closeNewOrderForm;

        // Improved Customer Search with Debounce and Dynamic List
        function handleCustomerSearch(value) {
            clearTimeout(customerSearchTimeout);
            const suggestionsEl = document.getElementById('customer-suggestions');
            const newFields = document.getElementById('new-customer-fields');
            const existDisp = document.getElementById('existing-customer-display');
            if (!suggestionsEl || !newFields || !existDisp) return;

            const searchTerm = value.trim().toLowerCase();
            suggestionsEl.innerHTML = ''; // Clear previous suggestions

            if (searchTerm.length < 1) {
                suggestionsEl.classList.add('hidden');
                newFields.style.display = 'none';
                existDisp.style.display = 'none'; // Hide existing display too
                document.getElementById('customer-id-existing').value = ''; // Clear ID
                return;
            }

            customerSearchTimeout = setTimeout(() => {
                const matches = state.customers.filter(cust =>
                    (cust.name && cust.name.toLowerCase().includes(searchTerm)) ||
                    (cust.customerNumber && cust.customerNumber.includes(searchTerm)) ||
                    (cust.phone && cust.phone.includes(searchTerm))
                ).slice(0, 5); // Limit suggestions

                if (matches.length > 0) {
                    matches.forEach(cust => {
                        const item = document.createElement('div');
                        item.className = 'suggestion-item';
                        item.innerHTML = `${cust.name} ${cust.customerNumber ? `(${cust.customerNumber})` : ''} <small>${cust.phone || ''}</small>`;
                        item.onclick = () => selectExistingCustomer(cust.id);
                        suggestionsEl.appendChild(item);
                    });
                    suggestionsEl.classList.remove('hidden');
                    newFields.style.display = 'none'; // Hide new fields when suggestions exist
                    existDisp.style.display = 'none'; // Hide existing display until selection
                } else {
                    suggestionsEl.classList.add('hidden');
                    existDisp.style.display = 'none';
                    newFields.style.display = 'block'; // Show new fields if no matches
                    // Pre-fill name, clear others
                    document.getElementById('customer-name-new').value = value; // Use original value
                    ['customer-phone-new', 'customer-street-new', 'customer-streetnum-new', 'customer-city-new', 'customer-contact-new', 'customer-number-new'].forEach(id => { const el=document.getElementById(id); if(el) el.value=''; });
                }
            }, 300); // Debounce time
        }
        window.handleCustomerSearch = handleCustomerSearch;

        function selectExistingCustomer(customerId) {
            const customer = state.customers.find(c => c.id === customerId);
            const suggestionsEl = document.getElementById('customer-suggestions');
            const searchInput = document.getElementById('customer-search');
            const existDisp = document.getElementById('existing-customer-display');
            const newFields = document.getElementById('new-customer-fields');
            if (!customer || !suggestionsEl || !searchInput || !existDisp || !newFields) return;

            // Display selected customer info
            searchInput.value = customer.customerNumber ? `${customer.name} (${customer.customerNumber})` : customer.name; // Update input field
            existDisp.style.display = 'block';
            newFields.style.display = 'none';
            document.getElementById('customer-id-existing').value = customer.id;
            document.getElementById('customer-name-display').innerText = customer.name;
            document.getElementById('customer-number-display').innerText = customer.customerNumber ? `(${customer.customerNumber})` : '';
            document.getElementById('customer-address-display').innerText = customer.defaultAddress || 'N/A';
            document.getElementById('customer-phone-display').innerText = customer.phone || 'N/A';

            suggestionsEl.innerHTML = ''; // Clear suggestions
            suggestionsEl.classList.add('hidden');
        }

        // --- RENDER FUNCTIONS (Refined styling, otherwise same logic) ---
        // ... (renderDrivers remains the same) ...

        function renderOrders() { // Dashboard Order List
            const list = document.getElementById('orders-list'); if (!list) return;
            const unassignedOrders = state.orders.filter(o => o.status === 'חדש');
            const hasData = unassignedOrders.length > 0;
            // Removed loader logic from here, handled in initializeApplication
            // showLoader('orders-list', !hasData);
            if (!hasData) { list.innerHTML = `<div class="p-4 text-center text-gray-500 text-sm">אין הזמנות חדשות לשיבוץ.</div>`; return; }
            const fragment = document.createDocumentFragment();
            unassignedOrders.sort((a,b)=>(a.createdAt?.toMillis()||0)-(b.createdAt?.toMillis()||0))
                           .forEach(order => fragment.appendChild(createOrderCard(order))); // Pass to creator function
            list.innerHTML = ''; list.appendChild(fragment);
            filterLists(); // Apply filter after rendering
            try { feather.replace({ width: '14px', height: '14px' }); } catch(e){} // Redraw icons if needed
        }

        function createOrderCard(order) { // Dashboard Order Card
            const el = document.createElement('div');
            // Base classes
            let cardClasses = 'order-card p-3 cursor-pointer border-b border-gray-200'; // Reduced padding, use border-b
            let urgencyIcon = '';
            let timeText = '';

            // Check urgency for today's orders with a specific time
            if (order.orderDate && order.deliveryTime) {
                try {
                    const now = new Date();
                    const deliveryDateTime = new Date(`${order.orderDate}T${order.deliveryTime}`);
                    const today = now.toISOString().split('T')[0];

                    if (order.orderDate === today) {
                        const timeDiffMinutes = (deliveryDateTime.getTime() - now.getTime()) / (1000 * 60);
                        timeText = ` (${order.deliveryTime})`; // Add time for today's orders

                        if (timeDiffMinutes < 0) {
                            cardClasses += ' border-l-4 border-red-500 bg-red-50'; // Past due styling
                            urgencyIcon = '<i data-feather="alert-triangle" class="w-3 h-3 text-red-600 ml-1"></i>'; // Alert icon
                        } else if (timeDiffMinutes < 60) {
                            cardClasses += ' border-l-4 border-yellow-500 bg-yellow-50'; // Approaching styling
                            urgencyIcon = '<i data-feather="clock" class="w-3 h-3 text-yellow-600 ml-1 animate-pulse"></i>'; // Clock icon pulsing
                        }
                    } else if (deliveryDateTime < now) {
                         // Optional: Style for past orders shown unexpectedly?
                         // cardClasses += ' opacity-60';
                    } else {
                         timeText = ` (${order.deliveryTime})`; // Add time for future orders
                    }
                } catch (e) { console.warn("Error parsing date/time for urgency", e); }
            }

            el.className = cardClasses;
            el.id = `order-card-${order.id}`;
            el.setAttribute('data-search', `${order.orderNumber || order.id} ${order.customer?.name?.toLowerCase()} ${order.address?.toLowerCase()}`);
            el.onclick = () => openDetailsModal(order.id, 'order'); // Changed to openDetailsModal

            const orderDateFormatted = order.orderDate ? new Date(order.orderDate).toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit', year: '2-digit' }) : 'N/A';
            const customerName = order.customer?.name || 'לקוח לא ידוע';
            const address = order.address || 'כתובת לא צוינה';
            const createdTime = order.createdAt?.toDate ? order.createdAt.toDate().toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' }) : '';
            const displayId = order.orderNumber || `#${order.id.slice(-6)}`;

            el.innerHTML = `
                <div class="flex justify-between items-center mb-1">
                    <span class="font-bold text-blue-600 text-sm">${displayId}</span>
                    <span class="text-xs font-semibold text-gray-700 flex items-center">
                        ${urgencyIcon}${orderDateFormatted}${timeText}
                    </span>
                </div>
                <div class="font-semibold text-gray-800 text-sm">${customerName}</div>
                <div class="text-xs text-gray-600 truncate">${address}</div>
                <div class="text-xs text-gray-500 mt-1 flex justify-between">
                    <span>${order.deliveryType || ''} | ${order.warehouse || ''}</span>
                    <span title="זמן יצירה">נוצר: ${createdTime}</span>
                </div>`;
            return el;
        }

        function renderMapMarkers() { /* ...logic remains the same... */ }

        function renderHistoryTable() { // History Table
            const list = document.getElementById('history-table-body');
            if (!list) return;
            // ... (filtering logic remains the same) ...

            let html = '';
            if (filteredOrders.length === 0) {
                html = '<tr><td colspan="7" class="text-center p-8 text-gray-500">לא נמצאו הזמנות תואמות</td></tr>';
            } else {
                filteredOrders.forEach(order => {
                    const orderDateTime = order.orderDate
                        ? new Date(order.orderDate).toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit', year: 'numeric' }) + (order.deliveryTime ? ` ${order.deliveryTime}` : '')
                        : (order.createdAt?.toDate ? order.createdAt.toDate().toLocaleDateString('he-IL') : 'N/A');
                    const displayId = order.orderNumber || `#${order.id.slice(-6)}`;
                    html += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${displayId}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.customer?.name || '...'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.driver?.name || '---'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 truncate" title="${order.address || ''}">${order.address || '...'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.status || '...'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${orderDateTime}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                <button class="action-button" onclick="promptForStatusChange('${order.id}', '${order.status || 'חדש'}')">עדכן</button>
                                <button class="action-button action-button-secondary" onclick="copyCustomerLink('${order.id}')" title="העתק לינק ללקוח">
                                    <i data-feather="share-2" class="w-4 h-4"></i>
                                </button>
                                <!-- Add Edit/Delete buttons here later -->
                            </td>
                        </tr>`;
                });
            }
            list.innerHTML = html;
            try { feather.replace({ width: '14px', height: '14px' }); } catch(e){}
        }

        // --- DETAILS MODAL (Add Time) ---
        function renderDetailsModalContent(id, type) { // Renamed from openDetailsModal
            const detailsEl = document.getElementById('details-modal-body');
            const titleEl = document.getElementById('details-modal-title');
            const copyBtn = document.getElementById('details-copy-link-btn');
            const whatsappBtn = document.getElementById('details-whatsapp-btn');
            if (!detailsEl || !titleEl || !copyBtn || !whatsappBtn) return;

            detailsEl.innerHTML = '<div class="loader-container"><div class="loader"></div></div>'; // Show loader
            copyBtn.classList.add('hidden'); // Hide buttons initially
            whatsappBtn.classList.add('hidden');
            currentDetailsItem = { id, type }; // Store current item

            let html = '';
            if (type === 'driver') {
                const driver = state.drivers.find(d => d.id === id);
                if (!driver) { detailsEl.innerHTML = 'נהג לא נמצא'; return; }
                const location = state.liveLocations[id];
                const assignedOrders = state.orders.filter(o => o.driver?.id === id && !['הושלם', 'בוטל'].includes(o.status));
                const minutesAgo = location?.lastUpdate?.toDate ? Math.round((Date.now() - location.lastUpdate.toDate().getTime()) / 60000) : '?';

                titleEl.textContent = driver.name;
                html = `<ul><li><strong>טלפון:</strong> ${driver.phone || '?'}</li><li><strong>רכב:</strong> ${driver.vehicleType || '?'}</li><li><strong>סטטוס:</strong> ${location ? (location.isStuck ? 'תקוע' : `פעיל (${minutesAgo} דק')`) : 'לא מחובר'}</li></ul>
                        <h4 class="sub-header">הזמנות משויכות (${assignedOrders.length})</h4><ul>`;
                html += assignedOrders.length > 0 ? assignedOrders.map(o => `<li>${o.orderNumber || `#${o.id.slice(-6)}`} - ${o.customer?.name || '...'} (${o.status})</li>`).join('') : `<li>אין הזמנות משויכות</li>`;
                html += `</ul>`;
                // No WhatsApp or copy link for driver details for now
            } else if (type === 'order') {
                const order = state.orders.find(o => o.id === id);
                if (!order) { detailsEl.innerHTML = 'הזמנה לא נמצאה'; return; }
                const displayId = order.orderNumber || `#${order.id.slice(-6)}`;
                const currentStatus = order.status || 'חדש';
                const orderDateFormatted = order.orderDate ? new Date(order.orderDate).toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit', year: 'numeric' }) : 'N/A';
                const deliveryTime = order.deliveryTime ? `בשעה ${order.deliveryTime}` : '(לא צוינה שעה)';

                titleEl.textContent = `הזמנה ${displayId}`;
                copyBtn.classList.remove('hidden'); // Show copy link button
                 // Show WhatsApp button only if driver is assigned and status is relevant
                if (order.driver?.id && ['שויך', 'בדרך'].includes(currentStatus)) {
                     whatsappBtn.classList.remove('hidden');
                 }

                html = `<ul><li><strong>לקוח:</strong> ${order.customer?.name || '?'}</li><li><strong>טלפון:</strong> ${order.customer?.phone || '?'}</li><li><strong>כתובת:</strong> ${order.address || '?'}</li><li><strong>תאריך אספקה:</strong> ${orderDateFormatted} ${deliveryTime}</li><li class="status-line"><strong>סטטוס:</strong> ${currentStatus} <button class="status-change-btn" onclick="promptForStatusChange('${order.id}', '${currentStatus}')">[שנה]</button></li><li><strong>סוג:</strong> ${order.deliveryType || '?'} | <strong>מחסן:</strong> ${order.warehouse || '?'}</li></ul>`;

                if (order.latitude && order.longitude) {
                    const orderLatLng = L.latLng(order.latitude, order.longitude);
                    html += `<h4 class="sub-header">מרחק ממחסנים</h4><ul>`;
                    Object.entries(WAREHOUSE_LOCATIONS).forEach(([name, coords]) => { if (Array.isArray(coords)) { try { const dist = orderLatLng.distanceTo(L.latLng(coords)); html += `<li><span class="dist">${(dist / 1000).toFixed(1)} ק"מ</span> - ${name}</li>`; } catch (e) {} } }); html += `</ul>`;
                    const activeDrivers = state.drivers.filter(d => state.liveLocations[d.id] && !state.liveLocations[d.id].isStuck).map(driver => { const loc = state.liveLocations[driver.id]; if (!loc?.latitude) return null; try { const dist = orderLatLng.distanceTo(L.latLng(loc.latitude, loc.longitude)); return { id: driver.id, name: driver.name, dist }; } catch (e) { return null; } }).filter(d => d).sort((a, b) => a.dist - b.dist);
                    html += `<h4 class="sub-header">נהגים זמינים (${activeDrivers.length})</h4><ul>`;
                    html += activeDrivers.length > 0 ? activeDrivers.map(d => `<li><span class="dist">${(d.dist / 1000).toFixed(1)} ק"מ</span> - ${d.name} <button class="status-change-btn" onclick="assignOrderToDriver('${order.id}', '${d.id}')">[שייך]</button></li>`).join('') : `<li>אין נהגים זמינים</li>`; html += `</ul>`;
                }
                if (order.notes) {
                     html += `<h4 class="sub-header">הערות</h4><p class="text-sm bg-gray-50 p-2 rounded border">${order.notes}</p>`;
                }
            }

            detailsEl.innerHTML = html;
            try { feather.replace({ width: '16px', height: '16px' }); } catch(e){}
        }

        function openDetailsModal(id, type) {
            const modal = document.getElementById('details-modal');
            renderDetailsModalContent(id, type); // Load content first
            if (modal) modal.showModal();
        }
        window.openDetailsModal = openDetailsModal; // Expose globally

        function closeDetailsModal() { document.getElementById('details-modal')?.close(); currentDetailsItem = null; document.querySelectorAll('.order-card, .driver-card').forEach(c => c.classList.remove('active')); }
        window.closeDetailsModal = closeDetailsModal;

        function copyCustomerLinkFromDetails() {
             if (currentDetailsItem && currentDetailsItem.type === 'order') {
                 copyCustomerLink(currentDetailsItem.id);
             }
        }
        window.copyCustomerLinkFromDetails = copyCustomerLinkFromDetails;


        async function submitNewOrder(event) {
            event.preventDefault();
            // ... (validation and customer handling logic remains the same) ...
            try {
                // ... (customer logic) ...

                // Step 2: Create Order - Add deliveryTime
                const newOrder = {
                    // ... (other fields remain the same) ...
                    orderDate: document.getElementById('order-date').value,
                    deliveryTime: document.getElementById('order-time').value || null, // Get time value or null
                    deliveryType: document.getElementById('order-delivery-type').value,
                    warehouse: document.getElementById('order-warehouse').value,
                    notes: document.getElementById('order-notes').value.trim(),
                    latitude: finalCoords[0],
                    longitude: finalCoords[1],
                    status: "חדש",
                    createdAt: serverTimestamp(),
                    lastModified: serverTimestamp()
                };

                // Final validation now includes deliveryTime indirectly via orderDate
                 if (!newOrder.orderDate || !newOrder.deliveryType || !newOrder.warehouse) {
                     throw new Error("תאריך, סוג הובלה ומחסן הם שדות חובה.");
                 }

                const orderDocRef = await addDoc(collection(db, "orders"), newOrder);
                // ... (rest of the success/error handling) ...

            } catch (error) { showToast(`שגיאה: ${error.message}`, 'error'); SmartLog.error(error, "CRUD.Order.Create"); }
            finally { btn.disabled = false; btn.innerText = 'צור הזמנה'; }
        }
        // submitNewOrder doesn't need to be global, triggered by form submit

        // --- WhatsApp Placeholder ---
        function handleWhatsAppAction() {
            if (!currentDetailsItem || currentDetailsItem.type !== 'order') return;
            const order = state.orders.find(o => o.id === currentDetailsItem.id);
            if (!order || !order.driver?.id) return;

            // Placeholder: Open WhatsApp chat with the driver? Send predefined message?
            // This requires knowing the driver's phone number accurately.
            const driver = state.drivers.find(d => d.id === order.driver.id);
            if (!driver?.phone) {
                showToast("מספר טלפון של הנהג לא זמין.", "warn");
                return;
            }
            const message = encodeURIComponent(`היי ${driver.name}, עדכון לגבי הזמנה ${order.orderNumber || `#${order.id.slice(-6)}`}: `);
            const whatsappUrl = `https://wa.me/${driver.phone}?text=${message}`; // Basic URL, might need adjustments based on country code etc.
            window.open(whatsappUrl, '_blank');
            SmartLog.info("Opened WhatsApp link for driver", "Integration.WhatsApp", { orderId: order.id, driverId: driver.id });
        }
        window.handleWhatsAppAction = handleWhatsAppAction; // Global for button

