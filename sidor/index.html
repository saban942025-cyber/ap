<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DeliveryMaster Admin (Mobile) V33.1</title>
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#1F2937">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/ryPT3r29/image.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* ... (כל סגנונות ה-CSS מ-index2.html נשארים זהים) ... */
        :root {
            --primary-color: #3b82f6; --primary-dark: #2563eb; --bg-light: #f3f4f6;
            --bg-white: #ffffff; --border-color: #e5e7eb; --text-dark: #1f2937;
            --text-light: #6b7280; --bg-dark-nav: #1f2937; --text-nav: #9ca3af;
            --text-nav-active: #ffffff; --bottom-nav-height: 60px;
        }
        html, body { height: 100dvh; width: 100vw; overflow: hidden; }
        body { font-family: 'Inter', 'Arial', sans-serif; background-color: var(--bg-light); color: var(--text-dark); display: flex; flex-direction: column; }
        .app-container { flex-grow: 1; overflow: hidden; position: relative; padding-bottom: calc(var(--bottom-nav-height) + env(safe-area-inset-bottom)); }
        .app-view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; background-color: var(--bg-light); opacity: 0; transition: opacity 0.2s ease-in-out; pointer-events: none; z-index: 1; display: flex; flex-direction: column; }
        .app-view.active { opacity: 1; pointer-events: auto; z-index: 10; }
        #bottom-navbar { position: fixed; bottom: 0; left: 0; right: 0; height: calc(var(--bottom-nav-height) + env(safe-area-inset-bottom)); background-color: var(--bg-dark-nav); color: var(--text-nav); display: flex; justify-content: space-around; align-items: flex-start; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; padding: 0 5px; padding-bottom: env(safe-area-inset-bottom); }
        .nav-button { display: flex; flex-direction: column; align-items: center; justify-content: center; padding-top: 8px; border-top: 3px solid transparent; flex-grow: 1; transition: color 0.2s, border-color 0.2s; height: 100%; }
        .nav-button svg { width: 22px; height: 22px; margin-bottom: 3px; }
        .nav-button span { font-size: 0.65rem; font-weight: 500; }
        .nav-button.active { color: var(--text-nav-active); border-top-color: var(--primary-color); }
        #view-dashboard { display: flex; flex-direction: column; }
        #dashboard-map-container { height: 45%; position: relative; background-color: #e0e0e0; flex-shrink: 0; border-bottom: 1px solid var(--border-color); }
        #map { height: 100%; width: 100%; border-radius: 0; }
        #dashboard-content { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; background-color: var(--bg-white); }
        #dashboard-tabs { display: flex; border-bottom: 1px solid var(--border-color); flex-shrink: 0; background-color: var(--bg-white); }
        .dash-tab-button { flex: 1; padding: 0.8rem 0.5rem; font-weight: 500; text-align: center; border-bottom: 3px solid transparent; color: var(--text-light); cursor: pointer; font-size: 0.9rem; }
        .dash-tab-button.active { border-bottom-color: var(--primary-color); color: var(--primary-color); }
        #dashboard-search { padding: 0.75rem; border-bottom: 1px solid var(--border-color); flex-shrink: 0; background-color: var(--bg-white); }
        #dashboard-search input { border-radius: 99px; }
        #dashboard-lists { flex-grow: 1; position: relative; overflow: hidden; }
        .panel-list { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow-y: auto; background-color: var(--bg-white); opacity: 1; }
        .panel-list:not(.active) { display: none; }
        .order-card, .driver-card { padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-color); }
        .order-card.active, .driver-card.active { background-color: #eff6ff; border-right: 3px solid var(--primary-color); }
        #details-modal { max-width: 100%; width: 100%; margin: 0 auto 0 auto; border: none; border-radius: 12px 12px 0 0; background-color: var(--bg-white); box-shadow: 0 -5px 20px rgba(0,0,0,0.1); padding: 0; max-height: 70vh; overflow: hidden; }
        #details-modal::backdrop { background-color: rgba(0,0,0,0.4); backdrop-filter: blur(1px); }
        .details-modal-handle { width: 40px; height: 4px; background-color: #d1d5db; border-radius: 2px; margin: 8px auto 0 auto; }
        .details-modal-header { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem 0.5rem 1rem; border-bottom: 1px solid var(--border-color); }
        .details-modal-header h4 { font-weight: 600; font-size: 1.1rem; }
        .details-modal-header button { background: none; border: none; color: var(--text-light); cursor: pointer; padding: 0.25rem; }
        .details-modal-content { padding: 1rem; max-height: calc(70vh - 70px); overflow-y: auto; }
        .details-modal-content ul { list-style: none; padding: 0; margin: 0; }
        .details-modal-content li { margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--text-light); }
        .details-modal-content strong { color: var(--text-dark); font-weight: 500; }
        .details-modal-content .sub-header { font-weight: 600; color: var(--text-dark); margin-top: 1rem; margin-bottom: 0.5rem; font-size: 0.95rem;}
        .details-modal-content .dist { font-weight: 500; color: var(--text-dark); display: inline-block; min-width: 50px; text-align: right; margin-left: 0.5rem; }
        .status-change-btn { margin-right: 5px; font-size: 0.75rem; color: var(--primary-color); background: none; border: none; cursor: pointer; font-weight: 500;}
        .status-change-btn:hover { text-decoration: underline;}
        .whatsapp-button { background-color: #25D366; color: white; padding: 3px 6px; border-radius: 4px; font-size: 0.75rem; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 3px;}
        .whatsapp-button:hover { background-color: #1DAE50; }
        #view-history { background-color: var(--bg-white); }
        #history-tabs { display: flex; border-bottom: 1px solid var(--border-color); flex-shrink: 0; background-color: var(--bg-white); position: sticky; top: 0; z-index: 20; }
        .history-tab-button { flex: 1; padding: 0.9rem 0.5rem; font-weight: 500; text-align: center; border-bottom: 3px solid transparent; color: var(--text-light); cursor: pointer; font-size: 0.9rem;}
        .history-tab-button.active { border-bottom-color: var(--primary-color); color: var(--primary-color); }
        .history-content { flex-grow: 1; overflow-y: auto; padding: 0.75rem; }
        .history-content h3 { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.75rem; color: var(--text-dark); padding: 0 0.25rem;}
        .table-tools { display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 1rem; background-color: var(--bg-white); padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border-color); }
        .table-tools input, .table-tools button { padding: 0.6rem; border-radius: 6px; border: 1px solid var(--border-color); font-size: 0.9rem; }
        .table-tools button { background-color: var(--primary-color); color: white; border: none; cursor: pointer; }
        .table-wrapper { overflow-x: auto; background-color: var(--bg-white); border-radius: 8px; border: 1px solid var(--border-color); }
        .data-table th, .data-table td { padding: 0.6rem 0.75rem; font-size: 0.8rem; }
        .data-table th { background-color: #f9fafb; }
        .data-table .action-button { padding: 4px 7px; font-size: 0.7rem; }
        .data-table .action-button i { width: 14px; height: 14px; }
        .full-modal { max-width: 100%; width: 100%; height: 100dvh; margin: 0; border-radius: 0; box-shadow: none; padding: 0; display: flex; flex-direction: column; background-color: var(--bg-light); }
        .modal-header { padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background-color: var(--bg-white); flex-shrink: 0; position: sticky; top: 0; z-index: 10; }
        .modal-header h3 { font-size: 1.1rem; font-weight: 600; }
        .modal-content { flex-grow: 1; overflow-y: auto; padding: 1rem; }
        .modal-footer { padding: 0.75rem 1rem; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 0.75rem; background-color: var(--bg-white); flex-shrink: 0; position: sticky; bottom: 0; z-index: 10; }
        .modal-content label { display: block; text-sm font-medium mb-1 text-gray-700; }
        .modal-content input[type="text"], .modal-content input[type="tel"], .modal-content input[type="date"], .modal-content input[type="time"], .modal-content select, .modal-content textarea { width: 100%; padding: 0.6rem 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9rem; background-color: var(--bg-white); }
        .modal-content select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E"); background-position: left 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-left: 2.5rem; }
        #customer-suggestions { max-height: 150px; overflow-y: auto; border: 1px solid var(--border-color); border-top: none; background-color: white; border-radius: 0 0 6px 6px; position: absolute; width: calc(100% - 2rem); z-index: 100; }
        .suggestion-item { padding: 0.5rem 0.75rem; cursor: pointer; font-size: 0.9rem; }
        .suggestion-item:hover { background-color: #eff6ff; }
        .suggestion-item small { color: var(--text-light); font-size: 0.75rem; }
        .loader-container { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.7); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; } @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #toast-container { position: fixed; bottom: calc(var(--bottom-nav-height) + 15px + env(safe-area-inset-bottom)); left: 50%; transform: translateX(-50%); z-index: 5000; display: flex; flex-direction: column; gap: 8px; width: calc(100% - 2rem); max-width: 400px;}
        .toast { padding: 10px 15px; background-color: var(--text-dark); color: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); opacity: 0; transform: translateY(20px); transition: all 0.3s ease; font-size: 0.9rem; width: 100%; }
        .toast.show { opacity: 1; transform: translateY(0); } .toast.success { background-color: #16a34a; } .toast.error { background-color: #dc2626; } .toast.info { background-color: #2563eb;} .toast.warn { background-color: #d97706;}
        #ping-modal { max-width: 90%; width: 350px; border-radius: 12px; border: none; box-shadow: 0 5px 20px rgba(0,0,0,0.1); padding: 0; }
        #ping-modal::backdrop { background-color: rgba(0,0,0,0.4); }
        .ping-option { display: block; width: 100%; text-align: right; padding: 1rem; border-bottom: 1px solid var(--border-color); cursor: pointer; font-size: 0.95rem; }
        .ping-option:hover { background-color: #f3f4f6; }
        .ping-option:last-child { border-bottom: none; }
        #ping-modal-footer { padding: 0.75rem 1rem; text-align: left; border-top: 1px solid var(--border-color); background-color: #f9fafb;}
    </style>
</head>
<body class="antialiased">

    <div class="app-container">
        <main id="view-dashboard" class="app-view active">
            <div id="dashboard-map-container">
                <div id="map"></div>
                <div id="map-loader" class="loader-container"><div class="loader"></div></div>
            </div>
            <div id="dashboard-content">
                <div id="dashboard-tabs">
                    <button id="tab-orders" class="dash-tab-button active" onclick="showPanelTab('orders')">הזמנות חדשות</button>
                    <button id="tab-drivers" class="dash-tab-button" onclick="showPanelTab('drivers')">נהגים פעילים</button>
                </div>
                <div id="dashboard-search">
                    <input type="text" id="search-input" placeholder="חיפוש..." class="w-full px-4 py-1.5 border rounded-full focus:outline-none focus:ring-1 focus:ring-blue-300 text-sm" onkeyup="filterLists()">
                </div>
                <div id="dashboard-lists">
                    <div id="orders-list" class="panel-list active"><div class="loader-container hidden"><div class="loader"></div></div></div>
                    <div id="drivers-list" class="panel-list"><div class="loader-container hidden"><div class="loader"></div></div></div>
                </div>
            </div>
        </main>

        <div id="view-history" class="app-view">
             <div id="history-tabs">
                <button class="history-tab-button active" onclick="showHistoryTab('orders')">היסטוריה</button>
                <button class="history-tab-button" onclick="showHistoryTab('customers')">לקוחות</button>
            </div>
            <div class="history-content" id="history-orders-content">
                <h3>היסטוריית הזמנות</h3>
                <div class="table-tools">
                    <input type="text" id="history-search" placeholder="חיפוש...">
                    <div class="flex gap-2"><input type="date" id="history-date-from" title="מתאריך" class="flex-1"><input type="date" id="history-date-to" title="עד תאריך" class="flex-1"></div>
                    <button id="history-filter-btn" onclick="renderHistoryTable()">סנן</button>
                </div>
                <div class="table-wrapper"><table class="data-table"><thead><tr><th>מס'</th><th>לקוח</th><th>נהג</th><th>כתובת</th><th>סטטוס</th><th>תאריך</th><th>פעולות</th></tr></thead><tbody id="history-table-body"><tr><td colspan="7" class="text-center p-4 text-gray-400">טוען...</td></tr></tbody></table></div>
            </div>
            <div class="history-content" id="history-customers-content" style="display: none;">
                <h3>ניהול לקוחות</h3>
                <div class="table-tools"><input type="text" id="customer-search-input" placeholder="חיפוש..." onkeyup="renderCustomerTable()"></div>
                <div class="table-wrapper"><table class="data-table customer-table"><thead><tr><th>שם</th><th>מס'</th><th>טלפון</th><th>כתובת</th></tr></thead><tbody id="customer-table-body"><tr><td colspan="4" class="text-center p-4 text-gray-400">טוען...</td></tr></tbody></table></div>
            </div>
        </div>
    </div>

    <nav id="bottom-navbar">
        <button class="nav-button active" onclick="showView('dashboard')"><i data-feather="map"></i><span>דשבורד</span></button>
        <button class="nav-button" onclick="showView('history')"><i data-feather="archive"></i><span>ארכיון</span></button>
        <button class="nav-button" onclick="openNewOrderForm()"><i data-feather="plus-circle"></i><span>הזמנה</span></button>
        <button class="nav-button" onclick="openPingOptionsModal()"><i data-feather="bell"></i><span>התראה</span></button>
         <a href="log.html" target="_blank" class="nav-button"><i data-feather="file-text"></i><span>לוגים</span></a>
    </nav>

    <dialog id="details-modal">
         <div class="details-modal-handle"></div>
        <div class="details-modal-header">
            <h4 id="details-modal-title">פרטים</h4>
            <div>
                 <button id="details-whatsapp-btn" class="whatsapp-button mr-2 hidden" onclick="handleWhatsAppAction()" title="פעולות וואטסאפ"><i class="fab fa-whatsapp"></i></button>
                <button id="details-copy-link-btn" class="hidden mr-1" onclick="copyCustomerLinkFromDetails()" title="העתק לינק ללקוח"><i data-feather="share-2"></i></button>
                <button onclick="closeDetailsModal()"><i data-feather="x"></i></button>
            </div>
        </div>
        <div class="details-modal-content" id="details-modal-body">טוען...</div>
    </dialog>

    <dialog id="new-order-modal" class="full-modal">
        <form onsubmit="submitNewOrder(event)">
            <div class="modal-header">
                <h3>יצירת הזמנה חדשה</h3>
                <button type="button" onclick="closeNewOrderForm()"><i data-feather="x"></i></button>
            </div>
            <div class="modal-content space-y-4">
                <div class="relative">
                    <label for="customer-search" class="block text-sm font-medium mb-1">לקוח (חיפוש או חדש)</label>
                    <input type="text" id="customer-search" class="w-full p-2 border rounded-md" oninput="handleCustomerSearch(this.value)" autocomplete="off" placeholder="התחל להקליד שם...">
                    <div id="customer-suggestions" class="absolute left-0 right-0 mt-1 hidden bg-white border border-gray-300 rounded-md z-10 max-h-48 overflow-y-auto shadow-lg"></div>
                </div>
                <div id="new-customer-fields" class="p-3 bg-blue-50 border border-blue-200 rounded-lg space-y-3" style="display: none;">
                     <p class="font-semibold text-blue-700 text-sm">פרטי לקוח חדש</p><input type="hidden" id="customer-id-new"><input type="text" id="customer-name-new" placeholder="שם מלא *" class="w-full p-2 border rounded-md text-sm"><input type="tel" id="customer-phone-new" placeholder="טלפון *" class="w-full p-2 border rounded-md text-sm"><div class="grid grid-cols-3 gap-2"><input type="text" id="customer-street-new" placeholder="רחוב *" class="w-full p-2 border rounded-md text-sm col-span-2"><input type="text" id="customer-streetnum-new" placeholder="מס' *" class="w-full p-2 border rounded-md text-sm"></div><input type="text" id="customer-city-new" placeholder="עיר *" class="w-full p-2 border rounded-md text-sm"><input type="text" id="customer-contact-new" placeholder="איש קשר" class="w-full p-2 border rounded-md text-sm"><input type="text" id="customer-number-new" placeholder="מס' לקוח" class="w-full p-2 border rounded-md text-sm">
                 </div>
                 <div id="existing-customer-display" class="p-3 bg-gray-100 border rounded-lg text-sm space-y-1" style="display: none;">
                    <input type="hidden" id="customer-id-existing">
                    <div class="flex justify-between items-center">
                        <span><strong>לקוח:</strong> <span id="customer-name-display"></span> <span id="customer-number-display" class="text-xs text-gray-500"></span></span>
                        <button type="button" onclick="clearCustomerSelection()" class="text-xs text-red-600 font-medium">נקה בחירה</button>
                    </div>
                    <p><strong>כתובת:</strong> <span id="customer-address-display"></span></p>
                    <p><strong>טלפון:</strong> <span id="customer-phone-display"></span></p>
                </div>
                <hr>
                <h4 class="font-medium text-gray-700">פרטי הזמנה</h4>
                <div><label for="order-number" class="block text-sm font-medium mb-1">מס' הזמנה (אופציונלי)</label><input type="text" id="order-number" placeholder="ריק = מזהה אוטומטי" class="w-full p-2 border rounded-md text-sm"></div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="order-date" class="block text-sm font-medium mb-1">תאריך אספקה*</label>
                        <input type="date" id="order-date" class="w-full p-2 border rounded-md text-sm" required>
                    </div>
                    <div>
                        <label for="order-time" class="block text-sm font-medium mb-1">שעת אספקה (אופצ')</label>
                        <input type="time" id="order-time" class="w-full p-2 border rounded-md text-sm">
                    </div>
                </div>
                
                 <div class="grid grid-cols-2 gap-4">
                     <div>
                         <label for="order-delivery-type" class="block text-sm font-medium mb-1">סוג הובלה*</label>
                         <select id="order-delivery-type" class="w-full p-2 border rounded-md text-sm bg-white" required>
                             <option value="">בחר...</option>
                             <option value="הובלת מנוף">מנוף</option>
                             <option value="הובלת משאית">משאית</option>
                             <option value="איסוף עצמי">איסוף</option>
                         </select>
                     </div>
                     <div>
                        <label for="order-warehouse" class="block text-sm font-medium mb-1">מחסן*</label>
                        <select id="order-warehouse" class="w-full p-2 border rounded-md text-sm bg-white" required>
                            <option value="">בחר...</option>
                            <option value="החרש">החרש</option>
                            <option value="התלמיד">התלמיד</option>
                        </select>
                     </div>
                 </div>
                <div><label for="order-notes" class="block text-sm font-medium mb-1">הערות</label><textarea id="order-notes" rows="3" placeholder="הערות להזמנה..." class="w-full p-2 border rounded-md text-sm"></textarea></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeNewOrderForm()">ביטול</button>
                <button type="submit" id="submit-order-btn" class="btn-primary">צור הזמנה</button>
            </div>
        </form>
    </dialog>

    <dialog id="customer-edit-modal" class="full-modal">
        <form onsubmit="handleSaveCustomer(event)">
            <input type="hidden" id="customer-edit-id">
            <div class="modal-header">
                <h3 id="customer-edit-title">עריכת לקוח</h3>
                <button type="button" onclick="closeCustomerEditModal()"><i data-feather="x"></i></button>
            </div>
            <div class="modal-content space-y-4">
                 <div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium mb-1">שם*</label><input type="text" id="customer-edit-name" class="w-full p-2 border rounded-md text-sm" required></div><div><label class="block text-sm font-medium mb-1">מס' לקוח</label><input type="text" id="customer-edit-number" class="w-full p-2 border rounded-md text-sm"></div></div>
                 <div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium mb-1">טלפון*</label><input type="tel" id="customer-edit-phone" class="w-full p-2 border rounded-md text-sm" required></div><div><label class="block text-sm font-medium mb-1">איש קשר</label><input type="text" id="customer-edit-contact" class="w-full p-2 border rounded-md text-sm"></div></div>
                 <hr><h4 class="font-medium text-gray-700">כתובת ברירת מחדל*</h4>
                 <div class="grid grid-cols-3 gap-2">
                     <input type="text" id="customer-edit-street" placeholder="רחוב" class="w-full p-2 border rounded-md text-sm col-span-2" required>
                     <input type="text" id="customer-edit-streetnum" placeholder="מס'" class="w-full p-2 border rounded-md text-sm" required>
                 </div>
                 <input type="text" id="customer-edit-city" placeholder="עיר" class="w-full p-2 border rounded-md text-sm" required>
                 <div><label class="block text-sm font-medium mb-1">קואורדינטות (lat, lon)</label><input type="text" id="customer-edit-coords" placeholder="הדבק מ-Google Maps (אופציונלי)" class="w-full p-2 border rounded-md text-sm"><p class="text-xs text-gray-500 mt-1">למיקום מדויק בהזמנות</p></div>
                 <div class="mt-4 border-t pt-3"><h4 class="text-sm font-medium text-gray-600 mb-1">היסטוריית שינויים</h4><ul id="customer-audit-log" class="text-xs text-gray-500 space-y-1 max-h-20 overflow-y-auto bg-gray-50 p-2 rounded border"></ul></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeCustomerEditModal()">ביטול</button>
                <button type="submit" id="customer-save-btn" class="btn-primary">שמור שינויים</button>
            </div>
        </form>
    </dialog>

     <dialog id="ping-modal">
        <div class="details-modal-handle" style="background-color: #9ca3af;"></div>
        <h3 class="text-lg font-semibold p-4 pb-2 text-center">בחר הודעת התראה</h3>
        <div id="ping-options-list">
            </div>
        <div class="ping-option font-medium" onclick="selectPingOption('custom')">
            <i data-feather="edit-3" class="inline-block w-4 h-4 ml-2"></i>הודעה מותאמת אישית...
        </div>
         <div id="ping-modal-footer">
             <button type="button" class="text-sm text-gray-600 hover:text-gray-800" onclick="closePingOptionsModal()">ביטול</button>
         </div>
    </dialog>


    <div id="toast-container"></div>

    <script type="module">
        // --- Import from Shared Module ---
        import {
            db, auth, authReadyPromise, functions, SmartLog, showToast,
            collection, doc, onSnapshot, query, orderBy, addDoc, updateDoc,
            serverTimestamp, deleteDoc, arrayUnion, where, getDocs, setDoc, limit, getDoc,
            Timestamp
        } from '../shared/firebase-init.js'; // V33: Changed to relative path

        // --- Import from Map Utils ---
        import {
            driverIconActive, driverIconStuck, orderIconNew, geocodeAddress
        } from '../shared/map-utils.js'; // V33: Import map utils

        // --- State, Config, ---
        const ISRAEL_CENTER = [32.0853, 34.7818];
        const WAREHOUSE_LOCATIONS = { "החרש": [32.13266165049073, 34.898196599998755], "התלמיד": [32.16303427408473, 34.894926705310006] };
        const ALLOWED_STATUSES = ["חדש", "שויך", "בדרך", "הושלם", "בוטל"];
        let state = { orders: [], drivers: [], liveLocations: {}, customers: [] };
        let map; let driverMarkers = {}; let orderMarkers = {};
        let currentDetailsItem = null;
        let customerSearchTimeout = null;

        // V33: Icons are now imported, no local definitions needed.

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            try { feather.replace(); } catch(e) {}
            initializeApplication();
            const orderDateInput = document.getElementById('order-date');
            if(orderDateInput) orderDateInput.value = new Date().toISOString().split('T')[0];
        });

        async function initializeApplication() {
            SmartLog.info("v33.1 (Canonical Admin): Initializing...", "Init");
            showLoader('map-loader', true);
            showLoader('orders-list', true);
            showLoader('drivers-list', true);
            try {
                initMap();
                await authReadyPromise;
                SmartLog.info(`Auth successful.`, "Init.Auth");
                listenToDrivers(); listenToOrders(); listenToLocations(); listenToCustomers();
                document.getElementById('history-filter-btn')?.addEventListener('click', renderHistoryTable);
                showView('dashboard');
            } catch (error) {
                SmartLog.error(error, "Init.Critical"); showToast(`שגיאת אתחול: ${error.message}`, 'error');
            } finally {
                 showLoader('map-loader', false);
                 // Loaders for lists are hidden by render functions
            }
        }

        // --- MAP ---
        function initMap() {
            try {
                if (map) map.remove();
                map = L.map('map', { zoomControl: false }).setView(ISRAEL_CENTER, 9); // Disable zoom control for mobile
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OSM' }).addTo(map);
                L.control.zoom({ position: 'bottomleft' }).addTo(map); // Add zoom to bottom left
                SmartLog.info("Map initialized", "Init.Map");
            } catch (error) {
                SmartLog.error(error, "Init.Map");
                document.getElementById('map').innerHTML = `<div class="p-4 text-center text-red-500">שגיאת מפה</div>`;
            }
        }

        // --- FIRESTORE LISTENERS ---
        function listenToDrivers() {
            const q = query(collection(db, "drivers"), orderBy("name"));
            onSnapshot(q, (snapshot) => {
                state.drivers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderDrivers(); 
                renderMapMarkers();
            }, e => SmartLog.error(e, "Firestore.Drivers"));
        }
        function listenToOrders() {
            // V33.1: Listen to orders from the last 7 days + all non-completed
            // This is an optimization, but for now we keep the full listener
            const q = query(collection(db, "orders"), orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                state.orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderOrders(); 
                renderMapMarkers(); 
                if (document.getElementById('view-history').classList.contains('active')) {
                    renderHistoryTable(); // Re-render history if visible
                }
            }, e => SmartLog.error(e, "Firestore.Orders"));
        }
        function listenToLocations() {
             const q = query(collection(db, "driverLocations"));
             onSnapshot(q, (snapshot) => {
                const newLocations = {}; 
                snapshot.forEach(doc => { newLocations[doc.id] = { id: doc.id, ...doc.data() }; });
                state.liveLocations = newLocations; 
                renderDrivers(); 
                renderMapMarkers();
             }, e => SmartLog.error(e, "Firestore.Locations"));
        }
        function listenToCustomers() {
             const q = query(collection(db, "customers"), orderBy("name"));
             onSnapshot(q, (snapshot) => {
                state.customers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // No need to populate datalist if using dynamic search
                if (document.getElementById('view-history').classList.contains('active')) {
                     renderCustomerTable(); // Re-render customers if visible
                }
             }, e => SmartLog.error(e, "Firestore.Customers"));
        }

        // --- RENDER FUNCTIONS ---
        function renderDrivers() {
            const list = document.getElementById('drivers-list'); if (!list) return;
            const hasData = state.drivers.length > 0;
            showLoader('drivers-list', !hasData);
            if (!hasData) { list.innerHTML = `<div class="p-4 text-center text-gray-500 text-sm">אין נהגים פעילים כעת.</div>`; return; }
            
            const fragment = document.createDocumentFragment();
            state.drivers.forEach(driver => {
                const location = state.liveLocations[driver.id];
                const assigned = state.orders.filter(o => o.driver?.id === driver.id && !['הושלם', 'בוטל'].includes(o.status)).length;
                fragment.appendChild(createDriverCard(driver, location, assigned));
            });
            list.innerHTML = ''; list.appendChild(fragment);
            filterLists();
        }

        function createDriverCard(driver, location, assignedCount) {
            const el = document.createElement('div');
            el.className = 'driver-card cursor-pointer p-3 border-b border-gray-200'; // Use p-3
            el.id = `driver-card-${driver.id}`;
            el.setAttribute('data-search', driver.name?.toLowerCase() || '');
            el.onclick = () => openDetailsModal(driver.id, 'driver'); // Use openDetailsModal
            
            let statusClass = 'bg-gray-400'; let statusText = 'לא מחובר';
            if (location) {
                const minutesAgo = location.lastUpdate?.toDate ? Math.round((Date.now() - location.lastUpdate.toDate().getTime()) / 60000) : '?';
                statusClass = location.isStuck ? 'bg-red-500' : 'bg-green-500';
                statusText = location.isStuck ? `תקוע (${minutesAgo}')` : `פעיל (${minutesAgo}')`;
            }
            el.innerHTML = `
                <div class="flex justify-between items-center">
                    <span class="font-semibold text-sm">${driver.name}</span>
                    <div class="flex items-center space-x-1.5 space-x-reverse">
                        <span class="text-xs font-medium text-gray-600">${statusText}</span>
                        <span class="status-dot ${statusClass}" style="width:8px; height:8px; border-radius: 50%;"></span>
                    </div>
                </div>
                <div class="text-xs text-gray-500 flex justify-between items-center mt-0.5">
                    <span>${driver.vehicleType || '?'} | ${driver.phone}</span>
                    <span class="text-xs font-medium text-blue-600">${assignedCount} משויכות</span>
                </div>`;
            return el;
        }

        function renderOrders() {
            const list = document.getElementById('orders-list'); if (!list) return;
            const unassignedOrders = state.orders.filter(o => o.status === 'חדש');
            const hasData = unassignedOrders.length > 0;
            showLoader('orders-list', !hasData && state.orders.length > 0); // Show loader if no *new* orders but orders *exist*
            
            if (!hasData) {
                list.innerHTML = `<div class="p-4 text-center text-gray-500 text-sm">אין הזמנות חדשות לשיבוץ.</div>`;
                return;
            }
            
            const fragment = document.createDocumentFragment();
            unassignedOrders.sort((a,b)=>(a.createdAt?.toMillis()||0)-(b.createdAt?.toMillis()||0))
                           .forEach(order => fragment.appendChild(createOrderCard(order)));
            list.innerHTML = ''; list.appendChild(fragment);
            filterLists();
            try { feather.replace({ width: '14px', height: '14px' }); } catch(e){}
        }

        function createOrderCard(order) {
            const el = document.createElement('div');
            let cardClasses = 'order-card p-3 cursor-pointer border-b border-gray-200';
            let urgencyIcon = '';
            let timeText = '';

            // Urgency logic
            if (order.orderDate) {
                try {
                    const now = new Date();
                    const today = now.toISOString().split('T')[0];
                    let deliveryDateTimeStr = order.orderDate;
                    if (order.deliveryTime) {
                        deliveryDateTimeStr += `T${order.deliveryTime}`;
                        timeText = ` (${order.deliveryTime})`;
                    } else {
                        deliveryDateTimeStr += `T00:00:00`; // Default to start of day if no time
                    }
                    
                    const deliveryDateTime = new Date(deliveryDateTimeStr);

                    if (order.orderDate === today) {
                        const timeDiffMinutes = (deliveryDateTime.getTime() - now.getTime()) / (1000 * 60);
                        if (order.deliveryTime) { // Only show urgency if time is specified
                            if (timeDiffMinutes < 0) {
                                cardClasses += ' border-l-4 border-red-500 bg-red-50';
                                urgencyIcon = '<i data-feather="alert-triangle" class="w-3 h-3 text-red-600 ml-1"></i>';
                            } else if (timeDiffMinutes < 60) {
                                cardClasses += ' border-l-4 border-yellow-500 bg-yellow-50';
                                urgencyIcon = '<i data-feather="clock" class="w-3 h-3 text-yellow-600 ml-1"></i>';
                            }
                        }
                    } else if (deliveryDateTime < now) {
                         cardClasses += ' border-l-4 border-gray-400 bg-gray-50 opacity-80'; // Past date
                         urgencyIcon = '<i data-feather="calendar" class="w-3 h-3 text-gray-500 ml-1"></i>';
                    }
                } catch (e) { console.warn("Error parsing date/time for urgency", e); }
            }

            el.className = cardClasses;
            el.id = `order-card-${order.id}`;
            el.setAttribute('data-search', `${order.orderNumber || order.id} ${order.customer?.name?.toLowerCase()} ${order.address?.toLowerCase()}`);
            el.onclick = () => openDetailsModal(order.id, 'order');

            const orderDateFormatted = order.orderDate ? new Date(order.orderDate).toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit', year: '2-digit' }) : 'N/A';
            const customerName = order.customer?.name || 'לקוח לא ידוע';
            const address = order.address || 'כתובת לא צוינה';
            const createdTime = order.createdAt?.toDate ? order.createdAt.toDate().toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' }) : '';
            const displayId = order.orderNumber || `#${order.id.slice(-6)}`;

            el.innerHTML = `
                <div class="flex justify-between items-center mb-1">
                    <span class="font-bold text-blue-600 text-sm">${displayId}</span>
                    <span class="text-xs font-semibold text-gray-700 flex items-center">
                        ${urgencyIcon}${orderDateFormatted}${timeText}
                    </span>
                </div>
                <div class="font-semibold text-gray-800 text-sm">${customerName}</div>
                <div class="text-xs text-gray-600 truncate">${address}</div>
                <div class="text-xs text-gray-500 mt-1 flex justify-between">
                    <span>${order.deliveryType || ''} | ${order.warehouse || ''}</span>
                    <span title="זמן יצירה">נוצר: ${createdTime}</span>
                </div>`;
            return el;
        }

        function renderMapMarkers() {
            if (!map) return;
            const bounds = L.latLngBounds();
            let activeMarkersExist = false;

            // Drivers
            Object.values(state.liveLocations).forEach(loc => {
                if (!loc.latitude) return;
                const driverData = state.drivers.find(d => d.id === loc.id);
                const name = driverData?.name || loc.id.slice(-6);
                const latLng = [loc.latitude, loc.longitude];
                const icon = loc.isStuck ? driverIconStuck : driverIconActive; // Imported icon
                const minutesAgo = loc.lastUpdate?.toDate ? Math.round((Date.now() - loc.lastUpdate.toDate().getTime()) / 60000) : '?';
                const popup = `<h4>${name}</h4><p>${loc.isStuck ? 'תקוע' : 'פעיל'} (${minutesAgo} דק')</p>`;
                
                if (driverMarkers[loc.id]) {
                    driverMarkers[loc.id].setLatLng(latLng).setIcon(icon).setPopupContent(popup);
                } else {
                    driverMarkers[loc.id] = L.marker(latLng, { icon }).addTo(map).bindPopup(popup).on('click', () => openDetailsModal(loc.id, 'driver'));
                }
                if (!loc.isStuck) { bounds.extend(latLng); activeMarkersExist = true; }
            });
            Object.keys(driverMarkers).forEach(id => { if (!state.liveLocations[id]) { if (map.hasLayer(driverMarkers[id])) map.removeLayer(driverMarkers[id]); delete driverMarkers[id]; } });

            // Orders (New only)
            const unassignedOrders = state.orders.filter(o => o.status === 'חדש' && o.latitude);
            Object.keys(orderMarkers).forEach(id => { if (!unassignedOrders.some(o => o.id == id)) { if (map.hasLayer(orderMarkers[id])) map.removeLayer(orderMarkers[id]); delete orderMarkers[id]; } });
            
            unassignedOrders.forEach(order => {
                const latLng = [order.latitude, order.longitude];
                const popup = `<h4>${order.orderNumber || `#${order.id.slice(-6)}`}</h4><p>${order.customer?.name || '?'}</p><p>${order.address || '?'}</p><button class"mt-1 px-2 py-0.5 bg-blue-500 text-white text-xs rounded" onclick="openAssignDriverPrompt('${order.id}')">שייך נהג</button>`;
                
                if (orderMarkers[order.id]) {
                    orderMarkers[order.id].setLatLng(latLng).setPopupContent(popup);
                } else {
                    orderMarkers[order.id] = L.marker(latLng, { icon: orderIconNew }).addTo(map).bindPopup(popup).on('click', () => openDetailsModal(order.id, 'order')); // Imported icon
                }
                bounds.extend(latLng); activeMarkersExist = true;
            });

            if (activeMarkersExist && bounds.isValid()) {
                try { map.fitBounds(bounds, { padding: [40, 40], maxZoom: 15 }); } catch (e) {}
            } else if (!activeMarkersExist) {
                 map.setView(ISRAEL_CENTER, 9);
            }
        }

        function renderHistoryTable() {
            const list = document.getElementById('history-table-body');
            if (!list) return;

            const search = document.getElementById('history-search')?.value.toLowerCase() || '';
            const dateFrom = document.getElementById('history-date-from')?.value;
            const dateTo = document.getElementById('history-date-to')?.value;

            let filteredOrders = state.orders;

            if (search) {
                filteredOrders = filteredOrders.filter(o =>
                    (o.id.toLowerCase().includes(search)) ||
                    (o.orderNumber?.toLowerCase().includes(search)) ||
                    (o.customer?.name?.toLowerCase().includes(search)) ||
                    (o.driver?.name?.toLowerCase().includes(search)) ||
                    (o.address?.toLowerCase().includes(search))
                );
            }
            if (dateFrom) {
                const fromTs = new Date(dateFrom).getTime();
                filteredOrders = filteredOrders.filter(o => (o.orderDate ? new Date(o.orderDate).getTime() : (o.createdAt?.toDate ? o.createdAt.toDate().getTime() : 0)) >= fromTs);
            }
            if (dateTo) {
                const toTs = new Date(dateTo).setHours(23, 59, 59, 999);
                filteredOrders = filteredOrders.filter(o => (o.orderDate ? new Date(o.orderDate).getTime() : (o.createdAt?.toDate ? o.createdAt.toDate().getTime() : Infinity)) <= toTs);
            }

            filteredOrders.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));

            let html = '';
            if (filteredOrders.length === 0) {
                html = '<tr><td colspan="7" class="text-center p-8 text-gray-500">לא נמצאו הזמנות תואמות</td></tr>';
            } else {
                filteredOrders.forEach(order => {
                    const orderDateTime = order.orderDate
                        ? new Date(order.orderDate).toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit', year: 'numeric' }) + (order.deliveryTime ? ` ${order.deliveryTime}` : '')
                        : (order.createdAt?.toDate ? order.createdAt.toDate().toLocaleDateString('he-IL') : 'N/A');
                    const displayId = order.orderNumber || `#${order.id.slice(-6)}`;
                    html += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${displayId}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.customer?.name || '...'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.driver?.name || '---'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 truncate" title="${order.address || ''}">${order.address || '...'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.status || '...'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${orderDateTime}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                <button class="action-button" onclick="promptForStatusChange('${order.id}', '${order.status || 'חדש'}')">עדכן</button>
                                <button class="action-button action-button-secondary" onclick="copyCustomerLink('${order.id}')" title="העתק לינק ללקוח">
                                    <i data-feather="share-2" class="w-4 h-4"></i>
                                </button>
                            </td>
                        </tr>`;
                });
            }
            list.innerHTML = html;
            try { feather.replace({ width: '14px', height: '14px' }); } catch(e){}
        }

        function renderCustomerTable() {
            const list = document.getElementById('customer-table-body');
            if(!list) return;
            const search = document.getElementById('customer-search-input')?.value.toLowerCase() || '';
            let filteredCustomers = state.customers;
            if (search) {
                 filteredCustomers = filteredCustomers.filter(c =>
                    (c.name?.toLowerCase().includes(search)) ||
                    (c.phone?.includes(search)) ||
                    (c.customerNumber?.toLowerCase().includes(search)) ||
                    (c.defaultAddress?.toLowerCase().includes(search))
                 );
            }
            filteredCustomers.sort((a, b) => a.name?.localeCompare(b.name || '') || 0);
            let html = '';
            if (filteredCustomers.length === 0) {
                 html = '<tr><td colspan="4" class="text-center p-8 text-gray-500">לא נמצאו לקוחות תואמים</td></tr>';
            } else {
                 filteredCustomers.forEach(cust => {
                     html += `
                        <tr class="hover:bg-gray-50 cursor-pointer" onclick="openCustomerEditModal('${cust.id}')">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${cust.name || '---'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${cust.customerNumber || '---'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${cust.phone || '---'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 truncate" title="${cust.defaultAddress || ''}">${cust.defaultAddress || '---'}</td>
                        </tr>`;
                 });
            }
             list.innerHTML = html;
        }

        // --- UI INTERACTIONS ---
        function showView(viewName) {
            document.querySelectorAll('.app-view').forEach(v => v.classList.remove('active'));
            const viewEl = document.getElementById(`view-${viewName}`);
            if (viewEl) viewEl.classList.add('active');
            
            document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
            // Handle <a> tag for log
            const btnEl = document.querySelector(`.nav-button[onclick*="'${viewName}'"]`) || document.querySelector(`.nav-button[href*='${viewName}']`);
            if (btnEl) btnEl.classList.add('active');

            if (viewName === 'history') {
                showHistoryTab('orders'); // Default to orders
                renderHistoryTable(); // Initial render
                renderCustomerTable(); // Initial render
            }
            if (viewName === 'dashboard' && map) {
                setTimeout(() => map.invalidateSize(), 50);
            }
            SmartLog.info(`View switched: ${viewName}`, "UI.Nav");
        }
        window.showView = showView;

        function showHistoryTab(tabName) {
            const ordersContent = document.getElementById('history-orders-content');
            const customersContent = document.getElementById('history-customers-content');
            const ordersButton = document.querySelector('.history-tab-button[onclick*="orders"]');
            const customersButton = document.querySelector('.history-tab-button[onclick*="customers"]');
            if (!ordersContent || !customersContent || !ordersButton || !customersButton) return;

            ordersContent.style.display = (tabName === 'orders') ? 'block' : 'none';
            customersContent.style.display = (tabName === 'customers') ? 'block' : 'none';
            ordersButton.classList.toggle('active', tabName === 'orders');
            customersButton.classList.toggle('active', tabName === 'customers');
        }
        window.showHistoryTab = showHistoryTab;

        function showPanelTab(tabName) {
            document.querySelectorAll('#dashboard-lists .panel-list').forEach(p => p.classList.remove('active'));
            const listEl = document.getElementById(tabName + '-list');
            if (listEl) listEl.classList.add('active');
            document.querySelectorAll('.dash-tab-button').forEach(b => b.classList.remove('active'));
            const btnEl = document.getElementById('tab-' + tabName);
            if (btnEl) btnEl.classList.add('active');
            filterLists();
        }
        window.showPanelTab = showPanelTab;

        function filterLists() {
            const query = document.getElementById('search-input')?.value.toLowerCase() || '';
            const activeList = document.querySelector('#dashboard-lists .panel-list.active');
            if (!activeList) return;
            activeList.querySelectorAll('.order-card, .driver-card').forEach(card => {
                const searchData = card.getAttribute('data-search') || '';
                card.style.display = searchData.includes(query) ? 'block' : 'none';
            });
        }
        window.filterLists = filterLists;

        // --- DETAILS MODAL ---
        function renderDetailsModalContent(id, type) {
            const detailsEl = document.getElementById('details-modal-body');
            const titleEl = document.getElementById('details-modal-title');
            const copyBtn = document.getElementById('details-copy-link-btn');
            const whatsappBtn = document.getElementById('details-whatsapp-btn');
            if (!detailsEl || !titleEl || !copyBtn || !whatsappBtn) return;

            detailsEl.innerHTML = '<div class="flex justify-center p-4"><div class="loader"></div></div>';
            copyBtn.classList.add('hidden');
            whatsappBtn.classList.add('hidden');
            currentDetailsItem = { id, type };

            let html = '';
            if (type === 'driver') {
                const driver = state.drivers.find(d => d.id === id);
                if (!driver) { detailsEl.innerHTML = 'נהג לא נמצא'; return; }
                const location = state.liveLocations[id];
                const assignedOrders = state.orders.filter(o => o.driver?.id === id && !['הושלם', 'בוטל'].includes(o.status));
                const minutesAgo = location?.lastUpdate?.toDate ? Math.round((Date.now() - location.lastUpdate.toDate().getTime()) / 60000) : '?';

                titleEl.textContent = driver.name;
                html = `<ul><li><strong>טלפון:</strong> ${driver.phone || '?'}</li><li><strong>רכב:</strong> ${driver.vehicleType || '?'}</li><li><strong>סטטוס:</strong> ${location ? (location.isStuck ? 'תקוע' : `פעיל (${minutesAgo} דק')`) : 'לא מחובר'}</li></ul>
                        <h4 class="sub-header">הזמנות משויכות (${assignedOrders.length})</h4><ul>`;
                html += assignedOrders.length > 0 ? assignedOrders.map(o => `<li>${o.orderNumber || `#${o.id.slice(-6)}`} - ${o.customer?.name || '...'} (${o.status})</li>`).join('') : `<li>אין הזמנות משויכות</li>`;
                html += `</ul>`;
                
            } else if (type === 'order') {
                const order = state.orders.find(o => o.id === id);
                if (!order) { detailsEl.innerHTML = 'הזמנה לא נמצאה'; return; }
                const displayId = order.orderNumber || `#${order.id.slice(-6)}`;
                const currentStatus = order.status || 'חדש';
                const orderDateFormatted = order.orderDate ? new Date(order.orderDate).toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit', year: 'numeric' }) : 'N/A';
                const deliveryTime = order.deliveryTime ? `בשעה ${order.deliveryTime}` : '(לא צוינה שעה)';

                titleEl.textContent = `הזמנה ${displayId}`;
                copyBtn.classList.remove('hidden');
                if (order.driver?.id && ['שויך', 'בדרך'].includes(currentStatus)) {
                     whatsappBtn.classList.remove('hidden');
                 }

                html = `<ul>
                            <li><strong>לקוח:</strong> ${order.customer?.name || '?'}</li>
                            <li><strong>טלפון:</strong> ${order.customer?.phone || '?'}</li>
                            <li><strong>כתובת:</strong> ${order.address || '?'}</li>
                            <li><strong>תאריך אספקה:</strong> ${orderDateFormatted} ${deliveryTime}</li>
                            <li class="status-line"><strong>סטטוס:</strong> ${currentStatus} ${order.driver?.name ? `(${order.driver.name})` : ''} <button class="status-change-btn" onclick="promptForStatusChange('${order.id}', '${currentStatus}')">[שנה]</button></li>
                            <li><strong>סוג:</strong> ${order.deliveryType || '?'} | <strong>מחסן:</strong> ${order.warehouse || '?'}</li>
                        </ul>`;

                if (order.latitude && order.longitude) {
                    const orderLatLng = L.latLng(order.latitude, order.longitude);
                    html += `<h4 class="sub-header">מרחק ממחסנים</h4><ul>`;
                    Object.entries(WAREHOUSE_LOCATIONS).forEach(([name, coords]) => { if (Array.isArray(coords)) { try { const dist = orderLatLng.distanceTo(L.latLng(coords)); html += `<li><span class="dist">${(dist / 1000).toFixed(1)} ק"מ</span> - ${name}</li>`; } catch (e) {} } }); html += `</ul>`;
                    
                    const activeDrivers = state.drivers.filter(d => state.liveLocations[d.id] && !state.liveLocations[d.id].isStuck).map(driver => { 
                        const loc = state.liveLocations[driver.id]; 
                        if (!loc?.latitude) return null; 
                        try { 
                            const dist = orderLatLng.distanceTo(L.latLng(loc.latitude, loc.longitude)); 
                            return { id: driver.id, name: driver.name, dist }; 
                        } catch (e) { return null; } 
                    }).filter(d => d).sort((a, b) => a.dist - b.dist);
                    
                    html += `<h4 class="sub-header">נהגים זמינים (${activeDrivers.length})</h4><ul>`;
                    html += activeDrivers.length > 0 ? activeDrivers.map(d => `<li><span class="dist">${(d.dist / 1000).toFixed(1)} ק"מ</span> - ${d.name} <button class="status-change-btn" onclick="assignOrderToDriver('${order.id}', '${d.id}')">[שייך]</button></li>`).join('') : `<li>אין נהגים זמינים</li>`; html += `</ul>`;
                }
                if (order.notes) {
                     html += `<h4 class="sub-header">הערות</h4><p class="text-sm bg-gray-50 p-2 rounded border">${order.notes}</p>`;
                }
            }

            detailsEl.innerHTML = html;
            try { feather.replace({ width: '16px', height: '16px' }); } catch(e){}
        }

        function openDetailsModal(id, type) {
            // Highlight card
            document.querySelectorAll('.driver-card, .order-card').forEach(c => c.classList.remove('active'));
            const card = document.getElementById(`${type}-card-${id}`);
            if (card) card.classList.add('active');

            const modal = document.getElementById('details-modal');
            renderDetailsModalContent(id, type); // Load content
            if (modal) modal.showModal();
        }

        async function assignOrderToDriver(orderId, driverId) {
            const driverData = state.drivers.find(d => d.id == driverId);
            if (!driverData) { showToast('Driver data error', 'error'); return; }
            
            const orderRef = doc(db, "orders", orderId);
            const orderData = state.orders.find(o => o.id === orderId);
            const displayId = orderData?.orderNumber || `#${orderId.slice(-6)}`;
            
            SmartLog.info(`Assigning order ${orderId} to ${driverId}`, "CRUD.Assign");
            try {
                await updateDoc(orderRef, { 
                    status: "שויך", 
                    driver: { id: driverData.id, name: driverData.name }, 
                    lastModified: serverTimestamp() 
                });
                showToast(`הזמנה ${displayId} שויכה ל-${driverData.name}`, 'success');
                
                // Re-render details modal if it's open for this order
                if (currentDetailsItem && currentDetailsItem.id === orderId) {
                    renderDetailsModalContent(orderId, 'order');
                }
            } catch (error) { 
                SmartLog.error(error, "CRUD.Assign", { orderId, driverId }); 
                showToast(`שגיאה בשיוך: ${error.message}`, 'error'); 
            }
        }
        window.assignOrderToDriver = assignOrderToDriver; // Expose for button click

        function promptForStatusChange(orderId, currentStatus) {
            const order = state.orders.find(o => o.id === orderId);
            const displayId = order?.orderNumber || `#${orderId.slice(-6)}`;
            const promptMessage = `הזמנה ${displayId}\nסטטוס: ${currentStatus}\n\nסטטוס חדש (${ALLOWED_STATUSES.join('/')}):`;
            const newStatus = prompt(promptMessage);
            
            if (newStatus === null) return; // User cancelled
            const trimmedStatus = newStatus.trim();
            
            if (ALLOWED_STATUSES.includes(trimmedStatus)) {
                if (trimmedStatus === currentStatus) {
                    showToast('הסטטוס זהה', 'info');
                } else {
                    updateOrderStatus(orderId, trimmedStatus);
                }
            } else {
                showToast(`סטטוס לא תקין: "${trimmedStatus}"`, 'error');
            }
        }
        window.promptForStatusChange = promptForStatusChange;

        async function updateOrderStatus(orderId, newStatus) {
             const orderRef = doc(db, "orders", orderId);
             const order = state.orders.find(o => o.id === orderId);
             const displayId = order?.orderNumber || `#${orderId.slice(-6)}`;
             SmartLog.info(`Updating status: ${orderId} to ${newStatus}`, "CRUD.StatusUpdate");
             
             try {
                const updates = { 
                    status: newStatus, 
                    lastModified: serverTimestamp() 
                };
                
                // If status is 'הושלם' or 'בוטל', remove driver association
                if (newStatus === 'הושלם' || newStatus === 'בוטל') {
                    updates.driver = null; // Or use deleteField() if preferred
                }

                await updateDoc(orderRef, updates);
                showToast(`סטטוס הזמנה ${displayId} עודכן ל: ${newStatus}`, 'success');
                SmartLog.info(`Order ${orderId} status updated OK`, "CRUD.StatusUpdate");
                
                // Re-render details modal if open
                if (currentDetailsItem && currentDetailsItem.id === orderId) {
                    renderDetailsModalContent(orderId, 'order');
                }
             } catch (error) { 
                 showToast(`שגיאה בעדכון: ${error.message}`, 'error'); 
                 SmartLog.error(error, "CRUD.StatusUpdate", { orderId, newStatus }); 
             }
        }

        // --- NEW ORDER FORM ---
        function openNewOrderForm() {
            document.getElementById('new-order-modal')?.showModal();
            try{feather.replace();}catch(e){}
        }
        window.openNewOrderForm = openNewOrderForm;
        
        function closeNewOrderForm() {
             document.getElementById('new-order-modal')?.close();
             const form = document.getElementById('new-order-modal')?.querySelector('form');
             if (form) form.reset();
             const dateInput = document.getElementById('order-date');
             if(dateInput) dateInput.value = new Date().toISOString().split('T')[0];
             clearCustomerSelection();
             document.getElementById('customer-suggestions').innerHTML = '';
             document.getElementById('customer-suggestions').classList.add('hidden');
        }
        window.closeNewOrderForm = closeNewOrderForm;

        function handleCustomerSearch(value) {
            clearTimeout(customerSearchTimeout);
            const suggestionsEl = document.getElementById('customer-suggestions');
            const newFields = document.getElementById('new-customer-fields');
            const existDisp = document.getElementById('existing-customer-display');
            if (!suggestionsEl || !newFields || !existDisp) return;

            const searchTerm = value.trim().toLowerCase();
            suggestionsEl.innerHTML = '';

            if (searchTerm.length < 1) {
                suggestionsEl.classList.add('hidden');
                if (document.getElementById('customer-id-existing').value === '') {
                     newFields.style.display = 'none';
                     existDisp.style.display = 'none';
                }
                return;
            }

            customerSearchTimeout = setTimeout(() => {
                const matches = state.customers.filter(cust =>
                    (cust.name && cust.name.toLowerCase().includes(searchTerm)) ||
                    (cust.customerNumber && cust.customerNumber.includes(searchTerm)) ||
                    (cust.phone && cust.phone.includes(searchTerm))
                ).slice(0, 5);

                if (matches.length > 0) {
                    matches.forEach(cust => {
                        const item = document.createElement('div');
                        item.className = 'suggestion-item';
                        item.innerHTML = `${cust.name} ${cust.customerNumber ? `(${cust.customerNumber})` : ''} <small class="block">${cust.phone || ''} - ${cust.defaultAddress || ''}</small>`;
                        item.onmousedown = () => selectExistingCustomer(cust.id); // Use onmousedown to fire before blur
                        suggestionsEl.appendChild(item);
                    });
                    suggestionsEl.classList.remove('hidden');
                    newFields.style.display = 'none';
                    existDisp.style.display = 'none';
                } else {
                    suggestionsEl.classList.add('hidden');
                    existDisp.style.display = 'none';
                    newFields.style.display = 'block';
                    document.getElementById('customer-name-new').value = value;
                    ['customer-phone-new', 'customer-street-new', 'customer-streetnum-new', 'customer-city-new', 'customer-contact-new', 'customer-number-new'].forEach(id => { const el=document.getElementById(id); if(el) el.value=''; });
                }
            }, 300);
        }
        window.handleCustomerSearch = handleCustomerSearch;

        function selectExistingCustomer(customerId) {
            const customer = state.customers.find(c => c.id === customerId);
            if (!customer) return;
            
            document.getElementById('customer-search').value = customer.customerNumber ? `${customer.name} (${customer.customerNumber})` : customer.name;
            document.getElementById('existing-customer-display').style.display = 'block';
            document.getElementById('new-customer-fields').style.display = 'none';
            document.getElementById('customer-id-existing').value = customer.id;
            document.getElementById('customer-name-display').innerText = customer.name;
            document.getElementById('customer-number-display').innerText = customer.customerNumber ? `(${customer.customerNumber})` : '';
            document.getElementById('customer-address-display').innerText = customer.defaultAddress || 'N/A';
            document.getElementById('customer-phone-display').innerText = customer.phone || 'N/A';
            
            document.getElementById('customer-suggestions').innerHTML = '';
            document.getElementById('customer-suggestions').classList.add('hidden');
        }

        function clearCustomerSelection() {
            document.getElementById('customer-search').value = '';
            document.getElementById('existing-customer-display').style.display = 'none';
            document.getElementById('new-customer-fields').style.display = 'none';
            document.getElementById('customer-id-existing').value = '';
            document.getElementById('customer-suggestions').innerHTML = '';
            document.getElementById('customer-suggestions').classList.add('hidden');
        }
        window.clearCustomerSelection = clearCustomerSelection;

        async function submitNewOrder(event) {
            event.preventDefault();
            const btn = document.getElementById('submit-order-btn');
            if (!btn) return;
            btn.disabled = true; btn.innerText = 'מעבד...';

            let customerRefId = null, customerName = '', customerPhone = '', customerAddress = '';
            let customerDataForOrder = {}; let useCustomerCoords = false; let customerCustomCoords = null; let isNewCustomer = false;

            try {
                // Determine customer
                const newFields = document.getElementById('new-customer-fields');
                const existDisp = document.getElementById('existing-customer-display');
                const existingId = document.getElementById('customer-id-existing').value;

                isNewCustomer = newFields.style.display === 'block' && !existingId;

                if (isNewCustomer) {
                    const name = document.getElementById('customer-name-new').value.trim();
                    const phone = document.getElementById('customer-phone-new').value.trim();
                    const street = document.getElementById('customer-street-new').value.trim();
                    const number = document.getElementById('customer-streetnum-new').value.trim();
                    const city = document.getElementById('customer-city-new').value.trim();
                    if (!name || !phone || !street || !number || !city) throw new Error("שם, טלפון וכתובת מלאה חובה ללקוח חדש.");
                    customerAddress = `${street} ${number}, ${city}`;
                    const newCustomerData = { 
                        name, phone, defaultAddress: customerAddress, 
                        addressStreet: street, addressNumber: number, addressCity: city, 
                        contactPerson: document.getElementById('customer-contact-new').value.trim(), 
                        customerNumber: document.getElementById('customer-number-new').value.trim() || null, 
                        auditLog: [{ timestamp: serverTimestamp(), action: "Created", by: "AdminForm" }] // Use serverTimestamp
                    };
                    const customerDocRef = await addDoc(collection(db, "customers"), newCustomerData);
                    customerRefId = customerDocRef.id; customerName = name; customerPhone = phone;
                    customerDataForOrder = { id: customerRefId, name, phone };
                    SmartLog.info("Created new customer", "CRUD.Customer", { id: customerRefId });
                } else if (existingId) {
                    customerRefId = existingId;
                    const customer = state.customers.find(c => c.id == customerRefId);
                    if (!customer) throw new Error("Selected customer not found.");
                    customerName = customer.name; customerPhone = customer.phone; customerAddress = customer.defaultAddress;
                    customerDataForOrder = { id: customerRefId, name: customerName, phone: customerPhone };
                    if (customer.customLat && customer.customLon) { 
                        useCustomerCoords = true; 
                        customerCustomCoords = [customer.customLat, customer.customLon]; 
                        SmartLog.info("Using custom coords", "CRUD.Order", { customerId: customerRefId }); 
                    }
                } else {
                    throw new Error('יש לבחור או ליצור לקוח');
                }

                btn.innerText = 'מאתר כתובת...';
                let finalCoords;
                if (useCustomerCoords) {
                    finalCoords = customerCustomCoords;
                } else {
                    const coords = await geocodeAddress(customerAddress);
                    const selectedWarehouse = document.getElementById('order-warehouse').value;
                    const warehouseCoords = WAREHOUSE_LOCATIONS[selectedWarehouse] || ISRAEL_CENTER;
                    finalCoords = coords || warehouseCoords; // Fallback to warehouse
                    if (!coords) showToast('כתובת לא אותרה, מוצג במיקום מחסן', 'warn');
                }

                btn.innerText = 'יוצר הזמנה...';
                const newOrder = {
                    customer: customerDataForOrder,
                    address: customerAddress,
                    orderNumber: document.getElementById('order-number').value.trim() || null,
                    orderDate: document.getElementById('order-date').value,
                    deliveryTime: document.getElementById('order-time').value || null,
                    deliveryType: document.getElementById('order-delivery-type').value,
                    warehouse: document.getElementById('order-warehouse').value,
                    notes: document.getElementById('order-notes').value.trim(),
                    latitude: finalCoords[0],
                    longitude: finalCoords[1],
                    status: "חדש",
                    createdAt: serverTimestamp(),
                    lastModified: serverTimestamp()
                };
                
                if (!newOrder.orderDate || !newOrder.deliveryType || !newOrder.warehouse) {
                    throw new Error("תאריך, סוג הובלה ומחסן הם שדות חובה.");
                }

                const orderDocRef = await addDoc(collection(db, "orders"), newOrder);
                const displayId = newOrder.orderNumber || `#${orderDocRef.id.slice(-6)}`;
                showToast(`הזמנה ${displayId} נוצרה`, 'success');
                closeNewOrderForm();
                SmartLog.info("Order created", "CRUD.Order", { id: orderDocRef.id, orderNumber: newOrder.orderNumber });

            } catch (error) { 
                showToast(`שגיאה: ${error.message}`, 'error'); 
                SmartLog.error(error, "CRUD.Order.Create"); 
            } finally { 
                btn.disabled = false; btn.innerText = 'צור הזמנה'; 
            }
        }

        // --- CUSTOMER EDIT MODAL ---
        function openCustomerEditModal(customerId) {
            const customer = state.customers.find(c => c.id === customerId);
            if (!customer) { showToast('לקוח לא נמצא', 'error'); return; }
            
            const modal = document.getElementById('customer-edit-modal');
            if (!modal) return;

            document.getElementById('customer-edit-id').value = customer.id;
            document.getElementById('customer-edit-title').innerText = `עריכת: ${customer.name}`;
            document.getElementById('customer-edit-name').value = customer.name || '';
            document.getElementById('customer-edit-number').value = customer.customerNumber || '';
            document.getElementById('customer-edit-phone').value = customer.phone || '';
            document.getElementById('customer-edit-contact').value = customer.contactPerson || '';
            document.getElementById('customer-edit-street').value = customer.addressStreet || '';
            document.getElementById('customer-edit-streetnum').value = customer.addressNumber || '';
            document.getElementById('customer-edit-city').value = customer.addressCity || '';
            document.getElementById('customer-edit-coords').value = (customer.customLat && customer.customLon) ? `${customer.customLat}, ${customer.customLon}` : '';

            // Audit Log
            const logList = document.getElementById('customer-audit-log');
            if (logList) {
                if (customer.auditLog && Array.isArray(customer.auditLog) && customer.auditLog.length > 0) {
                     logList.innerHTML = customer.auditLog
                        .filter(log => log.timestamp)
                        .sort((a, b) => (b.timestamp.toMillis ? b.timestamp.toMillis() : b.timestamp) - (a.timestamp.toMillis ? a.timestamp.toMillis() : a.timestamp))
                        .slice(0, 5) // Show last 5
                        .map(log => {
                            const time = (log.timestamp.toDate ? log.timestamp.toDate() : new Date(log.timestamp)).toLocaleString('he-IL', { dateStyle: 'short', timeStyle: 'short' });
                            let changes = log.action === "Created" ? "נוצר" : (log.changes ? Object.keys(log.changes).join(', ') : 'עודכן');
                            if (changes.length > 50) changes = changes.substring(0, 50) + '...';
                            return `<li>${time}: ${changes}</li>`;
                        }).join('');
                } else {
                    logList.innerHTML = '<li>אין היסטוריית שינויים</li>';
                }
            }
            
            modal.showModal();
            try { feather.replace(); } catch(e){}
         }
         window.openCustomerEditModal = openCustomerEditModal;

         function closeCustomerEditModal() { document.getElementById('customer-edit-modal')?.close(); }
         window.closeCustomerEditModal = closeCustomerEditModal;

         async function handleSaveCustomer(event) {
             event.preventDefault();
             const btn = document.getElementById('customer-save-btn');
             if (!btn) return;
             btn.disabled = true; btn.innerText = 'שומר...';
             
             const customerId = document.getElementById('customer-edit-id').value;
             const customerRef = doc(db, "customers", customerId);
             const originalCustomerData = state.customers.find(c => c.id === customerId);
             if (!originalCustomerData) { showToast('שגיאה: לקוח מקורי לא נמצא', 'error'); btn.disabled = false; btn.innerText = 'שמור'; return; }
             const originalAddress = originalCustomerData.defaultAddress || '';

             try {
                 const name = document.getElementById('customer-edit-name').value.trim();
                 const phone = document.getElementById('customer-edit-phone').value.trim();
                 const street = document.getElementById('customer-edit-street').value.trim();
                 const number = document.getElementById('customer-edit-streetnum').value.trim();
                 const city = document.getElementById('customer-edit-city').value.trim();
                 if (!name || !phone || !street || !number || !city) throw new Error("שם, טלפון וכתובת מלאה חובה.");
                 const fullAddress = `${street} ${number}, ${city}`;

                 let customLat = null, customLon = null, newCoords = null;
                 const coordsString = document.getElementById('customer-edit-coords').value.trim();
                 if (coordsString) {
                     const parts = coordsString.split(',');
                     if (parts.length === 2 && !isNaN(parseFloat(parts[0])) && !isNaN(parseFloat(parts[1]))) {
                         customLat = parseFloat(parts[0]); customLon = parseFloat(parts[1]);
                         newCoords = [customLat, customLon];
                     } else {
                         throw new Error("פורמט קואורדינטות לא תקין (lat, lon)");
                     }
                 }

                 const updatedData = { 
                     name, phone, 
                     defaultAddress: fullAddress, 
                     addressStreet: street, addressNumber: number, addressCity: city, 
                     customLat, customLon, 
                     customerNumber: document.getElementById('customer-edit-number').value.trim() || null, 
                     contactPerson: document.getElementById('customer-edit-contact').value.trim() || null 
                 };
                 
                 const changes = {}; 
                 let hasChanges = false, addressChanged = false;
                 
                 for (const key in updatedData) {
                     if ((updatedData[key] ?? null) !== (originalCustomerData[key] ?? null)) {
                         changes[key] = { from: originalCustomerData[key] ?? null, to: updatedData[key] };
                         hasChanges = true;
                         if (['defaultAddress', 'addressStreet', 'addressNumber', 'addressCity'].includes(key)) {
                             addressChanged = true;
                         }
                     }
                 }

                 if (addressChanged && !newCoords) { // Address changed but no custom coords provided
                     btn.innerText = 'מאתר כתובת...';
                     const geocodedCoords = await geocodeAddress(fullAddress); // Use imported function
                     if (geocodedCoords) {
                         newCoords = geocodedCoords;
                     } else {
                         showToast('אזהרה: לא ניתן לאתר קואורדינטות לכתובת החדשה', 'warn');
                     }
                     btn.innerText = 'שומר...';
                 }

                 if (hasChanges) {
                     const logEntry = { timestamp: serverTimestamp(), action: "Updated", changes, by: "AdminForm" };
                     await updateDoc(customerRef, { ...updatedData, auditLog: arrayUnion(logEntry) });
                     SmartLog.info("Customer updated", "CRUD.Customer", { id: customerId, changes: Object.keys(changes) });
                 } else {
                     SmartLog.info("No changes for customer", "CRUD.Customer", { id: customerId });
                 }

                 showToast('לקוח עודכן', 'success');
                 closeCustomerEditModal();

                 // If address changed AND we have new coords (either custom or geocoded)
                 if (addressChanged && newCoords) {
                     showToast('מעדכן הזמנות פעילות...', 'info');
                     // Find active orders for this customer with the *old* address
                     const ordersQuery = query(collection(db, "orders"), 
                         where("customer.id", "==", customerId), 
                         where("address", "==", originalAddress), 
                         where("status", "in", ["חדש", "שויך"])
                     );
                     try {
                         const ordersSnapshot = await getDocs(ordersQuery);
                         let updatedCount = 0;
                         const updatePromises = [];
                         ordersSnapshot.forEach((orderDoc) => {
                             SmartLog.info(`Updating order ${orderDoc.id} address`, "CRUD.Order.AddrUpdate", { customerId });
                             updatePromises.push(updateDoc(orderDoc.ref, { 
                                 address: fullAddress, 
                                 latitude: newCoords[0], 
                                 longitude: newCoords[1], 
                                 lastModified: serverTimestamp() 
                             }));
                             updatedCount++;
                         });
                         await Promise.all(updatePromises);
                         if (updatedCount > 0) showToast(`מיקום עודכן ב-${updatedCount} הזמנות פעילות`, 'success');
                         SmartLog.info(`Updated location for ${updatedCount} orders`, "CRUD.Order.AddrUpdate", { customerId });
                     } catch (orderUpdateError) { 
                         SmartLog.error(orderUpdateError, "CRUD.Order.AddrUpdate", { customerId }); 
                         showToast('שגיאה בעדכון הזמנות', 'error'); 
                     }
                 }

             } catch (error) { 
                 showToast(`שגיאה: ${error.message}`, 'error'); 
                 SmartLog.error(error, "CRUD.Customer.Update", { customerId }); 
             } finally { 
                 btn.disabled = false; btn.innerText = 'שמור שינויים'; 
             }
         }

        // --- HELPERS ---
        function showLoader(elementId, show) {
            const container = document.getElementById(elementId);
            if (!container) return;
            let loader = container.querySelector('.loader-container');
            if (show) {
                if (!loader) {
                    loader = document.createElement('div');
                    loader.className = 'loader-container';
                    loader.innerHTML = `<div class="loader"></div>`;
                    if (elementId !== 'map-loader') container.prepend(loader);
                    else container.style.display = 'flex';
                } else {
                    loader.style.display = 'flex';
                }
            } else {
                if (loader) loader.style.display = 'none';
                if (elementId === 'map-loader') container.style.display = 'none';
            }
        }
        
        function copyToClipboard(text) {
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text)
                    .then(() => showToast('לינק הועתק', 'success'))
                    .catch(err => showToast('העתקה נכשלה', 'error'));
            } else {
                // Fallback for insecure contexts
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed'; 
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    showToast('לינק הועתק (fallback)', 'success');
                } catch (err) {
                    showToast('העתקה נכשלה', 'error');
                }
                document.body.removeChild(textarea);
            }
        }

        function copyCustomerLink(orderId) {
             if (!orderId) return;
             const url = new URL(`./customer.html?id=${orderId}`, window.location.href).href;
             copyToClipboard(url);
        }
        window.copyCustomerLink = copyCustomerLink;

        // --- Global Ping (Enhanced) ---
        const PING_OPTIONS = [ "סידור העבודה למחר מוכן", "עדכון חשוב - נא לבדוק הודעות", "צפויים עיכובים היום", "בדיקת מערכת התראות" ];

        function openPingOptionsModal() {
            const modal = document.getElementById('ping-modal');
            const listEl = document.getElementById('ping-options-list');
            if (!modal || !listEl) return;
            listEl.innerHTML = '';
            PING_OPTIONS.forEach(option => {
                const btn = document.createElement('button');
                btn.className = 'ping-option';
                btn.textContent = option;
                btn.onclick = () => selectPingOption(option);
                listEl.appendChild(btn);
            });
            try{ feather.replace({ width: '16px', height: '16px'}); } catch(e){}
            modal.showModal();
        }
        window.openPingOptionsModal = openPingOptionsModal;

        function closePingOptionsModal() { document.getElementById('ping-modal')?.close(); }
        window.closePingOptionsModal = closePingOptionsModal;

        function selectPingOption(option) {
            closePingOptionsModal();
            if (option === 'custom') {
                const message = prompt("הזן הודעה מותאמת אישית:");
                if (message && message.trim() !== '') {
                    sendGlobalPing(message.trim());
                } else {
                    showToast('שליחת התראה בוטלה', 'info');
                }
            } else {
                sendGlobalPing(option);
            }
        }
        window.selectPingOption = selectPingOption;

        async function sendGlobalPing(message) {
             if (!message) return;
             SmartLog.info("Sending global ping...", "CRUD.Ping", { message });
             try {
                 await addDoc(collection(db, "globalPings"), { 
                     type: "MANAGER_BROADCAST", 
                     message: message, 
                     sender: "Admin", 
                     createdAt: serverTimestamp() 
                 });
                 showToast('התראה גלובלית נשלחה', 'success');
                 SmartLog.info("Global ping sent", "CRUD.Ping");
             } catch (error) { 
                 SmartLog.error(error, "CRUD.Ping", { message }); 
                 showToast('שגיאה בשליחת התראה', 'error'); 
             }
        }

         // --- WhatsApp ---
        function handleWhatsAppAction() {
            if (!currentDetailsItem || currentDetailsItem.type !== 'order') return;
            const order = state.orders.find(o => o.id === currentDetailsItem.id);
            if (!order || !order.driver?.id) return;

            const driver = state.drivers.find(d => d.id === order.driver.id);
            if (!driver?.phone) {
                showToast("מספר טלפון של הנהג לא זמין.", "warn");
                return;
            }
            // Basic URL, assumes Israeli number format if it doesn't start with +
            let cleanPhone = driver.phone.replace(/\D/g, '');
            if (cleanPhone.length === 9 && !cleanPhone.startsWith('972')) {
                 cleanPhone = `972${cleanPhone}`;
            } else if (cleanPhone.length === 10 && cleanPhone.startsWith('0')) {
                 cleanPhone = `972${cleanPhone.substring(1)}`;
            }

            const message = encodeURIComponent(`היי ${driver.name}, עדכון לגבי הזמנה ${order.orderNumber || `#${order.id.slice(-6)}`}: `);
            const whatsappUrl = `https://wa.me/${cleanPhone}?text=${message}`;
            window.open(whatsappUrl, '_blank');
            SmartLog.info("Opened WhatsApp link for driver", "Integration.WhatsApp", { orderId: order.id, driverId: driver.id });
        }
        window.handleWhatsAppAction = handleWhatsAppAction;

    </script>
     <script>
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
             window.addEventListener('load', () => {
                 navigator.serviceWorker.register('./sw.js') // Relative path
                     .then(reg => console.log('Admin SW registered:', reg.scope))
                     .catch(err => {
                          console.error('Admin SW registration failed:', err);
                          if (typeof showToast === 'function') {
                              showToast('שגיאה ברישום Service Worker', 'error');
                          }
                     });
             });
         }
    </script>
</body>
</html>
