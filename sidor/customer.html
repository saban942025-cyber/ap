<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מעקב משלוח - DeliveryMaster</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://unpkg.com/feather-icons"></script>

    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* CSS remains the same as v1.0 */
        body { font-family: 'Rubik', sans-serif; background-color: #f4f7f6; }
        #map { height: 300px; width: 100%; border-radius: 8px; background-color: #eee; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .status-tracker { display: flex; justify-content: space-between; align-items: flex-start; position: relative; margin-bottom: 2.5rem; }
        .status-tracker::before { content: ''; position: absolute; top: 16px; right: 0; left: 0; height: 4px; background-color: #e5e7eb; z-index: 1; }
        .status-tracker-progress { position: absolute; top: 16px; right: 0; height: 4px; background-color: #3b82f6; z-index: 2; width: 0%; transition: width 0.5s ease; }
        .status-step { display: flex; flex-direction: column; align-items: center; text-align: center; width: 60px; z-index: 3; }
        .status-dot { width: 36px; height: 36px; border-radius: 50%; background-color: #e5e7eb; border: 4px solid #f4f7f6; color: #9ca3af; display: flex; align-items: center; justify-content: center; font-weight: 700; transition: all 0.3s ease; }
        .status-label { font-size: 0.75rem; font-weight: 500; color: #9ca3af; margin-top: 0.5rem; line-height: 1.2; }
        .status-step.completed .status-dot { background-color: #3b82f6; color: white; border-color: #dbeafe; }
        .status-step.completed .status-label { color: #1f2937; }
        .status-step.active .status-dot { background-color: white; border-color: #3b82f6; color: #3b82f6; transform: scale(1.1); }
        .status-step.active .status-label { color: #3b82f6; font-weight: 700; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto max-w-lg p-4">
        <header class="text-center my-6 flex flex-col items-center">
            <img src="https://i.postimg.cc/ryPT3r29/image.png" alt="Company Logo" class="w-20 h-20 mx-auto mb-4 rounded-lg shadow-sm">
            <h1 class="text-3xl font-bold text-gray-800">מעקב משלוח</h1>
            <p id="order-id-display" class="text-gray-600">טוען פרטי הזמנה...</p>
        </header>

        <main class="bg-white p-6 rounded-lg shadow-lg">
            <div id="loader" class="text-center py-10">
                <div class="loader"></div>
                <p class="text-gray-600">מאתר את ההזמנה שלך...</p>
            </div>

            <div id="error-message" class="hidden text-center py-10">
                <i data-feather="alert-triangle" class="w-12 h-12 mx-auto text-red-500"></i>
                <p class="text-red-600 mt-4" id="error-text">שגיאה בטעינת הנתונים.</p>
            </div>

            <div id="order-content" class="hidden">
                <p class="text-gray-700 text-lg mb-6">שלום <strong id="customer-name"></strong>, ההזמנה שלך בסטטוס:</p>
                <div class="status-tracker">
                    <div class="status-tracker-progress" id="status-progress-bar"></div>
                    <div class="status-step" id="step-new"><div class="status-dot"><i data-feather="check"></i></div><div class="status-label">התקבלה</div></div>
                    <div class="status-step" id="step-assigned"><div class="status-dot"><i data-feather="user-check"></i></div><div class="status-label">שויכה לנהג</div></div>
                    <div class="status-step" id="step-onway"><div class="status-dot"><i data-feather="truck"></i></div><div class="status-label">בדרך אליך</div></div>
                    <div class="status-step" id="step-completed"><div class="status-dot"><i data-feather="flag"></i></div><div class="status-label">הושלמה</div></div>
                </div>
                <div class="mb-6" id="map-container" style="display: none;">
                    <h3 class="font-semibold mb-3">מעקב חי</h3><div id="map"></div>
                </div>
                <div id="driver-details" class="bg-gray-50 p-4 rounded-lg flex items-center space-x-4 space-x-reverse" style="display: none;">
                    <div class="bg-blue-100 p-3 rounded-full"><i data-feather="truck" class="w-6 h-6 text-blue-600"></i></div>
                    <div><p class="font-semibold">נהג: <span id="driver-name"></span></p><a href="#" id="driver-phone-link" class="text-blue-600 text-sm font-medium"><i data-feather="phone" class="w-4 h-4 inline-block ml-1"></i><span id="driver-phone"></span></a></div>
                </div>
                <div class="mt-6 border-t pt-4" id="notes-container" style="display: none;">
                    <h3 class="font-semibold mb-2">הערות למשלוח</h3><p id="order-notes" class="text-gray-700 bg-gray-50 p-3 rounded-md"></p>
                </div>
            </div>
        </main>

        <footer class="text-center mt-6 text-gray-500 text-sm"><p>&copy; 2024 DeliveryMaster</p></footer>
    </div>

    <script type="module">
        // --- Import from Shared Module ---
        import { db, authReadyPromise, SmartLog, doc, onSnapshot } from '../shared/firebase-init.js'; // Adjusted path

        // --- Map & State ---
        let map; let driverMarker; let orderMarker;
        let orderListenerUnsubscribe = null; let locationListenerUnsubscribe = null;
        let currentOrderId = null; let currentOrderLatLng = null;

        // --- Icons ---
        const driverIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', shadowSize: [41, 41] });
        const orderIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', shadowSize: [41, 41] });

        // --- UI Functions (remain the same) ---
        function showLoader(show) { document.getElementById('loader').style.display = show ? 'block' : 'none'; }
        function showError(message) {
            showLoader(false);
            document.getElementById('order-content').style.display = 'none';
            const errorMsgEl = document.getElementById('error-message');
            const errorTextEl = document.getElementById('error-text');
            if (errorMsgEl) errorMsgEl.style.display = 'block';
            if (errorTextEl) errorTextEl.innerText = message || 'אירעה שגיאה.';
            try { feather.replace(); } catch (e) {}
        }
        function showContent() {
            showLoader(false);
            document.getElementById('error-message').style.display = 'none';
            document.getElementById('order-content').style.display = 'block';
            try { feather.replace(); } catch (e) {}
        }

        // --- Map Functions (remain the same) ---
        function initializeMap(orderLatLng) {
            try {
                if (map) map.remove();
                map = L.map('map');
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OSM' }).addTo(map);
                const bounds = L.latLngBounds();
                if (orderLatLng && Array.isArray(orderLatLng) && orderLatLng.length === 2) {
                    orderMarker = L.marker(orderLatLng, { icon: orderIcon }).addTo(map).bindPopup("כתובת האספקה");
                    bounds.extend(orderLatLng);
                }
                if (bounds.isValid()) map.fitBounds(bounds, { padding: [50, 50], maxZoom: 16 });
                else map.setView([32.0853, 34.7818], 9); // Israel center
            } catch (error) { SmartLog.error(error, "MapInit"); document.getElementById('map').innerHTML = "שגיאה בטעינת המפה."; }
        }

        function updateMap(driverLatLng) {
            if (!map) return;
            const bounds = L.latLngBounds();
            if (currentOrderLatLng) bounds.extend(currentOrderLatLng); // Always include order location

            if (driverLatLng && Array.isArray(driverLatLng) && driverLatLng.length === 2) {
                document.getElementById('map-container').style.display = 'block';
                if (driverMarker) driverMarker.setLatLng(driverLatLng);
                else driverMarker = L.marker(driverLatLng, { icon: driverIcon }).addTo(map).bindPopup("מיקום הנהג");
                bounds.extend(driverLatLng);
            } else {
                if (driverMarker) { map.removeLayer(driverMarker); driverMarker = null; }
                // Keep map visible if order location exists, hide only if NO locations
                if (!currentOrderLatLng) document.getElementById('map-container').style.display = 'none';
            }
            if (bounds.isValid()) {
                // Use invalidateSize before fitBounds if map was hidden
                if (document.getElementById('map-container').style.display === 'block') {
                    map.invalidateSize();
                    setTimeout(() => map.fitBounds(bounds, { padding: [50, 50], maxZoom: 16 }), 50);
                }
            } else if (currentOrderLatLng) {
                 map.setView(currentOrderLatLng, 15); // Center on order if only order exists
            }
        }

        // --- Status Tracker UI (remains the same) ---
        function updateStatusTracker(status) {
            const steps = { 'חדש': 0, 'שויך': 1, 'בדרך': 2, 'הושלם': 3, 'בוטל': -1 };
            const stepIndex = steps[status] ?? 0;
            const progressBar = document.getElementById('status-progress-bar');
            const allSteps = document.querySelectorAll('.status-step');

            if (!progressBar || !allSteps.length) return;

            if (stepIndex === -1) { progressBar.style.width = '0%'; allSteps.forEach(s => s.classList.remove('active', 'completed')); return; }

            const progressPercentage = Math.min(100, (stepIndex / 3) * 100);
            progressBar.style.width = `${progressPercentage}%`;

            document.getElementById('step-new')?.classList.toggle('completed', stepIndex >= 0);
            document.getElementById('step-assigned')?.classList.toggle('completed', stepIndex >= 1);
            document.getElementById('step-onway')?.classList.toggle('completed', stepIndex >= 2);
            document.getElementById('step-completed')?.classList.toggle('completed', stepIndex >= 3);

            allSteps.forEach(s => s.classList.remove('active'));
            const activeStepId = ['step-new', 'step-assigned', 'step-onway', 'step-completed'][stepIndex];
            if (activeStepId) document.getElementById(activeStepId)?.classList.add('active');
        }

        // --- Main Logic (uses imported functions) ---
        function getOrderIdFromUrl() {
            try {
                const params = new URLSearchParams(window.location.search);
                const id = params.get('id');
                if (!id) { showError("קישור לא תקין: חסר מזהה הזמנה."); return null; }
                return id;
            } catch (e) { SmartLog.error(e, "URLParse"); showError("שגיאה בעיבוד הקישור."); return null; }
        }

        async function startTracking() {
            currentOrderId = getOrderIdFromUrl();
            if (!currentOrderId) return;

            try {
                await authReadyPromise; // Use imported promise
                SmartLog.info("Auth ready, tracking order.", "Init", { orderId: currentOrderId });

                const orderRef = doc(db, "orders", currentOrderId);
                orderListenerUnsubscribe = onSnapshot(orderRef, (docSnap) => {
                    if (!docSnap.exists()) {
                        showError("ההזמנה לא נמצאה."); SmartLog.error(new Error("Order not found"), "Listener", { orderId: currentOrderId });
                        stopTracking(); return;
                    }

                    const orderData = docSnap.data();
                    currentOrderLatLng = (orderData.latitude && orderData.longitude) ? [orderData.latitude, orderData.longitude] : null;
                    renderOrderData(orderData); // Update UI text, status, notes

                    const driverId = orderData.driver?.id;
                    if (driverId && ['שויך', 'בדרך'].includes(orderData.status)) {
                        listenToDriverLocation(driverId, orderData.status);
                    } else {
                        if (locationListenerUnsubscribe) { locationListenerUnsubscribe(); locationListenerUnsubscribe = null; }
                        updateMap(null); // Show only order location or default view
                    }
                    // Initialize map here if not already initialized and we have coords
                    if (!map && currentOrderLatLng) {
                        initializeMap(currentOrderLatLng);
                    } else if (map && currentOrderLatLng && !driverId) {
                         // If driver was removed, update map to show only order
                         updateMap(null);
                    }


                }, (error) => {
                    SmartLog.error(error, "Listener.Order"); showError("שגיאה בקבלת נתוני הזמנה."); stopTracking();
                });

            } catch (error) { SmartLog.error(error, "Init.AuthFail"); showError("שגיאת התחברות. נסה לרענן."); stopTracking(); }
        }

        function listenToDriverLocation(driverId, orderStatus) {
            if (locationListenerUnsubscribe) return; // Already listening

            SmartLog.info("Listening to driver location...", "Listener.Location", { driverId });
            const locationRef = doc(db, "driverLocations", driverId);
            locationListenerUnsubscribe = onSnapshot(locationRef, (docSnap) => {
                 if (docSnap.exists() && orderStatus === 'בדרך') { // Only show driver if order is 'On Way'
                     const locData = docSnap.data();
                     const driverLatLng = (locData.latitude && locData.longitude) ? [locData.latitude, locData.longitude] : null;
                     updateMap(driverLatLng); // Pass only driver coords, map function uses currentOrderLatLng
                 } else {
                     updateMap(null); // Driver doc missing or order not 'On Way', show only order
                 }
            }, (error) => {
                SmartLog.error(error, "Listener.Location", { driverId }); updateMap(null); // Stop showing driver on error
                if (locationListenerUnsubscribe) { locationListenerUnsubscribe(); locationListenerUnsubscribe = null; } // Stop listening on error
            });
        }

        function renderOrderData(order) {
            const displayId = order.orderNumber || `#${currentOrderId.slice(-6)}`;
            document.getElementById('order-id-display').innerText = `הזמנה ${displayId}`;
            document.getElementById('customer-name').innerText = order.customer?.name || 'לקוח';
            updateStatusTracker(order.status);

            const driverDetailsEl = document.getElementById('driver-details');
            const notesContainerEl = document.getElementById('notes-container');

            if (order.driver?.name && ['שויך', 'בדרך'].includes(order.status)) {
                 document.getElementById('driver-name').innerText = order.driver.name;
                 // Attempt to get phone from driver object within order (might be stale)
                 const phone = order.driver.phone || 'לא זמין';
                 document.getElementById('driver-phone').innerText = phone;
                 document.getElementById('driver-phone-link').href = `tel:${phone}`;
                 if(driverDetailsEl) driverDetailsEl.style.display = 'flex';
            } else {
                 if(driverDetailsEl) driverDetailsEl.style.display = 'none';
            }

            if (order.notes) {
                document.getElementById('order-notes').innerText = order.notes;
                 if(notesContainerEl) notesContainerEl.style.display = 'block';
            } else {
                 if(notesContainerEl) notesContainerEl.style.display = 'none';
            }

            showContent(); // Make content visible after rendering text
        }

        function stopTracking() {
            if (orderListenerUnsubscribe) { orderListenerUnsubscribe(); orderListenerUnsubscribe = null; }
            if (locationListenerUnsubscribe) { locationListenerUnsubscribe(); locationListenerUnsubscribe = null; }
            SmartLog.info("Stopped tracking listeners.", "Cleanup");
        }

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            startTracking();
        });

        // Optional: Clean up listeners when page is closed/hidden
        window.addEventListener('beforeunload', stopTracking);
        document.addEventListener('visibilitychange', () => {
             if (document.visibilityState === 'hidden') {
                 // Consider stopping listeners if hidden for long, but might miss updates
                 // For now, keep them running.
             } else {
                 // If restarting listeners was implemented, do it here.
             }
        });

    </script>
</body>
</html>
