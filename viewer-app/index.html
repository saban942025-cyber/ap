<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DeliveryMaster Viewer v50.7 (Modular + SW)</title>
    <!--
      DeliveryMaster Live Viewer App v50.7 (Modular + SW)

      Changelog:
      - v50.7.1 (FIX): Changed import path to absolute (/shared/firebase-init.js)
      - v50.7:
        - Refactored to use shared firebase-init.js module.
        - Added Service Worker registration.
        - Unified SmartLog to use 'system_logs_v3'.
      - v50.6: Fixed mobile UI, added Global Ping listener.
      - v50.5: Faulty mobile UI implementation.
      - v50.4: Added Global Ping listener (initial).
      - v50.3: Fixed ISRAEL_CENTER error.
    -->

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/ryPT3r29/image.png">

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* CSS remains the same as v50.6 */
        :root { --primary-color: #3b82f6; --primary-dark: #2563eb; --bg-light: #f3f4f6; --bg-white: #ffffff; --border-color: #e5e7eb; --text-dark: #1f2937; --text-light: #6b7280; --color-manof-bg: #e0f2fe; --color-masait-bg: #dcfce7; --color-isuf-bg: #f3f4f6; --color-future-bg: #f9fafb; }
        html, body { height: 100vh; width: 100vw; overflow: hidden; } body { font-family: 'Inter', 'Arial', sans-serif; background-color: var(--bg-light); color: var(--text-dark); }
        .viewer-layout { display: flex; flex-direction: column; height: 100vh; width: 100%; } header { flex-shrink: 0; }
        #viewer-counters { flex-shrink: 0; background-color: #e5e7eb; padding: 0.5rem 1rem; display: flex; flex-wrap: wrap; justify-content: space-around; gap: 0.5rem; border-bottom: 1px solid var(--border-color); } .counter-item { display: flex; align-items: center; gap: 0.5rem; font-weight: 500; color: var(--text-dark); background-color: var(--bg-white); padding: 0.25rem 0.75rem; border-radius: 99px; font-size: 0.8rem; } .counter-item .count { font-weight: 700; color: var(--primary-dark); min-width: 1.25rem; text-align: center; }
        #viewer-main-content { display: grid; grid-template-columns: 1fr 350px; grid-template-rows: 1fr; flex-grow: 1; overflow: hidden; } #viewer-map-container { position: relative; background-color: #e0e0e0; grid-row: 1; grid-column: 1; } #viewer-map { height: 100%; width: 100%; } #viewer-side-panel { grid-row: 1; grid-column: 2; background-color: var(--bg-white); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        @media (max-width: 768px) { #viewer-main-content { grid-template-columns: 1fr; grid-template-rows: 45% 1fr; } #viewer-map-container { grid-row: 1; grid-column: 1; } #viewer-side-panel { grid-row: 2; grid-column: 1; border-right: none; border-top: 1px solid var(--border-color); } }
        #viewer-side-panel .tabs-container { display: flex; border-bottom: 1px solid var(--border-color); flex-shrink: 0; } #viewer-side-panel .tab-button { flex: 1; padding: 0.75rem 0.5rem; font-weight: 500; text-align: center; border-bottom: 3px solid transparent; color: var(--text-light); font-size: 0.9rem; cursor: pointer; white-space: nowrap; } @media (max-width: 768px) { #viewer-side-panel .tab-button { font-size: 0.8rem; padding: 0.75rem 0.25rem; } } #viewer-side-panel .tab-button.active { border-bottom-color: var(--primary-color); color: var(--primary-color); }
        #viewer-side-panel .search-container { padding: 0.75rem; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .panel-list-container { flex: 1; overflow-y: auto; position: relative; } .panel-list { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow-y: auto; display: none; } .panel-list.active { display: block; }
        .order-card, .driver-card { padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-color); transition: background-color 0.2s; cursor: pointer; } .order-card:hover, .driver-card:hover { background-color: #fafafa; } .order-card.active, .driver-card.active { background-color: #eff6ff; border-right: 3px solid var(--primary-color); } .order-card .font-bold { color: var(--primary-dark); } .order-card.type-manof { background-color: var(--color-manof-bg); } .order-card.type-masait { background-color: var(--color-masait-bg); } .order-card.type-isuf { background-color: var(--color-isuf-bg); } .order-card.future-order { background-color: var(--color-future-bg); } .order-card.future-order .font-semibold { color: var(--text-light); } .order-type-icon { margin-left: 0.5rem; font-size: 1.1em; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; } .status-active { background-color: #22c55e; } .status-stuck { background-color: #ef4444; } .status-inactive { background-color: #9ca3af; }
        .leaflet-popup-content-wrapper { border-radius: 8px; } .leaflet-popup-content { margin: 13px 20px; font-family: 'Inter', sans-serif; } .leaflet-popup-content h4 { font-weight: 700; margin-bottom: 8px; display: flex; align-items: center; } .leaflet-popup-content p { margin: 4px 0; color: var(--text-light); }
        .loader-container { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.7); display: flex; align-items: center; justify-content: center; z-index: 10; } .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; } @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #connection-status { font-size: 0.8rem; font-weight: 500; padding: 4px 8px; border-radius: 99px; display: inline-flex; align-items: center; gap: 4px; } #connection-status.connected { background-color: #dcfce7; color: #166534; } #connection-status.connecting { background-color: #fef9c3; color: #854d0e; } #connection-status.error { background-color: #fee2e2; color: #991b1b; } #connection-status .dot { width: 6px; height: 6px; border-radius: 50%; } #connection-status.connected .dot { background-color: #22c55e; } #connection-status.connecting .dot { background-color: #facc15; } #connection-status.error .dot { background-color: #ef4444; }
        #toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 5000; display: flex; flex-direction: column; gap: 8px; } .toast { padding: 12px 20px; background-color: var(--text-dark); color: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); opacity: 0; transform: translateY(20px); transition: all 0.3s ease; } .toast.show { opacity: 1; transform: translateY(0); } .toast.success { background-color: #22c55e; } .toast.error { background-color: #ef4444; } .toast.ping { background-color: var(--primary-color); }
    </style>
</head>
<body class="antialiased">

    <div class="viewer-layout">
        <header class="bg-white shadow-sm p-4 flex justify-between items-center">
             <div class="flex items-center space-x-2 space-x-reverse"><i data-feather="truck" class="w-7 h-7 text-blue-500"></i><h1 class="text-xl font-bold">DeliveryMaster Viewer</h1></div>
             <div id="connection-status" class="connecting"><span class="dot"></span><span>××ª×—×‘×¨...</span></div>
        </header>

        <div id="viewer-counters">
             <div class="counter-item">ğŸ”„<span>×‘×¡×™×“×•×¨:</span><span id="count-active" class="count">-</span></div>
             <div class="counter-item">âœ…<span>×¡×•×¤×§×• ×”×™×•×:</span><span id="count-completed-today" class="count">-</span></div>
             <div class="counter-item">ğŸ“…<span>×¦×¤×™ ×¢×ª×™×“×™:</span><span id="count-future" class="count">-</span></div>
        </div>

        <main id="viewer-main-content">
            <div id="viewer-map-container">
                <div id="viewer-map"></div>
                <div id="viewer-map-loader" class="loader-container"><div class="loader"></div><span class="ml-4 font-semibold">×˜×•×¢×Ÿ ××¤×” ×•× ×ª×•× ×™×...</span></div>
            </div>

            <aside id="viewer-side-panel">
                <div class="tabs-container">
                    <button id="tab-orders-active" class="tab-button active" onclick="showViewerPanelTab('orders-active')">×”×–×× ×•×ª ×¤×¢×™×œ×•×ª</button>
                    <button id="tab-orders-future" class="tab-button" onclick="showViewerPanelTab('orders-future')">×”×–×× ×•×ª ×¢×ª×™×“×™×•×ª</button>
                    <button id="tab-drivers" class="tab-button" onclick="showViewerPanelTab('drivers')">× ×”×’×™×</button>
                </div>
                <div class="search-container"><input type="text" id="viewer-search-input" placeholder="×—×¤×© ×”×–×× ×” ××• × ×”×’..." class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300" onkeyup="filterViewerLists()"></div>
                <div class="panel-list-container">
                    <div id="viewer-orders-active-list" class="panel-list active"><div class="loader-container"><div class="loader"></div></div></div>
                    <div id="viewer-orders-future-list" class="panel-list"><div class="loader-container"><div class="loader"></div></div></div>
                    <div id="viewer-drivers-list" class="panel-list"><div class="loader-container"><div class="loader"></div></div></div>
                </div>
            </aside>
        </main>
    </div>

     <div id="toast-container"></div>


    <script type="module">
        // --- Import from Shared Module ---
        import {
            db, authReadyPromise, SmartLog, // Core shared components
            collection, doc, onSnapshot, query, orderBy, where, limit, Timestamp // Firestore functions used + Timestamp
        } from '/shared/firebase-init.js'; // *** FIXED PATH TO ABSOLUTE ***

        // --- CONFIG & STATE ---
        const ISRAEL_CENTER = [32.0853, 34.7818];
        const ACTIVE_ORDER_STATUSES = ["×—×“×©", "×©×•×™×š", "×‘×“×¨×š"];

        let viewerState = { allOrders: [], activeOrders: [], futureOrders: [], drivers: [], liveLocations: {} };
        let viewerMap; let viewerDriverMarkers = {}; let viewerOrderMarkers = {};

        // --- ICONS & STYLING ---
        const driverIconActive = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png', /*...*/ shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });
        const driverIconStuck = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png', /*...*/ shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });
        const orderIconActive = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png', /*...*/ shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });
        const orderTypeDetails = { '×”×•×‘×œ×ª ×× ×•×£': { icon: 'ğŸ—ï¸', className: 'type-manof' }, '×”×•×‘×œ×ª ××©××™×ª': { icon: 'ğŸšš', className: 'type-masait' }, '××™×¡×•×£ ×¢×¦××™': { icon: 'ğŸ‘¤', className: 'type-isuf' }, 'default': { icon: 'ğŸ“¦', className: '' } };

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            try { feather.replace(); } catch (e) { SmartLog.error(e, "Init.Feather"); }
            initializeViewerApplication();
        });

        async function initializeViewerApplication() {
            SmartLog.info("v50.7 Viewer (Modular): Initializing...", "Init");
            try {
                updateConnectionStatus('connecting', '××¤×¢×™×œ ××¤×”...');
                initViewerMap();
                showLoader('viewer-orders-active-list', true);
                showLoader('viewer-orders-future-list', true);
                showLoader('viewer-drivers-list', true);

                updateConnectionStatus('connecting', '××××ª...');
                await authReadyPromise; // Use imported promise
                SmartLog.info(`Auth successful for viewer.`, "Init.Auth");

                updateConnectionStatus('connecting', '××—×‘×¨ ×××–×™× ×™×...');
                listenToDriversViewer();
                listenToAllOrdersViewer();
                listenToLocationsViewer();
                listenToGlobalPings();

                showLoader('viewer-map-loader', false);
                updateConnectionStatus('connected', '××—×•×‘×¨');

            } catch (error) {
                SmartLog.error(error, "Init.Critical", { message: "Viewer init failed." });
                updateConnectionStatus('error', `×©×’×™××ª ××ª×—×•×œ: ${error.message}`);
                const mapLoader = document.getElementById('viewer-map-loader');
                if(mapLoader) mapLoader.innerHTML = `<span class="text-red-600">×©×’×™××ª ××ª×—×•×œ ×§×¨×™×˜×™×ª.</span>`;
                showToast(`×©×’×™××ª ××ª×—×•×œ: ${error.message}`, 'error');
            }
        }

        // --- initViewerMap, updateConnectionStatus remain the same ---
         function initViewerMap() {
            try {
                const mapContainer = document.getElementById('viewer-map');
                if (!mapContainer) throw new Error("Map container #viewer-map not found");
                 if (viewerMap) { viewerMap.remove(); viewerMap = null; }
                viewerMap = L.map('viewer-map').setView(ISRAEL_CENTER, 9);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OSM' }).addTo(viewerMap);
                SmartLog.info("Viewer Map initialized", "Init.Map");
            } catch (error) {
                SmartLog.error(error, "Init.Map");
                 const mapContainer = document.getElementById('viewer-map');
                 if(mapContainer) mapContainer.innerHTML = `<div class="p-8 text-center text-red-600">×©×’×™××” ×‘×˜×¢×™× ×ª ×”××¤×”.</div>`;
            }
        }

        function updateConnectionStatus(statusClass, message) {
             const el = document.getElementById('connection-status');
             if (el) {
                 el.className = statusClass;
                 const span = el.querySelector('span:last-child');
                 if (span) span.innerText = message;
             }
         }

        // --- FIRESTORE LISTENERS (use imported functions) ---
        function listenToDriversViewer() {
            SmartLog.info("Listening to Drivers...", "Firestore.Listen");
            const q = query(collection(db, "drivers"), orderBy("name"));
            onSnapshot(q, (snapshot) => {
                // SmartLog.info(`Drivers: ${snapshot.docs.length} docs.`, "Firestore.Snapshot");
                viewerState.drivers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderViewerDriversList();
                renderViewerMapMarkers();
                showLoader('viewer-drivers-list', false);
            }, e => { SmartLog.error(e, "Firestore.Drivers.Listener"); updateConnectionStatus("error", "×©×’×™××ª × ×”×’×™×"); });
        }

        function listenToAllOrdersViewer() {
            SmartLog.info("Listening to ALL Orders...", "Firestore.Listen");
            const q = query(collection(db, "orders"), orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                // SmartLog.info(`All Orders: ${snapshot.docs.length} docs.`, "Firestore.Snapshot");
                viewerState.allOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const todayStart = new Date(); todayStart.setHours(0, 0, 0, 0);
                const todayEnd = new Date(); todayEnd.setHours(23, 59, 59, 999);
                const todayStartMs = todayStart.getTime(); const todayEndMs = todayEnd.getTime();

                viewerState.activeOrders = []; viewerState.futureOrders = []; let completedTodayCount = 0;

                for (const o of viewerState.allOrders) {
                    if (ACTIVE_ORDER_STATUSES.includes(o.status || '')) viewerState.activeOrders.push(o);
                    if (o.orderDate) { try { const d = new Date(o.orderDate); d.setHours(0,0,0,0); if (d > todayEnd) viewerState.futureOrders.push(o); } catch (e) {} }
                    if (o.status === '×”×•×©×œ×') { const modTime = o.lastModified?.toDate ? o.lastModified.toDate().getTime() : 0; if (modTime >= todayStartMs && modTime <= todayEndMs) completedTodayCount++; }
                }
                viewerState.activeOrders.sort((a,b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                viewerState.futureOrders.sort((a,b) => (a.orderDate ? new Date(a.orderDate).getTime() : 0) - (b.orderDate ? new Date(b.orderDate).getTime() : 0));

                renderViewerOrdersList(); renderViewerFutureOrdersList(); renderViewerMapMarkers(); updateCounters(completedTodayCount);
                showLoader('viewer-orders-active-list', false); showLoader('viewer-orders-future-list', false);

            }, e => { SmartLog.error(e, "Firestore.AllOrders.Listener"); updateConnectionStatus("error", "×©×’×™××ª ×”×–×× ×•×ª"); });
        }

        function listenToLocationsViewer() {
             SmartLog.info("Listening to Locations...", "Firestore.Listen");
             const q = query(collection(db, "driverLocations"));
             onSnapshot(q, (snapshot) => {
                // SmartLog.info(`Locations: ${snapshot.docChanges().length} changes.`, "Firestore.Snapshot");
                const newLocations = {}; snapshot.forEach(doc => { newLocations[doc.id] = { id: doc.id, ...doc.data() }; }); viewerState.liveLocations = newLocations;
                renderViewerDriversList(); renderViewerMapMarkers();
             }, e => { SmartLog.error(e, "Firestore.Locations.Listener"); updateConnectionStatus("error", "×©×’×™××ª ××™×§×•××™×"); });
        }

        function listenToGlobalPings() {
             SmartLog.info("Listening for Global Pings...", "Firestore.Listen");
             const since = Timestamp.fromDate(new Date(Date.now() - 60000)); // Use imported Timestamp
             const q = query( collection(db, "globalPings"), where("createdAt", ">", since), orderBy("createdAt", "desc"), limit(1) );
             let initialLoad = true;
             onSnapshot(q, (snapshot) => {
                 if (initialLoad) { initialLoad = false; return; }
                 snapshot.docChanges().forEach(change => { if (change.type === "added") { const ping = change.doc.data(); SmartLog.info("Global Ping Received!", "Pings", ping); playNotificationSound('A5', '4n'); showToast(`×”×ª×¨××” ××”×× ×”×œ: ${ping.message}`, 'ping'); } });
             }, e => { SmartLog.error(e, "Firestore.Pings.Listener"); updateConnectionStatus("error", "×©×’×™××ª ×”×ª×¨××•×ª"); });
        }

        // --- RENDER FUNCTIONS (remain mostly the same) ---
         function updateCounters(completedTodayCount) {
             const activeCount = viewerState.activeOrders.length; const futureCount = viewerState.futureOrders.length;
             const countActiveEl = document.getElementById('count-active'); const countCompletedEl = document.getElementById('count-completed-today'); const countFutureEl = document.getElementById('count-future');
             if(countActiveEl) countActiveEl.innerText = activeCount; if(countCompletedEl) countCompletedEl.innerText = completedTodayCount; if(countFutureEl) countFutureEl.innerText = futureCount;
         }

        function renderViewerDriversList() {
            const list = document.getElementById('viewer-drivers-list'); if (!list) return;
            const sortedDrivers = viewerState.drivers; // Assume sorted by listener
            if (sortedDrivers.length === 0) { list.innerHTML = `<div class="p-4 text-center text-gray-500">×œ× × ××¦××• × ×”×’×™×.</div>`; return; }
            const fragment = document.createDocumentFragment(); sortedDrivers.forEach(d => fragment.appendChild(createViewerDriverCard(d, viewerState.liveLocations[d.id])));
            list.innerHTML = ''; list.appendChild(fragment); filterViewerLists();
        }

        function createViewerDriverCard(driver, location) {
            const el = document.createElement('div'); el.className = 'driver-card p-4 cursor-pointer'; el.id = `viewer-driver-card-${driver.id}`;
            el.setAttribute('data-search', driver.name?.toLowerCase() || ''); el.onclick = () => focusViewerMapItem(driver.id, 'driver');
            const minutesAgo = location?.lastUpdate?.toDate ? Math.round((Date.now() - location.lastUpdate.toDate().getTime()) / 60000) : '?';
            const statusClass = location ? (location.isStuck ? 'status-stuck' : 'status-active') : 'status-inactive'; const statusText = location ? (location.isStuck ? `×ª×§×•×¢ (${minutesAgo} ×“×§')` : `×¤×¢×™×œ (${minutesAgo} ×“×§')`) : '×œ× ××—×•×‘×¨';
            el.innerHTML = `<div class="flex justify-between items-center"><span class="font-semibold">${driver.name || '?'}</span><div class="flex items-center space-x-2 space-x-reverse"><span class="text-sm font-medium">${statusText}</span><span class="status-dot ${statusClass}"></span></div></div><div class="text-sm text-gray-500 mt-1"><span>${driver.vehicleType || '?'} | ${driver.phone || '?'}</span></div>`;
            return el;
        }

        function renderViewerOrdersList() { // Active
            const list = document.getElementById('viewer-orders-active-list'); if (!list) return;
            if (viewerState.activeOrders.length === 0) { list.innerHTML = `<div class="p-4 text-center text-gray-500">××™×Ÿ ×”×–×× ×•×ª ×¤×¢×™×œ×•×ª.</div>`; return; }
            const fragment = document.createDocumentFragment(); viewerState.activeOrders.forEach(o => fragment.appendChild(createViewerOrderCard(o, false)));
            list.innerHTML = ''; list.appendChild(fragment); filterViewerLists();
        }

        function renderViewerFutureOrdersList() { // Future
            const list = document.getElementById('viewer-orders-future-list'); if (!list) return;
            if (viewerState.futureOrders.length === 0) { list.innerHTML = `<div class="p-4 text-center text-gray-500">××™×Ÿ ×”×–×× ×•×ª ×¢×ª×™×“×™×•×ª.</div>`; return; }
            const fragment = document.createDocumentFragment(); viewerState.futureOrders.forEach(o => fragment.appendChild(createViewerOrderCard(o, true)));
            list.innerHTML = ''; list.appendChild(fragment); filterViewerLists();
        }

        function createViewerOrderCard(order, isFuture = false) { // Remains the same
            const el = document.createElement('div'); const typeInfo = orderTypeDetails[order.deliveryType] || orderTypeDetails['default']; el.className = `order-card p-3 cursor-pointer ${typeInfo.className} ${isFuture ? 'future-order' : ''}`; el.id = `viewer-order-card-${order.id}`; el.setAttribute('data-search', `${order.orderNumber || order.id} ${order.customer?.name?.toLowerCase()} ${order.address?.toLowerCase()}`); if (!isFuture) el.onclick = () => focusViewerMapItem(order.id, 'order'); else el.style.cursor = 'default';
            const customerName = order.customer?.name || '?'; const address = order.address || '?'; const displayId = order.orderNumber || `#${order.id.slice(-6)}`; const status = order.status || '?'; const driverName = order.driver?.name ? `(${order.driver.name})` : ''; const createdDateTime = order.createdAt?.toDate ? order.createdAt.toDate().toLocaleString('he-IL', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' }) : 'N/A'; const orderDateForDisplay = order.orderDate ? new Date(order.orderDate).toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit', year: 'numeric' }) : 'N/A';
            el.innerHTML = `<div class="flex justify-between items-center mb-1"><span class="font-bold text-blue-600 flex items-center">${displayId} <span class="order-type-icon">${typeInfo.icon}</span></span>${isFuture ? `<span class="text-sm font-semibold text-gray-600">×œ×ª××¨×™×š: ${orderDateForDisplay}</span>` : `<span class="text-sm font-semibold">${status} ${driverName}</span>`}</div><div class="font-semibold text-gray-800 text-sm">${customerName}</div><div class="text-xs text-gray-600 truncate">${address}</div><div class="text-xs text-gray-500 mt-1 flex justify-between"><span>${order.warehouse || ''}</span><span>× ×•×¦×¨: ${createdDateTime}</span></div>`;
            return el;
        }

        function renderViewerMapMarkers() { // Remains the same
            if (!viewerMap) return; const bounds = L.latLngBounds();
            Object.values(viewerState.liveLocations).forEach(loc => { if (!loc.latitude) return; const driverData = viewerState.drivers.find(d => d.id === loc.id); const name = driverData?.name || '?'; const latLng = [loc.latitude, loc.longitude]; const icon = loc.isStuck ? driverIconStuck : driverIconActive; const popup = `<h4>${name}</h4><p>${loc.isStuck ? '×ª×§×•×¢' : '×¤×¢×™×œ'}</p>`; if (viewerDriverMarkers[loc.id]) viewerDriverMarkers[loc.id].setLatLng(latLng).setIcon(icon).setPopupContent(popup); else viewerDriverMarkers[loc.id] = L.marker(latLng, { icon }).addTo(viewerMap).bindPopup(popup).on('click', () => focusViewerMapItem(loc.id, 'driver')); if (!loc.isStuck) bounds.extend(latLng); });
            Object.keys(viewerDriverMarkers).forEach(id => { if (!viewerState.liveLocations[id]) { if (viewerMap.hasLayer(viewerDriverMarkers[id])) viewerMap.removeLayer(viewerDriverMarkers[id]); delete viewerDriverMarkers[id]; } });
            const activeMapOrders = viewerState.activeOrders.filter(o => o.latitude); Object.keys(viewerOrderMarkers).forEach(id => { if (!activeMapOrders.some(o => o.id == id)) { if (viewerMap.hasLayer(viewerOrderMarkers[id])) viewerMap.removeLayer(viewerOrderMarkers[id]); delete viewerOrderMarkers[id]; } });
            activeMapOrders.forEach(order => { const latLng = [order.latitude, order.longitude]; const typeInfo = orderTypeDetails[order.deliveryType] || orderTypeDetails['default']; const popup = `<h4>${typeInfo.icon} ${order.orderNumber || `#${order.id.slice(-6)}`}</h4><p>${order.customer?.name || '?'}</p><p>${order.address || '?'}</p><p>×¡×˜×˜×•×¡: ${order.status}</p>${order.driver?.name ? `<p>× ×”×’: ${order.driver.name}</p>` : ''}`; if (viewerOrderMarkers[order.id]) viewerOrderMarkers[order.id].setLatLng(latLng).setPopupContent(popup); else viewerOrderMarkers[order.id] = L.marker(latLng, { icon: orderIconActive }).addTo(viewerMap).bindPopup(popup).on('click', () => focusViewerMapItem(order.id, 'order')); bounds.extend(latLng); });
            if (bounds.isValid() && (activeMapOrders.length > 0 || Object.values(viewerState.liveLocations).some(loc => !loc.isStuck))) { try { viewerMap.fitBounds(bounds, { padding: [50, 50], maxZoom: 15 }); } catch (e) { console.warn("FitBounds error:", e); } } else if (!bounds.isValid()) viewerMap.setView(ISRAEL_CENTER, 9);
        }

        // --- UI INTERACTIONS (remain the same) ---
        function showViewerPanelTab(tabName) {
            document.querySelectorAll('.panel-list').forEach(list => { list.style.display = 'none'; list.classList.remove('active'); });
            const listToShow = document.getElementById(`viewer-${tabName}-list`); if (listToShow) { listToShow.style.display = 'block'; listToShow.classList.add('active'); }
            document.querySelectorAll('#viewer-side-panel .tab-button').forEach(button => button.classList.remove('active'));
            const activeButton = document.getElementById(`tab-${tabName}`); if (activeButton) activeButton.classList.add('active');
            filterViewerLists();
         }
        window.showViewerPanelTab = showViewerPanelTab;

        function filterViewerLists() {
            const query = document.getElementById('viewer-search-input')?.value.toLowerCase() || '';
            const activeList = document.querySelector('.panel-list.active'); if (!activeList) return;
            activeList.querySelectorAll('.order-card, .driver-card').forEach(card => { const search = card.getAttribute('data-search') || ''; card.style.display = search.includes(query) ? 'block' : 'none'; });
        }
        window.filterViewerLists = filterViewerLists;

        function focusViewerMapItem(id, type) { // Remains the same
            let marker, card, listId; document.querySelectorAll('.driver-card, .order-card').forEach(c => c.classList.remove('active'));
            if (type === 'driver') { marker = viewerDriverMarkers[id]; card = document.getElementById(`viewer-driver-card-${id}`); listId = 'viewer-drivers-list'; }
            else { marker = viewerOrderMarkers[id]; card = document.getElementById(`viewer-order-card-${id}`); listId = 'viewer-orders-active-list'; }
            if (marker && viewerMap) { viewerMap.setView(marker.getLatLng(), 15); marker.openPopup(); }
            if (card) { card.classList.add('active'); const listEl = document.getElementById(listId); if (listEl) { const contRect = listEl.getBoundingClientRect(); const cardRect = card.getBoundingClientRect(); listEl.scrollTop += (cardRect.top - contRect.top) - 10; } }
        }
        window.focusViewerMapItem = focusViewerMapItem;


        // --- HELPERS (remain the same) ---
        async function playNotificationSound(note = "C5", duration = "8n") {
            try { if (!window.Tone) return; await Tone.start(); const synth = new Tone.Synth().toDestination(); synth.triggerAttackRelease(note, duration, Tone.now()); if (note !== "C5") synth.triggerAttackRelease(note, duration, Tone.now() + 0.2); SmartLog.info("Sound played.", 'Notifications'); }
            catch (e) { SmartLog.error(e, "Notifications.Sound"); }
        }
        function showLoader(elementId, show) {
            const container = document.getElementById(elementId); if (!container) return; let loader = container.querySelector('.loader-container');
            if (show) { if (!loader && !container.querySelector('.loader')) { loader = document.createElement('div'); loader.className = 'loader-container'; loader.innerHTML = `<div class="loader"></div>`; if (elementId !== 'viewer-map-loader') container.prepend(loader); else container.style.display = 'flex'; } else if (loader) loader.style.display = 'flex'; }
            else { if (loader) loader.style.display = 'none'; if (elementId === 'viewer-map-loader') container.style.display = 'none'; }
        }
        function showToast(message, type = 'info') {
            SmartLog.info(`Toast-${type}: ${message}`, "UI.Toast");
            const container = document.getElementById('toast-container'); if (!container) return; const toast = document.createElement('div'); toast.className = `toast ${type}`; toast.innerText = message; container.appendChild(toast); setTimeout(() => toast.classList.add('show'), 10); setTimeout(() => { toast.classList.remove('show'); setTimeout(() => { if (container.contains(toast)) container.removeChild(toast); }, 300); }, 5000);
        }

    </script>
    <!-- Service Worker Registration -->
     <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js') // Path relative to index.html
                    .then(registration => {
                        console.log('Viewer ServiceWorker registered: ', registration.scope);
                    })
                    .catch(registrationError => {
                        console.log('Viewer ServiceWorker registration failed: ', registrationError);
                    });
            });
        }
    </script>
</body>
</html>

