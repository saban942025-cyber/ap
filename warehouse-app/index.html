<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DeliveryMaster - טרמינל מחסן v50.7 (Modular + SW)</title>
    <!--
      Warehouse App v50.7 (Modular + SW)

      Changelog:
      - v50.7:
        - Refactored to use shared firebase-init.js module.
        - Added Service Worker registration.
        - Unified SmartLog usage.
      - v50.6: Added Global Ping listener.
      - v50.5: Updated coords, Added Call Driver button/logic.
      - v50.4: Firebase migration, map, listeners.
    -->

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/ryPT3r29/image.png">

    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- OneSignal -->
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <!-- Tone.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

    <style>
        /* CSS remains the same as v50.6 */
        :root { --primary-color: #007bff; --success: #28a745; --warning: #ffc107; --shadow-light: 0 8px 32px 0 rgba(31, 38, 135, 0.2); }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: 'Rubik', sans-serif; margin: 0; background: linear-gradient(135deg, #f5f7fa, #c3cfe2); color: #333; }
        .view { display: none !important; height: 100vh; } .view.active { display: flex !important; flex-direction: column; }
        .glass-card { background: rgba(255, 255, 255, 0.4); box-shadow: var(--shadow-light); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.6); }
        #loginView { justify-content: center; align-items: center; } .login-card { padding: 40px; text-align: center; width: 90%; max-width: 400px; } .login-card h2 { font-size: 1.8rem; margin-bottom: 20px; } .login-card input { width: 100%; padding: 15px; margin-bottom: 20px; border: none; border-radius: 12px; font-size: 1.2rem; text-align: center; background-color: rgba(255,255,255,0.5); color: #333; } .login-card button { width: 100%; padding: 15px; background-color: var(--primary-color); color:white; border:none; border-radius: 12px; font-size: 1.2rem; cursor: pointer; transition: transform 0.2s; } .login-card button:hover { transform: scale(1.05); }
        .app-header { padding: 15px 20px; z-index: 10; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; } #welcomeMessage { margin:0; font-size: 1.5em; }
        main { flex-grow: 1; overflow-y: auto; padding: 0 15px; }
        #warehouse-map { height: 300px; border-radius: 20px; margin: 15px 0; border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: var(--shadow-light); background-color: #eee; } .leaflet-popup-content-wrapper { border-radius: 8px; } .leaflet-popup-content { font-family: 'Rubik', sans-serif; }
        .order-section { margin-bottom: 30px; } .order-section h2 { padding-bottom: 10px; display: flex; align-items: center; gap: 10px; font-size: 1.5rem; }
        .order-card { margin: 10px 0; padding: 20px; } .order-card h4 { font-size: 1.2rem; margin-bottom: 10px; } .order-card p { opacity: 0.8; } .order-card button { width: 100%; padding: 12px; border: none; border-radius: 12px; color: white; cursor: pointer; font-size: 1em; margin-top: 15px; } .btn-acknowledge { background-color: var(--success); } .btn-load { background-color: var(--warning); } .btn-call-driver { background-color: var(--primary-color); margin-top: 8px; } button:disabled { background-color: #999; cursor: not-allowed; opacity: 0.7; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; display: inline-block; margin-right: 10px; } @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 5000; display: flex; flex-direction: column; gap: 8px; } .toast { padding: 12px 20px; background-color: var(--primary-color); color: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); opacity: 0; transform: translateY(20px); transition: all 0.3s ease; } .toast.show { opacity: 1; transform: translateY(0); }
    </style>
</head>
<body>

    <div id="loginView" class="view active">
        <div class="login-card glass-card">
            <h2>כניסת מנהל מחסן</h2>
            <input type="text" id="managerIdInput" placeholder="הזן קוד מנהל (OREN/TAMIR)">
            <button id="loginBtn">כניסה</button>
        </div>
    </div>

    <div id="mainView" class="view">
        <header class="app-header glass-card" style="margin: 15px; height: 70px;">
            <h1 id="welcomeMessage"></h1>
            <button id="logoutBtn" style="background:none; border:none; color:#333; font-size: 1.5em;"><i class="fas fa-sign-out-alt"></i></button>
        </header>
        <main>
            <div id="warehouse-map" class="glass-card" style="padding:0; overflow:hidden;"></div>
            <div id="newOrders" class="order-section"><h2><i class="fas fa-inbox"></i> הזמנות חדשות לאישור</h2><div id="newOrdersList"><p>טוען...</p></div></div>
            <div id="inProgressOrders" class="order-section"><h2><i class="fas fa-tasks"></i> הזמנות בתהליך</h2><div id="inProgressOrdersList"><p>טוען...</p></div></div>
        </main>
    </div>

    <div id="toast-container"></div>

    <script type="module">
        // --- Import from Shared Module ---
        import {
            db, authReadyPromise, SmartLog, // Core shared components
            collection, doc, onSnapshot, query, addDoc, updateDoc,
            serverTimestamp, where, setDoc, limit, orderBy, Timestamp // Firestore functions used + Timestamp
        } from '../shared/firebase-init.js'; // Adjust path if needed

        // --- App Logic (Modified v50.7) ---

        // DOM Elements
        const loginView = document.getElementById('loginView');
        const mainView = document.getElementById('mainView');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const managerIdInput = document.getElementById('managerIdInput');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const newOrdersList = document.getElementById('newOrdersList');
        const inProgressOrdersList = document.getElementById('inProgressOrdersList');

        let currentManager = null;
        let knownOrderIds = new Set();
        let state = { drivers: {}, orders: {}, locations: {} };
        let map; let driverMarkers = {};
        const warehouseCoords = { "החרש": [32.13266165049073, 34.898196599998755], "התלמיד": [32.16303427408473, 34.894926705310006] };

        // Map Icons
        const driverIconAvailable = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png', /*...*/ shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });
        const driverIconLoading = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-yellow.png', /*...*/ shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });
        const driverIconInactive = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-grey.png', /*...*/ shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });
        const warehouseIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png', /*...*/ shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });

        // OneSignal Init
        window.OneSignalDeferred = window.OneSignalDeferred || [];
        OneSignalDeferred.push(async function(OneSignal) {
            try { await OneSignal.init({ appId: "c711df10-6c87-4d81-889c-8e13963a155b" }); initWarehouseApp(OneSignal); }
            catch (e) { SmartLog.error(e, "OneSignal.Init"); initWarehouseApp(null); }
        });

        function initWarehouseApp(OneSignalInstance) {
            SmartLog.info("Initializing app v50.7 (Modular)...", "Init");
            loginBtn?.addEventListener('click', () => onLogin(OneSignalInstance));
            logoutBtn?.addEventListener('click', onLogout);
            const loggedInManager = JSON.parse(sessionStorage.getItem('warehouseManager'));
            if (loggedInManager) initApp(loggedInManager, OneSignalInstance);
            else switchView('loginView');
        }

        function onLogin(OneSignalInstance) {
            const managerId = managerIdInput.value.trim().toUpperCase();
            if(!managerId || !['OREN', 'TAMIR'].includes(managerId)) { alert('קוד מנהל לא תקין (OREN/TAMIR)'); return; }
            const managerData = { id: managerId, name: managerId === 'OREN' ? 'אורן' : 'תמיר', warehouse: managerId === 'OREN' ? 'החרש' : 'התלמיד' };
            sessionStorage.setItem('warehouseManager', JSON.stringify(managerData));
            initApp(managerData, OneSignalInstance);
        }

        function onLogout() {
            SmartLog.info("User logged out", "Auth");
            sessionStorage.removeItem('warehouseManager');
            if(window.OneSignal) OneSignal.logout().catch(e => SmartLog.error(e, "OneSignal.Logout"));
            switchView('loginView');
            // Consider stopping listeners explicitly here if needed before reload
            location.reload();
        }

        async function initApp(manager, OneSignalInstance) {
            SmartLog.info(`Initializing session for manager: ${manager.id}`, "Auth", { manager });
            currentManager = manager;
            if (welcomeMessage) welcomeMessage.textContent = `מחסן ${manager.warehouse} | ברוך הבא ${manager.name}`;
            switchView('mainView');

            try {
                await authReadyPromise; // Use imported promise
                SmartLog.info("Firebase Auth ready, initializing components.", "Init");
                initMap();
                listenToDrivers();
                listenToLocations();
                listenToOrders();
                listenToGlobalPings();
                if (OneSignalInstance) initializeNotifications(manager.id, OneSignalInstance);
                else SmartLog.warn("OneSignal failed, skipping notifications.", "Init");
            } catch (error) { SmartLog.error(error, "Init.Critical", { message: "Failed during initApp async." }); if (welcomeMessage) welcomeMessage.textContent = `שגיאת התחברות לשרת.`; }
        }

        // Map Functions (remain the same)
        function initMap() {
            if (map) map.remove();
            if (!currentManager || !warehouseCoords[currentManager.warehouse]) { SmartLog.error(new Error("Warehouse location unknown"), "Map.Init"); document.getElementById('warehouse-map').innerHTML = "שגיאה: מיקום מחסן לא ידוע"; return; }
            const center = warehouseCoords[currentManager.warehouse];
            map = L.map('warehouse-map').setView(center, 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM' }).addTo(map);
            L.marker(center, { icon: warehouseIcon }).addTo(map).bindPopup(`<b>המחסן (${currentManager.warehouse})</b>`);
            SmartLog.info("Map initialized", "Map.Init");
        }

        function renderWarehouseMap() {
            if (!map) return;
            // SmartLog.info("Rendering map markers...", "Map.Render"); // Can be noisy
            Object.values(state.locations).forEach(loc => {
                const driverId = loc.id; const driverData = state.drivers[driverId]; if (!driverData || !loc.latitude) return;
                let icon = driverIconInactive; let popup = `<b>${driverData.name}</b><br>לא פעיל`;
                const assignedOrder = Object.values(state.orders).find(o => o.driver?.id === driverId && o.status === 'שויך' && o.warehouse === currentManager.warehouse);
                const onDelivery = Object.values(state.orders).some(o => o.driver?.id === driverId && o.status === 'בדרך');
                const minutesAgo = loc.lastUpdate?.toDate ? Math.round((Date.now() - loc.lastUpdate.toDate().getTime()) / 60000) : '?';

                if (assignedOrder) { icon = driverIconLoading; popup = `<b>${driverData.name}</b><br>בדרך להעמיס #${assignedOrder.orderNumber || assignedOrder.id.slice(-6)}`; }
                else if (loc.isStuck) { popup = `<b>${driverData.name}</b><br>תקוע (${minutesAgo} דק')`; }
                else if (!onDelivery && minutesAgo !== '?' && minutesAgo < 15) { icon = driverIconAvailable; popup = `<b>${driverData.name}</b><br>פנוי (${minutesAgo} דק')`; }
                else if (onDelivery) { popup = `<b>${driverData.name}</b><br>במשלוח (${minutesAgo} דק')`; }
                else { popup = `<b>${driverData.name}</b><br>לא פעיל (${minutesAgo} דק')`; }

                const latLng = [loc.latitude, loc.longitude];
                if (driverMarkers[driverId]) driverMarkers[driverId].setLatLng(latLng).setIcon(icon).setPopupContent(popup);
                else driverMarkers[driverId] = L.marker(latLng, { icon }).addTo(map).bindPopup(popup);
            });
            Object.keys(driverMarkers).forEach(id => { if (!state.locations[id]) { if (map.hasLayer(driverMarkers[id])) map.removeLayer(driverMarkers[id]); delete driverMarkers[id]; } });
        }

        // Firebase Listeners (use imported functions)
        function listenToDrivers() {
            SmartLog.info("Listening to Drivers...", "Firestore.Listen");
            const q = query(collection(db, "drivers"));
            onSnapshot(q, (snapshot) => {
                // SmartLog.info(`Drivers: ${snapshot.docChanges().length} changes`, "Firestore.Snapshot");
                snapshot.docChanges().forEach(change => { state.drivers[change.doc.id] = { id: change.doc.id, ...change.doc.data() }; });
                renderWarehouseMap();
            }, e => SmartLog.error(e, "Firestore.Listen.Drivers"));
        }

        function listenToLocations() {
             SmartLog.info("Listening to Locations...", "Firestore.Listen");
             const q = query(collection(db, "driverLocations"));
             onSnapshot(q, (snapshot) => {
                 // SmartLog.info(`Locations: ${snapshot.docChanges().length} changes`, "Firestore.Snapshot");
                 snapshot.docChanges().forEach(change => {
                     if (change.type === "removed") delete state.locations[change.doc.id];
                     else state.locations[change.doc.id] = { id: change.doc.id, ...change.doc.data() };
                 });
                 renderWarehouseMap();
             }, e => SmartLog.error(e, "Firestore.Listen.Locations"));
        }

        function listenToOrders() {
            if (!currentManager) return;
            SmartLog.info(`Listening to orders for: ${currentManager.warehouse}`, "Firestore.Listen");
            const q = query( collection(db, "orders"), where("warehouse", "==", currentManager.warehouse), where("status", "in", ["חדש", "שויך", "באיסוף", "טעון"]) );
            onSnapshot(q, (snapshot) => {
                 // SmartLog.info(`Orders: ${snapshot.docChanges().length} changes`, "Firestore.Snapshot");
                 let newOrderDetected = false;
                 snapshot.docChanges().forEach(change => {
                      const orderId = change.doc.id; const orderData = { id: orderId, ...change.doc.data() };
                      const wasKnown = knownOrderIds.has(orderId);
                      if (change.type === "added") { state.orders[orderId] = orderData; if (orderData.status === 'חדש') { if (knownOrderIds.size > 0) newOrderDetected = true; knownOrderIds.add(orderId); } }
                      else if (change.type === "modified") { const oldStatus = state.orders[orderId]?.status; if (orderData.status === 'חדש' && oldStatus !== 'חדש' && knownOrderIds.size > 0) newOrderDetected = true; state.orders[orderId] = orderData; }
                      else if (change.type === "removed") { delete state.orders[orderId]; knownOrderIds.delete(orderId); }
                 });
                 // Populate known IDs on first load without beeping
                 if (knownOrderIds.size === 0 && Object.keys(state.orders).length > 0) { Object.values(state.orders).filter(o => o.status === 'חדש').forEach(o => knownOrderIds.add(o.id)); }
                 if (newOrderDetected) { SmartLog.info("New order detected.", "Orders"); playNotificationSound(); }
                 renderOrderLists(); renderWarehouseMap();
            }, (error) => { SmartLog.error(error, "Firestore.Listen.Orders"); if (newOrdersList) newOrdersList.innerHTML = `<p style="color:red;">שגיאת סנכרון.</p>`; });
        }

        function listenToGlobalPings() {
             SmartLog.info("Listening for Global Pings...", "Firestore.Listen");
             const since = Timestamp.fromDate(new Date(Date.now() - 60000)); // Use imported Timestamp
             const q = query( collection(db, "globalPings"), where("createdAt", ">", since), orderBy("createdAt", "desc"), limit(1) );
             let initialLoad = true;
             onSnapshot(q, (snapshot) => {
                 if (initialLoad) { initialLoad = false; return; }
                 snapshot.docChanges().forEach(change => { if (change.type === "added") { const ping = change.doc.data(); SmartLog.info("Global Ping Received!", "Pings", ping); playNotificationSound('A5', '4n'); showToast(`התראה מהמנהל: ${ping.message}`); } });
             }, e => SmartLog.error(e, "Firestore.Pings.Listener"));
        }

        // Render Functions (remain the same)
         function renderOrderLists() {
            if (!newOrdersList || !inProgressOrdersList) return;
            newOrdersList.innerHTML = ''; inProgressOrdersList.innerHTML = '';
            const allWarehouseOrders = Object.values(state.orders);
            const newOrders = allWarehouseOrders.filter(o => o.status === 'חדש');
            const inProgress = allWarehouseOrders.filter(o => ['באיסוף', 'טעון', 'שויך'].includes(o.status));

            if (newOrders.length === 0) newOrdersList.innerHTML = '<p>אין הזמנות חדשות.</p>';
            newOrders.forEach(order => newOrdersList.innerHTML += createOrderCard(order, 'acknowledge'));

            if (inProgress.length === 0) inProgressOrdersList.innerHTML = '<p>אין הזמנות בתהליך.</p>';
            inProgress.sort((a,b) => (a.status === 'שויך' ? -1 : 1)).forEach(order => inProgressOrdersList.innerHTML += createOrderCard(order, 'load'));
        }

        function createOrderCard(order, type) {
            let buttonHtml = '';
            if (type === 'acknowledge') buttonHtml = `<button class="btn-acknowledge" onclick="updateOrderStatus(event, '${order.id}', 'באיסוף')">אשר קבלה</button>`;
            else if (order.status === 'שויך') buttonHtml = `<button class="btn-call-driver" onclick="callDriverForLoading(event, '${order.id}')"><i class="fas fa-bullhorn" style="margin-left: 8px;"></i> קרא לנהג</button>`;
            else if (order.status === 'באיסוף') buttonHtml = `<button class="btn-load" onclick="updateOrderStatus(event, '${order.id}', 'טעון')">סמן כטעון</button>`;
            else buttonHtml = `<p style="color:var(--success); font-weight:bold; text-align:center; margin-top: 15px;">הועמס ✔️</p>`;
            const displayId = order.orderNumber || order.id.slice(-6);
            const driverName = order.driver?.name ? `(נהג: ${order.driver.name})` : '';
            return `<div class="order-card glass-card" data-order-id="${order.id}"><h4>${order.customer?.name || '?'} (${displayId})</h4><p><strong>כתובת:</strong> ${order.address || '?'}</p><p><strong>סוג:</strong> ${order.deliveryType || '?'} ${driverName}</p>${buttonHtml}</div>`;
        }

        // Action Functions (use imported functions)
        async function callDriverForLoading(event, orderId) {
            const btn = event.target.closest('button'); // Ensure we get the button element
            const order = state.orders[orderId];
            if (!order || !order.driver?.id) { alert("שגיאה: נהג לא משויך."); return; }
            if(btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> שולח...'; }
            try {
                playNotificationSound('G5', '8n');
                await setDoc(doc(collection(db, "driverPings")), { driverId: order.driver.id, orderId: orderId, warehouse: currentManager.warehouse, createdAt: serverTimestamp(), type: 'LOAD_REQUEST' });
                SmartLog.info(`Driver ping sent`, "CRUD.Ping", { orderId, driverId: order.driver.id });
                if(btn) btn.innerHTML = 'קריאה נשלחה <i class="fas fa-check"></i>';
                setTimeout(() => { if (!btn?.disabled) return; if(btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-bullhorn" style="margin-left: 8px;"></i> קרא לנהג'; } }, 3000);
            } catch (error) { SmartLog.error(error, "CRUD.Ping", { orderId }); alert("שגיאה בשליחת קריאה."); if(btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-bullhorn" style="margin-left: 8px;"></i> קרא לנהג'; } }
        }
        window.callDriverForLoading = callDriverForLoading;

        async function updateOrderStatus(event, orderId, newStatus) {
            SmartLog.info(`Updating order ${orderId} to: ${newStatus}`, "CRUD.Order");
            const btn = event.target.closest('button'); // Ensure we get the button element
            if(btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> מעדכן...'; }
             try {
                 const orderRef = doc(db, "orders", orderId);
                 await updateDoc(orderRef, { status: newStatus, lastModified: serverTimestamp() });
                 SmartLog.info(`Update success: ${orderId}.`, "CRUD.Order");
                 // Listener updates UI
             } catch (error) { SmartLog.error(error, "CRUD.Order.Update", { orderId, newStatus }); if(btn) { btn.disabled = false; btn.innerHTML = (newStatus === 'באיסוף' ? 'אשר קבלה' : 'סמן כטעון'); } } // Restore original text based on action
        }
        window.updateOrderStatus = updateOrderStatus;

        // Helper Functions (remain the same)
        async function playNotificationSound(note = "C5", duration = "8n") {
            try { if (!window.Tone) return; await Tone.start(); const synth = new Tone.Synth().toDestination(); synth.triggerAttackRelease(note, duration); SmartLog.info("Sound played.", 'Notifications'); }
            catch (e) { SmartLog.error(e, "Notifications.Sound"); }
        }
        function switchView(viewId) { document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); const el = document.getElementById(viewId); if (el) el.classList.add('active'); }
        async function initializeNotifications(managerId, OneSignal) {
             try { await OneSignal.Notifications.requestPermission(); await OneSignal.login(managerId); const playerId = OneSignal.User.onesignalId; if (playerId) { SmartLog.info(`Registering OneSignal: ${playerId}`, "OneSignal"); const deviceRef = doc(db, "warehouseDevices", playerId); await setDoc(deviceRef, { managerId: managerId, warehouse: currentManager.warehouse, registeredAt: serverTimestamp() }); SmartLog.info("Device registered", "OneSignal"); } } catch (e) { SmartLog.error(e, "OneSignal.Register"); }
        }
        function showToast(message) {
            const container = document.getElementById('toast-container'); if (!container) return;
            const toast = document.createElement('div'); toast.className = 'toast'; toast.innerText = message; container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => { toast.classList.remove('show'); setTimeout(() => { if (container.contains(toast)) container.removeChild(toast); }, 300); }, 5000);
        }

        // Fallback Init (remains the same)
        setTimeout(() => { if (!currentManager && !mainView?.classList.contains('active')) { SmartLog.warn("OneSignal timeout, manual init.", "Init"); initWarehouseApp(null); } }, 3000);

    </script>
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js') // Path relative to index.html
                    .then(registration => {
                        console.log('Warehouse ServiceWorker registered: ', registration.scope);
                    })
                    .catch(registrationError => {
                        console.log('Warehouse ServiceWorker registration failed: ', registrationError);
                    });
            });
        }
    </script>
</body>
</html>
