<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>×“×©×‘×•×¨×“ ×¨××©×™ - ×—.×¡×‘×Ÿ</title>
    <meta name="theme-color" content="#0b72b9"/>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        :root {
            --brand: #0b72b9; --accent: #ff9f1c; --bg: #f0f2f5; --card: #ffffff;
            --text-dark: #1a202c; --text-light: #4a5568; --text-muted: #718096;
            --border: #e2e8f0; --success: #38a169; --warning: #dd6b20; --danger: #e53e3e;
            --radius: 16px; --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --status-new: #a0aec0; --status-processing: #4299e1; --status-shipped: #ed8936; 
            --status-delivered: #38a169; --status-cancelled: #e53e3e;
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes statusPulse { 0% { box-shadow: 0 0 0 0 rgba(66, 153, 225, 0.5); } 70% { box-shadow: 0 0 0 10px rgba(66, 153, 225, 0); } 100% { box-shadow: 0 0 0 0 rgba(66, 153, 225, 0); } }
        
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; overflow: hidden; background-color: var(--bg); }
        body { font-family: 'Assistant', sans-serif; color: var(--text-dark); display: flex; flex-direction: column; overscroll-behavior-y: contain; }
        .app-shell { display: flex; flex-direction: column; height: 100%; }
        .app-header { flex-shrink: 0; display: flex; align-items: center; justify-content: space-between; padding: 10px 15px; background-color: var(--card); border-bottom: 1px solid var(--border); position: relative; z-index: 10; }
        .app-container { flex-grow: 1; overflow-y: auto; padding: 20px 15px 100px 15px; }
        
        .page-title { font-size: 28px; font-weight: 700; margin-bottom: 20px; animation: fadeIn 0.5s ease-out forwards; }
        .card { background-color: var(--card); border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow); margin-bottom: 20px; border: 1px solid var(--border); animation: popIn 0.5s ease-out forwards; overflow: hidden; }
        .btn { background: var(--brand); color: white; border: none; padding: 12px 18px; border-radius: 10px; cursor: pointer; font-weight: 700; font-size: 15px; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s; width: 100%; }
        .btn:active { transform: scale(0.95); }
        .btn.secondary { background-color: var(--bg); color: var(--text-dark); border: 1px solid var(--border); }
        
        .dashboard-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
        .dashboard-card { background: var(--card); border-radius: var(--radius); padding: 15px; text-align: center; box-shadow: var(--shadow); transition: transform 0.2s, box-shadow 0.2s; }
        .dashboard-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .dashboard-value { font-size: 24px; font-weight: 700; margin: 5px 0; }
        .dashboard-label { font-size: 14px; color: var(--text-muted); }
        
        .mini-map-container { border-radius: 12px; border: 1px solid var(--border); height: 150px; width: 100%; margin-top: 15px; background-color: #eee; }
        .leaflet-control-zoom, .leaflet-control-attribution { display: none !important; }
        .profile-avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--border); }
        
        .status-cube { width: 20px; height: 20px; border-radius: 4px; display: inline-block; margin-left: 8px; animation: statusPulse 2s infinite; }
        .status-new { background-color: var(--status-new); }
        .status-processing { background-color: var(--status-processing); }
        .status-shipped { background-color: var(--status-shipped); }
        .status-delivered { background-color: var(--status-delivered); }
        .status-cancelled { background-color: var(--status-cancelled); }
        
        .order-status { display: flex; align-items: center; gap: 10px; margin: 10px 0; padding: 10px; border-radius: var(--radius); background-color: var(--bg); }
        
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 80px; background-color: var(--card); display: flex; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; }
        .nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; color: var(--text-muted); text-decoration: none; font-weight: 600; font-size: 14px; border: none; background: transparent; cursor: pointer; transition: color 0.2s, transform 0.2s;}
        .nav-btn.active { color: var(--brand); }
        .nav-btn svg { width: 28px; height: 28px; pointer-events: none; }
        
        #toast-container { position: fixed; top: 20px; left: 15px; right: 15px; z-index: 4000; display: flex; flex-direction: column; gap: 10px; align-items: center;}
        .toast { display: flex; align-items: center; gap: 12px; width: 100%; max-width: 400px; background: var(--card); color: var(--text-dark); padding: 14px 22px; border-radius: var(--radius); font-weight: 600; box-shadow: 0 4px 20px rgba(0,0,0,0.15); border: 1px solid var(--border); opacity: 0; transform: translateY(-20px); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .toast.show { opacity: 1; transform: translateY(0); }
        
        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; z-index: 2000; opacity: 0; visibility: hidden; transition: opacity 0.3s; backdrop-filter: blur(5px); }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal-content { background-color: white; padding: 25px; border-radius: var(--radius); width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; animation: popIn 0.3s; }
        
        #splash-screen { position: fixed; inset: 0; z-index: 9999; background-color: #ffffff; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s ease, visibility 0.5s ease; }
        #splash-logo { width: 120px; }
        .splash-loader { width: 40px; height: 40px; border: 4px solid rgba(11, 114, 185, 0.2); border-top-color: var(--brand); border-radius: 50%; animation: spin 1s linear infinite; margin-top: 20px; opacity: 0; transition: opacity 0.3s; }
        #splash-screen.loading .splash-loader { opacity: 1; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .quick-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .quick-action-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--card); border-radius: var(--radius); padding: 20px 10px; text-align: center; box-shadow: var(--shadow); transition: all 0.2s; border: 1px solid var(--border); text-decoration: none; color: inherit; }
        .quick-action-btn:active { transform: scale(0.95); }
        .quick-action-btn svg { width: 40px; height: 40px; margin-bottom: 10px; color: var(--brand); }
        
        .order-item { padding: 10px; border-bottom: 1px solid var(--border); }
        .order-item:last-child { border-bottom: none; }
        
        .login-form { max-width: 400px; margin: 0 auto; padding: 20px; }
        .login-form input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 8px; font-size: 16px; }
    </style>
</head>
<body>
    <div class="app-shell">
        <header class="app-header">
            <div id="profile-container" class="profile-container">
                <img id="profile-avatar" src="https://img.icons8.com/?size=100&id=Ry7mumEprV9w&format=png&color=000000" alt="Profile" class="profile-avatar">
            </div>
             <h1 id="client-name-header" style="font-weight: 700; font-size: 16px;">...</h1>
            <div style="text-align: center; font-weight: 600;">
                <div id="clock"></div>
                <div id="date" style="font-size: 12px; color: var(--text-muted);"></div>
            </div>
        </header>

        <main class="app-container" id="app-container">
            <!-- Login Form (initially hidden) -->
            <div id="login-section" class="card" style="display: none;">
                <h2 class="page-title">×”×ª×—×‘×¨×•×ª</h2>
                <form id="login-form" class="login-form">
                    <input type="text" id="login-identifier" placeholder="××¡×¤×¨ ×œ×§×•×— / ×˜×œ×¤×•×Ÿ" required>
                    <button type="submit" class="btn">×”×ª×—×‘×¨</button>
                </form>
            </div>
            
            <!-- Dashboard Content (initially hidden) -->
            <div id="dashboard-content" style="display: none;">
                <h1 class="page-title" id="greeting"></h1>
                
                <!-- Dashboard -->
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <div class="dashboard-value" id="active-containers">0</div>
                        <div class="dashboard-label">××›×•×œ×•×ª ×¤×¢×™×œ×•×ª</div>
                    </div>
                    <div class="dashboard-card">
                        <div class="dashboard-value" id="pending-orders">0</div>
                        <div class="dashboard-label">×”×–×× ×•×ª ×××ª×™× ×•×ª</div>
                    </div>
                </div>
                
                <!-- Active Orders -->
                <div class="card">
                    <h2 style="margin-bottom: 15px;">×”×–×× ×•×ª ×¤×¢×™×œ×•×ª</h2>
                    <div id="active-orders-container">
                        <p style="color: var(--text-muted);">×˜×•×¢×Ÿ ×”×–×× ×•×ª...</p>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="card">
                    <h2 style="margin-bottom: 15px;">×¤×¢×•×œ×•×ª ××”×™×¨×•×ª</h2>
                    <div class="quick-actions">
                        <a id="materials-link" href="#" class="quick-action-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                                <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
                            </svg>
                            <span>×—×•××¨×™ ×‘× ×™×Ÿ</span>
                        </a>
                        <a id="containers-link" href="#" class="quick-action-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14 11V5a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-5"></path>
                                <path d="M20 7h-5a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h5a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"></path>
                            </svg>
                            <span>××›×•×œ×•×ª</span>
                        </a>
                    </div>
                </div>
                
                <!-- Order Location Map -->
                <div class="card">
                    <h2 style="margin-bottom: 15px;">××™×§×•× ×”×–×× ×•×ª ×¤×¢×™×œ×•×ª</h2>
                    <div id="map" class="mini-map-container"></div>
                </div>
                
                <!-- Recent Orders -->
                <div class="card">
                    <h2 style="margin-bottom: 15px;">×”×–×× ×•×ª ××—×¨×•× ×•×ª</h2>
                    <div id="recent-orders-list" class="space-y-2">
                        <p style="color: var(--text-muted);">×˜×•×¢×Ÿ ×”×–×× ×•×ª...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <nav class="bottom-nav" style="display: none;" id="bottom-nav">
        <button class="nav-btn active" data-action="navigate" data-page="page-home">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
            <span>×“×£ ×”×‘×™×ª</span>
        </button>
        <button class="nav-btn" data-action="navigate" data-page="page-materials">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>
            <span>×—×•××¨×™ ×‘× ×™×Ÿ</span>
        </button>
        <button class="nav-btn" data-action="navigate" data-page="page-history">
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>
            <span>×”×™×¡×˜×•×¨×™×”</span>
        </button>
    </nav>
    
    <div id="splash-screen"><img id="splash-logo" src="https://i.postimg.cc/2SbDgD1B/1.png" alt="×œ×•×’×• ×—.×¡×‘×Ÿ"><div class="splash-loader"></div></div>
    <div id="toast-container"></div>
    <div id="modal-container" class="modal-overlay"></div>

    <script>
        // Main Application Logic
        document.addEventListener('DOMContentLoaded', () => {
            let clientState = { 
                id: null, 
                name: null, 
                avatar: null, 
                orders: []
            };
            
            const dom = {};

            function initApp() {
                cacheDomElements();
                updateClock();
                setInterval(updateClock, 1000);
                
                // Check if user is already logged in
                checkAuthentication();
            }
            
            function cacheDomElements(){
                Object.assign(dom, {
                    appShell: document.querySelector('.app-shell'),
                    splashScreen: document.getElementById('splash-screen'),
                    modalContainer: document.getElementById('modal-container'),
                    toastContainer: document.getElementById('toast-container'),
                    loginSection: document.getElementById('login-section'),
                    dashboardContent: document.getElementById('dashboard-content'),
                    loginForm: document.getElementById('login-form'),
                    bottomNav: document.getElementById('bottom-nav'),
                    activeOrdersContainer: document.getElementById('active-orders-container'),
                    greeting: document.getElementById('greeting'),
                    clientNameHeader: document.getElementById('client-name-header'),
                    profileAvatar: document.getElementById('profile-avatar'),
                    clock: document.getElementById('clock'),
                    date: document.getElementById('date'),
                    recentOrdersList: document.getElementById('recent-orders-list'),
                    activeContainers: document.getElementById('active-containers'),
                    pendingOrders: document.getElementById('pending-orders'),
                    materialsLink: document.getElementById('materials-link'),
                    containersLink: document.getElementById('containers-link'),
                    navButtons: document.querySelectorAll('.nav-btn')
                });
            }
            
            function checkAuthentication() {
                console.log("--- ×“×©×‘×•×¨×“: ××ª×—×™×œ ×‘×“×™×§×ª ××™××•×ª ---");

                const urlParams = new URLSearchParams(window.location.search);
                const customerIdFromUrl = urlParams.get('customerId');
                console.log("×©×œ×‘ 1: ××¡×¤×¨ ×œ×§×•×— ××›×ª×•×‘×ª ×”××ª×¨:", customerIdFromUrl);
                
                const loggedInUserString = sessionStorage.getItem('loggedInUser');
                console.log("×©×œ×‘ 2: ××™×“×¢ ×’×•×œ××™ ××–×™×›×¨×•×Ÿ ×”×“×¤×“×¤×Ÿ:", loggedInUserString);

                // If no session found, show login form
                if (!loggedInUserString) {
                    console.log("×œ× × ××¦× ××™×“×¢ ×”×ª×—×‘×¨×•×ª, ××¦×™×’ ×˜×•×¤×¡ ×”×ª×—×‘×¨×•×ª");
                    showLoginForm();
                    return;
                }

                const loggedInUser = JSON.parse(loggedInUserString);
                console.log("×©×œ×‘ 3: ××•×‘×™×™×§×˜ ×”××©×ª××© ×©×¤×•×¢× ×—:", loggedInUser);

                const customerIdFromSession = loggedInUser['××¡×¤×¨ ×œ×§×•×—'];
                console.log("×©×œ×‘ 4: ××¡×¤×¨ ×œ×§×•×— ×©×—×•×œ×¥ ×××•×‘×™×™×§×˜ ×”××©×ª××©:", customerIdFromSession);

                const finalIdFromUrl = String(customerIdFromUrl || '').trim();
                const finalIdFromSession = String(customerIdFromSession || '').trim();

                console.log(`×©×œ×‘ 5: ××‘×¦×¢ ×”×©×•×•××”: ×”×× "${finalIdFromUrl}" (××”×›×ª×•×‘×ª) ×–×”×” ×œ-"${finalIdFromSession}" (××”×–×™×›×¨×•×Ÿ)?`);

                if (finalIdFromUrl && finalIdFromSession && finalIdFromUrl !== finalIdFromSession) {
                    console.error("×©×’×™××ª ××™××•×ª: ××¡×¤×¨×™ ×”×œ×§×•×— ××™× × ×–×”×™×! ××‘×¦×¢ ×”×¤× ×™×” ×œ×“×£ ×”×ª×—×‘×¨×•×ª.");
                    showLoginForm();
                    return;
                }

                console.log("××™××•×ª ×¢×‘×¨ ×‘×”×¦×œ×—×”! ×˜×•×¢×Ÿ ××ª ×”×“×©×‘×•×¨×“.");

                // If we reached here, the user is authorized
                const finalCustomerId = finalIdFromUrl || finalIdFromSession;
                clientState.id = finalCustomerId;
                clientState.name = loggedInUser['×©× ×œ×§×•×—'];
                
                // Load client data
                loadClientData(finalCustomerId);
            }
            
            function showLoginForm() {
                // Hide splash screen
                dom.splashScreen.style.opacity = '0';
                setTimeout(() => {
                    dom.splashScreen.style.display = 'none';
                    
                    // Show login form
                    dom.loginSection.style.display = 'block';
                    
                    // Set up login form handler
                    dom.loginForm.addEventListener('submit', handleLogin);
                }, 500);
            }
            
            function handleLogin(event) {
                event.preventDefault();
                
                const identifier = document.getElementById('login-identifier').value.trim();
                if (!identifier) {
                    showToast("×× × ×”×–×Ÿ ××¡×¤×¨ ×œ×§×•×— ××• ×˜×œ×¤×•×Ÿ", 'âš ï¸');
                    return;
                }
                
                // Show loading state
                const submitBtn = dom.loginForm.querySelector('button');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = '××ª×—×‘×¨...';
                submitBtn.disabled = true;
                
                // Simulate login process
                setTimeout(() => {
                    // For demo purposes, create a mock user
                    const mockUser = {
                        '××¡×¤×¨ ×œ×§×•×—': identifier,
                        '×©× ×œ×§×•×—': `×œ×§×•×— ${identifier}`,
                        '×˜×œ×¤×•×Ÿ': '050-0000000'
                    };
                    
                    // Save to session storage
                    sessionStorage.setItem('loggedInUser', JSON.stringify(mockUser));
                    
                    // Update client state
                    clientState.id = identifier;
                    clientState.name = mockUser['×©× ×œ×§×•×—'];
                    
                    // Hide login form and show dashboard
                    dom.loginSection.style.display = 'none';
                    
                    // Load client data
                    loadClientData(identifier);
                    
                    // Reset button
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }, 1000);
            }
            
            function loadClientData(clientId) {
                try {
                    // Create mock data based on client ID
                    const mockData = generateMockData(clientId);
                    
                    clientState = { 
                        ...clientState, 
                        avatar: mockData.avatarUrl, 
                        orders: mockData.orders || [] 
                    };
                    
                    // Hide splash screen and show content
                    setTimeout(() => {
                        dom.splashScreen.style.opacity = '0';
                        setTimeout(() => {
                            dom.splashScreen.style.display = 'none';
                            dom.dashboardContent.style.display = 'block';
                            dom.bottomNav.style.display = 'flex';
                            
                            renderDashboard();
                            setupEventListeners();
                        }, 500);
                    }, 500);
                    
                } catch (error) {
                    console.error("Failed to load client data:", error);
                    showToast("×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™×.", 'âŒ');
                    
                    // Fallback: hide splash screen even on error
                    setTimeout(() => {
                        dom.splashScreen.style.opacity = '0';
                        setTimeout(() => {
                            dom.splashScreen.style.display = 'none';
                            dom.loginSection.style.display = 'block';
                        }, 500);
                    }, 500);
                }
            }
            
            function generateMockData(clientId) {
                // Generate consistent mock data based on client ID
                const clientNum = parseInt(clientId) || 1;
                
                const projects = [
                    '×‘× ×™×™×Ÿ ××’×•×¨×™× ×ª×œ ××‘×™×‘',
                    '××©×¨×“×™× ×¨××ª ×’×Ÿ',
                    '×•×™×œ×” ×”×¨×¦×œ×™×”',
                    '××¨×›×– ××¡×—×¨×™ ×—×™×¤×”',
                    '××’×“×œ ××©×¨×“×™× ×™×¨×•×©×œ×™×'
                ];
                
                const addresses = [
                    '×“×™×–× ×’×•×£ 123, ×ª×œ ××‘×™×‘',
                    '××‘× ×”×œ×œ 45, ×¨××ª ×’×Ÿ',
                    '×”×¨×¦×œ 78, ×”×¨×¦×œ×™×”',
                    '×”× ××œ 22, ×—×™×¤×”',
                    '×™afo 56, ×™×¨×•×©×œ×™×'
                ];
                
                const statuses = ['×—×“×©', '×‘×¢×™×‘×•×“', '×‘××©×œ×•×—', '× ××¡×¨', '×‘×•×˜×œ'];
                
                const orders = [];
                const numOrders = (clientNum % 3) + 2; // 2-4 orders based on client ID
                
                for (let i = 0; i < numOrders; i++) {
                    const projectIndex = (clientNum + i) % projects.length;
                    const addressIndex = (clientNum + i) % addresses.length;
                    const statusIndex = (clientNum + i) % statuses.length;
                    const daysAgo = i * 3;
                    
                    orders.push({
                        '×ª×¢×•×“×”': `ORD${clientNum}${i+1}`,
                        '×©× ×¤×¨×•×™×§×˜': projects[projectIndex],
                        '×›×ª×•×‘×ª': addresses[addressIndex],
                        '×¡×˜×˜×•×¡': statuses[statusIndex],
                        '×ª××¨×™×š ×”×–×× ×”': new Date(Date.now() - daysAgo * 86400000).toISOString()
                    });
                }
                
                return {
                    avatarUrl: 'https://img.icons8.com/?size=100&id=Ry7mumEprV9w&format=png&color=000000',
                    orders: orders
                };
            }

            function updateClock() {
                const now = new Date();
                // Convert to Israel timezone
                const options = { timeZone: 'Asia/Jerusalem', hour: '2-digit', minute: '2-digit' };
                dom.clock.textContent = now.toLocaleTimeString('he-IL', options);
                
                const dateOptions = { timeZone: 'Asia/Jerusalem', weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
                dom.date.textContent = now.toLocaleDateString('he-IL', dateOptions);
            }
            
            function renderDashboard() {
                dom.clientNameHeader.textContent = clientState.name;
                dom.greeting.textContent = `×©×œ×•×, ${clientState.name}`;
                dom.profileAvatar.src = clientState.avatar;
                dom.materialsLink.href = `./Materials.html?customerId=${clientState.id}`;
                dom.containersLink.href = `./containers.html?customerId=${clientState.id}`;
                
                renderActiveOrders();
                renderRecentOrders();
                updateDashboard();
                initMap();
            }
            
            function renderActiveOrders() {
                const activeOrders = clientState.orders.filter(o => 
                    o['×¡×˜×˜×•×¡'] !== '× ××¡×¨' && o['×¡×˜×˜×•×¡'] !== '×‘×•×˜×œ'
                );
                const container = dom.activeOrdersContainer;
                container.innerHTML = '';
                
                if (activeOrders.length > 0) {
                    activeOrders.forEach(order => {
                        const cardElement = createOrderCardElement(order);
                        container.appendChild(cardElement);
                    });
                } else {
                    container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 20px;">××™×Ÿ ×œ×š ×›×¨×’×¢ ×”×–×× ×•×ª ×¤×¢×™×œ×•×ª.</p>';
                }
            }
            
            function renderRecentOrders() {
                const recentOrders = clientState.orders.slice(0, 5); // Show last 5 orders
                const listEl = dom.recentOrdersList;
                
                if (recentOrders.length === 0) {
                    listEl.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 20px;">××™×Ÿ ×”×–×× ×•×ª ××—×¨×•× ×•×ª ×œ×”×¦×’×”.</p>';
                    return;
                }
                
                listEl.innerHTML = recentOrders.map(order => `
                    <div class="order-item">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${formatDate(order['×ª××¨×™×š ×”×–×× ×”'])}</strong>
                                <div style="font-size: 14px; color: var(--text-muted);">${order['×›×ª×•×‘×ª']}</div>
                            </div>
                            <div class="order-status">
                                <span class="status-cube status-${getStatusClass(order['×¡×˜×˜×•×¡'])}"></span>
                                <span>${order['×¡×˜×˜×•×¡']}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            function createOrderCardElement(order) {
                const card = document.createElement('div');
                card.className = 'order-card';
                card.style.padding = '15px';
                card.style.borderBottom = '1px solid var(--border)';
                card.innerHTML = `
                    <h3 style="margin-bottom: 10px; font-size: 18px;">${order['×©× ×¤×¨×•×™×§×˜'] || `×”×–×× ×”`}</h3>
                    <p style="margin-bottom: 10px; color: var(--text-light);">${order['×›×ª×•×‘×ª']}</p>
                    <div class="order-status">
                        <span>×¡×˜×˜×•×¡:</span>
                        <span class="status-cube status-${getStatusClass(order['×¡×˜×˜×•×¡'])}"></span>
                        <span>${order['×¡×˜×˜×•×¡']}</span>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="btn secondary" data-action="request-swap" data-id="${order['×ª×¢×•×“×”']}" style="flex: 1; font-size: 14px; padding: 8px;">×”×—×œ×¤×”</button>
                        <button class="btn" data-action="request-pickup" data-id="${order['×ª×¢×•×“×”']}" style="flex: 1; font-size: 14px; padding: 8px;">×¤×™× ×•×™</button>
                    </div>`;
                return card;
            }
            
            function initMap() {
                const mapContainer = document.getElementById('map');
                if (!mapContainer) return;
                
                // Use the first active order's address for the map
                const activeOrders = clientState.orders.filter(o => 
                    o['×¡×˜×˜×•×¡'] !== '× ××¡×¨' && o['×¡×˜×˜×•×¡'] !== '×‘×•×˜×œ'
                );
                
                if (activeOrders.length > 0) {
                    const order = activeOrders[0];
                    renderLeafletMap(mapContainer, order['×›×ª×•×‘×ª']);
                } else {
                    mapContainer.innerHTML = '<p style="text-align: center; padding: 60px 0; color: var(--text-muted);">××™×Ÿ ×”×–×× ×•×ª ×¤×¢×™×œ×•×ª ×œ×”×¦×’×” ×‘××¤×”</p>';
                }
            }
            
            function renderLeafletMap(container, address) {
                if (!container || !address) return;
                
                // Use a default location for demo (Tel Aviv)
                const defaultCoords = [32.0853, 34.7818]; // Tel Aviv coordinates
                
                try {
                    const map = L.map(container, { zoomControl: false }).setView(defaultCoords, 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: 'Â© OpenStreetMap contributors'
                    }).addTo(map);
                    
                    L.marker(defaultCoords).addTo(map)
                        .bindPopup(address)
                        .openPopup();
                        
                } catch (err) { 
                    container.innerHTML = '<p style="text-align: center; padding: 60px 0; color: var(--text-muted);">××¤×” ×œ× ×–××™× ×” ×›×¨×’×¢</p>'; 
                }
            }

            function updateDashboard() {
                // Calculate counts based on order status
                const activeContainersCount = clientState.orders.filter(o => 
                    ['×‘×¢×™×‘×•×“', '×‘××©×œ×•×—'].includes(o['×¡×˜×˜×•×¡'])
                ).length;
                
                const pendingOrdersCount = clientState.orders.filter(o => 
                    o['×¡×˜×˜×•×¡'] === '×‘×¢×™×‘×•×“'
                ).length;
                
                dom.activeContainers.textContent = activeContainersCount;
                dom.pendingOrders.textContent = pendingOrdersCount;
            }

            // --- UTILITY FUNCTIONS ---
            async function sendClientRequest(requestType, orderId) {
                 try {
                    showToast("×©×•×œ×— ×‘×§×©×”...", 'ğŸ’¬');
                    
                    // Simulate API call delay
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    showToast("×‘×§×©×ª×š × ×©×œ×—×” ×‘×”×¦×œ×—×”!", 'âœ…');
                    
                    // Save request to localStorage for persistence
                    const requests = JSON.parse(localStorage.getItem('clientRequests') || '[]');
                    requests.push({
                        clientId: clientState.id,
                        clientName: clientState.name,
                        requestType: requestType,
                        orderId: orderId,
                        timestamp: new Date().toISOString(),
                        status: 'new'
                    });
                    localStorage.setItem('clientRequests', JSON.stringify(requests));
                    
                } catch (error) { 
                    showToast(`×©×’×™××” ×‘×©×œ×™×—×ª ×”×‘×§×©×”`, 'âŒ'); 
                }
            }

            function showToast(message, icon = 'â„¹ï¸') {
                const toast = document.createElement('div');
                toast.className = 'toast';
                toast.innerHTML = `<span>${icon}</span> ${message}`;
                dom.toastContainer.appendChild(toast);
                
                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => { 
                    toast.classList.remove('show'); 
                    setTimeout(() => toast.remove(), 400); 
                }, 4000);
            }

            function getStatusClass(status) {
                const statusMap = {
                    '×—×“×©': 'new',
                    '×‘×¢×™×‘×•×“': 'processing',
                    '×‘××©×œ×•×—': 'shipped',
                    '× ××¡×¨': 'delivered',
                    '×‘×•×˜×œ': 'cancelled'
                };
                return statusMap[status] || 'new';
            }

            function formatDate(dateString) {
                if (!dateString) return '×ª××¨×™×š ×œ× ×–××™×Ÿ';
                try {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('he-IL');
                } catch (e) {
                    return dateString;
                }
            }

            function setupEventListeners() {
                // Navigation buttons
                dom.navButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const page = e.currentTarget.dataset.page;
                        dom.navButtons.forEach(b => b.classList.remove('active'));
                        e.currentTarget.classList.add('active');
                        
                        // Handle navigation
                        if (page === 'page-home') {
                            // Already on home page
                            window.location.href = `./dashboard.html?customerId=${clientState.id}`;
                        } else if (page === 'page-materials') {
                            window.location.href = `./Materials.html?customerId=${clientState.id}`;
                        } else if (page === 'page-history') {
                            window.location.href = `./history.html?customerId=${clientState.id}`;
                        }
                    });
                });
                
                // Order action buttons
                document.addEventListener('click', (e) => {
                    if (e.target.matches('[data-action="request-swap"]')) {
                        const orderId = e.target.dataset.id;
                        sendClientRequest('swap', orderId);
                    } else if (e.target.matches('[data-action="request-pickup"]')) {
                        const orderId = e.target.dataset.id;
                        sendClientRequest('pickup', orderId);
                    }
                });
                
                // Logout functionality (optional - could add a logout button)
                // For now, clearing sessionStorage will log the user out
            }

            // Initialize the application
            initApp();
        });
    </script>
</body>
</html>
