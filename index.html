<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeliveryMaster v32.5 (Fixed & Resilient)</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <!-- נכסים חיצוניים - נטען עם defer/async לשיפור מהירות -->
    <script src="https://cdn.tailwindcss.com" async></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
    <script src="https://unpkg.com/feather-icons" defer></script>
    <!-- Firebase SDK - קריטי, נטען עם defer -->
    <!-- שימוש בגרסת Compat לרוחב פס טוב יותר -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js" defer></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- סגנונות CSS - לוגיקת תגובתיות Mobile/Desktop -->
    <style>
        :root {
            --primary-color: #3b82f6;
            --bg-light: #f3f4f6;
            --text-dark: #1f2937;
        }
        body {
            font-family: 'Inter', 'Arial', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            overflow: hidden;
            margin: 0;
        }
        .app-layout {
            display: grid;
            grid-template-columns: 80px 1fr; /* Default Desktop */
            height: 100vh;
        }
        #navbar {
             width: 80px;
             background-color: #ffffff;
             border-left: 1px solid var(--border-color);
             transition: width 0.3s ease-in-out;
        }
        #navbar .nav-link {
            transition: background-color 0.2s;
        }
        #map { height: 100%; width: 100%; z-index: 10; }
        .app-view { width: 100%; height: 100vh; overflow: hidden; display: none; }
        .app-view.active { display: block; }
        #view-dashboard { display: grid; grid-template-columns: 1fr 350px; overflow: hidden; }
        .app-view.active#view-dashboard { display: grid; }
        .connection-status-dot {
            width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-left: 4px; transition: background-color 0.3s;
        }
        .status-online { background-color: #22c55e; }
        .status-degraded { background-color: #f59e0b; }
        .status-offline { background-color: #ef4444; }

        /* Responsive Breakpoint (900px) */
        @media (max-width: 900px) {
            .app-layout {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr 56px; /* Content then Mobile Navbar */
            }
            #navbar {
                width: 100%;
                flex-direction: row;
                position: fixed;
                bottom: 0;
                right: 0;
                left: 0;
                height: 56px;
                padding: 0;
                z-index: 2001;
                border-left: none;
                border-top: 1px solid var(--border-color);
            }
            #navbar .hidden.lg\:flex, #navbar .hidden.lg\:block { display: none !important; }
            #navbar .nav-link { flex: 1; justify-content: center; padding: 10px; border-right: none !important; border-bottom: none !important; }
            #navbar .nav-link span { display: none; }
            #navbar .nav-link.active { border-bottom: 3px solid var(--primary-color) !important; }

            /* Panel for Mobile */
            #side-panel {
                position: fixed;
                bottom: 56px;
                left: 0;
                right: 0;
                height: 40vh;
                z-index: 2000;
                transform: translateY(100%);
                transition: transform 0.3s ease;
            }
            #side-panel.open { transform: translateY(0); }
            .app-view { height: 100%; }
            #view-dashboard { grid-template-columns: 1fr !important; grid-template-rows: 1fr auto; }
        }
    </style>
</head>
<body class="antialiased">

    <!-- פריסת היישום -->
    <div class="app-layout">
        <!-- תוכן ראשי (Main Content) -->
        <div class="relative">
            <main id="view-dashboard" class="app-view active">
                 <div id="map-container">
                    <div id="map"></div>
                    <div id="map-loader" class="loader-container absolute inset-0 bg-white/70 flex items-center justify-center z-20" style="display: none;">
                        <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
                        <span class="mr-4 font-semibold text-gray-700">טוען מפה ומאמת...</span>
                    </div>
                </div>
                <aside id="side-panel" class="bg-white border-l border-gray-200 overflow-y-auto p-4 shadow-lg">
                    <h2 class="text-xl font-bold mb-4">פרטי הזמנה/מכולה</h2>
                    <div id="panel-content">בחר פריט על המפה...</div>
                    <button onclick="openContainerEditModal('123')" class="w-full mt-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">ערוך</button>
                </aside>
            </main>
            <!-- Views נוספים (הושמטו לשמירה על תמציתיות, אך הלוגיקה נשמרה) -->
             <div id="view-history" class="app-view" style="overflow-y: auto; padding: 1.5rem 2.5rem;">היסטוריית הזמנות</div>
             <div id="view-containers" class="app-view" style="overflow-y: auto; padding: 1.5rem 2.5rem;">ניהול מכולות</div>
        </div>

        <!-- ניווט (Navbar) -->
        <nav id="navbar" class="flex flex-col p-4 space-y-4 bg-gray-800 text-gray-300">
            <!-- לוגו וטקסט (Desktop only) -->
            <div class="hidden lg:flex items-center space-x-2 space-x-reverse px-2 mb-4">
                <i data-feather="truck" class="w-8 h-8 text-blue-500"></i>
                <span class="text-xl font-bold text-white">DM</span>
            </div>

             <a href="#" class="nav-link active flex items-center p-3 space-x-4 space-x-reverse rounded-lg hover:bg-gray-700" onclick="showView('dashboard')">
                <i data-feather="map" class="w-6 h-6"></i>
                <span class="font-semibold text-lg hidden lg:block">דשבורד</span>
            </a>
            <a href="#" class="nav-link flex items-center p-3 space-x-4 space-x-reverse rounded-lg hover:bg-gray-700" onclick="showView('history')">
                <i data-feather="clock" class="w-6 h-6"></i>
                <span class="font-semibold text-lg hidden lg:block">היסטוריה</span>
            </a>
            <a href="#" class="nav-link flex items-center p-3 space-x-4 space-x-reverse rounded-lg hover:bg-gray-700" onclick="showView('containers')">
                <i data-feather="box" class="w-6 h-6"></i>
                <span class="font-semibold text-lg hidden lg:block">מכולות</span>
            </a>

            <div class="flex-grow"></div>

            <!-- שורת סטטוס בתחתית ה-Navbar -->
            <div class="hidden lg:block border-t border-gray-700 pt-4 mt-4">
                <div class="text-sm text-gray-400">UID: <span id="user-id" class="font-semibold">טוען...</span></div>
                <div id="connection-status-info" class="text-xs flex items-center mt-1">
                     <span id="connection-status-label">מתחבר...</span>
                    <span id="connection-status-dot" class="connection-status-dot status-offline"></span>
                </div>
            </div>
            <!-- שורת סטטוס עבור Mobile - יוצג במיקום אחר או כטקסט ב-Navbar -->
        </nav>
    </div>

    <!-- Modals (Dialogs) - נשמר קוד ה-Modal הקריטי -->
    <dialog id="container-edit-modal" class="p-0 rounded-xl shadow-2xl w-full max-w-lg backdrop:bg-black/50">
        <div class="bg-white p-6">
            <h3 class="text-2xl font-bold mb-4">עריכת הזמנת מכולה</h3>
            <form id="container-edit-form" onsubmit="handleSaveContainerOrder(event)">
                <input type="hidden" id="container-edit-id">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">מספר מכולה</label>
                    <input type="text" id="container-edit-number" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" readonly>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">סוג משלוח</label>
                    <select id="container-edit-delivery-type" class="shadow border rounded w-full py-2 px-3 text-gray-700">
                        <option value="delivery">איסוף</option>
                        <option value="pickup">הורדה</option>
                    </select>
                </div>
                 <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">תאריך התחלה (שכירות)</label>
                    <input type="date" id="container-edit-rental-start" class="shadow border rounded w-full py-2 px-3 text-gray-700">
                </div>
                 <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">הערות</label>
                    <textarea id="container-edit-notes" class="shadow border rounded w-full py-2 px-3 text-gray-700" rows="3"></textarea>
                </div>
                <div class="p-4 bg-gray-50 border-t flex justify-end space-x-3 space-x-reverse">
                    <button type="button" onclick="closeContainerEditModal()" class="px-6 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600">ביטול</button>
                    <button type="submit" id="submit-container-edit-btn" class="px-6 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600"> שמור שינויים </button>
                </div>
            </form>
        </div>
    </dialog>
    <div id="toast-container" class="fixed top-4 right-4 z-[9999] space-y-3"></div>


    <!-- סקריפט ראשי משודרג - כולל Service Worker מובנה -->
    <script>
        // --- 0. הגדרות גלובליות ואתחול Firebase חסין (תיקון API Key) ---
        // שימוש במשתנים הגלובליים המסופקים על ידי Canvas (תיקון ה-API_KEY החסר)
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // לשימוש בנתיבי Firestore

        let db;
        let auth;
        let isAuthReady = false;
        let userId = 'loading'; // מזהה משתמש נוכחי
        let DB_CONNECTION_STATUS = 'offline';
        const MOBILE_BREAKPOINT_PX = 900;
        let isMobile = false;
        let pollingAttempts = 0;
        let map; // משתנה גלובלי למפה

        // --- 1. SmartLog ו-Queue חסין ---
        const SmartLog = {
            logQueueKey: 'smartlog-queue',

            generateTraceId: () => Math.random().toString(36).substring(2, 9) + Date.now().toString(36),

            saveToQueue: (logEntry) => {
                try {
                    const queue = JSON.parse(localStorage.getItem(SmartLog.logQueueKey) || '[]');
                    queue.push(logEntry);
                    localStorage.setItem(SmartLog.logQueueKey, JSON.stringify(queue));
                    console.warn(`[SmartLog] - נשמר ל-Local Queue: ${logEntry.context}`);
                } catch(e) {
                    console.error("שגיאה קריטית בשמירה ל-SmartLog Queue", e);
                }
            },

            send: async (data, context, metadata, type) => {
                const traceId = SmartLog.generateTraceId();
                const logEntry = {
                    traceId,
                    timestamp: new Date().toISOString(),
                    type: type,
                    message: typeof data === 'string' ? data : data.message || 'Unknown error',
                    context: context,
                    metadata: { ...metadata, errorStack: data.stack || 'N/A', userId: userId },
                };

                console.log(`[SmartLog|${type.toUpperCase()}] (${traceId}) - ${context}`, logEntry);

                // אם האימות לא תקין, שמור ל-Queue באופן מיידי
                if (!isAuthReady) {
                    return SmartLog.saveToQueue(logEntry);
                }

                try {
                    const logCollectionPath = `artifacts/${appId}/public/data/admin_logs`; // נתיב ציבורי ללוגים
                    const logRef = db.collection(logCollectionPath).doc();

                    await logRef.set({
                        ...logEntry,
                        serverTimestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });

                } catch (error) {
                    // טיפול בכשל כתיבה, כולל Permission Denied
                    if (error.code === 'permission-denied' || error.message.includes('permission denied')) {
                         console.error(`[SmartLog] - הרשאה נדחתה. שמירה ל-Queue.`);
                    } else {
                         console.error(`[SmartLog] - כשל כתיבה ל-Firestore.`);
                    }
                    SmartLog.saveToQueue(logEntry);
                }
            },

            error: (e, context, meta = {}) => SmartLog.send(e, context, meta, 'error'),
            info: (m, context, meta = {}) => SmartLog.send(m, context, meta, 'info'),
            warn: (m, context, meta = {}) => SmartLog.send(m, context, meta, 'warn'),

            flushQueue: async () => {
                if (!isAuthReady) return;

                try {
                    const queueString = localStorage.getItem(SmartLog.logQueueKey);
                    const queue = JSON.parse(queueString || '[]');
                    if (queue.length === 0) return;

                    console.log(`[SmartLog] - מנסה לשלוח מחדש ${queue.length} לוגים מה-Queue...`);

                    const logCollectionPath = `artifacts/${appId}/public/data/admin_logs`;
                    const batch = db.batch();
                    let successCount = 0;

                    for (const logEntry of queue) {
                        const logRef = db.collection(logCollectionPath).doc();
                        batch.set(logRef, {
                            ...logEntry,
                            serverTimestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            isQueued: true
                        });
                        successCount++;
                    }

                    await batch.commit();
                    localStorage.removeItem(SmartLog.logQueueKey);
                    console.info(`[SmartLog] - נשלחו בהצלחה ${successCount} לוגים מה-Queue.`);

                } catch (e) {
                    SmartLog.error(e, "SmartLog.QueueFlush.Failure");
                }
            }
        };

        // --- 2. פונקציות עזר ו-UI ---
        const debounce = (func, delay) => {
            let timeoutId;
            return (...args) => {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        };

        function updateConnectionStatus(status, message = '') {
            DB_CONNECTION_STATUS = status;
            const dot = document.getElementById('connection-status-dot');
            const label = document.getElementById('connection-status-label');

            if (dot && label) {
                dot.className = 'connection-status-dot';
                dot.classList.add(`status-${status}`);
                label.innerText = message;
            }
        }

        window.showToast = function(message, type = 'info') {
             const container = document.getElementById('toast-container');
             const toast = document.createElement('div');
             const baseClasses = 'p-3 rounded-lg shadow-lg text-white font-semibold flex items-center';
             let typeClasses;

             switch(type) {
                 case 'success': typeClasses = 'bg-green-500'; break;
                 case 'error': typeClasses = 'bg-red-500'; break;
                 case 'warn': typeClasses = 'bg-yellow-500'; break;
                 default: typeClasses = 'bg-blue-500';
             }

             toast.className = `${baseClasses} ${typeClasses}`;
             toast.innerText = message;
             container.prepend(toast);

             setTimeout(() => {
                 toast.remove();
             }, 4000);
         };

        window.showView = function(viewId) {
             document.querySelectorAll('.app-view').forEach(view => view.classList.remove('active'));
             document.getElementById(`view-${viewId}`).classList.add('active');
             document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
             document.querySelector(`.nav-link[onclick*="${viewId}"]`).classList.add('active');
         };

        window.openContainerEditModal = function(id) {
            document.getElementById('container-edit-id').value = id;
            document.getElementById('container-edit-number').value = 'CON-' + id;
            document.getElementById('container-edit-modal').showModal();
        }

        window.closeContainerEditModal = function() {
            document.getElementById('container-edit-modal').close();
        }


        // --- 3. לוגיקת DB ו-Auth חסינה (תיקון API Key) ---

        async function ensureAuth() {
            // הוספת בדיקה אם הקונפיגורציה זמינה
            if (!firebaseConfig) {
                 console.error("שגיאה: Firebase Config לא זמינה.");
                 updateConnectionStatus('offline', 'שגיאה: Config חסר');
                 return false;
            }
             // אתחול App ו-Auth
            const app = firebase.initializeApp(firebaseConfig);
            auth = app.auth();

            return new Promise(resolve => {
                const unsubscribe = auth.onAuthStateChanged(user => {
                    unsubscribe(); // ביטול ה-Listener לאחר הפעולה הראשונה

                    if (user) {
                        isAuthReady = true;
                        userId = user.uid;
                        document.getElementById('user-id').innerText = userId.substring(0, 8) + '...'; // הצגת UID (חלקי)
                        SmartLog.info("אימות Firebase תקין", "Auth.Success");
                        console.log("INIT STEP: FIREBASE OK");
                        SmartLog.flushQueue(); // נסה לשלוח לוגים תקועים
                        resolve(true);
                    } else if (initialAuthToken) {
                         // ניסיון כניסה עם Custom Token
                         auth.signInWithCustomToken(initialAuthToken)
                             .then(credential => {
                                 isAuthReady = true;
                                 userId = credential.user.uid;
                                 document.getElementById('user-id').innerText = userId; // הצגת UID מלא
                                 SmartLog.info("כניסה עם Custom Token הצליחה", "Auth.CustomToken");
                                 console.log("INIT STEP: FIREBASE OK");
                                 SmartLog.flushQueue();
                                 resolve(true);
                             })
                             .catch(error => {
                                 // אם Custom Token נכשל, נסה אנונימי כ-Fallback
                                 SmartLog.error(error, "Auth.CustomToken.Failed.FallbackToAnon");
                                 signInAnonymouslyFallback(resolve);
                             });
                    } else {
                        // כניסה אנונימית כ-Fallback הראשי
                        signInAnonymouslyFallback(resolve);
                    }
                });
            });
        }

        function signInAnonymouslyFallback(resolve) {
             auth.signInAnonymously().then(credential => {
                 isAuthReady = true;
                 userId = credential.user.uid;
                 document.getElementById('user-id').innerText = userId;
                 SmartLog.info("כניסה אנונימית הצליחה", "Auth.Anonymous");
                 console.log("INIT STEP: FIREBASE OK");
                 SmartLog.flushQueue();
                 resolve(true);
             }).catch(error => {
                 isAuthReady = false;
                 userId = crypto.randomUUID(); // UID רנדומלי למצב לא מאומת
                 document.getElementById('user-id').innerText = userId;
                 updateConnectionStatus('offline', 'כשל אימות. נסה רענון.');
                 SmartLog.error(error, "Auth.Failed");
                 console.error("שגיאה באימות:", error);
                 resolve(false);
             });
        }

        function initFirestoreListeners() {
            if (!isAuthReady) return;

            try {
                db = firebase.firestore();
                // השתמש ב-App ID וב-User ID לנתיב Firestore (לדוגמה: נתונים ציבוריים)
                const publicOrdersPath = `artifacts/${appId}/public/data/orders`;
                const q = db.collection(publicOrdersPath);

                // שימוש ב-onSnapshot (Real-time) - הדרישה הראשית
                q.onSnapshot(snapshot => {
                    updateConnectionStatus('online', 'מחובר (Real-time)');
                    console.log("INIT STEP: FIRESTORE LISTENER ACTIVE");
                    // כאן יטופל עדכון הטבלאות והמפה - לדוגמה: updateOrders(snapshot.docs)
                    if (document.getElementById('map')._leaflet_id === undefined) {
                        initMap(); // אתחול מפה לאחר קבלת הנתונים הראשונית
                    }
                }, error => {
                    SmartLog.error(error, "Firestore.onSnapshot.Error");
                    console.error("Firestore Listener נכשל, עובר ל-Fallback Polling.", error);
                    updateConnectionStatus('degraded', 'כשל Listener. עובר ל-Polling.');
                    startPollingFallback(0);
                });
            } catch (e) {
                SmartLog.error(e, "Firestore.Init.Failure");
                updateConnectionStatus('degraded', 'כשל Init. עובר ל-Polling.');
                startPollingFallback(0);
            }
        }

        function startPollingFallback(attempt) {
            const BASE_DELAY_MS = 5000;
            const MAX_DELAY_MS = 60000;
            const delay = Math.min(MAX_DELAY_MS, BASE_DELAY_MS * Math.pow(2, attempt));

            // בדיקת סטטוס חיבור רשת
            if (!navigator.onLine) {
                 updateConnectionStatus('offline', 'מנותק רשת. ממתין לחיבור...');
                 setTimeout(() => startPollingFallback(attempt), 5000);
                 return;
            }

            // הפעלת Polling
            setTimeout(async () => {
                // רק אם אנחנו במצב Degraded
                if (DB_CONNECTION_STATUS === 'online') return;

                try {
                    // סימולציית Polling: קריאה חד-פעמית ל-DB (getDocs)
                    const traceId = SmartLog.generateTraceId();
                    const publicOrdersPath = `artifacts/${appId}/public/data/orders`;

                    // שימוש ב-get() במקום onSnapshot
                    const snapshot = await db.collection(publicOrdersPath).limit(100).get();

                    console.warn(`FALLBACK: POLLING ACTIVE (${traceId}) (Attempt: ${attempt + 1}, Next in: ${delay / 1000}s)`);
                    updateConnectionStatus('degraded', `Polling פעיל. רענון בעוד ${delay / 1000} שניות.`);
                    pollingAttempts = attempt + 1;

                    // ... עיבוד נתונים ...

                } catch (e) {
                    SmartLog.error(e, "Polling.Fetch.Error");
                    // נכשל, נסה שוב עם Backoff
                    startPollingFallback(pollingAttempts + 1);
                }
            }, delay);
        }

        // --- 4. לוגיקת CRUD קריטית (שימוש ב-getDocs/set/update) ---

        window.handleSaveContainerOrder = async function(event) {
             event.preventDefault();
             if (!isAuthReady) {
                 showToast('שגיאה: אימות נדרש לכתיבה ל-DB', 'error');
                 SmartLog.warn("ניסיון כתיבה נכשל: אימות לא תקין", "CRUD.Container.Edit.PreAuthFail");
                 return;
             }

             const btn = event.submitter;
             btn.disabled = true;
             btn.innerText = 'שומר...';
             const traceId = SmartLog.generateTraceId();

             try {
                // ... לוגיקת איסוף נתונים ...
                const publicOrdersPath = `artifacts/${appId}/public/data/orders`;
                const orderId = document.getElementById('container-edit-id').value;
                const updatedData = {
                   deliveryType: document.getElementById('container-edit-delivery-type').value,
                   rentalStartDate: document.getElementById('container-edit-rental-start').value || null,
                   notes: document.getElementById('container-edit-notes').value.trim(),
                   lastModified: firebase.firestore.FieldValue.serverTimestamp()
                };

                const orderRef = db.collection(publicOrdersPath).doc(orderId);

                // שימוש ב-update() במקום updateDoc() שאינו זמין ב-Compat SDK ללא ייבוא ספציפי
                await orderRef.update(updatedData);
                SmartLog.info("Container order updated", "CRUD.Container.Edit", { orderId, traceId, changes: updatedData });
                showToast('הזמנת מכולה עודכנה', 'success');
                closeContainerEditModal();

             } catch (error) {
                 showToast(`שגיאה בעדכון הזמנת מכולה: ${error.message}`, 'error');
                 SmartLog.error(error, "CRUD.Container.Edit.Failure", { orderId, traceId });
             } finally {
                 btn.disabled = false;
                 btn.innerText = 'שמור שינויים';
             }
         }

        // --- 5. לוגיקת Device Detection ו-Map Init ---
        function checkDeviceType() {
            isMobile = window.innerWidth <= MOBILE_BREAKPOINT_PX || /Mobi|Android/i.test(navigator.userAgent);
            const deviceType = isMobile ? 'Mobile' : 'Desktop';
            console.log(`[INIT STEP: DEVICE DETECTED]: ${deviceType} Layout Selected (Width: ${window.innerWidth}px, Breakpoint: ${MOBILE_BREAKPOINT_PX}px)`);
        }

        function initMap() {
            const mapContainer = document.getElementById('map');
            if (mapContainer && !map) {
                 map = L.map('map').setView([32.0853, 34.7818], 12); // תל אביב
                 L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
                 }).addTo(map);
                 console.log("Map Initialized.");
                 document.getElementById('map-loader').style.display = 'none';
            }
        }

        // --- 6. Service Worker מובנה (תיקון 404) ---
        // הטמעת Service Worker כ-Blob URL ישירות ב-HTML
        const swCode = `
            const CACHE_VERSION = 'v20251029.2_s-w-r_inlined';
            const CACHE_NAME = 'deliverymaster-admin-' + CACHE_VERSION;
            const CACHE_API_DATA = 'deliverymaster-api-data';
            const MOBILE_FALLBACK_DATA = { orders: [], drivers: [], containers: [] };

            const urlsToCache = [
              './',
              './index2_fixed.html',
              'https://cdn.tailwindcss.com',
              'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css',
              'https://unpkg.com/feather-icons',
              // רק קישורים שלא דורשים הרשאת CORS קשוחה
            ];

            self.addEventListener('install', event => {
              console.log('[SW] Installing cache:', CACHE_NAME);
              event.waitUntil(
                caches.open(CACHE_NAME)
                  .then(cache => cache.addAll(urlsToCache.filter(url => !url.includes('googleapis'))))
                  .then(() => self.skipWaiting())
              );
            });

            self.addEventListener('activate', event => {
              console.log('[SW] Activating new cache version:', CACHE_NAME);
              const cacheWhitelist = [CACHE_NAME, CACHE_API_DATA];

              event.waitUntil(
                caches.keys().then(cacheNames => Promise.all(
                    cacheNames.map(cacheName => {
                      if (!cacheWhitelist.includes(cacheName)) {
                        console.log('[SW] Deleting old cache:', cacheName);
                        return caches.delete(cacheName);
                      }
                    })
                )).then(() => self.clients.claim())
              );
            });

            self.addEventListener('fetch', event => {
              const url = new URL(event.request.url);
              const isApiRequest = url.hostname.includes('googleapis.com') || url.pathname.includes('/api/');

              if (isApiRequest) {
                // Network First with Cache Fallback + Placeholder
                event.respondWith(
                  fetch(event.request)
                    .then(response => {
                      if (response.ok && event.request.method === 'GET') {
                          const responseClone = response.clone();
                          caches.open(CACHE_API_DATA).then(cache => cache.put(event.request, responseClone));
                      }
                      return response;
                    })
                    .catch(async () => {
                      const cachedResponse = await caches.match(event.request);
                      if (cachedResponse) return cachedResponse;

                      // Fallback: החזר JSON ריק
                      console.warn('[SW] Offline API request. Returning placeholder.');
                      return new Response(JSON.stringify(MOBILE_FALLBACK_DATA), {
                        headers: { 'Content-Type': 'application/json' },
                        status: 200,
                        statusText: 'OK (Offline Placeholder)'
                      });
                    })
                );
                return;
              }

              // Stale-While-Revalidate לא נכסי API/DB
              event.respondWith(
                caches.match(event.request).then(cachedResponse => {
                  const fetchPromise = fetch(event.request).then(networkResponse => {
                    if (networkResponse.ok && event.request.method === 'GET') {
                      const responseClone = networkResponse.clone();
                      caches.open(CACHE_NAME).then(cache => cache.put(event.request, responseClone));
                    }
                    return networkResponse;
                  }).catch(e => cachedResponse || e); // אם הרשת נכשלה, החזר Cache או זרוק שגיאה

                  return cachedResponse || fetchPromise;
                })
              );
            });
        `;
        // יצירת Blob ורישום
        function registerInlinedServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                     const blob = new Blob([swCode], { type: 'application/javascript' });
                     const swURL = URL.createObjectURL(blob);
                     navigator.serviceWorker.register(swURL, { scope: './' })
                         .then(reg => console.log('Service Worker Registered (Inlined via Blob)'))
                         .catch(e => {
                             console.error('Service Worker Registration Failed:', e);
                             SmartLog.error(e, "SW.Registration.Failed");
                         });
                } catch(e) {
                     console.error("Failed to create Service Worker Blob", e);
                     SmartLog.error(e, "SW.Blob.CreationFailed");
                }
            }
        }


        // --- 7. אתחול ראשי ---
        document.addEventListener('DOMContentLoaded', () => {
            // הוספת לוגר לבדיקות:
            // if (typeof firebase !== 'undefined' && typeof firebase.firestore !== 'undefined') {
            //     firebase.firestore.setLogLevel('debug');
            // }

            // 1. Device Detection
            checkDeviceType();
            window.addEventListener('resize', debounce(checkDeviceType, 100)); // Debounce לריסייז

            // 2. Service Worker (Inlined)
            registerInlinedServiceWorker();

            // 3. Auth and DB connection
            document.getElementById('map-loader').style.display = 'flex'; // הצג לודר
            ensureAuth().then(success => {
                if (success) {
                    initFirestoreListeners(); // Listeners
                } else {
                    initMap(); // אתחל מפה גם אם אין נתונים
                    startPollingFallback(0); // Polling כ-Fallback ראשי
                }
            }).catch(e => {
                SmartLog.error(e, "App.Init.Fatal");
                initMap();
                document.getElementById('map-loader').style.display = 'none';
                showToast('שגיאת אתחול קריטית', 'error');
            });

            // 4. Feather Icons
            feather.replace();
        });

    </script>
</body>
</html>
