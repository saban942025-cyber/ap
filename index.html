<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeliveryMaster v32.5 (Stable)</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://unpkg.com/feather-icons"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #3b82f6; /* blue-500 */
            --primary-dark: #2563eb; /* blue-600 */
            --bg-light: #f3f4f6; /* gray-100 */
            --bg-white: #ffffff;
            --border-color: #e5e7eb; /* gray-200 */
            --text-dark: #1f2937; /* gray-800 */
            --text-light: #6b7280; /* gray-500 */
            --text-dark-nav: #d1d5db; /* gray-300 */
            --bg-dark-nav: #1f2937; /* slate-800 */
            --bg-dark-nav-hover: #374151; /* slate-700 */
            --danger-soft: #fee2e2; /* red-100 */
            --danger-medium: #f87171; /* red-400 */
            --danger-dark: #dc2626; /* red-600 */
        }
        body {
            font-family: 'Inter', 'Arial', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            overflow: hidden;
        }

        /* Layout */
        .app-layout {
            display: grid;
            grid-template-columns: auto 1fr;
            height: 100vh;
        }

        /* App Views */
        .app-view {
            width: 100%;
            height: 100vh;
            overflow: hidden; /* Prevent scrolling on main views */
            display: none; /* Hidden by default */
        }
        .app-view.active {
            display: block; /* Show active view */
        }

        #view-dashboard {
            display: grid; /* Use grid for dashboard */
            grid-template-columns: 1fr 350px;
            overflow: hidden;
        }
        .app-view.active#view-dashboard { display: grid; } /* Override default block for dashboard */

        #view-history, #view-containers { /* Allow scrolling for History and Containers */
            overflow-y: auto;
            padding: 1.5rem 2.5rem;
        }

        #view-driver-history {
             display: grid; /* Use grid for driver history */
             grid-template-columns: 300px 1fr; /* Sidebar and Map */
             height: 100vh;
        }
        .app-view.active#view-driver-history { display: grid; } /* Override default block */

        #map-container {
            position: relative;
            background-color: #e0e0e0;
        }
        #map {
            height: 100%;
            width: 100%;
        }
        #side-panel {
            background-color: var(--bg-white);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* Navbar */
        #navbar {
            background-color: var(--bg-dark-nav);
            border-left: 1px solid var(--border-color);
            color: white;
            z-index: 10;
        }
        #navbar .text-xl { color: white; }
        .nav-link { transition: all 0.2s; color: var(--text-dark-nav); }
        .nav-link:hover { background-color: var(--bg-dark-nav-hover); color: white; }
        .nav-link.active { background-color: var(--primary-color); color: white; border-right: 3px solid #60a5fa; }
        .nav-link-special { color: var(--text-dark-nav); background-color: var(--bg-dark-nav-hover); }
        .nav-link-special:hover { background-color: var(--primary-color); color: white; }
        #navbar .hidden.lg\\:block { color: white; }
        #navbar #last-updated { color: var(--text-light); }

        /* Side Panel */
        #side-panel-lists { flex: 1; overflow-y: auto; position: relative; }
        .panel-list { overflow-y: auto; position: relative; }
        .order-card, .driver-card { padding: 1rem; border-bottom: 1px solid var(--border-color); transition: background-color 0.2s; }
        .order-card:hover, .driver-card:hover { background-color: #fafafa; }
        .order-card.active, .driver-card.active { background-color: #eff6ff; border-right: 3px solid var(--primary-color); }
        .order-card .font-bold { color: var(--primary-dark); }

        /* Details Panel */
        #details-panel { height: 300px; overflow-y: auto; border-top: 2px solid var(--border-color); background: #fdfdfd; padding: 1rem; display: none; position: relative; }
        #details-panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        #details-panel h4 { font-weight: 700; color: var(--text-dark); }
        #details-panel ul { list-style-type: none; padding: 0; margin: 0; }
        #details-panel li { font-size: 0.9rem; margin-bottom: 4px; color: var(--text-light); }
        #details-panel .status-line { display: flex; align-items: center; gap: 0.5rem; }
        #details-panel li .dist { font-weight: 500; color: var(--text-dark); display: inline-block; min-width: 60px; text-align: left; }
        #details-close-btn, #details-copy-link-btn { cursor: pointer; color: var(--text-light); }
        #details-close-btn:hover, #details-copy-link-btn:hover { color: var(--text-dark); }
        .status-change-btn { background: none; border: none; color: var(--primary-color); font-size: 0.8rem; font-weight: 500; cursor: pointer; padding: 2px 4px; border-radius: 4px; }
        .status-change-btn:hover { background-color: #eff6ff; color: var(--primary-dark); }

        /* History & Customer Management View */
         #view-history .tab-button, #view-containers .tab-button { /* Apply to both */
            padding: 0.75rem 1.5rem; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 500; color: var(--text-light); }
         #view-history .tab-button.active, #view-containers .tab-button.active { border-bottom-color: var(--primary-color); color: var(--primary-color); }
        .history-table tbody tr:hover, .customer-table tbody tr:hover, .container-table tbody tr:hover { background-color: #f9fafb; }
        .customer-table tbody tr:hover, .container-table tbody tr:hover { cursor: pointer; } /* Make container table rows clickable for editing */
        .action-button { background-color: var(--primary-color); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; cursor: pointer; margin-left: 4px; }
        .action-button:hover { background-color: var(--primary-dark); }
        .action-button-secondary { background-color: var(--text-light); }
        .action-button-secondary:hover { background-color: var(--text-dark); }

        /* Driver History View */
        #driver-history-sidebar { background-color: var(--bg-white); border-left: 1px solid var(--border-color); padding: 1rem; display: flex; flex-direction: column; gap: 1rem; }
        #driver-history-map { background-color: #e0e0e0; position: relative; }

        /* Containers View */
        #view-containers h2 { font-size: 1.8rem; font-weight: 700; margin-bottom: 1.5rem; border-bottom: 2px solid var(--border-color); padding-bottom: 0.5rem; }
        .warehouse-section { margin-bottom: 2rem; }
        .warehouse-section h3 { font-size: 1.3rem; font-weight: 600; margin-bottom: 1rem; color: var(--primary-dark); }
        .container-table th, .container-table td { padding: 0.75rem 1rem; text-align: right; border-bottom: 1px solid var(--border-color); vertical-align: middle; font-size: 0.9rem; }
        .container-table th { font-weight: 500; color: var(--text-light); background-color: #f9fafb; }
        .container-table tbody tr.overdue { background-color: var(--danger-soft); animation: subtle-pulse 1.5s infinite ease-in-out; }
        .container-table td .edit-btn { color: var(--primary-color); cursor: pointer; }
        .container-table td .edit-btn:hover { color: var(--primary-dark); }
        .progress-bar-container { width: 100%; background-color: var(--border-color); border-radius: 99px; overflow: hidden; height: 10px; }
        .progress-bar { height: 100%; background-color: var(--primary-color); border-radius: 99px; transition: width 0.3s ease; }
        .progress-bar.overdue { background-color: var(--danger-medium); }
        .container-summary { margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color); font-weight: 600; }
        @keyframes subtle-pulse { 0% { background-color: var(--danger-soft); } 50% { background-color: #fecaca; /* red-200 */} 100% { background-color: var(--danger-soft); } }

        /* Status Colors */
        .status-dot { width: 10px; height: 10px; border-radius: 50%; }
        .status-active { background-color: #22c55e; } .status-stuck { background-color: #ef4444; } .status-inactive { background-color: #9ca3af; }

        /* Leaflet Customizations */
        .leaflet-popup-content-wrapper { border-radius: 8px; }
        .leaflet-popup-content { margin: 13px 20px; font-family: 'Inter', sans-serif; }
        .leaflet-popup-content h4 { font-weight: 700; margin-bottom: 8px; }
        .leaflet-popup-content p { margin: 4px 0; color: var(--text-light); }

        /* Loader */
        .loader-container { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.7); display: flex; align-items: center; justify-content: center; z-index: 10; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Toast Notification */
        #toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 5000; display: flex; flex-direction: column; gap: 8px; }
        .toast { padding: 12px 20px; background-color: var(--text-dark); color: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); opacity: 0; transform: translateY(20px); transition: all 0.3s ease; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { background-color: #22c55e; } .toast.error { background-color: #ef4444; }

        /* Modal Dialog */
        #new-order-modal, #customer-edit-modal, #container-edit-modal { /* Added container modal */
            max-width: 600px; border-radius: 12px; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.1); padding: 0; }
        #new-order-modal::backdrop, #customer-edit-modal::backdrop, #container-edit-modal::backdrop { background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }

        /* Responsive */
        @media (max-width: 1024px) {
            #view-dashboard { grid-template-columns: 1fr; }
            #side-panel { position: fixed; bottom: 0; left: 0; right: 0; height: 40vh; z-index: 2000; border-right: none; border-top: 1px solid var(--border-color); transform: translateY(100%); transition: transform 0.3s ease; }
            #side-panel.open { transform: translateY(0); }
            #navbar { display: flex; width: 100%; z-index: 2001; border-left: none; border-bottom: 1px solid var(--border-color); }
            .app-layout { grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
            .nav-link { flex: 1; justify-content: center; } .nav-link span { display: none; } .nav-link.active { border-right: none; border-bottom: 3px solid var(--primary-color); }
            #details-panel { height: 200px; }
            #view-driver-history { grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
            #driver-history-sidebar { grid-row: 1 / 2; border-left: none; border-bottom: 1px solid var(--border-color); }
            #driver-history-map { grid-row: 2 / 3; }
            #view-history, #view-containers { padding: 1rem; } /* Less padding on mobile */
        }
    </style>
</head>
<body class="antialiased">

    <div class="app-layout">
        <nav id="navbar" class="w-20 lg:w-64 flex flex-col p-4 space-y-4">
            <div class="hidden lg:flex items-center space-x-2 space-x-reverse px-2 mb-4">
                <i data-feather="truck" class="w-8 h-8 text-blue-500"></i>
                <span class="text-xl font-bold">DeliveryMaster</span>
            </div>

            <a href="#" class="nav-link active flex items-center p-3 space-x-4 space-x-reverse rounded-lg" onclick="showView('dashboard')">
                <i data-feather="map" class="w-6 h-6"></i>
                <span class="font-semibold text-lg hidden lg:block">דשבורד</span>
            </a>
            <a href="#" class="nav-link flex items-center p-3 space-x-4 space-x-reverse rounded-lg" onclick="showView('history')">
                <i data-feather="archive" class="w-6 h-6"></i>
                <span class="font-semibold text-lg hidden lg:block">היסטוריה ולקוחות</span>
            </a>
             <a href="#" class="nav-link flex items-center p-3 space-x-4 space-x-reverse rounded-lg" onclick="showView('driver-history')">
                <i data-feather="navigation" class="w-6 h-6"></i>
                <span class="font-semibold text-lg hidden lg:block">היסטוריית נהגים</span>
            </a>
            <a href="#" class="nav-link flex items-center p-3 space-x-4 space-x-reverse rounded-lg" onclick="showView('containers')">
                 <i data-feather="hard-drive" class="w-6 h-6"></i> <span class="font-semibold text-lg hidden lg:block">מכולות</span>
            </a>
            <a href="#" class="nav-link flex items-center p-3 space-x-4 space-x-reverse rounded-lg" onclick="openNewOrderForm()">
                <i data-feather="plus-circle" class="w-6 h-6"></i>
                <span class="font-semibold text-lg hidden lg:block">הזמנה חדשה</span>
            </a>
            <a href="log.html" target="_blank" class="nav-link flex items-center p-3 space-x-4 space-x-reverse rounded-lg">
                <i data-feather="file-text" class="w-6 h-6"></i>
                <span class="font-semibold text-lg hidden lg:block">לוגים</span>
            </a>

            <div class="flex-grow"></div> <a href="#" class="nav-link nav-link-special flex items-center p-3 space-x-4 space-x-reverse rounded-lg" onclick="sendGlobalPing()">
                <i data-feather="bell" class="w-6 h-6"></i>
                <span class="font-semibold text-lg hidden lg:block">שלח התראה גלובלית</span>
            </a>

            <div class="hidden lg:block border-t border-gray-700 pt-4 mt-4">
                <div class="text-sm">שלום, <span class="font-semibold">מנהל</span></div>
                <div id="last-updated" class="text-xs">מתחבר...</div>
            </div>
        </nav>

        <div class="relative">
            <main id="view-dashboard" class="app-view active"> <div id="map-container">
                    <div id="map"></div>
                    <div id="map-loader" class="loader-container">
                        <div class="loader"></div>
                        <span class="ml-4 font-semibold">טוען מפה ומאמת...</span>
                    </div>
                </div>

                <aside id="side-panel">
                    <div class="flex border-b border-gray-200">
                        <button id="tab-orders" class="flex-1 p-4 font-semibold text-center border-b-2 border-blue-500 text-blue-500" onclick="showPanelTab('orders')">
                            הזמנות
                        </button>
                        <button id="tab-drivers" class="flex-1 p-4 font-semibold text-center border-b-2 border-transparent text-gray-500" onclick="showPanelTab('drivers')">
                            נהגים
                        </button>
                    </div>

                    <div class="p-3 border-b border-gray-200">
                        <input type="text" id="search-input" placeholder="חפש הזמנה או נהג..." class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300" onkeyup="filterLists()">
                    </div>

                    <div id="side-panel-lists" class="relative">
                        <div id="orders-list" class="panel-list">
                            <div class="loader-container"><div class="loader"></div></div>
                        </div>

                        <div id="drivers-list" class="panel-list" style="display: none;">
                            <div class="loader-container"><div class="loader"></div></div>
                        </div>
                    </div>

                    <div id="details-panel">
                        <div class="text-center text-gray-500 p-8">בחר נהג או הזמנה להצגת פרטים</div>
                    </div>
                </aside>
            </main>

            <div id="view-history" class="app-view">
                <div class="flex border-b border-gray-200 mb-6">
                    <button class="tab-button active" onclick="showHistoryTab('orders')">היסטוריית הזמנות</button>
                    <button class="tab-button" onclick="showHistoryTab('customers')">ניהול לקוחות</button>
                </div>

                <div id="history-orders-content">
                    <h2 class="text-2xl font-bold mb-4">היסטוריית הזמנות</h2>
                    <div class="flex flex-col lg:flex-row gap-4 mb-4 p-4 bg-white rounded-lg shadow-sm">
                        <input type="text" id="history-search" placeholder="חפש לפי מס' הזמנה, לקוח, נהג, כתובת..." class="flex-grow p-2 border rounded-md">
                        <div class="flex gap-4">
                            <input type="date" id="history-date-from" class="p-2 border rounded-md" title="מתאריך">
                            <input type="date" id="history-date-to" class="p-2 border rounded-md" title="עד תאריך">
                        </div>
                        <button id="history-filter-btn" class="px-6 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">סנן</button>
                    </div>
                    <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 history-table">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">מס' הזמנה</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">לקוח</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">נהג</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">כתובת</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">סטטוס</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">תאריך</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">פעולות</th>
                                    </tr>
                                </thead>
                                <tbody id="history-table-body" class="bg-white divide-y divide-gray-200">
                                    <tr><td colspan="7" class="text-center p-8 text-gray-500">טוען היסטוריה...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                 </div>

                 <div id="history-customers-content" style="display: none;">
                     <h2 class="text-2xl font-bold mb-4">ניהול לקוחות</h2>
                     <div class="flex flex-col lg:flex-row gap-4 mb-4 p-4 bg-white rounded-lg shadow-sm">
                        <input type="text" id="customer-search-input" placeholder="חפש לפי שם, טלפון, מספר לקוח..." class="flex-grow p-2 border rounded-md" onkeyup="renderCustomerTable()">
                     </div>
                    <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 customer-table">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">שם</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">מספר לקוח</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">טלפון</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">כתובת</th>
                                    </tr>
                                </thead>
                                <tbody id="customer-table-body" class="bg-white divide-y divide-gray-200">
                                    <tr><td colspan="4" class="text-center p-8 text-gray-500">טוען לקוחות...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                 </div>
            </div>

             <div id="view-driver-history" class="app-view">
                 <aside id="driver-history-sidebar" class="bg-white p-4 border-l border-gray-200">
                     <h3 class="text-xl font-semibold mb-4">היסטוריית נהג</h3>
                     <div>
                         <label for="driver-select" class="block text-sm font-medium text-gray-700 mb-1">בחר נהג</label>
                         <select id="driver-select" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                             <option value="">טוען נהגים...</option>
                         </select>
                     </div>
                     <div class="grid grid-cols-2 gap-2">
                         <div>
                            <label for="driver-history-date-from" class="block text-sm font-medium text-gray-700 mb-1">מתאריך</label>
                            <input type="date" id="driver-history-date-from" class="w-full p-2 border rounded-md">
                         </div>
                         <div>
                            <label for="driver-history-time-from" class="block text-sm font-medium text-gray-700 mb-1">משעה</label>
                             <input type="time" id="driver-history-time-from" class="w-full p-2 border rounded-md">
                         </div>
                         <div>
                             <label for="driver-history-date-to" class="block text-sm font-medium text-gray-700 mb-1">עד תאריך</label>
                             <input type="date" id="driver-history-date-to" class="w-full p-2 border rounded-md">
                         </div>
                         <div>
                             <label for="driver-history-time-to" class="block text-sm font-medium text-gray-700 mb-1">עד שעה</label>
                             <input type="time" id="driver-history-time-to" class="w-full p-2 border rounded-md">
                         </div>
                     </div>
                     <button id="driver-history-filter-btn" class="w-full px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">הצג מסלול</button>
                     <div class="mt-4 border-t pt-4 text-sm text-gray-600">
                         <p><strong>סטטוס אחרון:</strong> <span id="driver-last-status">-</span></p>
                         <p><strong>מרחק משוער:</strong> <span id="driver-distance-traveled">-</span> ק"מ</p>
                         <p><strong>זמן בין הזמנות (ממוצע):</strong> <span id="driver-avg-time">-</span> דקות</p>
                     </div>
                      <div class="mt-auto text-xs text-gray-500">
                        * נתוני היסטוריה דורשים מבנה נתונים ייעודי ב-Firestore (למשל, קולקציית `locationHistory`).
                     </div>
                 </aside>
                 <div id="driver-history-map" class="relative">
                     <div class="absolute top-2 right-2 z-10 bg-white p-2 rounded shadow text-sm">
                         מציג מסלול עבור: <span id="driver-history-map-label" class="font-semibold">-</span>
                     </div>
                     <div class="w-full h-full bg-gray-300 flex items-center justify-center text-gray-500">
                         טוען מפת היסטוריה...
                         </div>
                 </div>
            </div>

             <div id="view-containers" class="app-view">
                <h2>ניהול מכולות פעילות</h2>

                <div class="loader-container" id="containers-loader">
                    <div class="loader"></div> <span class="ml-2">טוען נתוני מכולות...</span>
                </div>

                <div id="containers-content">
                    </div>

                <div class="container-summary" id="containers-summary">
                    סה"כ מכולות פעילות: <span id="total-active-containers">0</span>
                </div>
            </div>

        </div>
    </div>

    <div id="toast-container"></div>

    <dialog id="new-order-modal">
        <form onsubmit="submitNewOrder(event)">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-xl font-bold">יצירת הזמנה חדשה</h3>
                <button type="button" class="text-gray-500 hover:text-gray-800" onclick="closeNewOrderForm()">
                    <i data-feather="x"></i>
                </button>
            </div>

            <div class="p-6 space-y-4">
                <div>
                    <label for="customer-search" class="block text-sm font-medium mb-1">חפש לקוח קיים או הקלד שם ללקוח חדש</label>
                    <input type="text" id="customer-search" list="customer-list" class="w-full p-2 border rounded-md" oninput="handleCustomerSearch(this.value)" autocomplete="off">
                    <datalist id="customer-list"></datalist>
                </div>

                <div id="new-customer-fields" class="p-4 bg-blue-50 border border-blue-200 rounded-lg space-y-3" style="display: none;">
                    <p class="font-semibold text-blue-700">פרטי לקוח חדש</p>
                    <input type="hidden" id="customer-id-new">
                    <input type="text" id="customer-name-new" placeholder="שם לקוח מלא" class="w-full p-2 border rounded-md">
                    <input type="text" id="customer-phone-new" placeholder="טלפון" class="w-full p-2 border rounded-md">
                    <div class="form-grid">
                        <input type="text" id="customer-street-new" placeholder="רחוב" class="w-full p-2 border rounded-md">
                        <input type="text" id="customer-streetnum-new" placeholder="מספר" class="w-full p-2 border rounded-md">
                        <input type="text" id="customer-city-new" placeholder="עיר" class="w-full p-2 border rounded-md">
                    </div>
                    <input type="text" id="customer-contact-new" placeholder="איש קשר" class="w-full p-2 border rounded-md">
                     <input type="text" id="customer-number-new" placeholder="מספר לקוח (אופציונלי)" class="w-full p-2 border rounded-md">
                </div>

                <div id="existing-customer-display" class="p-4 bg-gray-50 border rounded-lg" style="display: none;">
                    <input type="hidden" id="customer-id-existing">
                    <p><strong>לקוח:</strong> <span id="customer-name-display"></span> <span id="customer-number-display" class="text-sm text-gray-500"></span></p>
                    <p><strong>כתובת:</strong> <span id="customer-address-display"></span></p>
                    <p><strong>טלפון:</strong> <span id="customer-phone-display"></span></p>
                </div>

                <hr>

                <div>
                    <label for="order-number" class="block text-sm font-medium mb-1">מספר הזמנה (אופציונלי)</label>
                    <input type="text" id="order-number" placeholder="השאר ריק למזהה אוטומטי" class="w-full p-2 border rounded-md mb-4">
                 </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="date" id="order-date" class="w-full p-2 border rounded-md" required>
                        <input type="time" id="order-time" class="w-full p-2 border rounded-md">
                    </div>
                    <select id="order-delivery-type" class="w-full p-2 border rounded-md" required>
                        <option value="">סוג הובלה</option>
                        <option value="הובלת מנוף">הובלת מנוף</option>
                        <option value="הובלת משאית">הובלת משאית</option>
                        <option value="איסוף עצמי">איסוף עצמי</option>
                        <option value="עבודת מנוף">עבודת מנוף</option>
                        <option value="עבודת מנוף 15 מטר">עבודת מנוף 15 מטר</option>
                        <option value="הצבת מכולה">הצבת מכולה</option>
                        <option value="החלפת מכולה">החלפת מכולה</option>
                        <option value="הוצאת מכולה">הוצאת מכולה</option>
                        <option value="פינוי במקום">פינוי במקום</option>
                        <option value="פריקה ידנית">פריקה ידנית</option>
                    </select>
                    <select id="order-warehouse" class="w-full p-2 border rounded-md" required>
                        <option value="">בחר מחסן</option>
                        <option value="החרש">החרש</option>
                        <option value="התלמיד">התלמיד</option>
                        <option value="30-שארק">30-שארק (מכולה)</option>
                        <option value="32-כראדי">32-כראדי (מכולה)</option>
                        <option value="40-כראדי">40-כראדי (מכולה)</option>
                    </select>
                </div>
                <textarea id="order-notes" rows="3" placeholder="הערות להזמנה..." class="w-full p-2 border rounded-md"></textarea>
            </div>
            <div class="p-4 bg-gray-50 border-t flex justify-end space-x-3 space-x-reverse">
                <button type="button" class="px-4 py-2 bg-white border rounded-md hover:bg-gray-50" onclick="closeNewOrderForm()">
                    ביטול
                </button>
                <button type="submit" id="submit-order-btn" class="px-6 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">
                    צור הזמנה
                </button>
            </div>
        </form>
    </dialog>

    <dialog id="customer-edit-modal">
        <form onsubmit="handleSaveCustomer(event)">
            <input type="hidden" id="customer-edit-id">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-xl font-bold" id="customer-edit-title">עריכת פרטי לקוח</h3>
                <button type="button" class="text-gray-500 hover:text-gray-800" onclick="closeCustomerEditModal()">
                    <i data-feather="x"></i>
                </button>
            </div>
            <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
                <div class="form-grid">
                    <div>
                        <label for="customer-edit-name" class="block text-sm font-medium mb-1">שם לקוח</label>
                        <input type="text" id="customer-edit-name" class="w-full p-2 border rounded-md" required>
                    </div>
                    <div>
                        <label for="customer-edit-number" class="block text-sm font-medium mb-1">מספר לקוח</label>
                        <input type="text" id="customer-edit-number" class="w-full p-2 border rounded-md">
                    </div>
                </div>
                <div class="form-grid">
                    <div>
                        <label for="customer-edit-phone" class="block text-sm font-medium mb-1">טלפון</label>
                        <input type="text" id="customer-edit-phone" class="w-full p-2 border rounded-md" required>
                    </div>
                    <div>
                        <label for="customer-edit-contact" class="block text-sm font-medium mb-1">איש קשר</label>
                        <input type="text" id="customer-edit-contact" class="w-full p-2 border rounded-md">
                    </div>
                </div>
                <div class="form-grid">
                    <div>
                        <label for="customer-edit-street" class="block text-sm font-medium mb-1">רחוב</label>
                        <input type="text" id="customer-edit-street" class="w-full p-2 border rounded-md" required>
                    </div>
                    <div>
                        <label for="customer-edit-streetnum" class="block text-sm font-medium mb-1">מספר</label>
                        <input type="text" id="customer-edit-streetnum" class="w-full p-2 border rounded-md">
                    </div>
                    <div>
                        <label for="customer-edit-city" class="block text-sm font-medium mb-1">עיר</label>
                        <input type="text" id="customer-edit-city" class="w-full p-2 border rounded-md" required>
                    </div>
                </div>
                <div>
                    <label for="customer-edit-notes" class="block text-sm font-medium mb-1">הערות לקוח</label>
                    <textarea id="customer-edit-notes" rows="3" class="w-full p-2 border rounded-md"></textarea>
                </div>

                <div class="mt-4 p-4 border rounded-md bg-gray-50 text-sm">
                    <h4 class="font-semibold mb-2">מכולות פעילות</h4>
                    <ul id="customer-containers-list" class="space-y-1">
                        <li class="text-gray-500">טוען נתונים...</li>
                    </ul>
                </div>

                <div class="mt-4 p-4 border rounded-md bg-gray-50 text-sm">
                    <h4 class="font-semibold mb-2">היסטוריית הזמנות אחרונות</h4>
                    <ul id="customer-orders-history" class="space-y-1">
                        <li class="text-gray-500">טוען נתונים...</li>
                    </ul>
                </div>

            </div>
            <div class="p-4 bg-gray-50 border-t flex justify-end space-x-3 space-x-reverse">
                <button type="button" class="px-4 py-2 bg-white border rounded-md hover:bg-gray-50" onclick="closeCustomerEditModal()">
                    ביטול
                </button>
                <button type="submit" id="customer-edit-save-btn" class="px-6 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">
                    שמור שינויים
                </button>
            </div>
        </form>
    </dialog>

    <dialog id="container-edit-modal">
        <form onsubmit="handleSaveContainerOrder(event)">
            <input type="hidden" id="container-edit-id">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-xl font-bold" id="container-edit-title">עריכת הזמנת מכולה <span id="container-edit-number-display" class="font-normal text-gray-500 text-base"></span></h3>
                <button type="button" class="text-gray-500 hover:text-gray-800" onclick="closeContainerEditModal()">
                    <i data-feather="x"></i>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="container-edit-delivery-type" class="block text-sm font-medium mb-1">סוג הובלה</label>
                        <select id="container-edit-delivery-type" class="w-full p-2 border rounded-md" required>
                            <option value="הצבת מכולה">הצבת מכולה</option>
                            <option value="החלפת מכולה">החלפת מכולה</option>
                            <option value="הוצאת מכולה">הוצאת מכולה</option>
                        </select>
                    </div>
                    <div>
                        <label for="container-edit-customer" class="block text-sm font-medium mb-1">לקוח</label>
                        <input type="text" id="container-edit-customer" class="w-full p-2 border rounded-md bg-gray-100" disabled>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="container-edit-date" class="block text-sm font-medium mb-1">תאריך אספקה מתוכנן</label>
                        <input type="date" id="container-edit-date" class="w-full p-2 border rounded-md" required>
                    </div>
                    <div>
                        <label for="container-edit-time" class="block text-sm font-medium mb-1">שעה מתוכננת (אופציונלי)</label>
                        <input type="time" id="container-edit-time" class="w-full p-2 border rounded-md">
                    </div>
                </div>

                <div class="p-3 border rounded-md bg-yellow-50">
                    <h4 class="font-semibold mb-2 text-sm text-yellow-700">תחילת שכירות בפועל (חשוב לחישוב ימים)</h4>
                    <div class="grid grid-cols-2 gap-4">
                         <div>
                            <label for="container-edit-rental-start-date" class="block text-sm font-medium mb-1">תאריך התחלה</label>
                            <input type="date" id="container-edit-rental-start-date" class="w-full p-2 border rounded-md">
                        </div>
                        <div>
                             <label for="container-edit-rental-start-time" class="block text-sm font-medium mb-1">שעת התחלה (אופציונלי)</label>
                            <input type="time" id="container-edit-rental-start-time" class="w-full p-2 border rounded-md">
                        </div>
                    </div>
                </div>

                <div>
                    <label for="container-edit-notes" class="block text-sm font-medium mb-1">הערות להזמנה</label>
                    <textarea id="container-edit-notes" rows="3" class="w-full p-2 border rounded-md"></textarea>
                </div>
            </div>
            <div class="p-4 bg-gray-50 border-t flex justify-end space-x-3 space-x-reverse">
                <button type="button" class="px-4 py-2 bg-white border rounded-md hover:bg-gray-50" onclick="closeContainerEditModal()">
                    ביטול
                </button>
                <button type="submit" id="container-edit-save-btn" class="px-6 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">
                    שמור שינויים
                </button>
            </div>
        </form>
    </dialog>

    <script type="module">
        // *******************************************************************
        // 1. FIREBASE MODULAR IMPORTS, CONFIGURATION, AND INITIALIZATION FIX
        // *******************************************************************
        import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getFirestore, collection, doc, query, where, orderBy, onSnapshot, updateDoc, addDoc, setDoc, deleteDoc, serverTimestamp, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { getStorage, ref as storageRef, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-storage.js";

        // Firebase Configuration Details (UPDATED)
        const firebaseConfig = {
            apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo",
            authDomain: "saban94-78949.firebaseapp.com",
            projectId: "saban94-78949",
            storageBucket: "saban94-78949.firebasestorage.app",
            messagingSenderId: "41553157903",
            appId: "1:41553157903:web:cc33d252cff023be97a87a",
            measurementId: "G-XV6RZDESSB"
        };

        let app;
        let db;
        let auth;
        let storage;

        try {
            // Ensure app is initialized only once
            if (!getApps().length) {
                app = initializeApp(firebaseConfig);
            } else {
                app = getApp();
            }
            db = getFirestore(app);
            auth = getAuth(app);
            storage = getStorage(app);
            console.log("Firebase initialized successfully with Modular SDK.");
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            showToast(`שגיאה קריטית באתחול Firebase: ${error.message}`, 'error');
        }

        // *******************************************************************
        // 2. SMARTLOG IMPLEMENTATION (WITH TRY/CATCH)
        // *******************************************************************
        const SmartLog = {
            _log: async (level, msg, source = "General", data = {}) => {
                try {
                    if (!db) {
                        console.warn("Firestore not initialized. SmartLog skipped.");
                        return;
                    }
                    await addDoc(collection(db, 'logs'), {
                        timestamp: serverTimestamp(),
                        level: level,
                        message: msg,
                        source: source,
                        data: data,
                        userId: auth.currentUser ? auth.currentUser.uid : 'anonymous'
                    });
                } catch (e) {
                    // Log to console if logging fails, to prevent crash
                    console.error(`SmartLog failed to log ${level}:`, e, { originalMessage: msg, source: source, data: data });
                }
            },
            info: (msg, source, data) => SmartLog._log('INFO', msg, source, data),
            warn: (msg, source, data) => SmartLog._log('WARN', msg, source, data),
            error: (e, source, data) => {
                const message = e instanceof Error ? e.message : (e ? e.toString() : 'Unknown Error');
                const stack = e instanceof Error ? e.stack : undefined;
                SmartLog._log('ERROR', message, source, { error_stack: stack, ...data });
            }
        };
        window.SmartLog = SmartLog;

        // *******************************************************************
        // 3. AUTHENTICATION & SECURITY (`ensureAuth`)
        // *******************************************************************
        let isUserAuthenticated = false;

        function ensureAuth() {
            return new Promise((resolve, reject) => {
                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    unsubscribe(); // Stop listening after first check
                    if (user) {
                        isUserAuthenticated = true;
                        document.getElementById('last-updated').innerText = `מחובר כ: ${user.email}`;
                        SmartLog.info("User authenticated", "Auth");
                        resolve(user);
                    } else {
                        isUserAuthenticated = false;
                        document.getElementById('last-updated').innerText = 'מנותק';
                        SmartLog.warn("User unauthenticated. Initiating sign-in process.", "Auth");

                        // Use Google Auth popup for a stable, admin login mechanism
                        const provider = new GoogleAuthProvider();
                        signInWithPopup(auth, provider)
                            .then((result) => {
                                const user = result.user;
                                SmartLog.info("Sign-in successful", "Auth", { uid: user.uid, email: user.email });
                                document.getElementById('last-updated').innerText = `מחובר כ: ${user.email}`;
                                isUserAuthenticated = true;
                                resolve(user);
                            })
                            .catch((error) => {
                                console.error("Authentication failed:", error);
                                showToast(`שגיאת התחברות: ${error.message}. נסה לרענן.`, 'error');
                                reject(new Error("Authentication failed"));
                            });
                    }
                });
            });
        }
        window.ensureAuth = ensureAuth;

        // *******************************************************************
        // 4. CORE DATA FETCHING AND REALTIME LISTENERS (onSnapshot)
        //    - Added try/catch to onSnapshot error handling
        // *******************************************************************

        let ordersData = [];
        let driversData = [];
        let customersData = [];
        let containersData = {};

        function setupRealtimeListeners() {
            if (!db) return; // Skip if Firebase init failed

            // 4.1 Orders Listener
            try {
                // Query: active orders, ordered by date/time
                const ordersQuery = query(collection(db, 'orders'), where('status', 'in', ['pending', 'assigned', 'on_route']), orderBy('orderDate', 'asc'), orderBy('orderTime', 'asc'));
                onSnapshot(ordersQuery, (snapshot) => {
                    ordersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    console.log(`Realtime update: ${ordersData.length} active orders received.`);
                    // Update UI functions (kept the original names)
                    renderOrdersList();
                    updateMapMarkers();
                    document.getElementById('last-updated').innerText = `עדכון: ${new Date().toLocaleTimeString('he-IL')}`;
                }, (error) => {
                    SmartLog.error(error, "Listener.Orders", { message: "Failed to fetch active orders" });
                    showToast('שגיאה בהאזנה להזמנות פעילות', 'error');
                    document.getElementById('orders-list').innerHTML = `<div class="p-4 text-center text-red-500">שגיאה: לא ניתן לטעון הזמנות.</div>`;
                });
            } catch (e) {
                SmartLog.error(e, "Listener.Orders.Setup", { message: "Error setting up orders listener" });
            }

            // 4.2 Drivers Listener
            try {
                // Query: active drivers
                const driversQuery = query(collection(db, 'drivers'), where('isActive', '==', true));
                onSnapshot(driversQuery, (snapshot) => {
                    driversData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    console.log(`Realtime update: ${driversData.length} active drivers received.`);
                    // Update UI functions (kept the original names)
                    renderDriversList();
                    updateDriverSelect(); // Populate driver selection for history view
                    updateDriverMarkers();
                }, (error) => {
                    SmartLog.error(error, "Listener.Drivers", { message: "Failed to fetch active drivers" });
                    showToast('שגיאה בהאזנה לנהגים פעילים', 'error');
                    document.getElementById('drivers-list').innerHTML = `<div class="p-4 text-center text-red-500">שגיאה: לא ניתן לטעון נהגים.</div>`;
                });
            } catch (e) {
                SmartLog.error(e, "Listener.Drivers.Setup", { message: "Error setting up drivers listener" });
            }

            // 4.3 Customers Listener
            try {
                // Query: all customers
                const customersQuery = query(collection(db, 'customers'), orderBy('name', 'asc'));
                onSnapshot(customersQuery, (snapshot) => {
                    customersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    console.log(`Realtime update: ${customersData.length} customers received.`);
                    // Update UI functions (kept the original names)
                    updateCustomerDatalist(customersData);
                    if (document.querySelector('.app-view.active').id === 'view-history') {
                        renderCustomerTable(); // Refresh table if visible
                    }
                }, (error) => {
                    SmartLog.error(error, "Listener.Customers", { message: "Failed to fetch customers" });
                    showToast('שגיאה בהאזנה ללקוחות', 'error');
                });
            } catch (e) {
                SmartLog.error(e, "Listener.Customers.Setup", { message: "Error setting up customers listener" });
            }

            // 4.4 Containers Listener
            try {
                // Query: container orders that are not yet completed/cancelled
                const containersQuery = query(collection(db, 'orders'), where('isContainer', '==', true), where('status', 'not-in', ['completed', 'cancelled']));
                onSnapshot(containersQuery, (snapshot) => {
                    containersData = {}; // Clear existing data
                    let totalActive = 0;
                    snapshot.docs.forEach(doc => {
                        const data = { id: doc.id, ...doc.data() };
                        const warehouse = data.warehouse || 'Unknown';
                        if (!containersData[warehouse]) {
                            containersData[warehouse] = [];
                        }
                        containersData[warehouse].push(data);
                        totalActive++;
                    });
                    console.log(`Realtime update: ${totalActive} active containers received across warehouses.`);

                    // Update UI functions (kept the original names)
                    if (document.querySelector('.app-view.active').id === 'view-containers') {
                         renderContainersView();
                    }
                    document.getElementById('total-active-containers').innerText = totalActive;

                }, (error) => {
                    SmartLog.error(error, "Listener.Containers", { message: "Failed to fetch container data" });
                    showToast('שגיאה בהאזנה לנתוני מכולות', 'error');
                });
            } catch (e) {
                 SmartLog.error(e, "Listener.Containers.Setup", { message: "Error setting up containers listener" });
            }
        }
        window.setupRealtimeListeners = setupRealtimeListeners;


        // *******************************************************************
        // 5. CRUD OPERATIONS IMPROVEMENTS (Add try/catch, ensure serverTimestamp)
        // *******************************************************************

        // 5.1 submitNewOrder - Added try/catch and consistency checks
        async function submitNewOrder(event) {
            event.preventDefault();
            const btn = document.getElementById('submit-order-btn');
            btn.disabled = true;
            btn.innerText = 'שולח...';

            try {
                await ensureAuth(); // Ensure user is authenticated before writing

                const customerIdExisting = document.getElementById('customer-id-existing').value;
                const customerSearchTerm = document.getElementById('customer-search').value.trim();

                let finalCustomerId;
                let customerAddress;

                if (customerIdExisting) {
                    // Existing customer
                    finalCustomerId = customerIdExisting;
                    customerAddress = document.getElementById('customer-address-display').innerText;
                } else if (customerSearchTerm) {
                    // New customer flow
                    const name = document.getElementById('customer-name-new').value.trim();
                    const phone = document.getElementById('customer-phone-new').value.trim();
                    const street = document.getElementById('customer-street-new').value.trim();
                    const streetNum = document.getElementById('customer-streetnum-new').value.trim();
                    const city = document.getElementById('customer-city-new').value.trim();
                    const contact = document.getElementById('customer-contact-new').value.trim();
                    const customerNumber = document.getElementById('customer-number-new').value.trim() || generateUniqueCustomerNumber(); // Assuming this exists

                    if (!name || !phone || !street || !city) {
                        throw new Error("חובה למלא את כל שדות הלקוח החדש (שם, טלפון, רחוב, עיר).");
                    }

                    // Add new customer
                    const newCustomerRef = await addDoc(collection(db, 'customers'), {
                        name: name,
                        phone: phone,
                        street: street,
                        streetNum: streetNum,
                        city: city,
                        contact: contact,
                        customerNumber: customerNumber,
                        createdAt: serverTimestamp(),
                        lastModified: serverTimestamp()
                    });
                    finalCustomerId = newCustomerRef.id;
                    customerAddress = `${street} ${streetNum}, ${city}`;
                    SmartLog.info("New customer created successfully", "CRUD.Customer.Create", { customerId: finalCustomerId, name: name });

                } else {
                     throw new Error("חובה לבחור או להזין פרטי לקוח חדש.");
                }

                // Order data
                const orderNumber = document.getElementById('order-number').value.trim() || generateUniqueOrderNumber(); // Assuming this exists
                const orderDate = document.getElementById('order-date').value;
                const orderTime = document.getElementById('order-time').value;
                const deliveryType = document.getElementById('order-delivery-type').value;
                const warehouse = document.getElementById('order-warehouse').value;
                const notes = document.getElementById('order-notes').value.trim();

                if (!orderDate || !deliveryType || !warehouse) {
                    throw new Error("חובה למלא את שדות ההזמנה (תאריך, סוג הובלה, מחסן).");
                }

                const isContainer = deliveryType.includes('מכולה');
                let rentalStartDate = null;
                if (isContainer) {
                    // Set rentalStartDate based on order date/time
                    try {
                        const date = new Date(`${orderDate}T${orderTime || '00:00'}:00`);
                        if (isNaN(date)) throw new Error("Invalid date/time for container start");
                        rentalStartDate = date;
                    } catch(e) {
                         SmartLog.error(e, "CRUD.Order.Create", { date: orderDate, time: orderTime });
                         throw new Error("שגיאה בהמרת תאריך/שעה לתחילת שכירות.");
                    }
                }

                // Create the new order document
                const newOrderData = {
                    orderNumber: orderNumber,
                    customerId: finalCustomerId,
                    customerName: document.getElementById(customerIdExisting ? 'customer-name-display' : 'customer-name-new').value.trim(),
                    address: customerAddress, // Use the determined address
                    orderDate: orderDate,
                    orderTime: orderTime,
                    deliveryType: deliveryType,
                    warehouse: warehouse,
                    notes: notes,
                    status: 'pending', // Initial status
                    isContainer: isContainer,
                    rentalStartDate: rentalStartDate,
                    createdAt: serverTimestamp(),
                    lastModified: serverTimestamp()
                };

                const orderRef = await addDoc(collection(db, 'orders'), newOrderData);

                SmartLog.info("New order created successfully", "CRUD.Order.Create", { orderId: orderRef.id, orderNumber: orderNumber });
                showToast('הזמנה חדשה נוצרה בהצלחה!', 'success');
                closeNewOrderForm();
                resetNewOrderForm(); // Assuming this function exists
            } catch (error) {
                showToast(`שגיאה ביצירת הזמנה: ${error.message}`, 'error');
                SmartLog.error(error, "CRUD.Order.Create.Error");
            } finally {
                btn.disabled = false;
                btn.innerText = 'צור הזמנה';
            }
        }
        window.submitNewOrder = submitNewOrder;

        // 5.2 updateOrderStatus - Added try/catch and consistency checks
        async function updateOrderStatus(orderId, newStatus, btn) {
            if (!orderId || !newStatus || !db) return;

            // Optional: add visual feedback before disabling
            btn.innerHTML = `<i data-feather="loader" class="w-4 h-4 animate-spin"></i>`;
            feather.replace();
            btn.disabled = true;

            try {
                await ensureAuth();

                const orderRef = doc(db, 'orders', orderId);

                // Fetch existing data for a robust update/logging
                const orderSnap = await getDoc(orderRef);
                if (!orderSnap.exists()) {
                    throw new Error("Order not found.");
                }
                const existingStatus = orderSnap.data().status;

                await updateDoc(orderRef, {
                    status: newStatus,
                    updatedBy: auth.currentUser ? auth.currentUser.email : 'admin',
                    lastModified: serverTimestamp()
                });

                SmartLog.info(`Order status updated from ${existingStatus} to ${newStatus}`, "CRUD.Order.StatusUpdate", { orderId, newStatus });
                showToast(`סטטוס הזמנה ${orderId} עודכן ל: ${newStatus}`, 'success');

            } catch (error) {
                showToast(`שגיאה בעדכון סטטוס: ${error.message}`, 'error');
                SmartLog.error(error, "CRUD.Order.StatusUpdate", { orderId, newStatus });
            } finally {
                // Restore button state
                btn.disabled = false;
                if (newStatus === 'completed') {
                     btn.innerText = 'בוצע';
                     btn.className = btn.className.replace('text-blue-500', 'text-green-500');
                } else {
                     btn.innerHTML = 'עדכן סטטוס';
                     feather.replace();
                }
            }
        }
        window.updateOrderStatus = updateOrderStatus;

        // 5.3 handleSaveCustomer - Added try/catch and setDoc/updateDoc logic
        async function handleSaveCustomer(event) {
            event.preventDefault();
            const btn = document.getElementById('customer-edit-save-btn');
            btn.disabled = true;
            btn.innerText = 'שומר...';

            try {
                await ensureAuth();

                const customerId = document.getElementById('customer-edit-id').value;
                const name = document.getElementById('customer-edit-name').value.trim();
                const number = document.getElementById('customer-edit-number').value.trim();
                const phone = document.getElementById('customer-edit-phone').value.trim();
                const street = document.getElementById('customer-edit-street').value.trim();
                const streetNum = document.getElementById('customer-edit-streetnum').value.trim();
                const city = document.getElementById('customer-edit-city').value.trim();
                const contact = document.getElementById('customer-edit-contact').value.trim();
                const notes = document.getElementById('customer-edit-notes').value.trim();

                if (!customerId || !name || !phone || !street || !city) {
                    throw new Error("חובה למלא את שדות השם, טלפון, רחוב ועיר.");
                }

                const customerRef = doc(db, 'customers', customerId);
                const customerSnap = await getDoc(customerRef);
                const isNew = !customerSnap.exists();

                const customerData = {
                    name: name,
                    customerNumber: number,
                    phone: phone,
                    street: street,
                    streetNum: streetNum,
                    city: city,
                    contact: contact,
                    notes: notes,
                    lastModified: serverTimestamp()
                };

                if (isNew) {
                    customerData.createdAt = serverTimestamp();
                    await setDoc(customerRef, customerData); // Use setDoc for new/upsert
                    SmartLog.info("Customer created/updated (setDoc)", "CRUD.Customer.Edit", { customerId });
                } else {
                    await updateDoc(customerRef, customerData); // Use updateDoc for existing
                    SmartLog.info("Customer updated", "CRUD.Customer.Edit", { customerId, changes: customerData });
                }

                showToast('פרטי לקוח נשמרו בהצלחה', 'success');
                closeCustomerEditModal();

            } catch (error) {
                showToast(`שגיאה בשמירת לקוח: ${error.message}`, 'error');
                SmartLog.error(error, "CRUD.Customer.Edit.Error", { customerId: document.getElementById('customer-edit-id').value });
            } finally {
                btn.disabled = false;
                btn.innerText = 'שמור שינויים';
            }
        }
        window.handleSaveCustomer = handleSaveCustomer;

        // 5.4 handleSaveContainerOrder - Ensured full try/catch and modular functions
        async function handleSaveContainerOrder(event) {
            event.preventDefault();
            const btn = document.getElementById('container-edit-save-btn');
            btn.disabled = true;
            btn.innerText = 'שומר...';

            try {
                await ensureAuth();

                const orderId = document.getElementById('container-edit-id').value;
                const orderRef = doc(db, 'orders', orderId);

                const orderDate = document.getElementById('container-edit-date').value;
                const orderTime = document.getElementById('container-edit-time').value;
                const deliveryType = document.getElementById('container-edit-delivery-type').value;

                let rentalStartDate = null;
                const rentalStartDateInput = document.getElementById('container-edit-rental-start-date').value;
                const rentalStartTimeInput = document.getElementById('container-edit-rental-start-time').value;

                if (rentalStartDateInput) {
                     try {
                         const dateString = `${rentalStartDateInput}T${rentalStartTimeInput || '00:00'}:00`;
                         const date = new Date(dateString);
                         if (isNaN(date)) {
                             throw new Error("Invalid date/time format for rental start");
                         }
                         // Firestore stores Date objects as Timestamps
                         rentalStartDate = date;
                     } catch(e) {
                         SmartLog.error(e, "CRUD.Container.Edit", { orderId, date: rentalStartDateInput, time: rentalStartTimeInput });
                         throw new Error("שגיאה בהמרת תאריך/שעה לתחילת שכירות.");
                     }
                 }

                 const updatedData = {
                    deliveryType: deliveryType,
                    orderDate: orderDate,
                    orderTime: orderTime,
                    notes: document.getElementById('container-edit-notes').value.trim(),
                    rentalStartDate: rentalStartDate, // Update or clear the field
                    lastModified: serverTimestamp()
                 };

                 await updateDoc(orderRef, updatedData);
                 SmartLog.info("Container order updated", "CRUD.Container.Edit", { orderId, changes: updatedData });
                 showToast('הזמנת מכולה עודכנה', 'success');
                 closeContainerEditModal();
                 // Listener will automatically refresh the container view if it's active

             } catch (error) {
                 showToast(`שגיאה בעדכון הזמנת מכולה: ${error.message}`, 'error');
                 SmartLog.error(error, "CRUD.Container.Edit", { orderId: document.getElementById('container-edit-id').value });
             } finally {
                 btn.disabled = false;
                 btn.innerText = 'שמור שינויים';
             }
         }
        window.handleSaveContainerOrder = handleSaveContainerOrder;

        // *******************************************************************
        // 6. MAIN INIT FUNCTION (Added robust execution flow)
        // *******************************************************************
        document.addEventListener('DOMContentLoaded', () => {
            feather.replace(); // Ensure icons are loaded
            initializeMap(); // Assuming this exists and works

            // Start the process: Ensure auth, then setup listeners
            ensureAuth()
                .then(() => {
                    setupRealtimeListeners(); // Start listening for data
                    document.getElementById('map-loader').style.display = 'none'; // Hide initial loader
                })
                .catch(error => {
                    console.error("Critical: Initialization failed after auth attempt.", error);
                    document.getElementById('map-loader').innerHTML = `<div class="p-8 text-center text-red-500">שגיאה קריטית: נדרשת התחברות. רענן ונסה שוב.</div>`;
                });

            // Other DOM listeners (assuming these existed)
            if (document.getElementById('history-filter-btn')) {
                document.getElementById('history-filter-btn').addEventListener('click', filterHistoryOrders);
            }
            if (document.getElementById('driver-history-filter-btn')) {
                document.getElementById('driver-history-filter-btn').addEventListener('click', loadDriverHistory);
            }
        });

        // *******************************************************************
        // 7. PLACEHOLDERS FOR REQUIRED UI/UTILITY FUNCTIONS (Must exist for code to run)
        // *******************************************************************

        // Placeholder UI/Utility Functions - Assuming original implementation exists but not provided
        function showView(viewId) {
            document.querySelectorAll('.app-view').forEach(view => view.classList.remove('active'));
            document.getElementById(`view-${viewId}`).classList.add('active');
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            document.querySelector(`.nav-link[onclick*="${viewId}"]`).classList.add('active');
            console.log(`View switched to: ${viewId}`);
            if (viewId === 'containers') { renderContainersView(); }
        }
        window.showView = showView;

        function initializeMap() { console.log('Map initialized.'); }
        window.initializeMap = initializeMap;

        function updateMapMarkers() { console.log('Map markers updated.'); }
        window.updateMapMarkers = updateMapMarkers;

        function updateDriverMarkers() { console.log('Driver markers updated.'); }
        window.updateDriverMarkers = updateDriverMarkers;

        function renderOrdersList() { document.getElementById('orders-list').innerHTML = ordersData.map(o => `<div class="order-card" onclick="showOrderDetails('${o.id}')"><h4>${o.orderNumber} - ${o.customerName}</h4></div>`).join(''); }
        window.renderOrdersList = renderOrdersList;

        function renderDriversList() { document.getElementById('drivers-list').innerHTML = driversData.map(d => `<div class="driver-card" onclick="showDriverDetails('${d.id}')"><h4>${d.name} (${d.status})</h4></div>`).join(''); }
        window.renderDriversList = renderDriversList;

        function updateDriverSelect() { console.log('Driver select updated.'); }
        window.updateDriverSelect = updateDriverSelect;

        function updateCustomerDatalist() { console.log('Customer datalist updated.'); }
        window.updateCustomerDatalist = updateCustomerDatalist;

        function renderCustomerTable() { console.log('Customer table rendered.'); }
        window.renderCustomerTable = renderCustomerTable;

        function renderContainersView() { console.log('Containers view rendered.'); }
        window.renderContainersView = renderContainersView;

        function filterHistoryOrders() { console.log('History filtered.'); }
        window.filterHistoryOrders = filterHistoryOrders;

        function loadDriverHistory() { console.log('Driver history loaded.'); }
        window.loadDriverHistory = loadDriverHistory;

        function generateUniqueOrderNumber() { return 'ORD-' + Math.random().toString(36).substring(2, 9).toUpperCase(); }
        window.generateUniqueOrderNumber = generateUniqueOrderNumber;

        function generateUniqueCustomerNumber() { return 'CUST-' + Math.random().toString(36).substring(2, 7).toUpperCase(); }
        window.generateUniqueCustomerNumber = generateUniqueCustomerNumber;

        function showPanelTab(tab) { console.log(`Panel tab switched to: ${tab}`); }
        window.showPanelTab = showPanelTab;

        function filterLists() { console.log('Lists filtered.'); }
        window.filterLists = filterLists;

        function openNewOrderForm() { document.getElementById('new-order-modal').showModal(); }
        window.openNewOrderForm = openNewOrderForm;

        function closeNewOrderForm() { document.getElementById('new-order-modal').close(); }
        window.closeNewOrderForm = closeNewOrderForm;

        function resetNewOrderForm() { console.log('New order form reset.'); }
        window.resetNewOrderForm = resetNewOrderForm;

        function handleCustomerSearch() { console.log('Customer search handled.'); }
        window.handleCustomerSearch = handleCustomerSearch;

        function closeCustomerEditModal() { document.getElementById('customer-edit-modal').close(); }
        window.closeCustomerEditModal = closeCustomerEditModal;

        function closeContainerEditModal() { document.getElementById('container-edit-modal').close(); }
        window.closeContainerEditModal = closeContainerEditModal;

        function showOrderDetails(orderId) { console.log(`Showing details for order: ${orderId}`); document.getElementById('details-panel').style.display = 'block'; }
        window.showOrderDetails = showOrderDetails;

        function showDriverDetails(driverId) { console.log(`Showing details for driver: ${driverId}`); document.getElementById('details-panel').style.display = 'block'; }
        window.showDriverDetails = showDriverDetails;


        // Toast implementation
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerText = message;
            container.prepend(toast);
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }
        window.showToast = showToast;

        function sendGlobalPing() {
            // Placeholder for an Apps Script / API call.
            // Ensure any API calls are wrapped in try/catch for stability.
            try {
                // Placeholder API logic:
                showToast('שולח התראה גלובלית... (API קריאה מדומה)', 'info');
                // await fetch('YOUR_APPS_SCRIPT_URL', { ... });
                // showToast('התראה גלובלית נשלחה בהצלחה', 'success');
            } catch (e) {
                SmartLog.error(e, "API.GlobalPing", { url: 'Placeholder' });
                showToast('שגיאה בשליחת התראה גלובלית', 'error');
            }
        }
        window.sendGlobalPing = sendGlobalPing;

    </script>
</body>
</html>
