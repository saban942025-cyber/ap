<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DeliveryMaster Admin (Mobile)</title>
    <!--
      DeliveryMaster Admin App v33.0 (Mobile UI)

      Changelog:
      - v33.0: Refactored UI for Mobile-First experience.
        - Replaced sidebar with bottom navigation bar.
        - Dashboard: Map top, scrollable lists/tabs below.
        - Details Panel opens as a bottom sheet modal.
        - History/Customers: Tabs remain, tables optimized.
        - New Order/Edit Customer forms are full-screen modals.
        - Added dedicated manifest.json for Admin PWA.
        - Integrated WhatsApp placeholders/ideas.
      - v32.0: Modularized Firebase/SmartLog, Added SW registration.
      - v31.9: Added Global Ping.
      ... (Previous versions)
    -->

    <!-- PWA Settings -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#1F2937"> <!-- Dark Nav Color -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/ryPT3r29/image.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #3b82f6; --primary-dark: #2563eb; --bg-light: #f3f4f6;
            --bg-white: #ffffff; --border-color: #e5e7eb; --text-dark: #1f2937;
            --text-light: #6b7280; --bg-dark-nav: #1f2937; --text-nav: #9ca3af;
            --text-nav-active: #ffffff; --bottom-nav-height: 60px; /* Height for bottom nav */
        }
        html, body { height: 100vh; width: 100vw; overflow: hidden; }
        body { font-family: 'Inter', 'Arial', sans-serif; background-color: var(--bg-light); color: var(--text-dark); display: flex; flex-direction: column; }

        /* Main App View Container */
        .app-container { flex-grow: 1; overflow: hidden; position: relative; padding-bottom: var(--bottom-nav-height); /* Space for bottom nav */ }
        .app-view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; background-color: var(--bg-light); opacity: 0; transition: opacity 0.3s ease; pointer-events: none; z-index: 1; }
        .app-view.active { opacity: 1; pointer-events: auto; z-index: 10; }

        /* Bottom Navigation */
        #bottom-navbar { position: fixed; bottom: 0; left: 0; right: 0; height: var(--bottom-nav-height); background-color: var(--bg-dark-nav); color: var(--text-nav); display: flex; justify-content: space-around; align-items: center; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; padding: 0 5px; padding-bottom: env(safe-area-inset-bottom); /* iOS safe area */ }
        .nav-button { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 5px 0; border-top: 3px solid transparent; flex-grow: 1; transition: color 0.2s, border-color 0.2s; }
        .nav-button svg { width: 24px; height: 24px; margin-bottom: 2px; }
        .nav-button span { font-size: 0.7rem; font-weight: 500; }
        .nav-button.active { color: var(--text-nav-active); border-top-color: var(--primary-color); }
        .nav-button:not(.active):hover { color: var(--text-nav-active); }

        /* Header (Optional, maybe just for specific views) */
        .view-header { background-color: var(--bg-white); padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .view-header h2 { font-size: 1.1rem; font-weight: 700; }

        /* Dashboard View */
        #view-dashboard { display: flex; flex-direction: column; }
        #dashboard-map-container { height: 50%; /* Adjust as needed */ position: relative; background-color: #e0e0e0; flex-shrink: 0; }
        #map { height: 100%; width: 100%; }
        #dashboard-content { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; background-color: var(--bg-white); border-top: 1px solid var(--border-color); }
        #dashboard-tabs { display: flex; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .dash-tab-button { flex: 1; padding: 0.8rem 0.5rem; font-weight: 500; text-align: center; border-bottom: 3px solid transparent; color: var(--text-light); cursor: pointer; }
        .dash-tab-button.active { border-bottom-color: var(--primary-color); color: var(--primary-color); }
        #dashboard-search { padding: 0.5rem; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        #dashboard-lists { flex-grow: 1; position: relative; overflow: hidden; }
        .panel-list { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow-y: auto; background-color: var(--bg-white); opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
        .panel-list.active { opacity: 1; pointer-events: auto; }
        .order-card, .driver-card { padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-color); }
        .order-card.active, .driver-card.active { background-color: #eff6ff; border-right: 3px solid var(--primary-color); /* Keep border indicator */ }

        /* Details Panel Modal (Bottom Sheet) */
        #details-modal { max-width: 100%; width: 100%; margin: 0; border: none; border-radius: 16px 16px 0 0; background-color: var(--bg-white); box-shadow: 0 -5px 20px rgba(0,0,0,0.1); padding: 0; max-height: 60vh; /* Limit height */ overflow: hidden; /* Prevent body scroll */ }
        #details-modal::backdrop { background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        .details-modal-content { padding: 1.5rem 1rem 1rem 1rem; display: flex; flex-direction: column; max-height: calc(60vh - 50px); /* Adjust based on handle/header */ overflow-y: auto; }
        .details-modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .details-modal-header h4 { font-weight: 700; font-size: 1.1rem; }
        .details-modal-header button { background: none; border: none; color: var(--text-light); cursor: pointer; padding: 0.25rem; }
        .details-modal-header button:hover { color: var(--text-dark); }
        .details-modal-content ul { list-style: none; padding: 0; margin: 0; }
        .details-modal-content li { margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--text-light); }
        .details-modal-content strong { color: var(--text-dark); font-weight: 500; }
        .details-modal-content .sub-header { font-weight: 600; color: var(--text-dark); margin-top: 1rem; margin-bottom: 0.5rem; }
        .details-modal-content .dist { font-weight: 500; color: var(--text-dark); display: inline-block; min-width: 50px; text-align: right; margin-left: 0.5rem; }

        /* History/Customers View */
        #view-history { display: flex; flex-direction: column; }
        #history-tabs { display: flex; border-bottom: 1px solid var(--border-color); flex-shrink: 0; background-color: var(--bg-white); }
        .history-tab-button { flex: 1; padding: 0.8rem 0.5rem; font-weight: 500; text-align: center; border-bottom: 3px solid transparent; color: var(--text-light); cursor: pointer; }
        .history-tab-button.active { border-bottom-color: var(--primary-color); color: var(--primary-color); }
        .history-content { flex-grow: 1; overflow-y: auto; padding: 1rem; }
        .history-content h3 { font-size: 1.2rem; font-weight: 700; margin-bottom: 1rem; }
        .table-tools { display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem; background-color: var(--bg-white); padding: 0.75rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .table-tools input, .table-tools button { padding: 0.6rem; border-radius: 6px; border: 1px solid var(--border-color); font-size: 0.9rem; }
        .table-tools button { background-color: var(--primary-color); color: white; border: none; cursor: pointer; }
        .table-wrapper { overflow-x: auto; background-color: var(--bg-white); border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .data-table { width: 100%; min-width: 600px; /* Ensure horizontal scroll on small screens */ border-collapse: collapse; }
        .data-table th, .data-table td { padding: 0.75rem; text-align: right; border-bottom: 1px solid var(--border-color); font-size: 0.85rem; white-space: nowrap; }
        .data-table thead { background-color: #f9fafb; } .data-table th { font-weight: 500; color: var(--text-light); text-transform: uppercase; font-size: 0.75rem; }
        .data-table tbody tr:hover { background-color: #f3f4f6; }
        .data-table .action-button { background-color: var(--primary-color); color: white; padding: 3px 6px; border-radius: 4px; font-size: 0.75rem; cursor: pointer; border: none; margin-right: 4px; }
        .data-table .action-button-secondary { background-color: var(--text-light); }
        .customer-table tbody tr { cursor: pointer; }

        /* Full Screen Modals (New Order, Edit Customer) */
        .full-modal { max-width: 100%; width: 100%; height: 100%; margin: 0; border-radius: 0; box-shadow: none; padding: 0; display: flex; flex-direction: column; }
        .modal-header { padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background-color: var(--bg-white); flex-shrink: 0; }
        .modal-header h3 { font-size: 1.1rem; font-weight: 700; }
        .modal-header button { background: none; border: none; padding: 0.25rem; color: var(--text-light); cursor: pointer; }
        .modal-content { flex-grow: 1; overflow-y: auto; padding: 1rem; }
        .modal-footer { padding: 0.75rem 1rem; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 0.5rem; background-color: #f9fafb; flex-shrink: 0; }
        .modal-footer button { padding: 0.6rem 1rem; border-radius: 6px; font-weight: 500; cursor: pointer; border: 1px solid var(--border-color); }
        .modal-footer .btn-primary { background-color: var(--primary-color); color: white; border: none; }
        .modal-footer .btn-secondary { background-color: var(--bg-white); color: var(--text-dark); }

        /* Loader */
        .loader-container { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.7); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; } @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Toast */
        #toast-container { position: fixed; bottom: calc(var(--bottom-nav-height) + 10px); /* Above bottom nav */ left: 50%; transform: translateX(-50%); z-index: 5000; display: flex; flex-direction: column; gap: 8px; }
        .toast { padding: 10px 15px; background-color: var(--text-dark); color: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); opacity: 0; transform: translateY(20px); transition: all 0.3s ease; font-size: 0.9rem; }
        .toast.show { opacity: 1; transform: translateY(0); } .toast.success { background-color: #22c55e; } .toast.error { background-color: #ef4444; } .toast.info { background-color: #3b82f6;} .toast.warn { background-color: #f59e0b;}

        /* WhatsApp Button Placeholder */
        .whatsapp-button { background-color: #25D366; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; cursor: pointer; margin-left: 4px; border: none; }
        .whatsapp-button:hover { background-color: #1DAE50; }
        .whatsapp-button i { margin-right: 4px; } /* Correct margin for RTL */

    </style>
</head>
<body class="antialiased">

    <div class="app-container">
        <!-- Dashboard View -->
        <main id="view-dashboard" class="app-view active">
            <div id="dashboard-map-container">
                <div id="map"></div>
                <div id="map-loader" class="loader-container"><div class="loader"></div></div>
            </div>
            <div id="dashboard-content">
                <div id="dashboard-tabs">
                    <button id="tab-orders" class="dash-tab-button active" onclick="showPanelTab('orders')">הזמנות חדשות</button>
                    <button id="tab-drivers" class="dash-tab-button" onclick="showPanelTab('drivers')">נהגים פעילים</button>
                </div>
                <div id="dashboard-search">
                    <input type="text" id="search-input" placeholder="חיפוש..." class="w-full px-3 py-1.5 border rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-300 text-sm" onkeyup="filterLists()">
                </div>
                <div id="dashboard-lists">
                    <div id="orders-list" class="panel-list active"><div class="loader-container hidden"><div class="loader"></div></div></div>
                    <div id="drivers-list" class="panel-list"><div class="loader-container hidden"><div class="loader"></div></div></div>
                </div>
            </div>
        </main>

        <!-- History & Customers View -->
        <div id="view-history" class="app-view">
            <div id="history-tabs">
                <button class="history-tab-button active" onclick="showHistoryTab('orders')">היסטוריית הזמנות</button>
                <button class="history-tab-button" onclick="showHistoryTab('customers')">ניהול לקוחות</button>
            </div>
            <div class="history-content" id="history-orders-content">
                <h3>היסטוריית הזמנות</h3>
                <div class="table-tools">
                    <input type="text" id="history-search" placeholder="חיפוש...">
                    <div class="flex gap-2">
                        <input type="date" id="history-date-from" title="מתאריך" class="flex-1">
                        <input type="date" id="history-date-to" title="עד תאריך" class="flex-1">
                    </div>
                    <button id="history-filter-btn" onclick="renderHistoryTable()">סנן</button>
                </div>
                <div class="table-wrapper"><table class="data-table"><thead><tr><th>מס'</th><th>לקוח</th><th>נהג</th><th>כתובת</th><th>סטטוס</th><th>תאריך</th><th>פעולות</th></tr></thead><tbody id="history-table-body"></tbody></table></div>
            </div>
            <div class="history-content" id="history-customers-content" style="display: none;">
                <h3>ניהול לקוחות</h3>
                <div class="table-tools"><input type="text" id="customer-search-input" placeholder="חיפוש..." onkeyup="renderCustomerTable()"></div>
                <div class="table-wrapper"><table class="data-table"><thead><tr><th>שם</th><th>מס' לקוח</th><th>טלפון</th><th>כתובת</th></tr></thead><tbody id="customer-table-body"></tbody></table></div>
            </div>
        </div>

        <!-- Add more views here if needed (e.g., Driver History, Settings) -->

    </div>

    <!-- Bottom Navigation Bar -->
    <nav id="bottom-navbar">
        <button class="nav-button active" onclick="showView('dashboard')"><i data-feather="map"></i><span>דשבורד</span></button>
        <button class="nav-button" onclick="showView('history')"><i data-feather="archive"></i><span>היסטוריה</span></button>
        <button class="nav-button" onclick="openNewOrderForm()"><i data-feather="plus-circle"></i><span>חדשה</span></button>
        <button class="nav-button" onclick="sendGlobalPing()"><i data-feather="bell"></i><span>התראה</span></button>
        <!-- Add button for log view? -->
         <a href="log.html" target="_blank" class="nav-button"><i data-feather="file-text"></i><span>לוגים</span></a>
    </nav>

    <!-- Details Modal (Bottom Sheet) -->
    <dialog id="details-modal">
        <div class="details-modal-header">
            <h4 id="details-modal-title">פרטים</h4>
            <div>
                 <button id="details-whatsapp-btn" class="whatsapp-button mr-2 hidden" onclick="handleWhatsAppAction()" title="פעולות וואטסאפ">
                     <i class="fab fa-whatsapp"></i>
                 </button>
                <button id="details-copy-link-btn" class="hidden" onclick="copyCustomerLinkFromDetails()" title="העתק לינק ללקוח"><i data-feather="share-2"></i></button>
                <button onclick="closeDetailsModal()"><i data-feather="x"></i></button>
            </div>
        </div>
        <div class="details-modal-content" id="details-modal-body">טוען פרטים...</div>
    </dialog>

    <!-- New Order Modal (Full Screen) -->
    <dialog id="new-order-modal" class="full-modal">
        <form onsubmit="submitNewOrder(event)">
            <div class="modal-header">
                <h3>יצירת הזמנה חדשה</h3>
                <button type="button" onclick="closeNewOrderForm()"><i data-feather="x"></i></button>
            </div>
            <div class="modal-content space-y-4">
                <div><label for="customer-search" class="block text-sm font-medium mb-1">לקוח (חיפוש או חדש)</label><input type="text" id="customer-search" list="customer-list" class="w-full p-2 border rounded-md" oninput="handleCustomerSearch(this.value)" autocomplete="off"><datalist id="customer-list"></datalist></div>
                <div id="new-customer-fields" class="p-3 bg-blue-50 border border-blue-200 rounded-lg space-y-3" style="display: none;">
                    <p class="font-semibold text-blue-700 text-sm">פרטי לקוח חדש</p><input type="hidden" id="customer-id-new"><input type="text" id="customer-name-new" placeholder="שם מלא" class="w-full p-2 border rounded-md text-sm"><input type="text" id="customer-phone-new" placeholder="טלפון" class="w-full p-2 border rounded-md text-sm"><div class="grid grid-cols-3 gap-2"><input type="text" id="customer-street-new" placeholder="רחוב" class="w-full p-2 border rounded-md text-sm col-span-2"><input type="text" id="customer-streetnum-new" placeholder="מס'" class="w-full p-2 border rounded-md text-sm"></div><input type="text" id="customer-city-new" placeholder="עיר" class="w-full p-2 border rounded-md text-sm"><input type="text" id="customer-contact-new" placeholder="איש קשר" class="w-full p-2 border rounded-md text-sm"><input type="text" id="customer-number-new" placeholder="מס' לקוח (אופציונלי)" class="w-full p-2 border rounded-md text-sm">
                </div>
                <div id="existing-customer-display" class="p-3 bg-gray-100 border rounded-lg text-sm" style="display: none;">
                    <input type="hidden" id="customer-id-existing"><p><strong>לקוח:</strong> <span id="customer-name-display"></span> <span id="customer-number-display" class="text-xs text-gray-500"></span></p><p><strong>כתובת:</strong> <span id="customer-address-display"></span></p><p><strong>טלפון:</strong> <span id="customer-phone-display"></span></p>
                </div>
                <hr>
                <div><label for="order-number" class="block text-sm font-medium mb-1">מס' הזמנה (אופציונלי)</label><input type="text" id="order-number" placeholder="ריק = מזהה אוטומטי" class="w-full p-2 border rounded-md text-sm"></div>
                <div class="grid grid-cols-2 gap-4"><div><label for="order-date" class="block text-sm font-medium mb-1">תאריך</label><input type="date" id="order-date" class="w-full p-2 border rounded-md text-sm" required></div><div><label for="order-delivery-type" class="block text-sm font-medium mb-1">סוג הובלה</label><select id="order-delivery-type" class="w-full p-2 border rounded-md text-sm bg-white" required><option value="">בחר...</option><option value="הובלת מנוף">מנוף</option><option value="הובלת משאית">משאית</option><option value="איסוף עצמי">איסוף</option></select></div></div>
                <div><label for="order-warehouse" class="block text-sm font-medium mb-1">מחסן</label><select id="order-warehouse" class="w-full p-2 border rounded-md text-sm bg-white" required><option value="">בחר...</option><option value="החרש">החרש</option><option value="התלמיד">התלמיד</option></select></div>
                <div><label for="order-notes" class="block text-sm font-medium mb-1">הערות</label><textarea id="order-notes" rows="3" placeholder="הערות להזמנה..." class="w-full p-2 border rounded-md text-sm"></textarea></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeNewOrderForm()">ביטול</button>
                <button type="submit" id="submit-order-btn" class="btn-primary">צור הזמנה</button>
            </div>
        </form>
    </dialog>

    <!-- Edit Customer Modal (Full Screen) -->
    <dialog id="customer-edit-modal" class="full-modal">
        <form onsubmit="handleSaveCustomer(event)">
            <input type="hidden" id="customer-edit-id">
            <div class="modal-header">
                <h3 id="customer-edit-title">עריכת לקוח</h3>
                <button type="button" onclick="closeCustomerEditModal()"><i data-feather="x"></i></button>
            </div>
            <div class="modal-content space-y-4">
                 <div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium mb-1">שם</label><input type="text" id="customer-edit-name" class="w-full p-2 border rounded-md text-sm" required></div><div><label class="block text-sm font-medium mb-1">מס' לקוח</label><input type="text" id="customer-edit-number" class="w-full p-2 border rounded-md text-sm"></div></div>
                 <div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-medium mb-1">טלפון</label><input type="tel" id="customer-edit-phone" class="w-full p-2 border rounded-md text-sm" required></div><div><label class="block text-sm font-medium mb-1">איש קשר</label><input type="text" id="customer-edit-contact" class="w-full p-2 border rounded-md text-sm"></div></div>
                 <hr><p class="font-semibold text-gray-700 text-sm">כתובת ברירת מחדל</p>
                 <div class="grid grid-cols-3 gap-2">
                     <input type="text" id="customer-edit-street" placeholder="רחוב" class="w-full p-2 border rounded-md text-sm col-span-2" required>
                     <input type="text" id="customer-edit-streetnum" placeholder="מס'" class="w-full p-2 border rounded-md text-sm" required>
                 </div>
                 <input type="text" id="customer-edit-city" placeholder="עיר" class="w-full p-2 border rounded-md text-sm" required>
                 <div><label class="block text-sm font-medium mb-1">קואורדינטות (lat, lon)</label><input type="text" id="customer-edit-coords" placeholder="הדבק מ-Google Maps (אופציונלי)" class="w-full p-2 border rounded-md text-sm"><p class="text-xs text-gray-500 mt-1">למיקום מדויק בהזמנות</p></div>
                 <div class="mt-4 border-t pt-3"><h4 class="text-sm font-medium text-gray-600 mb-1">היסטוריית שינויים</h4><ul id="customer-audit-log" class="text-xs text-gray-500 space-y-1 max-h-20 overflow-y-auto"></ul></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeCustomerEditModal()">ביטול</button>
                <button type="submit" id="customer-save-btn" class="btn-primary">שמור שינויים</button>
            </div>
        </form>
    </dialog>

    <div id="toast-container"></div>

    <script type="module">
        // --- Import from Shared Module ---
        import {
            db, auth, authReadyPromise, functions, SmartLog,
            collection, doc, onSnapshot, query, orderBy, addDoc, updateDoc,
            serverTimestamp, deleteDoc, arrayUnion, where, getDocs, setDoc, limit, getDoc,
            Timestamp
        } from '../shared/firebase-init.js'; // Ensure relative path is correct

        // --- State, Config, Icons (remain the same) ---
        const ISRAEL_CENTER = [32.0853, 34.7818];
        const WAREHOUSE_LOCATIONS = { "החרש": [32.13266165049073, 34.898196599998755], "התלמיד": [32.16303427408473, 34.894926705310006] };
        const ALLOWED_STATUSES = ["חדש", "שויך", "בדרך", "הושלם", "בוטל"];
        let state = { orders: [], drivers: [], liveLocations: {}, customers: [] };
        let map; let driverMarkers = {}; let orderMarkers = {};
        let currentDetailsItem = null; // Store { id, type } of item in details modal

        const driverIconActive = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png', /*...*/ shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });
        const driverIconStuck = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png', /*...*/ shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });
        const orderIconNew = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png', /*...*/ shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            try { feather.replace(); } catch(e) {}
            initializeApplication();
            // Set default date for new order
            const orderDateInput = document.getElementById('order-date');
            if(orderDateInput) orderDateInput.value = new Date().toISOString().split('T')[0];
        });

        async function initializeApplication() {
            SmartLog.info("v33.0-FB (Mobile UI): Initializing...", "Init");
            showLoader('map-loader', true);
            showLoader('orders-list', true);
            showLoader('drivers-list', true);
            try {
                initMap(); // Init map early
                await authReadyPromise;
                SmartLog.info(`Auth successful.`, "Init.Auth");
                listenToDrivers(); listenToOrders(); listenToLocations(); listenToCustomers();
                document.getElementById('history-filter-btn')?.addEventListener('click', renderHistoryTable);
                // Placeholder for driver history button if added back
                // document.getElementById('driver-history-filter-btn')?.addEventListener('click', fetchAndDrawDriverRoute);
                updateStatus("מחובר"); // Simple status for mobile UI
            } catch (error) {
                SmartLog.error(error, "Init.Critical");
                updateStatus(`שגיאת אתחול`, true);
                showToast(`שגיאת אתחול: ${error.message}`, 'error');
            } finally {
                 showLoader('map-loader', false);
                 showLoader('orders-list', false);
                 showLoader('drivers-list', false);
            }
        }

        // --- initMap (remains the same), updateStatus (simplified) ---
         function initMap() {
            try {
                if (map) map.remove();
                map = L.map('map').setView(ISRAEL_CENTER, 9);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OSM' }).addTo(map);
                SmartLog.info("Map initialized", "Init.Map");
            } catch (error) {
                SmartLog.error(error, "Init.Map");
                const mapEl = document.getElementById('map');
                if (mapEl) mapEl.innerHTML = `<div class="p-4 text-center text-red-500">שגיאת מפה</div>`;
            }
        }

        // Simplified status (no dedicated element in mobile UI)
        function updateStatus(message, isError = false) {
             console.log(`Status: ${message} ${isError ? '(Error)' : ''}`);
             // Could update a small indicator in the header later if needed
        }

        // --- FIRESTORE LISTENERS (remain the same, use imported functions) ---
        function listenToDrivers() {
            const q = query(collection(db, "drivers"), orderBy("name"));
            onSnapshot(q, (snapshot) => {
                state.drivers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderDrivers(); renderMapMarkers(); // populateDriverSelector(); // History view not default
            }, e => SmartLog.error(e, "Firestore.Drivers"));
        }
        function listenToOrders() {
            const q = query(collection(db, "orders"), orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                state.orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderOrders(); renderMapMarkers(); renderHistoryTable();
            }, e => SmartLog.error(e, "Firestore.Orders"));
        }
        function listenToLocations() {
             const q = query(collection(db, "driverLocations"));
             onSnapshot(q, (snapshot) => {
                const newLocations = {}; snapshot.forEach(doc => { newLocations[doc.id] = { id: doc.id, ...doc.data() }; });
                state.liveLocations = newLocations; renderDrivers(); renderMapMarkers();
             }, e => SmartLog.error(e, "Firestore.Locations"));
        }
        function listenToCustomers() {
             const q = query(collection(db, "customers"), orderBy("name"));
             onSnapshot(q, (snapshot) => {
                state.customers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateCustomerDatalist(); renderCustomerTable();
             }, e => SmartLog.error(e, "Firestore.Customers"));
        }

        // --- RENDER FUNCTIONS (Adapted for Mobile UI) ---
        function renderDrivers() {
            const list = document.getElementById('drivers-list'); if (!list) return;
            showLoader('drivers-list', state.drivers.length === 0); // Show loader if list empty initially
            if (state.drivers.length === 0) { list.innerHTML = `<div class="p-4 text-center text-gray-500 text-sm">אין נהגים פעילים.</div>`; return; }
            const fragment = document.createDocumentFragment();
            state.drivers.forEach(driver => {
                const location = state.liveLocations[driver.id];
                const assigned = state.orders.filter(o => o.driver?.id === driver.id && o.status !== 'הושלם' && o.status !== 'בוטל').length;
                fragment.appendChild(createDriverCard(driver, location, assigned));
            });
            list.innerHTML = ''; list.appendChild(fragment); filterLists();
        }

        function createDriverCard(driver, location, assignedCount) { // Slightly smaller design
            const el = document.createElement('div');
            el.className = 'driver-card cursor-pointer'; el.id = `driver-card-${driver.id}`;
            el.setAttribute('data-search', driver.name?.toLowerCase() || '');
            el.onclick = () => focusOnMapItem(driver.id, 'driver');
            let statusClass = 'status-inactive'; let statusText = 'לא מחובר';
            if (location) {
                const minutesAgo = location.lastUpdate?.toDate ? Math.round((Date.now() - location.lastUpdate.toDate().getTime()) / 60000) : '?';
                statusClass = location.isStuck ? 'status-stuck' : 'status-active';
                statusText = location.isStuck ? `תקוע (${minutesAgo}')` : `פעיל (${minutesAgo}')`;
            }
            el.innerHTML = `
                <div class="flex justify-between items-center">
                    <span class="font-semibold text-sm">${driver.name}</span>
                    <div class="flex items-center space-x-1.5 space-x-reverse">
                        <span class="text-xs font-medium">${statusText}</span>
                        <span class="status-dot ${statusClass}" style="width:8px; height:8px;"></span>
                    </div>
                </div>
                <div class="text-xs text-gray-500 flex justify-between items-center mt-0.5">
                    <span>${driver.vehicleType || '?'} | ${driver.phone}</span>
                    <span class="text-xs font-medium text-blue-600">${assignedCount} משויכות</span>
                </div>`;
            return el;
        }

        function renderOrders() { // Renders only NEW orders for dashboard list
            const list = document.getElementById('orders-list'); if (!list) return;
            const unassignedOrders = state.orders.filter(o => o.status === 'חדש');
            showLoader('orders-list', unassignedOrders.length === 0);
            if (unassignedOrders.length === 0) { list.innerHTML = `<div class="p-4 text-center text-gray-500 text-sm">אין הזמנות חדשות.</div>`; return; }
            const fragment = document.createDocumentFragment();
            unassignedOrders.sort((a,b)=>(a.createdAt?.toMillis()||0)-(b.createdAt?.toMillis()||0))
                           .forEach(order => fragment.appendChild(createOrderCard(order)));
            list.innerHTML = ''; list.appendChild(fragment); filterLists();
        }

        function createOrderCard(order) { // Slightly smaller design
            const el = document.createElement('div');
            el.className = 'order-card cursor-pointer'; el.id = `order-card-${order.id}`;
            el.setAttribute('data-search', `${order.orderNumber || order.id} ${order.customer?.name?.toLowerCase()} ${order.address?.toLowerCase()}`);
            el.onclick = () => focusOnMapItem(order.id, 'order');
            const date = order.orderDate ? new Date(order.orderDate).toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit' }) : 'N/A';
            const name = order.customer?.name || '?'; const address = order.address || '?';
            const created = order.createdAt?.toDate ? order.createdAt.toDate().toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' }) : '';
            const displayId = order.orderNumber || `#${order.id.slice(-6)}`;
            el.innerHTML = `
                <div class="flex justify-between items-center mb-0.5">
                    <span class="font-bold text-blue-600 text-sm">${displayId}</span>
                    <span class="text-xs font-semibold">${date}</span>
                </div>
                <div class="font-semibold text-gray-800 text-xs">${name}</div>
                <div class="text-xs text-gray-600 truncate">${address}</div>
                <div class="text-xs text-gray-500 mt-0.5 flex justify-between">
                    <span>${order.deliveryType || ''} | ${order.warehouse || ''}</span>
                    <span>נוצר: ${created}</span>
                </div>`;
            return el;
        }

        // renderMapMarkers, renderHistoryTable, renderCustomerTable remain mostly the same
        // but ensure they handle potential missing elements gracefully if views are hidden
        function renderMapMarkers() {
            if (!map) return;
             const bounds = L.latLngBounds();
            let activeMarkersExist = false; // Flag to check if we should fit bounds

            // Drivers
            Object.values(state.liveLocations).forEach(loc => {
                if (!loc.latitude) return;
                const driverData = state.drivers.find(d => d.id === loc.id);
                const name = driverData?.name || loc.id.slice(-6);
                const latLng = [loc.latitude, loc.longitude];
                const icon = loc.isStuck ? driverIconStuck : driverIconActive;
                const minutesAgo = loc.lastUpdate?.toDate ? Math.round((Date.now() - loc.lastUpdate.toDate().getTime()) / 60000) : '?';
                const popup = `<h4>${name}</h4><p>${loc.isStuck ? 'תקוע' : 'פעיל'} (${minutesAgo} דק')</p>`;
                if (driverMarkers[loc.id]) driverMarkers[loc.id].setLatLng(latLng).setIcon(icon).setPopupContent(popup);
                else driverMarkers[loc.id] = L.marker(latLng, { icon }).addTo(map).bindPopup(popup).on('click', () => openDetailsModal(loc.id, 'driver'));
                 if (!loc.isStuck) { bounds.extend(latLng); activeMarkersExist = true; }
            });
            Object.keys(driverMarkers).forEach(id => { if (!state.liveLocations[id]) { if (map.hasLayer(driverMarkers[id])) map.removeLayer(driverMarkers[id]); delete driverMarkers[id]; } });

            // Orders (New only on main map)
            const unassignedOrders = state.orders.filter(o => o.status === 'חדש' && o.latitude);
            Object.keys(orderMarkers).forEach(id => { if (!unassignedOrders.some(o => o.id == id)) { if (map.hasLayer(orderMarkers[id])) map.removeLayer(orderMarkers[id]); delete orderMarkers[id]; } });
            unassignedOrders.forEach(order => {
                const latLng = [order.latitude, order.longitude];
                const popup = `<h4>${order.orderNumber || `#${order.id.slice(-6)}`}</h4><p>${order.customer?.name || '?'}</p><p>${order.address || '?'}</p><button class="mt-1 px-2 py-0.5 bg-blue-500 text-white text-xs rounded hover:bg-blue-600" onclick="openAssignDriverPrompt('${order.id}')">שייך נהג</button>`;
                if (orderMarkers[order.id]) orderMarkers[order.id].setLatLng(latLng).setPopupContent(popup);
                else orderMarkers[order.id] = L.marker(latLng, { icon: orderIconNew }).addTo(map).bindPopup(popup).on('click', () => openDetailsModal(order.id, 'order'));
                bounds.extend(latLng); activeMarkersExist = true;
            });

             // Only fit bounds if active markers exist and bounds are valid
             if (activeMarkersExist && bounds.isValid()) {
                 try { map.fitBounds(bounds, { padding: [40, 40], maxZoom: 15 }); } catch (e) {}
             } else if (!activeMarkersExist) {
                  map.setView(ISRAEL_CENTER, 9); // Reset if no markers
             }
        }
        // Simplified renderHistoryTable for brevity - Logic remains same
        function renderHistoryTable() { const list = document.getElementById('history-table-body'); if(!list) return; /* ... Filtering logic ... */ list.innerHTML = 'טוען...'; /* ... HTML generation ... */ try{feather.replace();}catch(e){} }
        // Simplified renderCustomerTable for brevity - Logic remains same
        function renderCustomerTable() { const list = document.getElementById('customer-table-body'); if(!list) return; /* ... Filtering logic ... */ list.innerHTML = 'טוען...'; /* ... HTML generation ... */ }


        // --- UI INTERACTIONS (Adapted for Mobile) ---
        function showView(viewName) {
            document.querySelectorAll('.app-view').forEach(v => v.classList.remove('active'));
            const viewEl = document.getElementById(`view-${viewName}`);
            if (viewEl) viewEl.classList.add('active');
            document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
            const btnEl = document.querySelector(`.nav-button[onclick*="'${viewName}'"]`);
            if (btnEl) btnEl.classList.add('active');
            // Re-render relevant table/list when view becomes active
            if (viewName === 'history') showHistoryTab('orders'); // Default to orders history
            if (viewName === 'dashboard') { map?.invalidateSize(); renderOrders(); renderDrivers(); } // Refresh map and lists
            SmartLog.info(`Switched to view: ${viewName}`, "UI.Nav");
        }
        window.showView = showView; // Make global

        function showHistoryTab(tabName) { // Combined History/Customer view logic
            const ordersContent = document.getElementById('history-orders-content');
            const customersContent = document.getElementById('history-customers-content');
            const ordersButton = document.querySelector('.history-tab-button[onclick*="orders"]');
            const customersButton = document.querySelector('.history-tab-button[onclick*="customers"]');
            if (!ordersContent || !customersContent || !ordersButton || !customersButton) return;
            ordersContent.style.display = (tabName === 'orders') ? 'block' : 'none';
            customersContent.style.display = (tabName === 'customers') ? 'block' : 'none';
            ordersButton.classList.toggle('active', tabName === 'orders');
            customersButton.classList.toggle('active', tabName === 'customers');
            if (tabName === 'orders') renderHistoryTable(); else renderCustomerTable();
        }
        window.showHistoryTab = showHistoryTab; // Make global

        function showPanelTab(tabName) { // Dashboard tabs (Orders/Drivers)
            document.querySelectorAll('.panel-list').forEach(p => p.classList.remove('active'));
            const listEl = document.getElementById(tabName + '-list');
            if (listEl) listEl.classList.add('active');
            document.querySelectorAll('.dash-tab-button').forEach(b => b.classList.remove('active'));
            const btnEl = document.getElementById('tab-' + tabName);
            if (btnEl) btnEl.classList.add('active');
            filterLists(); // Filter the newly shown list
        }
        window.showPanelTab = showPanelTab; // Make global

        function filterLists() { // Dashboard list filter
            const query = document.getElementById('search-input')?.value.toLowerCase() || '';
            const activeList = document.querySelector('#dashboard-lists .panel-list.active');
            if (!activeList) return;
            activeList.querySelectorAll('.order-card, .driver-card').forEach(card => {
                const searchData = card.getAttribute('data-search') || '';
                card.style.display = searchData.includes(query) ? 'block' : 'none';
            });
        }
        window.filterLists = filterLists; // Make global

        // --- DETAILS MODAL (Bottom Sheet) ---
        function openDetailsModal(id, type) {
            const modal = document.getElementById('details-modal');
            const titleEl = document.getElementById('details-modal-title');
            const bodyEl = document.getElementById('details-modal-body');
            const copyBtn = document.getElementById('details-copy-link-btn');
            const whatsappBtn = document.getElementById('details-whatsapp-btn');
            if (!modal || !titleEl || !bodyEl || !copyBtn || !whatsappBtn) return;

            currentDetailsItem = { id, type }; // Store current item
            bodyEl.innerHTML = '<div class="flex justify-center p-4"><div class="loader"></div></div>'; // Show loader
            copyBtn.classList.add('hidden'); // Hide copy button by default
             whatsappBtn.classList.add('hidden'); // Hide WhatsApp button by default

            let html = '';
            if (type === 'driver') {
                const driver = state.drivers.find(d => d.id === id); if (!driver) { bodyEl.innerHTML = 'נהג לא נמצא.'; modal.showModal(); return; }
                const location = state.liveLocations[id];
                const assigned = state.orders.filter(o => o.driver?.id === id && !['הושלם', 'בוטל'].includes(o.status));
                const minutesAgo = location?.lastUpdate?.toDate ? Math.round((Date.now() - location.lastUpdate.toDate().getTime()) / 60000) : '?';
                titleEl.innerText = driver.name;
                html = `<ul><li><strong>טלפון:</strong> ${driver.phone}</li><li><strong>רכב:</strong> ${driver.vehicleType || '?'}</li><li><strong>סטטוס:</strong> ${location ? (location.isStuck ? `תקוע (${minutesAgo}')` : `פעיל (${minutesAgo}')`) : 'לא מחובר'}</li></ul><div class="sub-header">הזמנות משויכות (${assigned.length})</div><ul>`;
                html += assigned.length > 0 ? assigned.map(o => `<li>${o.orderNumber || `#${o.id.slice(-6)}`} - ${o.customer?.name || '?'} (${o.status})</li>`).join('') : `<li>אין</li>`; html += `</ul>`;
            } else { // Order
                const order = state.orders.find(o => o.id === id); if (!order) { bodyEl.innerHTML = 'הזמנה לא נמצאה.'; modal.showModal(); return; }
                const displayId = order.orderNumber || `#${id.slice(-6)}`;
                titleEl.innerText = `הזמנה ${displayId}`;
                copyBtn.classList.remove('hidden'); // Show copy button for orders
                 if (order.status === 'שויך' || order.status === 'בדרך') whatsappBtn.classList.remove('hidden'); // Show WhatsApp if assigned/on way

                html = `<ul><li><strong>לקוח:</strong> ${order.customer?.name || '?'} (${order.customer?.phone || '?'})</li><li><strong>כתובת:</strong> ${order.address || '?'}</li><li><strong>סטטוס:</strong> ${order.status || '?'} ${order.driver?.name ? `(${order.driver.name})` : ''} <button class="status-change-btn" onclick="promptForStatusChange('${id}', '${order.status || 'חדש'}')">שנה</button></li><li><strong>סוג:</strong> ${order.deliveryType || '?'} | <strong>מחסן:</strong> ${order.warehouse || '?'}</li></ul>`;
                 if (order.latitude && order.longitude) {
                    const orderLatLng = L.latLng(order.latitude, order.longitude);
                    html += `<div class="sub-header">מרחק ממחסנים</div><ul>`;
                    Object.entries(WAREHOUSE_LOCATIONS).forEach(([name, coords]) => { if (Array.isArray(coords)) { try { const dist = orderLatLng.distanceTo(L.latLng(coords)); html += `<li><span class="dist">${(dist / 1000).toFixed(1)} ק"מ</span> - ${name}</li>`; } catch(e){} } }); html += `</ul>`;
                    const activeDrivers = state.drivers.filter(d => state.liveLocations[d.id] && !state.liveLocations[d.id].isStuck).map(driver => { const loc = state.liveLocations[driver.id]; if (!loc?.latitude) return null; try { const dist = orderLatLng.distanceTo(L.latLng(loc.latitude, loc.longitude)); return { name: driver.name, dist }; } catch (e) { return null; } }).filter(d => d).sort((a, b) => a.dist - b.dist);
                    html += `<div class="sub-header">נהגים זמינים (${activeDrivers.length})</div><ul>`;
                    html += activeDrivers.length > 0 ? activeDrivers.map(d => `<li><span class="dist">${(d.dist / 1000).toFixed(1)} ק"מ</span> - ${d.name}</li>`).join('') : `<li>אין</li>`; html += `</ul>`;
                }
                 if (order.notes) html += `<div class="sub-header">הערות</div><p class="text-sm bg-gray-50 p-2 rounded">${order.notes}</p>`;
            }

            bodyEl.innerHTML = html;
            modal.showModal();
            try { feather.replace({ width: '18px', height: '18px' }); } catch(e){} // Redraw icons in modal
        }

        function closeDetailsModal() { document.getElementById('details-modal')?.close(); currentDetailsItem = null; }
        window.closeDetailsModal = closeDetailsModal; // Make global

         // Wrapper for copy link from details modal context
         function copyCustomerLinkFromDetails() {
             if (currentDetailsItem && currentDetailsItem.type === 'order') {
                 copyCustomerLink(currentDetailsItem.id);
             }
         }
         window.copyCustomerLinkFromDetails = copyCustomerLinkFromDetails; // Make global


        function focusOnMapItem(id, type) { // Opens details modal instead of popup
            let marker; let card;
            document.querySelectorAll('.driver-card, .order-card').forEach(c => c.classList.remove('active'));
            if (type === 'driver') { marker = driverMarkers[id]; card = document.getElementById(`driver-card-${id}`); }
            else { marker = orderMarkers[id]; card = document.getElementById(`order-card-${id}`); }
            if (marker && map) map.setView(marker.getLatLng(), 15); // Center map
            if (card) { card.classList.add('active'); card.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }
            openDetailsModal(id, type); // Open bottom sheet
        }
        // No need to expose focusOnMapItem globally if only called by card clicks

        function openAssignDriverPrompt(orderId) { // Simplified prompt for mobile
             const order = state.orders.find(o => o.id == orderId); if (!order) return;
             const availableDrivers = state.drivers.filter(d => state.liveLocations[d.id] && !state.liveLocations[d.id].isStuck);
             if (availableDrivers.length === 0) { showToast('אין נהגים זמינים', 'warn'); return; }
             // Simple prompt for now
             let driverOptions = availableDrivers.map(d => `${d.id}: ${d.name}`).join('\n');
             const displayId = order.orderNumber || `#${order.id.slice(-6)}`;
             let driverId = prompt(`שייך הזמנה ${displayId} לנהג (הזן ID):\n\n${driverOptions}`);
             if (driverId) {
                 const driverExists = availableDrivers.some(d => d.id == driverId.trim());
                 if (driverExists) assignOrderToDriver(orderId, driverId.trim());
                 else showToast('ID נהג לא תקין/זמין', 'error');
             }
         }
         window.openAssignDriverPrompt = openAssignDriverPrompt; // For inline button click

        // assignOrderToDriver (remains the same logic, uses imported functions)
        async function assignOrderToDriver(orderId, driverId) {
            // No button to update directly in prompt flow, maybe add loader to screen?
            const driverData = state.drivers.find(d => d.id == driverId); if (!driverData) { showToast('Driver data error', 'error'); return; }
            const orderRef = doc(db, "orders", orderId);
            const orderData = state.orders.find(o => o.id === orderId);
            const displayId = orderData?.orderNumber || `#${orderId.slice(-6)}`;
            try {
                await updateDoc(orderRef, { status: "שויך", driver: { id: driverData.id, name: driverData.name }, lastModified: serverTimestamp() });
                showToast(`הזמנה ${displayId} שויכה ל-${driverData.name}`, 'success');
                SmartLog.info(`Order ${orderId} assigned to ${driverId}`, "CRUD.Assign");
                closeDetailsModal(); // Close if details modal was open for this order
            } catch (error) { SmartLog.error(error, "CRUD.Assign", { orderId, driverId }); showToast(`שגיאה בשיוך: ${error.message}`, 'error'); }
        }

        // --- Geocoding (remains the same) ---
        async function geocodeAddress(address) { /* ... function code ... */ }

        // --- STATUS UPDATE (remains the same, uses imported functions) ---
        function promptForStatusChange(orderId, currentStatus) { /* ... function code ... */ }
        window.promptForStatusChange = promptForStatusChange;
        async function updateOrderStatus(orderId, newStatus) { /* ... function code ... */ }

        // --- NEW ORDER FORM (remain the same, uses imported functions) ---
        function populateCustomerDatalist() { /* ... function code ... */ }
        function openNewOrderForm() { document.getElementById('new-order-modal')?.showModal(); try{feather.replace();}catch(e){} }
        window.openNewOrderForm = openNewOrderForm;
        function closeNewOrderForm() { /* ... function code ... */ }
        window.closeNewOrderForm = closeNewOrderForm;
        function handleCustomerSearch(value) { /* ... function code ... */ }
        window.handleCustomerSearch = handleCustomerSearch;
        async function submitNewOrder(event) { /* ... function code ... */ }
        // submitNewOrder doesn't need to be global if only called by form submit

        // --- CUSTOMER EDIT MODAL (remain the same, uses imported functions) ---
        function openCustomerEditModal(customerId) { /* ... function code ... */ }
         window.openCustomerEditModal = openCustomerEditModal; // Needs to be global for table row click
         function closeCustomerEditModal() { /* ... function code ... */ }
         window.closeCustomerEditModal = closeCustomerEditModal; // Needs to be global
         async function handleSaveCustomer(event) { /* ... function code ... */ }
         // handleSaveCustomer doesn't need to be global if only called by form submit

        // --- DRIVER HISTORY (placeholder remains the same) ---
        function populateDriverSelector() { /* ... function code ... */ }
        async function fetchAndDrawDriverRoute() { /* ... function code ... */ }
        // window.fetchAndDrawDriverRoute = fetchAndDrawDriverRoute; // Not currently used in UI
        function drawRouteOnHistoryMap(latLngPoints) { /* ... function code ... */ }
        function calculateRouteDistance(points) { /* ... function code ... */ }

        // --- HELPERS (remain the same) ---
        function showLoader(elementId, show) { /* ... function code ... */ }
        function showToast(message, type = 'info') { /* ... function code ... */ }
        function copyToClipboard(text) { /* ... function code ... */ }
        function copyCustomerLink(orderId) { /* ... function code ... */ }
        window.copyCustomerLink = copyCustomerLink; // Global for history table button

        // --- Global Ping (remains the same, uses imported functions) ---
        async function sendGlobalPing() { /* ... function code ... */ }
        window.sendGlobalPing = sendGlobalPing; // Global for nav button

        // --- WhatsApp Placeholder ---
        function handleWhatsAppAction() {
            if (!currentDetailsItem || currentDetailsItem.type !== 'order') return;
            const order = state.orders.find(o => o.id === currentDetailsItem.id);
            if (!order) return;

            SmartLog.info("WhatsApp action triggered (placeholder)", "WhatsApp", { orderId: order.id });
            // This is where you would trigger the backend (e.g., Firebase Function)
            // For now, just show a toast.
            showToast(`פעולת וואטסאפ עבור הזמנה ${order.orderNumber || `#${order.id.slice(-6)}`} (לא ממומש)`, 'info');

            // Example using whatsapp:// URL scheme (opens chat, doesn't send automatically)
            // const phone = order.customer?.phone?.replace(/\D/g, ''); // Clean phone number
            // if (phone) {
            //     const message = encodeURIComponent(`שלום ${order.customer?.name || ''}, עדכון לגבי הזמנה ${order.orderNumber || `#${order.id.slice(-6)}`: הנהג ${order.driver?.name || ''} בדרך אליך.`);
            //     const whatsappUrl = `whatsapp://send?phone=972${phone.substring(1)}&text=${message}`; // Assumes Israeli number format
            //     window.open(whatsappUrl, '_blank');
            // } else {
            //     showToast('מספר טלפון של לקוח לא זמין', 'warn');
            // }
        }
        window.handleWhatsAppAction = handleWhatsAppAction; // Make global for button

    </script>
     <script>
        // Service Worker Registration (Remains the same)
        if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').then(reg => console.log('Admin SW registered:', reg.scope)).catch(err => console.log('Admin SW registration failed:', err)); }); }
    </script>
</body>
</html>

