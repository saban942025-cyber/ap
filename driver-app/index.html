<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>DeliveryMaster נהג v50.4.1 (Path Fix)</title>
    <!--
      DeliveryMaster Driver App v50.4.1 (Path Fix)

      Changelog:
      - v50.4.1 (FIX): Corrected import path to absolute (/shared/firebase-init.js).
      - v50.4: Modularized, Added Ping Listener.
      - v50.3.3: mobile-web-app-capable meta tag.
      - v50.3.2: DOM initialization fix.
      - v50.3.1: Graceful handling of missing ID/Name.
      - v50.3: Integrated live map, distance, Firebase backend.
    -->

    <link rel="manifest" href="manifest.json"> <meta name="theme-color" content="#3a86ff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/ryPT3r29/image.png"> <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        /* CSS remains the same */
        :root { --primary-color: #3a86ff; --primary-dark: #2f6ac2; --success-color: #28a745; --success-dark: #218838; --warning-color: #ffc107; --warning-dark: #e0a800; --danger-color: #dc3545; --danger-dark: #c82333; --bg-light: #f8f9fa; --bg-white: #ffffff; --border-color: #dee2e6; --text-dark: #212529; --text-light: #6c757d; }
        html, body { height: 100vh; overflow: hidden; }
        body { font-family: 'Rubik', sans-serif; overscroll-behavior-y: contain; background-color: var(--bg-light); color: var(--text-dark); }
        #map { height: 250px; border-radius: 0.5rem; background-color: #e9ecef; }
        .leaflet-control-zoom { display: none; } .leaflet-control-attribution { font-size: 10px; background: rgba(255,255,255,0.7); padding: 1px 4px; border-radius: 2px; }
        .leaflet-popup-content-wrapper { border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); } .leaflet-popup-content { font-family: 'Rubik', sans-serif; font-size: 0.9rem; line-height: 1.4; } .leaflet-popup-content h4 { font-weight: 700; margin-bottom: 5px; font-size: 1rem; } .leaflet-popup-content p { margin: 3px 0; color: var(--text-light); }
        .btn { padding: 0.6rem 1rem; border-radius: 0.375rem; font-weight: 500; transition: background-color 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 0.3rem; }
        .btn-primary { background-color: var(--primary-color); color: white; } .btn-primary:hover { background-color: var(--primary-dark); } .btn-secondary { background-color: var(--text-light); color: white; } .btn-secondary:hover { background-color: #5a6268; } .btn-success { background-color: var(--success-color); color: white; } .btn-success:hover { background-color: var(--success-dark); } .btn-warning { background-color: var(--warning-color); color: var(--text-dark); } .btn-warning:hover { background-color: var(--warning-dark); } .btn-icon { padding: 0.5rem; } .btn-disabled { opacity: 0.6; cursor: not-allowed; pointer-events: none; }
        .notification-card { border-left: 5px solid var(--warning-color); animation: pulse 1.5s infinite; } @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 193, 7, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); } }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; } @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .order-card { background-color: var(--bg-white); border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); } .order-card h3 { color: var(--text-dark); } .order-card .address { color: var(--text-light); } .order-card .distance { color: var(--primary-dark); font-weight: 500; }
        #status-indicator { font-size: 0.8rem; font-weight: 500; padding: 4px 8px; border-radius: 99px; display: inline-flex; align-items: center; gap: 4px; } #status-indicator.connected { background-color: #dcfce7; color: #166534; } #status-indicator.connecting { background-color: #fef9c3; color: #854d0e; } #status-indicator.error { background-color: #fee2e2; color: #991b1b; } #status-indicator .dot { width: 6px; height: 6px; border-radius: 50%; } #status-indicator.connected .dot { background-color: #22c55e; } #status-indicator.connecting .dot { background-color: #facc15; } #status-indicator.error .dot { background-color: #ef4444; }
        #login-error-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255, 255, 255, 0.95); z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 2rem; }
        #driver-toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: var(--primary-color); color: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 5000; opacity: 0; transition: opacity 0.3s ease, transform 0.3s ease; transform: translate(-50%, 20px); display: none; font-weight: 500; } #driver-toast.show { display: block; opacity: 1; transform: translateX(-50%); }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div id="login-error-overlay">
        <i data-feather="alert-triangle" class="w-16 h-16 text-red-500 mb-4"></i>
        <h2 class="text-2xl font-bold text-red-700 mb-2">שגיאת התחברות</h2>
        <p class="text-gray-600">לא זוהו פרטי נהג.</p>
        <p class="text-gray-600 mt-1">אנא חזור למסך הראשי והתחבר מחדש.</p>
    </div>


    <div id="main-container" class="container mx-auto max-w-lg p-0 flex flex-col h-screen bg-white shadow-lg">
        <header class="bg-white shadow-sm p-4 flex justify-between items-center sticky top-0 z-10 border-b border-gray-200">
            <div>
                <h1 class="text-xl font-bold text-gray-800">DeliveryMaster</h1>
                <p id="driver-name-display" class="text-sm text-gray-600">נהג: טוען...</p>
            </div>
            <div id="status-indicator" class="connecting"><span id="status-text">טוען...</span><span id="status-dot" class="dot"></span></div>
        </header>

        <div id="permission-section" class="p-4 space-y-3 bg-yellow-100 border-b border-yellow-300" style="display: none;">
             <p class="text-sm font-medium text-yellow-800">נדרשות הרשאות למיקום והתראות:</p>
             <button id="request-perms-btn" class="w-full text-sm btn btn-warning">בקש הרשאות</button>
        </div>

        <div class="p-4 border-b border-gray-200">
            <div id="location-info" class="bg-blue-50 p-3 rounded-lg mb-3 text-sm text-blue-800">
                 <p id="current-location-text">📍 מאתר מיקום נוכחי...</p>
                 <p id="eta-text" class="mt-1 font-medium hidden">...</p>
            </div>
            <div id="map"></div>
        </div>

        <main id="order-list" class="flex-grow overflow-y-auto p-4 space-y-4 bg-gray-50">
             <div id="loading-orders" class="text-center py-10 text-gray-500">
                 <div class="loader mx-auto mb-2"></div>טוען משימות...
             </div>
             <!-- Order cards dynamically inserted here -->
        </main>
    </div>

     <div id="driver-toast"></div> <!-- Toast element for pings -->

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>


    <script type="module">
        // --- Import from Shared Module ---
        import {
            db, authReadyPromise, SmartLog,
            collection, doc, onSnapshot, query, addDoc, updateDoc,
            serverTimestamp, where, setDoc, limit, orderBy, Timestamp // Ensure Timestamp is imported if used in shared module
        } from '/shared/firebase-init.js'; // *** FIXED PATH ***

        console.log('Driver App script started (v50.4.1 Modular Path Fix)');

        // --- Driver App Specific Logic ---

        // Globals (remain the same)
        let map; let driverMarker = null; let orderMarkers = {};
        let currentDriverId = localStorage.getItem('driverId');
        let currentDriverName = localStorage.getItem('driverName');
        let watchId = null; let currentOrders = []; let currentLatLng = null;
        let notificationAudio = null; let hasNotificationPermission = false; let hasGeolocationPermission = false;
        let lastLocationUpdate = 0;
        const LOCATION_UPDATE_INTERVAL = 20000;
        const ACTIVE_DRIVER_ORDER_STATUSES = ["שויך", "בדרך"];
        const ISRAEL_CENTER = [32.0853, 34.7818];

        // Map Icons
        const orderIconActive = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', shadowSize: [41, 41] });

        // DOM Elements
        let DOM = {}; // Populated in initializeDriverApp

        // --- Initialization ---
        async function initializeDriverApp() {
            try {
                DOM = { // Populate DOM refs
                     driverNameDisplay: document.getElementById('driver-name-display'), statusIndicator: document.getElementById('status-indicator'), statusText: document.getElementById('status-text'), statusDot: document.getElementById('status-dot'), permissionSection: document.getElementById('permission-section'), requestPermsBtn: document.getElementById('request-perms-btn'), locationInfo: document.getElementById('location-info'), currentLocationText: document.getElementById('current-location-text'), etaText: document.getElementById('eta-text'), mapElement: document.getElementById('map'), orderList: document.getElementById('order-list'), loadingOrders: document.getElementById('loading-orders'), loginErrorOverlay: document.getElementById('login-error-overlay'), mainContainer: document.getElementById('main-container'), driverToast: document.getElementById('driver-toast')
                };
                SmartLog.info("DOM elements referenced.", "Init.DOM");
                if (!DOM.driverNameDisplay || !DOM.statusIndicator || !DOM.mapElement || !DOM.orderList || !DOM.loginErrorOverlay || !DOM.mainContainer || !DOM.driverToast) { throw new Error("Essential DOM elements missing!"); }

                SmartLog.info("Initializing Driver App (v50.4.1 Path Fix)...", "Init"); // Version bump
                updateStatus("connecting", "מאמת...");

                // Check login status early
                if (!currentDriverId || !currentDriverName) { SmartLog.error(new Error("Missing driverId/Name"), "Auth"); showLoginErrorOverlay(); return; }
                DOM.driverNameDisplay.textContent = `נהג: ${currentDriverName}`;

                await authReadyPromise; // Use imported promise
                SmartLog.info("Firebase Auth Ready.", "Init");
                updateStatus("connecting", "בודק הרשאות...");

                await checkAndRequestPermissions();

                updateStatus("connecting", "מאתחל מפה...");
                initMap();

                if (hasGeolocationPermission) { updateStatus("connecting", "מפעיל GPS..."); startGeolocation(); }
                else { updateStatus("error", "ממתין לאישור מיקום"); SmartLog.warn("Geolocation permission pending.", "Permissions"); }

                initNotifications(); // Sound engine

                updateStatus("connecting", "מסנכרן משימות...");
                listenToOrders();
                listenToDriverPings(); // PING LISTENER

                updateFinalStatus();
                SmartLog.info("Driver App Initialization Complete.", "Init");

            } catch (error) { SmartLog.error(error, "Init.Critical"); if (DOM.statusIndicator) updateStatus("error", `שגיאת אתחול`); showLoginErrorOverlay(`שגיאת אתחול: ${error.message}`); }
        }

        // --- Login Error Handling (remains the same) ---
        function showLoginErrorOverlay(message = "לא זוהו פרטי נהג.") {
            // ... (code remains the same)
        }

        // --- Status Update (remains the same) ---
        function updateFinalStatus() {
            // ... (code remains the same)
        }
        function updateStatus(statusClass, text) {
            // ... (code remains the same)
        }

        // --- Permissions (remains the same) ---
        async function checkAndRequestPermissions() {
            // ... (code remains the same)
        }
        async function handlePermissionRequest() {
           // ... (code remains the same)
        }

        // --- Geolocation & Location Update (use imported functions) ---
        function startGeolocation() {
            // ... (code remains the same, uses SmartLog)
        }
        async function updateLocationInFirestore(lat, lng) {
             // ... (code uses imported db, doc, setDoc, serverTimestamp, SmartLog)
        }
        async function updateLocationText(lat, lng) {
            // ... (code remains the same, uses SmartLog)
        }

        // --- Map Handling (remains the same) ---
         function initMap() {
             // ... (code remains the same, uses SmartLog)
        }
        function updateDriverMarkerOnMap(lat, lng) {
            // ... (code remains the same, uses SmartLog)
        }
        function updateOrderMarkersOnMap() {
            // ... (code remains the same, uses SmartLog)
        }
        function updateMapBounds() {
            // ... (code remains the same)
        }

        // --- Order Handling (use imported functions) ---
        function listenToOrders() {
            // ... (code uses imported SmartLog, query, collection, db, where, onSnapshot)
        }
        function renderOrderList() {
            // ... (code remains the same)
        }
        function updateDistances() {
             // ... (code remains the same)
        }
        function createOrderCard(order) {
           // ... (code remains the same)
        }

        // --- Order Actions (use imported functions) ---
        window.acknowledgeOrder = async (orderId) => {
            // ... (code uses imported SmartLog, doc, db, updateDoc, serverTimestamp)
        };
        window.completeOrder = async (orderId) => {
             // ... (code uses imported SmartLog, doc, db, updateDoc, serverTimestamp)
        };

        // --- Notifications (remain the same) ---
         function initNotifications() {
             // ... (code remains the same, uses SmartLog)
        }
        function handleNewOrderNotification() {
             // ... (code remains the same, uses SmartLog)
        }
        function stopNotificationSound() {
             // ... (code remains the same, uses SmartLog)
        }

        // --- Ping Listener & Helpers (use imported functions) ---
        function showDriverToast(message, duration = 4000) {
           // ... (code remains the same, uses SmartLog)
        }
        async function playPingSound() {
           // ... (code remains the same, uses SmartLog, notificationAudio)
        }
        function listenToDriverPings() {
           // ... (code uses imported SmartLog, query, collection, db, where, orderBy, limit, onSnapshot, Timestamp)
        }

        // --- Start Application ---
        document.addEventListener('DOMContentLoaded', () => {
            // Fallback for SmartLog moved to shared module
            SmartLog.info("DOMContentLoaded.", "Init");
            initializeDriverApp(); // All logic starts here
        });

    </script>
    <!-- Service Worker Registration -->
     <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js') // Path relative to index.html
                    .then(registration => {
                        console.log('Driver ServiceWorker registered: ', registration.scope);
                    })
                    .catch(registrationError => {
                        console.log('Driver ServiceWorker registration failed: ', registrationError);
                    });
            });
        }
    </script>

</body>
</html>

