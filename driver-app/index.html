<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>DeliveryMaster נהג v50.3.3 (Refactored V33)</title>
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#3a86ff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/ryPT3r29/image.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        /* ... (כל סגנונות ה-CSS נשארים זהים) ... */
        :root { --primary-color: #3a86ff; --primary-dark: #2f6ac2; --success-color: #28a745; --success-dark: #218838; --warning-color: #ffc107; --warning-dark: #e0a800; --danger-color: #dc3545; --danger-dark: #c82333; --bg-light: #f8f9fa; --bg-white: #ffffff; --border-color: #dee2e6; --text-dark: #212529; --text-light: #6c757d; }
        html, body { height: 100vh; overflow: hidden; }
        body { font-family: 'Rubik', sans-serif; overscroll-behavior-y: contain; background-color: var(--bg-light); color: var(--text-dark); }
        #map { height: 250px; border-radius: 0.5rem; background-color: #e9ecef; }
        .leaflet-control-zoom { display: none; } 
        .leaflet-control-attribution { font-size: 10px; }
        .leaflet-popup-content h4 { font-weight: 700; }
        .btn { padding: 0.6rem 1rem; border-radius: 0.375rem; font-weight: 500; transition: background-color 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 0.3rem; }
        .btn-primary { background-color: var(--primary-color); color: white; } .btn-primary:hover { background-color: var(--primary-dark); }
        .btn-secondary { background-color: var(--text-light); color: white; } .btn-secondary:hover { background-color: #5a6268; }
        .btn-success { background-color: var(--success-color); color: white; } .btn-success:hover { background-color: var(--success-dark); }
        .btn-warning { background-color: var(--warning-color); color: var(--text-dark); } .btn-warning:hover { background-color: var(--warning-dark); }
        .btn-disabled { opacity: 0.6; cursor: not-allowed; pointer-events: none; }
        .notification-card { border-left: 5px solid var(--warning-color); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 193, 7, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); } }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .order-card { background-color: var(--bg-white); border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        #status-indicator { font-size: 0.8rem; font-weight: 500; padding: 4px 8px; border-radius: 99px; display: inline-flex; align-items: center; gap: 4px; }
        #status-indicator.connected { background-color: #dcfce7; color: #166534; }
        #status-indicator.connecting { background-color: #fef9c3; color: #854d0e; }
        #status-indicator.error { background-color: #fee2e2; color: #991b1b; }
        #status-indicator .dot { width: 6px; height: 6px; border-radius: 50%; }
        #status-indicator.connected .dot { background-color: #22c55e; }
        #status-indicator.connecting .dot { background-color: #facc15; }
        #status-indicator.error .dot { background-color: #ef4444; }
        #login-error-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255, 255, 255, 0.95); z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 2rem; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div id="login-error-overlay">
        <i data-feather="alert-triangle" class="w-16 h-16 text-red-500 mb-4"></i>
        <h2 class="text-2xl font-bold text-red-700 mb-2">שגיאת התחברות</h2>
        <p class="text-gray-600">לא זוהו פרטי נהג.</p>
        <p class="text-gray-600 mt-1">אנא חזור למסך הראשי והתחבר מחדש.</p>
    </div>

    <div id="main-container" class="container mx-auto max-w-lg p-0 flex flex-col h-screen bg-white shadow-lg">
        <header class="bg-white shadow-sm p-4 flex justify-between items-center sticky top-0 z-10 border-b border-gray-200">
            <div>
                <h1 class="text-xl font-bold text-gray-800">DeliveryMaster</h1>
                <p id="driver-name-display" class="text-sm text-gray-600">נהג: טוען...</p>
            </div>
            <div id="status-indicator" class="connecting">
                 <span id="status-text">טוען...</span>
                 <span id="status-dot" class="dot"></span>
            </div>
        </header>

        <div id="permission-section" class="p-4 space-y-3 bg-yellow-100 border-b border-yellow-300" style="display: none;"> 
             <p class="text-sm font-medium text-yellow-800">נדרשות הרשאות למיקום והתראות:</p>
             <button id="request-perms-btn" class="w-full text-sm btn btn-warning">בקש הרשאות</button>
        </div>

        <div class="p-4 border-b border-gray-200">
            <div id="location-info" class="bg-blue-50 p-3 rounded-lg mb-3 text-sm text-blue-800">
                 <p id="current-location-text">📍 מאתר מיקום נוכחי...</p>
                 <p id="eta-text" class="mt-1 font-medium hidden">...</p>
            </div>
            <div id="map"></div>
        </div>

        <main id="order-list" class="flex-grow overflow-y-auto p-4 space-y-4 bg-gray-50">
             <div id="loading-orders" class="text-center py-10 text-gray-500">
                 <div class="loader mx-auto mb-2"></div>
                 טוען משימות...
             </div>
        </main>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <script type="module">
        console.log('Driver App script started (V33.0 Refactored)');

        // --- V33: Import from Shared Modules ---
        import { 
            db, auth, authReadyPromise, SmartLog, showToast, 
            collection, doc, onSnapshot, query, addDoc, updateDoc, 
            serverTimestamp, where, setDoc 
        } from '../shared/firebase-init.js';
        
        import { 
            orderIconActive // V33: Use shared icons
            // Driver markers are custom (circle) in this app, so we don't import them
        } from '../shared/map-utils.js';

        // --- Driver App Specific Logic ---

        // Globals
        let map; 
        let driverMarker = null;
        let orderMarkers = {};
        let currentDriverId = localStorage.getItem('driverId');
        let currentDriverName = localStorage.getItem('driverName');
        let watchId = null; 
        let currentOrders = [];
        let currentLatLng = null;
        let notificationAudio = null;
        let hasNotificationPermission = false; 
        let hasGeolocationPermission = false;
        let lastLocationUpdate = 0;
        const LOCATION_UPDATE_INTERVAL = 20000;
        const ACTIVE_DRIVER_ORDER_STATUSES = ["שויך", "בדרך"];

        const ISRAEL_CENTER = [32.0853, 34.7818];

        // DOM Elements
        let DOM = {};

        // --- Initialization ---
        async function initializeDriverApp() {
            try { 
                DOM = {
                     driverNameDisplay: document.getElementById('driver-name-display'), 
                     statusIndicator: document.getElementById('status-indicator'),
                     statusText: document.getElementById('status-text'), 
                     statusDot: document.getElementById('status-dot'),
                     permissionSection: document.getElementById('permission-section'), 
                     requestPermsBtn: document.getElementById('request-perms-btn'), 
                     locationInfo: document.getElementById('location-info'),
                     currentLocationText: document.getElementById('current-location-text'), 
                     etaText: document.getElementById('eta-text'), 
                     mapElement: document.getElementById('map'), 
                     orderList: document.getElementById('order-list'), 
                     loadingOrders: document.getElementById('loading-orders'),
                     loginErrorOverlay: document.getElementById('login-error-overlay'),
                     mainContainer: document.getElementById('main-container')
                };
                SmartLog.info("DOM elements referenced.", "Init.DOM");
                
                if (!DOM.driverNameDisplay || !DOM.statusIndicator || !DOM.mapElement || !DOM.orderList || !DOM.loginErrorOverlay || !DOM.mainContainer) {
                     throw new Error("Essential DOM elements missing!"); 
                }
    
                SmartLog.info("Initializing Driver App (V33.0 Refactored)...", "Init");
                updateStatus("connecting", "מאמת..."); 

                if (!currentDriverId || !currentDriverName) {
                    SmartLog.error(new Error("Missing driverId/Name"), "Auth", null, "Auth", "הנהג אינו מחובר.");
                    showLoginErrorOverlay();
                    return;
                }
                DOM.driverNameDisplay.textContent = `נהג: ${currentDriverName}`;

                await authReadyPromise; // Use imported promise
                SmartLog.info("Firebase Auth Ready.", "Init");
                updateStatus("connecting", "בודק הרשאות...");

                await checkAndRequestPermissions(); 

                updateStatus("connecting", "מאתחל מפה...");
                initMap();

                if (hasGeolocationPermission) {
                    updateStatus("connecting", "מפעיל GPS...");
                    startGeolocation();
                } else {
                     updateStatus("error", "המתן לאישור מיקום");
                     SmartLog.warn("Geolocation permission pending/denied. GPS not started.", "Permissions");
                }

                 initNotifications();

                updateStatus("connecting", "מסנכרן משימות...");
                listenToOrders(); // Uses imported db, collection, etc.

                updateFinalStatus();

                SmartLog.info("Driver App Initialization Complete.", "Init");

            } catch (error) {
                SmartLog.error(error, "Init.Critical");
                if (DOM.statusIndicator) {
                    updateStatus("error", `שגיאת אתחול`);
                }
                showLoginErrorOverlay(`שגיאת אתחול: ${error.message}`);
            }
        }

        // --- Login Error Handling ---
        function showLoginErrorOverlay(message = "לא זוהו פרטי נהג.") {
             if (DOM && DOM.loginErrorOverlay && DOM.mainContainer) {
                 const messageParagraphs = DOM.loginErrorOverlay.querySelectorAll('p');
                 if (messageParagraphs.length > 0) messageParagraphs[0].textContent = message;
                 if (messageParagraphs.length > 1) messageParagraphs[1].textContent = "אנא חזור למסך הראשי והתחבר מחדש.";
                 
                 DOM.loginErrorOverlay.style.display = 'flex';
                 DOM.mainContainer.style.display = 'none';
                 try { if(feather) feather.replace(); } catch(e){}
             } else {
                 console.error("Login Error Overlay failed to display, DOM not ready.", message);
                 alert(message + "\nאנא חזור למסך הראשי והתחבר מחדש.");
             }
         }
        
         // ... (updateFinalStatus, updateStatus, checkAndRequestPermissions, handlePermissionRequest functions remain the same) ...
         function updateFinalStatus() {
             if (watchId) { updateStatus("connected", "GPS פעיל"); }
             else if (!hasGeolocationPermission) { updateStatus("error", "נדרשת הרשאת מיקום"); }
             else { updateStatus("connecting", "GPS לא פעיל"); }
         }
         function updateStatus(statusClass, text) {
             if (!DOM.statusIndicator || !DOM.statusText || !DOM.statusDot) { return; }
             SmartLog.info(`Updating Status: ${text}`, "UI.Status", { class: statusClass });
             DOM.statusIndicator.className = statusClass;
             DOM.statusText.textContent = text;
        }
        async function checkAndRequestPermissions() {
             SmartLog.info("Checking permissions...", "Permissions");
             let needsGeoRequest = false, needsNotifRequest = false;
             try {
                const geoStatus = await navigator.permissions.query({ name: 'geolocation' });
                hasGeolocationPermission = geoStatus.state === 'granted';
                if (geoStatus.state === 'prompt') needsGeoRequest = true;
                SmartLog.info("Geolocation status:", "Permissions", { status: geoStatus.state });
             } catch (e) { SmartLog.warn("Could not query geo permission.", "Permissions", e); needsGeoRequest = true; }
             if ('Notification' in window) {
                hasNotificationPermission = Notification.permission === 'granted';
                if (Notification.permission === 'default') needsNotifRequest = true;
                SmartLog.info("Notification status:", "Permissions", { status: Notification.permission });
             } else { SmartLog.warn("Notifications not supported.", "Permissions"); }
             if (needsGeoRequest || needsNotifRequest) {
                 if (DOM.permissionSection && DOM.requestPermsBtn) {
                     DOM.permissionSection.style.display = 'block';
                     DOM.requestPermsBtn.removeEventListener('click', handlePermissionRequest); 
                     DOM.requestPermsBtn.addEventListener('click', handlePermissionRequest);
                     updateStatus("error", "נדרשות הרשאות");
                 } else { SmartLog.error("Permission UI elements not found!", "Permissions"); }
             } else {
                 if (DOM.permissionSection) DOM.permissionSection.style.display = 'none';
                 SmartLog.info("Permissions already handled.", "Permissions");
             }
        }
        async function handlePermissionRequest() {
             SmartLog.info("Requesting permissions via button click...", "Permissions");
            let geoGranted = hasGeolocationPermission, notifGranted = hasNotificationPermission;
            if (!hasGeolocationPermission) {
                try {
                    await new Promise((resolve, reject) => { 
                        navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 15000, enableHighAccuracy: true }); 
                    });
                    const geoStatus = await navigator.permissions.query({ name: 'geolocation' });
                    geoGranted = geoStatus.state === 'granted';
                    hasGeolocationPermission = geoGranted;
                    SmartLog.info("Geolocation request result:", "Permissions", { status: geoStatus.state });
                    if(geoGranted && !watchId) {
                        updateStatus("connecting", "מפעיל GPS...");
                        startGeolocation();
                    }
                 } catch (e) { SmartLog.error(e, "Permissions", { message: "Geolocation request failed." }); }
            }
            if ('Notification' in window && Notification.permission === 'default') {
                try {
                    const permission = await Notification.requestPermission();
                    notifGranted = permission === 'granted';
                    hasNotificationPermission = notifGranted;
                    SmartLog.info("Notification request result:", "Permissions", { status: permission });
                     if(notifGranted) initNotifications();
                } catch (e) { SmartLog.error(e, "Permissions", { message: "Notification request failed." }); }
            }
            if (geoGranted) { 
                if (DOM.permissionSection) DOM.permissionSection.style.display = 'none';
                updateFinalStatus();
            } else {
                 updateStatus("error", "נדרשת הרשאת מיקום!");
                 if (DOM.requestPermsBtn) {
                    DOM.requestPermsBtn.textContent = "בקש הרשאת מיקום שוב";
                    DOM.requestPermsBtn.classList.add('btn-disabled');
                    setTimeout(() => { if(DOM.requestPermsBtn) DOM.requestPermsBtn.classList.remove('btn-disabled'); }, 5000);
                 }
            }
        }

        // --- Geolocation & Location Update ---
        function startGeolocation() { 
            // ... (Logic remains the same, uses imported SmartLog) ...
            if (watchId) { SmartLog.info("Geolocation already watching.", "GPS"); return; }
            if (!hasGeolocationPermission) { SmartLog.warn("Cannot start GPS, permission not granted.", "GPS"); updateStatus("error", "נדרשת הרשאת מיקום"); return; }
            if (!('geolocation' in navigator)) { SmartLog.error("Geolocation not supported.", "GPS"); updateStatus("error", "GPS לא נתמך"); return; }
            SmartLog.info("Starting geolocation watchPosition...", "GPS");
            updateStatus("connecting", "מפעיל GPS...");
            watchId = navigator.geolocation.watchPosition(
                async (position) => {
                    const { latitude, longitude, accuracy } = position.coords;
                    currentLatLng = [latitude, longitude];
                    SmartLog.info("GPS Update Received", "GPS", { lat: latitude, lon: longitude, acc: accuracy });
                    updateStatus("connected", "GPS פעיל");
                    updateDriverMarkerOnMap(latitude, longitude);
                    updateLocationText(latitude, longitude);
                    updateDistances();
                    updateMapBounds();
                    const now = Date.now();
                    if (now - lastLocationUpdate > LOCATION_UPDATE_INTERVAL) { 
                        SmartLog.info("Sending location update to Firestore...", "GPS.Firestore");
                        await updateLocationInFirestore(latitude, longitude); // Uses imported FS functions
                        lastLocationUpdate = now;
                    }
                },
                (error) => {
                    SmartLog.error(error, "GPS.Error");
                    currentLatLng = null;
                    let errorMsg = "שגיאת GPS"; if (error.code === 1) errorMsg = "GPS: אין הרשאה"; else if (error.code === 2) errorMsg = "GPS: לא זמין"; else if (error.code === 3) errorMsg = "GPS: Timeout";
                    updateStatus("error", errorMsg);
                    if(watchId) { navigator.geolocation.clearWatch(watchId); watchId = null; }
                },
                { enableHighAccuracy: true, timeout: 20000, maximumAge: 10000 }
            );
        }
        
        async function updateLocationInFirestore(lat, lng) { 
             if (!db || !currentDriverId) return; 
             const locationRef = doc(db, "driverLocations", currentDriverId); // Uses imported db, doc
             const locationData = { 
                 latitude: lat, 
                 longitude: lng, 
                 lastUpdate: serverTimestamp(), // Uses imported serverTimestamp
                 driverName: currentDriverName
             };
             try { 
                 await setDoc(locationRef, locationData, { merge: true }); // Uses imported setDoc
                 SmartLog.info("Location updated/set in Firestore.", "GPS.Firestore");
             } catch (e) { 
                 SmartLog.error(e, "GPS.Firestore.Set"); 
             } 
        }
        
        async function updateLocationText(lat, lng) { 
            // ... (Logic remains the same, uses imported SmartLog) ...
            if (!DOM.currentLocationText) return; DOM.currentLocationText.textContent = `📍 ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            try { const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=16`); if (!response.ok) throw new Error(`${response.status}`); const data = await response.json(); if (data?.display_name) { const parts = data.display_name.split(', '); const short = parts.slice(0, 3).join(', '); DOM.currentLocationText.textContent = `📍 ${short}`; SmartLog.info("Reverse geocode success", "GPS.Geo", { address: short }); } else { SmartLog.warn("Reverse geocode failed: No display_name", "GPS.Geo", { data }); } } catch (error) { SmartLog.error(error, "GPS.ReverseGeocode"); }
        }

        // --- Map Handling ---
        function initMap() { 
             try { 
                 if (map) map.remove();
                 map = L.map(DOM.mapElement).setView(ISRAEL_CENTER, 13);
                 L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
                     attribution: '© OSM', 
                     maxZoom: 18, 
                 }).addTo(map); 
                 SmartLog.info("Map initialized", "Map"); 
             } catch (e) { 
                 SmartLog.error(e, "Map.Init"); 
                 if (DOM.mapElement) DOM.mapElement.innerHTML = '<p class="text-red-500 p-4 text-center">Map Error</p>'; 
             }
        }
        
        function updateDriverMarkerOnMap(lat, lng) { 
             // ... (Logic remains the same, uses imported SmartLog) ...
             if (!map) return; 
             const latLng = [lat, lng]; 
             if (driverMarker) { 
                 driverMarker.setLatLng(latLng); 
             } else { 
                 driverMarker = L.circleMarker(latLng, { radius: 8, fillColor: "#3a86ff", color: "#fff", weight: 2, opacity: 1, fillOpacity: 0.9 }).addTo(map); 
                 driverMarker.bindPopup(`<b>${currentDriverName}</b> (מיקום נוכחי)`);
                 SmartLog.info("Driver marker added", "Map"); 
             } 
        }

        function updateOrderMarkersOnMap() {
            if (!map) return;
            const activeMapOrders = currentOrders.filter(o => o.latitude && o.longitude);

            Object.keys(orderMarkers).forEach(orderId => {
                if (!activeMapOrders.some(o => o.id === orderId)) {
                    if (map.hasLayer(orderMarkers[orderId])) map.removeLayer(orderMarkers[orderId]);
                    delete orderMarkers[orderId];
                }
            });

            activeMapOrders.forEach(order => {
                const latLng = [order.latitude, order.longitude];
                const distanceText = currentLatLng ? `מרחק: ${(L.latLng(currentLatLng).distanceTo(latLng) / 1000).toFixed(1)} ק"מ` : 'מחשב מרחק...';
                const popupContent = `<h4>${order.customer?.name || '?'}</h4><p>${order.address || '?'}</p><p>${distanceText}</p><p>סטטוס: ${order.status}</p>`;

                if (orderMarkers[order.id]) {
                    orderMarkers[order.id].setLatLng(latLng).setPopupContent(popupContent);
                } else {
                    orderMarkers[order.id] = L.marker(latLng, { icon: orderIconActive }) // V33: Use imported icon
                        .addTo(map)
                        .bindPopup(popupContent);
                    SmartLog.info("Order marker added", "Map", { orderId: order.id });
                }
            });
            updateMapBounds();
        }
        
        function updateMapBounds() {
            // ... (Logic remains the same) ...
            if (!map) return;
            const bounds = L.latLngBounds();
            if (driverMarker) bounds.extend(driverMarker.getLatLng());
            Object.values(orderMarkers).forEach(marker => bounds.extend(marker.getLatLng()));
            if (bounds.isValid()) { map.fitBounds(bounds, { padding: [40, 40], maxZoom: 16 }); }
            else if (driverMarker) { map.setView(driverMarker.getLatLng(), 15); }
            else { map.setView(ISRAEL_CENTER, 13); }
        }

        // --- Order Handling ---
        function listenToOrders() { 
             SmartLog.info("Listening to orders:", "Orders", { driverId: currentDriverId }); 
             const q = query( 
                 collection(db, "orders"), // Uses imported db, collection
                 where("driver.id", "==", currentDriverId), // Uses imported where
                 where("status", "in", ACTIVE_DRIVER_ORDER_STATUSES) 
             );
             
             onSnapshot(q, (snapshot) => { // Uses imported onSnapshot
                 SmartLog.info(`Orders snapshot: ${snapshot.docChanges().length} changes`, "Orders"); 
                 if (DOM.loadingOrders) DOM.loadingOrders.style.display = 'none'; 
                 let newOrderDetected = false;
                 
                 snapshot.docChanges().forEach((change) => { 
                     const orderId = change.doc.id; 
                     const orderData = { id: orderId, ...change.doc.data() };
                     if (change.type === "added") { 
                         SmartLog.info("New order added to list:", "Orders", { orderId }); 
                         currentOrders.push(orderData);
                         if (orderData.status === 'שויך') newOrderDetected = true; 
                     } else if (change.type === "modified") { 
                         SmartLog.info("Order modified:", "Orders", { orderId, status: orderData.status }); 
                         const index = currentOrders.findIndex(o => o.id === orderId);
                         if (index > -1) currentOrders[index] = orderData;
                         else currentOrders.push(orderData);
                     } else if (change.type === "removed") { 
                         SmartLog.info("Order removed from list:", "Orders", { orderId }); 
                         currentOrders = currentOrders.filter(o => o.id !== orderId);
                     } 
                 });
                 
                 renderOrderList();
                 updateOrderMarkersOnMap();
                 if (newOrderDetected) handleNewOrderNotification();
                 
             }, (error) => { 
                 SmartLog.error(error, "Orders.Listener"); 
                 updateStatus("error", "שגיאת סנכרון"); 
                 if (DOM.loadingOrders) DOM.loadingOrders.innerHTML = '<p class="text-red-500">שגיאת סנכרון</p>'; 
             });
        }
        
        function renderOrderList() { 
             // ... (Logic remains the same) ...
             currentOrders.sort((a, b) => {
                 if (a.status === 'שויך' && b.status !== 'שויך') return -1;
                 if (a.status !== 'שויך' && b.status === 'שויך') return 1;
                 return (a.createdAt?.toMillis() || 0) - (b.createdAt?.toMillis() || 0); 
             }); 
             if (!DOM.orderList) return;
             if (currentOrders.length === 0) { 
                 DOM.orderList.innerHTML = `<p class="text-center text-gray-500 py-10">אין משימות פעילות.</p>`; 
                 updateOrderMarkersOnMap();
                 return; 
             }
             DOM.orderList.innerHTML = currentOrders.map(order => createOrderCard(order)).join(''); 
             updateDistances();
             try{ if(feather) feather.replace(); } catch(e){}
        }

        function updateDistances() {
             // ... (Logic remains the same) ...
             if (!currentLatLng) return;
             currentOrders.forEach(order => {
                 const card = document.getElementById(`order-${order.id}`);
                 const distEl = card?.querySelector('.distance');
                 if (distEl && order.latitude && order.longitude) {
                     try {
                        const orderLatLng = L.latLng(order.latitude, order.longitude);
                        const driverLatLng = L.latLng(currentLatLng);
                        const distanceKm = (driverLatLng.distanceTo(orderLatLng) / 1000).toFixed(1);
                        distEl.textContent = `📍 ${distanceKm} ק"מ`;
                     } catch (e) { distEl.textContent = `📍 - ק"מ`; }
                 } else if (distEl) { distEl.textContent = `📍 - ק"מ`; }
                 const marker = orderMarkers[order.id];
                 if (marker && marker.isPopupOpen()) {
                      const distanceText = `מרחק: ${(L.latLng(currentLatLng).distanceTo([order.latitude, order.longitude]) / 1000).toFixed(1)} ק"מ`;
                      const popupContent = `<h4>${order.customer?.name || '?'}</h4><p>${order.address || '?'}</p><p>${distanceText}</p><p>סטטוס: ${order.status}</p>`;
                      marker.setPopupContent(popupContent);
                 }
             });
        }

        function createOrderCard(order) { 
            // ... (Logic remains the same) ...
            let cardClass = "order-card bg-white p-4 rounded-lg shadow"; 
            let actionButton = ''; 
            let statusText = order.status || '?'; 
            let statusColor = "text-gray-500";
            let distanceText = 'מחשב מרחק...';
             if (currentLatLng && order.latitude && order.longitude) {
                  try {
                     const orderLatLng = L.latLng(order.latitude, order.longitude);
                     const driverLatLng = L.latLng(currentLatLng);
                     distanceText = `📍 ${(driverLatLng.distanceTo(orderLatLng) / 1000).toFixed(1)} ק"מ`;
                  } catch(e) { distanceText = 'שגיאת מרחק'; }
             }
            switch (order.status) {
                case 'שויך': 
                    cardClass += " notification-card"; 
                    statusText = "חדשה - לאישור"; 
                    statusColor = "text-yellow-600 font-bold"; 
                    actionButton = `<button class="w-full btn btn-success mt-3" onclick="window.acknowledgeOrder('${order.id}')"><i data-feather="check-circle" class="inline w-4 h-4 ml-1"></i> אישור והתחלת העמסה</button>`; 
                    break;
                case 'בדרך': 
                    statusText = "בדרך ללקוח"; 
                    statusColor = "text-green-600 font-semibold"; 
                    actionButton = `<button class="w-full btn btn-success mt-3" onclick="window.completeOrder('${order.id}')"><i data-feather="flag" class="inline w-4 h-4 ml-1"></i> סיום משימה</button>`; 
                    break;
                default: 
                    cardClass += " opacity-70";
            }
            const mapsUrl = `https://maps.google.com/maps?q=${order.latitude},${order.longitude}`; // Use lat,lon
            const buttons = `<div class="grid grid-cols-2 gap-2 mt-3 text-sm">
                                <a href="tel:${order.customer?.phone || ''}" class="btn btn-secondary btn-sm"><i data-feather="phone" class="inline w-4 h-4"></i> לקוח</a>
                                <a href="${mapsUrl}" target="_blank" class="btn btn-primary btn-sm"><i data-feather="navigation" class="inline w-4 h-4"></i> ניווט</a>
                             </div>`;
            return `<div class="${cardClass}" id="order-${order.id}">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h3 class="text-lg font-bold text-gray-900">${order.customer?.name || '?'}</h3>
                                <p class="text-sm text-gray-600 address">${order.address || '?'}</p>
                                <span class="text-sm distance">${distanceText}</span> 
                            </div>
                            <span class="text-xs font-medium ${statusColor} whitespace-nowrap">${statusText}</span>
                        </div>
                        <p class="text-xs text-gray-500 mb-3">הערות: ${order.notes || 'אין'}</p>
                        ${actionButton}
                        ${buttons}
                    </div>`;
        }

        // --- Order Actions ---
        window.acknowledgeOrder = async (orderId) => { 
            SmartLog.info("Acknowledging order...", "Orders.Action", { orderId }); 
            const button = document.querySelector(`#order-${orderId} button`);
             if(button) button.classList.add('btn-disabled');
            try { 
                const orderRef = doc(db, "orders", orderId); // Uses imported db, doc
                await updateDoc(orderRef, { status: "בדרך", lastModified: serverTimestamp() }); // Uses imported updateDoc, serverTimestamp
                SmartLog.info("Status updated to 'בדרך'", "Orders.Action", { orderId }); 
                stopNotificationSound(); 
                document.getElementById(`order-${orderId}`)?.classList.remove('notification-card'); 
            } catch (e) { 
                SmartLog.error(e, "Orders.Action.Acknowledge"); 
                alert("שגיאה באישור."); 
                 if(button) button.classList.remove('btn-disabled');
            }
        };
        
        window.completeOrder = async (orderId) => { 
             SmartLog.info("Completing order...", "Orders.Action", { orderId }); 
             if (!confirm("לסמן משימה כהושלמה?")) return; 
             const button = document.querySelector(`#order-${orderId} button`);
             if(button) button.classList.add('btn-disabled');
             try { 
                 const orderRef = doc(db, "orders", orderId); // Uses imported db, doc
                 await updateDoc(orderRef, { status: "הושלם", completedAt: serverTimestamp(), lastModified: serverTimestamp() }); // Uses imported updateDoc, serverTimestamp
                 SmartLog.info("Status updated to 'הושלם'", "Orders.Action", { orderId }); 
             } catch (e) { 
                 SmartLog.error(e, "Orders.Action.Complete"); 
                 alert("שגיאה בסיום."); 
                 if(button) button.classList.remove('btn-disabled');
             }
        };

        // --- Notifications ---
        function initNotifications() { 
            // ... (Logic remains the same, uses imported SmartLog) ...
            if (!hasNotificationPermission || !window.Tone) return; try { notificationAudio = new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.2 } }).toDestination(); SmartLog.info("Audio initialized.", "Notifications"); } catch (e) { SmartLog.error(e, "Notifications.InitAudio"); }
        }
        function handleNewOrderNotification() { 
            // ... (Logic remains the same, uses imported SmartLog) ...
             SmartLog.info("New order notification...", "Notifications");
             if (notificationAudio && Tone?.context?.state === 'running') { try { notificationAudio.triggerAttackRelease("C5", "8n", Tone.now()); notificationAudio.triggerAttackRelease("G5", "8n", Tone.now() + 0.2); SmartLog.info("Sound played.", "Notifications"); } catch(e) { SmartLog.error(e, "Notifications.PlaySound"); } }
             else if (notificationAudio) { Tone.start().then(() => { SmartLog.info("Audio context resumed. Retrying sound.", "Notifications"); try { notificationAudio.triggerAttackRelease("C5", "8n", Tone.now()); notificationAudio.triggerAttackRelease("G5", "8n", Tone.now() + 0.2); }
