<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>DeliveryMaster  v50.4 (Modular + Ping)</title>
    <link rel="manifest" href="manifest.json"> <meta name="theme-color" content="#3a86ff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/ryPT3r29/image.png"> <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        /* CSS remains the same as v50.3.3 */
        :root { --primary-color: #3a86ff; --primary-dark: #2f6ac2; --success-color: #28a745; --success-dark: #218838; --warning-color: #ffc107; --warning-dark: #e0a800; --danger-color: #dc3545; --danger-dark: #c82333; --bg-light: #f8f9fa; --bg-white: #ffffff; --border-color: #dee2e6; --text-dark: #212529; --text-light: #6c757d; }
        html, body { height: 100vh; overflow: hidden; }
        body { font-family: 'Rubik', sans-serif; overscroll-behavior-y: contain; background-color: var(--bg-light); color: var(--text-dark); }
        #map { height: 250px; border-radius: 0.5rem; background-color: #e9ecef; }
        .leaflet-control-zoom { display: none; } .leaflet-control-attribution { font-size: 10px; background: rgba(255,255,255,0.7); padding: 1px 4px; border-radius: 2px; }
        .leaflet-popup-content-wrapper { border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); } .leaflet-popup-content { font-family: 'Rubik', sans-serif; font-size: 0.9rem; line-height: 1.4; } .leaflet-popup-content h4 { font-weight: 700; margin-bottom: 5px; font-size: 1rem; } .leaflet-popup-content p { margin: 3px 0; color: var(--text-light); }
        .btn { padding: 0.6rem 1rem; border-radius: 0.375rem; font-weight: 500; transition: background-color 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 0.3rem; }
        .btn-primary { background-color: var(--primary-color); color: white; } .btn-primary:hover { background-color: var(--primary-dark); } .btn-secondary { background-color: var(--text-light); color: white; } .btn-secondary:hover { background-color: #5a6268; } .btn-success { background-color: var(--success-color); color: white; } .btn-success:hover { background-color: var(--success-dark); } .btn-warning { background-color: var(--warning-color); color: var(--text-dark); } .btn-warning:hover { background-color: var(--warning-dark); } .btn-icon { padding: 0.5rem; } .btn-disabled { opacity: 0.6; cursor: not-allowed; pointer-events: none; }
        .notification-card { border-left: 5px solid var(--warning-color); animation: pulse 1.5s infinite; } @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 193, 7, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); } }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; } @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .order-card { background-color: var(--bg-white); border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); } .order-card h3 { color: var(--text-dark); } .order-card .address { color: var(--text-light); } .order-card .distance { color: var(--primary-dark); font-weight: 500; }
        #status-indicator { font-size: 0.8rem; font-weight: 500; padding: 4px 8px; border-radius: 99px; display: inline-flex; align-items: center; gap: 4px; } #status-indicator.connected { background-color: #dcfce7; color: #166534; } #status-indicator.connecting { background-color: #fef9c3; color: #854d0e; } #status-indicator.error { background-color: #fee2e2; color: #991b1b; } #status-indicator .dot { width: 6px; height: 6px; border-radius: 50%; } #status-indicator.connected .dot { background-color: #22c55e; } #status-indicator.connecting .dot { background-color: #facc15; } #status-indicator.error .dot { background-color: #ef4444; }
        #login-error-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255, 255, 255, 0.95); z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 2rem; }

        /* Simple Toast for Ping */
        #driver-toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--primary-color);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 5000;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            transform: translate(-50%, 20px); /* Start below */
            display: none; /* Hidden initially */
            font-weight: 500;
        }
        #driver-toast.show {
            display: block;
            opacity: 1;
            transform: translateX(-50%); /* Center horizontally */
        }

    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div id="login-error-overlay">
        <i data-feather="alert-triangle" class="w-16 h-16 text-red-500 mb-4"></i>
        <h2 class="text-2xl font-bold text-red-700 mb-2">砖转 转专转</h2>
        <p class="text-gray-600">  驻专 .</p>
        <p class="text-gray-600 mt-1"> 专 住 专砖 转专 砖.</p>
    </div>


    <div id="main-container" class="container mx-auto max-w-lg p-0 flex flex-col h-screen bg-white shadow-lg">
        <header class="bg-white shadow-sm p-4 flex justify-between items-center sticky top-0 z-10 border-b border-gray-200">
            <div>
                <h1 class="text-xl font-bold text-gray-800">DeliveryMaster</h1>
                <p id="driver-name-display" class="text-sm text-gray-600">: 注...</p>
            </div>
            <div id="status-indicator" class="connecting"><span id="status-text">注...</span><span id="status-dot" class="dot"></span></div>
        </header>

        <div id="permission-section" class="p-4 space-y-3 bg-yellow-100 border-b border-yellow-300" style="display: none;">
             <p class="text-sm font-medium text-yellow-800">专砖转 专砖转 拽 转专转:</p>
             <button id="request-perms-btn" class="w-full text-sm btn btn-warning">拽砖 专砖转</button>
        </div>

        <div class="p-4 border-b border-gray-200">
            <div id="location-info" class="bg-blue-50 p-3 rounded-lg mb-3 text-sm text-blue-800">
                 <p id="current-location-text"> 转专 拽 ...</p>
                 <p id="eta-text" class="mt-1 font-medium hidden">...</p>
            </div>
            <div id="map"></div>
        </div>

        <main id="order-list" class="flex-grow overflow-y-auto p-4 space-y-4 bg-gray-50">
             <div id="loading-orders" class="text-center py-10 text-gray-500">
                 <div class="loader mx-auto mb-2"></div>注 砖转...
             </div>
             </main>
    </div>

     <div id="driver-toast"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>


    <script type="module">
        // --- Import from Shared Module ---
        import {
            db, authReadyPromise, SmartLog,
            collection, doc, onSnapshot, query, addDoc, updateDoc,
            serverTimestamp, where, setDoc, limit, orderBy // Ensure orderBy and limit are imported
        } from '../shared/firebase-init.js'; // Adjust path

        console.log('Driver App script started (v50.4 Modular)');

        // --- Driver App Specific Logic ---

        // Globals (remain mostly the same)
        let map; let driverMarker = null; let orderMarkers = {};
        let currentDriverId = localStorage.getItem('driverId');
        let currentDriverName = localStorage.getItem('driverName');
        let watchId = null; let currentOrders = []; let currentLatLng = null;
        let notificationAudio = null; let hasNotificationPermission = false; let hasGeolocationPermission = false;
        let lastLocationUpdate = 0;
        const LOCATION_UPDATE_INTERVAL = 20000;
        const ACTIVE_DRIVER_ORDER_STATUSES = ["砖", "专"];
        const ISRAEL_CENTER = [32.0853, 34.7818];

        // Map Icons
        const orderIconActive = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png', shadowSize: [41, 41] });


        // DOM Elements
        let DOM = {}; // Populated in initializeDriverApp

        // --- Initialization ---
        async function initializeDriverApp() {
            try {
                DOM = {
                     driverNameDisplay: document.getElementById('driver-name-display'), statusIndicator: document.getElementById('status-indicator'), statusText: document.getElementById('status-text'), statusDot: document.getElementById('status-dot'), permissionSection: document.getElementById('permission-section'), requestPermsBtn: document.getElementById('request-perms-btn'), locationInfo: document.getElementById('location-info'), currentLocationText: document.getElementById('current-location-text'), etaText: document.getElementById('eta-text'), mapElement: document.getElementById('map'), orderList: document.getElementById('order-list'), loadingOrders: document.getElementById('loading-orders'), loginErrorOverlay: document.getElementById('login-error-overlay'), mainContainer: document.getElementById('main-container'), driverToast: document.getElementById('driver-toast') // Added toast element
                };
                SmartLog.info("DOM elements referenced.", "Init.DOM");
                if (!DOM.driverNameDisplay || !DOM.statusIndicator || !DOM.mapElement || !DOM.orderList || !DOM.loginErrorOverlay || !DOM.mainContainer || !DOM.driverToast) { throw new Error("Essential DOM elements missing!"); }

                SmartLog.info("Initializing Driver App (v50.4 Modular)...", "Init");
                updateStatus("connecting", "转...");

                if (!currentDriverId || !currentDriverName) { SmartLog.error(new Error("Missing driverId/Name"), "Auth"); showLoginErrorOverlay(); return; }
                DOM.driverNameDisplay.textContent = `: ${currentDriverName}`;

                await authReadyPromise; // Use imported promise
                SmartLog.info("Firebase Auth Ready.", "Init");
                updateStatus("connecting", "拽 专砖转...");

                await checkAndRequestPermissions();

                updateStatus("connecting", "转 驻...");
                initMap();

                if (hasGeolocationPermission) { updateStatus("connecting", "驻注 GPS..."); startGeolocation(); }
                else { updateStatus("error", "转 砖专 拽"); SmartLog.warn("Geolocation permission pending.", "Permissions"); }

                initNotifications(); // Initialize sound engine

                updateStatus("connecting", "住专 砖转...");
                listenToOrders();
                listenToDriverPings(); // *** ADDED PING LISTENER CALL ***

                updateFinalStatus();
                SmartLog.info("Driver App Initialization Complete.", "Init");

            } catch (error) { SmartLog.error(error, "Init.Critical"); if (DOM.statusIndicator) updateStatus("error", `砖转 转`); showLoginErrorOverlay(`砖转 转: ${error.message}`); }
        }

        // --- Login Error Handling (remains the same) ---
         function showLoginErrorOverlay(message = "  驻专 .") {
             if (DOM && DOM.loginErrorOverlay && DOM.mainContainer) {
                 const msgP = DOM.loginErrorOverlay.querySelector('p:nth-of-type(1)'); if (msgP) msgP.textContent = message;
                 const instrP = DOM.loginErrorOverlay.querySelector('p:nth-of-type(2)'); if (instrP) instrP.textContent = " 专 住 专砖 转专 砖.";
                 DOM.loginErrorOverlay.style.display = 'flex';
                 DOM.mainContainer.style.display = 'none';
                 try { if(feather) feather.replace(); } catch(e){}
             } else { console.error("Login Error Overlay failed, DOM not ready.", message); alert(message + "\n 专 住 专砖 转专 砖."); }
         }

        // --- Status Update (remains the same) ---
        function updateFinalStatus() {
             if (watchId) updateStatus("connected", "GPS 驻注");
             else if (!hasGeolocationPermission) updateStatus("error", "专砖转 专砖转 拽");
             else updateStatus("connecting", "GPS  驻注");
        }
        function updateStatus(statusClass, text) {
             if (!DOM.statusIndicator || !DOM.statusText || !DOM.statusDot) { console.warn("Status elements not ready:", text); return; }
             // SmartLog.info(`Updating Status: ${text}`, "UI.Status", { class: statusClass }); // Can be noisy, uncomment if needed
             DOM.statusIndicator.className = statusClass; DOM.statusText.textContent = text;
        }

        // --- Permissions (remains the same) ---
        async function checkAndRequestPermissions() {
             SmartLog.info("Checking permissions...", "Permissions");
             let needsGeo = false, needsNotif = false;
             try { const s = await navigator.permissions.query({ name: 'geolocation' }); hasGeolocationPermission = s.state === 'granted'; if (s.state === 'prompt') needsGeo = true; SmartLog.info("Geo status:", "Permissions", { s: s.state }); } catch (e) { SmartLog.warn("Geo query failed.", "Permissions", e); needsGeo = true; }
             if ('Notification' in window) { hasNotificationPermission = Notification.permission === 'granted'; if (Notification.permission === 'default') needsNotif = true; SmartLog.info("Notif status:", "Permissions", { s: Notification.permission }); } else SmartLog.warn("Notifications not supported.", "Permissions");

             if (needsGeo || needsNotif) {
                 if (DOM.permissionSection && DOM.requestPermsBtn) { DOM.permissionSection.style.display = 'block'; DOM.requestPermsBtn.onclick = handlePermissionRequest; updateStatus("error", "专砖转 专砖转"); }
                 else SmartLog.error("Permission UI missing!", "Permissions");
             } else { if (DOM.permissionSection) DOM.permissionSection.style.display = 'none'; SmartLog.info("Permissions handled.", "Permissions"); }
        }
        async function handlePermissionRequest() {
            SmartLog.info("Requesting permissions...", "Permissions");
            let geoGranted = hasGeolocationPermission; let notifGranted = hasNotificationPermission;
            if (!hasGeolocationPermission) {
                try { await new Promise((res, rej) => navigator.geolocation.getCurrentPosition(res, rej, { timeout: 15000, enableHighAccuracy: true })); const s = await navigator.permissions.query({ name: 'geolocation' }); geoGranted = s.state === 'granted'; hasGeolocationPermission = geoGranted; SmartLog.info("Geo req result:", "Permissions", { s: s.state }); if (geoGranted && !watchId) { updateStatus("connecting", "驻注 GPS..."); startGeolocation(); } } catch (e) { SmartLog.error(e, "Permissions.GeoReq"); }
            }
            if ('Notification' in window && Notification.permission === 'default') {
                try { const p = await Notification.requestPermission(); notifGranted = p === 'granted'; hasNotificationPermission = notifGranted; SmartLog.info("Notif req result:", "Permissions", { p }); if (notifGranted) initNotifications(); } catch (e) { SmartLog.error(e, "Permissions.NotifReq"); }
            }
            if (geoGranted && DOM.permissionSection) DOM.permissionSection.style.display = 'none';
            updateFinalStatus();
            if (!geoGranted && DOM.requestPermsBtn) { DOM.requestPermsBtn.textContent = "拽砖 拽 砖"; DOM.requestPermsBtn.classList.add('btn-disabled'); setTimeout(() => DOM.requestPermsBtn?.classList.remove('btn-disabled'), 5000); }
        }

        // --- Geolocation & Location Update (use imported functions) ---
        function startGeolocation() {
            if (watchId) { SmartLog.info("GPS already watching.", "GPS"); return; }
            if (!hasGeolocationPermission) { SmartLog.warn("No geo permission.", "GPS"); updateStatus("error", "专砖转 专砖转 拽"); return; }
            if (!('geolocation' in navigator)) { SmartLog.error("Geolocation not supported.", "GPS"); updateStatus("error", "GPS  转"); return; }
            SmartLog.info("Starting watchPosition...", "GPS"); updateStatus("connecting", "驻注 GPS...");
            watchId = navigator.geolocation.watchPosition(
                async (position) => {
                    const { latitude, longitude, accuracy } = position.coords; currentLatLng = [latitude, longitude];
                    // SmartLog.info("GPS Update", "GPS", { lat: latitude.toFixed(4), acc: accuracy }); // Can be noisy
                    updateStatus("connected", "GPS 驻注");
                    updateDriverMarkerOnMap(latitude, longitude); updateLocationText(latitude, longitude); updateDistances(); updateMapBounds();
                    const now = Date.now();
                    if (now - lastLocationUpdate > LOCATION_UPDATE_INTERVAL) { await updateLocationInFirestore(latitude, longitude); lastLocationUpdate = now; }
                },
                (error) => {
                    SmartLog.error(error, "GPS.Error"); currentLatLng = null; let msg = "砖转 GPS"; if (error.code === 1) msg = "GPS:  专砖"; else if (error.code === 2) msg = "GPS:  "; else if (error.code === 3) msg = "GPS: Timeout"; updateStatus("error", msg); if (watchId) { navigator.geolocation.clearWatch(watchId); watchId = null; }
                },
                { enableHighAccuracy: true, timeout: 20000, maximumAge: 10000 }
            );
        }
        async function updateLocationInFirestore(lat, lng) {
             if (!db || !currentDriverId) return;
             const locationRef = doc(db, "driverLocations", currentDriverId);
             const locationData = { latitude: lat, longitude: lng, lastUpdate: serverTimestamp(), driverName: currentDriverName }; // Use imported serverTimestamp
             try { await setDoc(locationRef, locationData, { merge: true }); SmartLog.info("Location updated.", "GPS.Firestore"); } // Use imported setDoc
             catch (e) { SmartLog.error(e, "GPS.Firestore.Set"); }
        }
        async function updateLocationText(lat, lng) {
            if (!DOM.currentLocationText) return; DOM.currentLocationText.textContent = ` ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            try { const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=16`); if (!r.ok) throw new Error(`${r.status}`); const d = await r.json(); if (d?.display_name) { const s = d.display_name.split(', ').slice(0, 3).join(', '); DOM.currentLocationText.textContent = ` ${s}`; /* SmartLog.info("Rev geocode OK", "GPS.Geo", { a: s }); */ } else SmartLog.warn("Rev geocode failed", "GPS.Geo", { d }); } catch (e) { SmartLog.error(e, "GPS.ReverseGeocode"); }
        }

        // --- Map Handling (remains the same) ---
         function initMap() {
             try { if (map) map.remove(); map = L.map(DOM.mapElement).setView(ISRAEL_CENTER, 13); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '漏 OSM', maxZoom: 18, }).addTo(map); SmartLog.info("Map initialized", "Map"); }
             catch (e) { SmartLog.error(e, "Map.Init"); if (DOM.mapElement) DOM.mapElement.innerHTML = '<p class="text-red-500 p-4 text-center">Map Error</p>'; }
        }
        function updateDriverMarkerOnMap(lat, lng) {
             if (!map) return; const latLng = [lat, lng];
             if (driverMarker) { driverMarker.setLatLng(latLng); }
             else { driverMarker = L.circleMarker(latLng, { radius: 8, fillColor: "#3a86ff", color: "#fff", weight: 2, opacity: 1, fillOpacity: 0.9 }).addTo(map).bindPopup(`<b>${currentDriverName}</b>`); SmartLog.info("Driver marker added", "Map"); }
        }
        function updateOrderMarkersOnMap() {
            if (!map) return;
            const activeMapOrders = currentOrders.filter(o => o.latitude && o.longitude);
            // Remove old markers
            Object.keys(orderMarkers).forEach(orderId => { if (!activeMapOrders.some(o => o.id === orderId)) { if (map.hasLayer(orderMarkers[orderId])) map.removeLayer(orderMarkers[orderId]); delete orderMarkers[orderId]; } });
            // Add/Update current markers
            activeMapOrders.forEach(order => {
                const latLng = [order.latitude, order.longitude];
                const distTxt = currentLatLng ? `专拽: ${(L.latLng(currentLatLng).distanceTo(latLng) / 1000).toFixed(1)} 拽"` : '';
                const popup = `<h4>${order.customer?.name || '?'}</h4><p>${order.address || '?'}</p><p>${distTxt}</p><p>住住: ${order.status}</p>`;
                if (orderMarkers[order.id]) orderMarkers[order.id].setLatLng(latLng).setPopupContent(popup);
                else { orderMarkers[order.id] = L.marker(latLng, { icon: orderIconActive }).addTo(map).bindPopup(popup); SmartLog.info("Order marker added", "Map", { orderId: order.id }); }
            });
            updateMapBounds();
        }
        function updateMapBounds() {
            if (!map) return; const bounds = L.latLngBounds();
            if (driverMarker) bounds.extend(driverMarker.getLatLng());
            Object.values(orderMarkers).forEach(m => bounds.extend(m.getLatLng()));
            if (bounds.isValid()) map.fitBounds(bounds, { padding: [40, 40], maxZoom: 16 });
            else if (driverMarker) map.setView(driverMarker.getLatLng(), 15);
            else map.setView(ISRAEL_CENTER, 13);
        }

        // --- Order Handling (use imported functions) ---
        function listenToOrders() {
             SmartLog.info("Listening to orders", "Orders", { driverId: currentDriverId });
             const q = query( collection(db, "orders"), where("driver.id", "==", currentDriverId), where("status", "in", ACTIVE_DRIVER_ORDER_STATUSES) );
             onSnapshot(q, (snapshot) => {
                 // SmartLog.info(`Orders snapshot: ${snapshot.docChanges().length} changes`, "Orders");
                 if (DOM.loadingOrders) DOM.loadingOrders.style.display = 'none'; let newOrder = false;
                 snapshot.docChanges().forEach((change) => {
                     const orderId = change.doc.id; const orderData = { id: orderId, ...change.doc.data() };
                     if (change.type === "added") { currentOrders.push(orderData); if (orderData.status === '砖') newOrder = true; }
                     else if (change.type === "modified") { const i = currentOrders.findIndex(o => o.id === orderId); if (i > -1) currentOrders[i] = orderData; else currentOrders.push(orderData); }
                     else if (change.type === "removed") { currentOrders = currentOrders.filter(o => o.id !== orderId); }
                 });
                 renderOrderList(); updateOrderMarkersOnMap(); if (newOrder) handleNewOrderNotification();
             }, (error) => { SmartLog.error(error, "Orders.Listener"); updateStatus("error", "砖转 住专"); if (DOM.loadingOrders) DOM.loadingOrders.innerHTML = '<p class="text-red-500">砖转 住专</p>'; });
        }
        function renderOrderList() {
             currentOrders.sort((a, b) => (a.status === '砖' && b.status !== '砖') ? -1 : (a.status !== '砖' && b.status === '砖') ? 1 : (a.createdAt?.toMillis() || 0) - (b.createdAt?.toMillis() || 0));
             if (!DOM.orderList) return;
             if (currentOrders.length === 0) { DOM.orderList.innerHTML = `<p class="text-center text-gray-500 py-10"> 砖转 驻注转.</p>`; updateOrderMarkersOnMap(); return; }
             DOM.orderList.innerHTML = currentOrders.map(o => createOrderCard(o)).join('');
             updateDistances(); try { if(feather) feather.replace(); } catch(e){}
        }
        function updateDistances() {
             if (!currentLatLng) return;
             currentOrders.forEach(order => {
                 const card = document.getElementById(`order-${order.id}`); const distEl = card?.querySelector('.distance');
                 if (distEl && order.latitude && order.longitude) { try { const dist = (L.latLng(currentLatLng).distanceTo(L.latLng(order.latitude, order.longitude)) / 1000).toFixed(1); distEl.textContent = ` ${dist} 拽"`; } catch (e) { distEl.textContent = ` - 拽"`; } }
                 else if (distEl) distEl.textContent = ` - 拽"`;
                 const marker = orderMarkers[order.id]; if (marker && marker.isPopupOpen() && order.latitude && order.longitude) { try { const distTxt = `专拽: ${(L.latLng(currentLatLng).distanceTo([order.latitude, order.longitude]) / 1000).toFixed(1)} 拽"`; const popup = `<h4>${order.customer?.name || '?'}</h4><p>${order.address || '?'}</p><p>${distTxt}</p><p>住住: ${order.status}</p>`; marker.setPopupContent(popup); } catch(e){} }
             });
        }
        function createOrderCard(order) {
            let cardClass = "order-card bg-white p-4 rounded-lg shadow", actionBtn = '', statusTxt = order.status || '?', statusColor = "text-gray-500", distTxt = ' 砖...';
             if (currentLatLng && order.latitude && order.longitude) { try { distTxt = ` ${(L.latLng(currentLatLng).distanceTo(L.latLng(order.latitude, order.longitude)) / 1000).toFixed(1)} 拽"`; } catch(e) { distTxt = ' 砖'; } }
            switch (order.status) {
                case '砖': cardClass += " notification-card"; statusTxt = "砖 砖专"; statusColor = "text-yellow-600 font-bold"; actionBtn = `<button class="w-full btn btn-success mt-3" onclick="window.acknowledgeOrder('${order.id}')"><i data-feather="check-circle" class="inline w-4 h-4 ml-1"></i> 砖专 转</button>`; break;
                case '专': statusTxt = "专 拽"; statusColor = "text-green-600 font-semibold"; actionBtn = `<button class="w-full btn btn-success mt-3" onclick="window.completeOrder('${order.id}')"><i data-feather="flag" class="inline w-4 h-4 ml-1"></i> 住 砖</button>`; break;
                default: cardClass += " opacity-70";
            }
            const mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${order.latitude},${order.longitude}`; // Use standard Google Maps URL
            const buttons = `<div class="grid grid-cols-2 gap-2 mt-3 text-sm"><a href="tel:${order.customer?.phone || ''}" class="btn btn-secondary btn-sm"><i data-feather="phone" class="inline w-4 h-4"></i> 拽</a><a href="${mapsUrl}" target="_blank" class="btn btn-primary btn-sm"><i data-feather="navigation" class="inline w-4 h-4"></i> </a></div>`;
            return `<div class="${cardClass}" id="order-${order.id}"><div class="flex justify-between items-start mb-2"><div><h3 class="text-lg font-bold text-gray-900">${order.customer?.name || '?'}</h3><p class="text-sm text-gray-600 address">${order.address || '?'}</p><span class="text-sm distance">${distTxt}</span></div><span class="text-xs font-medium ${statusColor} whitespace-nowrap">${statusTxt}</span></div><p class="text-xs text-gray-500 mb-3">注专转: ${order.notes || ''}</p>${actionBtn}${buttons}</div>`;
        }

        // --- Order Actions (use imported functions) ---
        window.acknowledgeOrder = async (orderId) => {
            SmartLog.info("Acknowledging order...", "Orders.Action", { orderId }); const btn = document.querySelector(`#order-${orderId} button`); if(btn) btn.classList.add('btn-disabled');
            try { const orderRef = doc(db, "orders", orderId); await updateDoc(orderRef, { status: "专", lastModified: serverTimestamp() }); SmartLog.info("Status updated to '专'", "Orders.Action", { orderId }); stopNotificationSound(); document.getElementById(`order-${orderId}`)?.classList.remove('notification-card'); }
            catch (e) { SmartLog.error(e, "Orders.Action.Ack"); alert("砖 砖专."); if(btn) btn.classList.remove('btn-disabled'); }
        };
        window.completeOrder = async (orderId) => {
             SmartLog.info("Completing order...", "Orders.Action", { orderId }); if (!confirm("住 砖 砖?")) return; const btn = document.querySelector(`#order-${orderId} button`); if(btn) btn.classList.add('btn-disabled');
             try { const orderRef = doc(db, "orders", orderId); await updateDoc(orderRef, { status: "砖", completedAt: serverTimestamp(), lastModified: serverTimestamp() }); SmartLog.info("Status updated to '砖'", "Orders.Action", { orderId }); }
             catch (e) { SmartLog.error(e, "Orders.Action.Complete"); alert("砖 住."); if(btn) btn.classList.remove('btn-disabled'); }
        };

        // --- Notifications (remain the same) ---
         function initNotifications() {
             if (!window.Tone) { SmartLog.warn("Tone.js not loaded.", "Notifications"); return; }
             try { notificationAudio = new Tone.Synth({ oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.2 } }).toDestination(); SmartLog.info("Audio initialized.", "Notifications"); }
             catch (e) { SmartLog.error(e, "Notifications.InitAudio"); }
        }
        function handleNewOrderNotification() {
             SmartLog.info("New order notification...", "Notifications");
             if (notificationAudio) { Tone.start().then(() => { try { notificationAudio.triggerAttackRelease("C5", "8n", Tone.now()); notificationAudio.triggerAttackRelease("G5", "8n", Tone.now() + 0.2); SmartLog.info("Sound played.", "Notifications"); } catch(e) { SmartLog.error(e, "Notifications.PlaySound"); } }).catch(e => SmartLog.error(e, "Notifications.ToneStartFailed")); }
             else SmartLog.warn("Audio not ready.", "Notifications");
             if (hasNotificationPermission && 'Notification' in window) { try { const n = new Notification(" 砖!", { body: "砖 砖 转.", icon: "https://i.postimg.cc/ryPT3r29/image.png", vibrate: [200, 100, 200] }); n.onclick = () => { window.focus(); SmartLog.info("Notification clicked.", "Notifications"); }; SmartLog.info("Browser notification shown.", "Notifications"); } catch(e) { SmartLog.error(e, "Notifications.Show"); } }
             else SmartLog.warn("Cannot show browser notification.", "Notifications", { perm: hasNotificationPermission });
        }
        function stopNotificationSound() { /* Placeholder - could add synth.triggerRelease() if needed */ SmartLog.info("Stopping sound (placeholder).", "Notifications"); }

        // --- *** NEW: PING LISTENER & HELPERS *** ---
        function showDriverToast(message, duration = 4000) {
            if (!DOM.driverToast) return;
            DOM.driverToast.textContent = message;
            DOM.driverToast.classList.add('show');
            SmartLog.info(`Toast: ${message}`, "UI.Toast");
            setTimeout(() => {
                DOM.driverToast?.classList.remove('show');
            }, duration);
        }

        async function playPingSound() {
            if (!notificationAudio || !window.Tone) { SmartLog.warn("Audio not ready for ping sound", "Notifications.Ping"); return; }
            SmartLog.info("Playing warehouse ping sound...", "Notifications.Ping");
            try {
                await Tone.start();
                notificationAudio.triggerAttackRelease("A5", "8n", Tone.now());
                notificationAudio.triggerAttackRelease("E6", "8n", Tone.now() + 0.15);
                notificationAudio.triggerAttackRelease("A5", "8n", Tone.now() + 0.3);
            } catch (e) { SmartLog.error(e, "Notifications.PlayPingSound"); }
        }

        function listenToDriverPings() {
            if (!currentDriverId || !db) return;
            SmartLog.info("Listening for Driver Pings...", "Pings.Listen", { driverId: currentDriverId });
            // Query for pings specifically for this driver, created recently
            const q = query(
                collection(db, "driverPings"),
                where("driverId", "==", currentDriverId),
                orderBy("createdAt", "desc"),
                limit(1) // Only need the very latest ping
            );

            let initialLoad = true;
            let lastPingTimestamp = null;

            onSnapshot(q, (snapshot) => {
                if (initialLoad) {
                    initialLoad = false;
                    if (!snapshot.empty) lastPingTimestamp = snapshot.docs[0].data().createdAt;
                    return;
                }
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const pingData = change.doc.data();
                        const pingTimestamp = pingData.createdAt;
                        // Process only if newer than the last one seen
                        if (pingTimestamp && (!lastPingTimestamp || pingTimestamp.toMillis() > lastPingTimestamp.toMillis())) {
                             SmartLog.info("New Driver Ping Received!", "Pings", pingData);
                             lastPingTimestamp = pingTimestamp;
                             playPingSound();
                             showDriverToast(`拽专 住 ${pingData.warehouse || ''}!  砖转 注住.`);
                             if ('vibrate' in navigator) navigator.vibrate([300, 100, 300, 100, 300]); // Longer vibration
                        }
                    }
                });
            }, (error) => { SmartLog.error(error, "Pings.Listener"); updateStatus("error", "砖转 拽专转"); });
        }


        // --- Start Application ---
        document.addEventListener('DOMContentLoaded', () => {
            SmartLog.info("DOMContentLoaded.", "Init");
            initializeDriverApp(); // All logic moved inside here
        });

    </script>
    <script>
        if ('serviceWorker' in
