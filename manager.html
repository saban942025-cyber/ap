<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>דשבורד ניהול - ח.סבן</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-main: #f0f2f5;
            --bg-card: #ffffff;
            --primary: #0c5b9e;
            --secondary: #ff9900;
            --text-dark: #1a202c;
            --text-light: #718096;
            --border-color: #e2e8f0;
        }
        body { 
            font-family: 'Assistant', sans-serif; 
            background-color: var(--bg-main);
            color: var(--text-dark);
        }
        .kanban-column {
            min-height: 400px;
        }
        .order-card {
            transition: all 0.2s ease-in-out;
            cursor: grab;
        }
        .order-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .order-card.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease, opacity 0.3s ease;
            transform: translateY(-50px);
        }
        .chart-container {
            animation: fadeIn 0.8s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="p-4 lg:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-primary">מרכז הבקרה למנהל</h1>
            <div>
                <span class="text-lg" id="current-time"></span>
            </div>
        </header>

        <!-- KPIs -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-bg-card p-4 rounded-lg shadow animate-fadeIn"><p class="text-sm text-text-light">הזמנות חדשות</p><p id="kpi-new-orders" class="text-3xl font-bold">0</p></div>
            <div class="bg-bg-card p-4 rounded-lg shadow animate-fadeIn" style="animation-delay: 100ms;"><p class="text-sm text-text-light">בתהליך</p><p id="kpi-in-progress" class="text-3xl font-bold">0</p></div>
            <div class="bg-bg-card p-4 rounded-lg shadow animate-fadeIn" style="animation-delay: 200ms;"><p class="text-sm text-text-light">הכנסה (היום)</p><p id="kpi-revenue" class="text-3xl font-bold">₪0</p></div>
            <div class="bg-bg-card p-4 rounded-lg shadow animate-fadeIn" style="animation-delay: 300ms;"><p class="text-sm text-text-light">לקוחות אונליין</p><p id="kpi-online-users" class="text-3xl font-bold">0</p></div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="bg-bg-card p-6 rounded-lg shadow chart-container"><canvas id="ordersByTypeChart"></canvas></div>
            <div class="bg-bg-card p-6 rounded-lg shadow chart-container" style="animation-delay: 150ms;"><canvas id="dailyOrdersChart"></canvas></div>
        </div>

        <!-- Kanban Board -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="kanban-board">
            <!-- Columns will be injected by JS -->
        </div>
    </div>
    
    <!-- Order Detail Modal -->
    <div id="order-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div id="modal-content" class="bg-bg-card rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col opacity-0">
             <div class="p-4 border-b border-border-color flex justify-between items-center">
                <h2 class="text-xl font-bold" id="modal-title">פרטי הזמנה</h2>
                <button onclick="closeModal()" class="text-text-light hover:text-text-dark">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto" id="modal-body">
                <!-- Modal content will be injected by JS -->
            </div>
             <div class="p-4 bg-gray-50 border-t border-border-color mt-auto">
                 <select id="modal-status-select" class="p-2 border rounded-md">
                     <option value="חדשה">חדשה</option>
                     <option value="בתהליך">בתהליך</option>
                     <option value="הושלמה">הושלמה</option>
                     <option value="מבוטלת">מבוטלת</option>
                 </select>
                <button id="modal-save-btn" class="bg-primary text-white font-bold py-2 px-4 rounded-md hover:bg-opacity-90 mr-2">שמור שינויים</button>
            </div>
        </div>
    </div>


    <script>
        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDy3k1AoEKeuCKjmFxefn9fapeqv2Le1_w",
            authDomain: "hsaban94-cc777.firebaseapp.com",
            databaseURL: "https://hsaban94-cc777.firebaseio.com",
            projectId: "hsaban94-cc777",
            storageBucket: "hsaban94-cc777.appspot.com",
            messagingSenderId: "299206369469",
            appId: "1:299206369469:web:50ca90c58f1981ec9457d4"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- GLOBAL STATE & CHARTS ---
        let ordersData = [];
        let ordersByTypeChart, dailyOrdersChart;

        // --- DOM ELEMENTS ---
        const kanbanBoard = document.getElementById('kanban-board');
        const modal = document.getElementById('order-modal');
        const modalContent = document.getElementById('modal-content');
        
        // --- KANBAN SETUP ---
        const kanbanColumns = {
            'חדשה': { title: 'הזמנות חדשות', color: 'blue-500' },
            'בתהליך': { title: 'בתהליך הכנה', color: 'yellow-500' },
            'הושלמה': { title: 'הזמנות שהושלמו', color: 'green-500' },
            'מבוטלת': { title: 'הזמנות שבוטלו', color: 'red-500' }
        };

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initKanbanBoard();
            initCharts();
            listenForOrders();
            setInterval(updateTime, 1000);
            updateTime();
        });

        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
        }

        function initKanbanBoard() {
            Object.keys(kanbanColumns).forEach(status => {
                const columnInfo = kanbanColumns[status];
                const column = document.createElement('div');
                column.id = `column-${status}`;
                column.className = 'bg-bg-card rounded-lg shadow p-4 kanban-column';
                column.innerHTML = `<h2 class="font-bold text-lg mb-4 border-b-4 border-${columnInfo.color} pb-2">${columnInfo.title}</h2><div id="list-${status}" class="space-y-4"></div>`;
                
                // Drag and Drop listeners
                column.addEventListener('dragover', e => e.preventDefault());
                column.addEventListener('drop', e => handleDrop(e, status));
                
                kanbanBoard.appendChild(column);
            });
        }

        function listenForOrders() {
             // We listen to the orders collections from the customer apps
             // Assuming the collections are named 'הזמנות חומרי בניין' and 'הזמנות מכולות'
            const materialsRef = db.collection('הזמנות חומרי בניין');
            const containersRef = db.collection('הזמנות מכולות');

            materialsRef.orderBy('תאריך קליטה', 'desc').onSnapshot(snapshot => processSnapshot(snapshot, 'חומרי בניין'));
            containersRef.orderBy('תאריך הזמנה', 'desc').onSnapshot(snapshot => processSnapshot(snapshot, 'מכולה'));
        }

        let combinedOrders = {};
        function processSnapshot(snapshot, type) {
            snapshot.docs.forEach(doc => {
                combinedOrders[doc.id] = { id: doc.id, type, ...doc.data() };
            });
            ordersData = Object.values(combinedOrders);
            renderAll();
        }

        function renderAll() {
            renderKanbanCards();
            updateKPIs();
            updateCharts();
        }
        
        // --- RENDERING FUNCTIONS ---
        function renderKanbanCards() {
            // Clear existing cards
            Object.keys(kanbanColumns).forEach(status => {
                document.getElementById(`list-${status}`).innerHTML = '';
            });

            ordersData.forEach(order => {
                const status = order['סטטוס'] || 'חדשה';
                const list = document.getElementById(`list-${status}`);
                if (list) {
                    const card = createOrderCard(order);
                    list.appendChild(card);
                }
            });
        }
        
        function createOrderCard(order) {
            const card = document.createElement('div');
            card.className = 'order-card bg-white p-3 rounded-md shadow-sm border-l-4 border-primary';
            card.draggable = true;
            card.id = `order-${order.id}`;
            card.dataset.orderId = order.id;

            const orderDate = (order['תאריך קליטה'] || order['תאריך הזמנה'])?.toDate ? (order['תאריך קליטה'] || order['תאריך הזמנה']).toDate() : new Date();

            card.innerHTML = `
                <p class="font-bold truncate">${order['שם לקוח'] || 'לקוח לא ידוע'}</p>
                <p class="text-sm text-text-light">${order.type === 'חומרי בניין' ? 'הזמנת חומרים' : 'הזמנת מכולה'}</p>
                <p class="text-xs text-gray-400 mt-2">${orderDate.toLocaleDateString('he-IL')} ${orderDate.toLocaleTimeString('he-IL')}</p>
            `;
            
            card.addEventListener('dragstart', e => {
                e.dataTransfer.setData('text/plain', order.id);
                setTimeout(() => card.classList.add('dragging'), 0);
            });
            card.addEventListener('dragend', () => card.classList.remove('dragging'));
            card.addEventListener('click', () => openModal(order.id));

            return card;
        }
        
        function updateKPIs() {
            document.getElementById('kpi-new-orders').textContent = ordersData.filter(o => o['סטטוס'] === 'חדשה').length;
            document.getElementById('kpi-in-progress').textContent = ordersData.filter(o => o['סטטוס'] === 'בתהליך').length;
            // Placeholders for other KPIs
            document.getElementById('kpi-revenue').textContent = '₪0';
            document.getElementById('kpi-online-users').textContent = '0';
        }

        // --- DRAG & DROP LOGIC ---
        function handleDrop(event, newStatus) {
            event.preventDefault();
            const orderId = event.dataTransfer.getData('text/plain');
            const order = ordersData.find(o => o.id === orderId);

            if (order && order['סטטוס'] !== newStatus) {
                const collectionName = order.type === 'חומרי בניין' ? 'הזמנות חומרי בניין' : 'הזמנות מכולות';
                db.collection(collectionName).doc(orderId).update({ 'סטטוס': newStatus })
                    .catch(err => console.error("Error updating status: ", err));
            }
        }
        
        // --- MODAL LOGIC ---
        function openModal(orderId) {
            const order = ordersData.find(o => o.id === orderId);
            if (!order) return;

            document.getElementById('modal-title').textContent = `הזמנה #${order.id.substring(0,6)}`;
            document.getElementById('modal-status-select').value = order['סטטוס'] || 'חדשה';

            let bodyHtml = `<div class="space-y-4">`;
            bodyHtml += `<div><p class="text-sm text-text-light">לקוח</p><p class="font-semibold">${order['שם לקוח']}</p></div>`;
            bodyHtml += `<div><p class="text-sm text-text-light">סוג</p><p class="font-semibold">${order.type}</p></div>`;
            
            if(order.type === 'חומרי בניין') {
                bodyHtml += `<div><p class="text-sm text-text-light">כתובת למשלוח</p><p class="font-semibold">${order['פרטי אספקה'] || 'לא צוין'}</p></div>`;
                const items = (order['פריטים'] || "").split(', ');
                bodyHtml += `<div><p class="text-sm text-text-light">פירוט</p><ul class="list-disc pr-4">${items.map(item => `<li>${item}</li>`).join('')}</ul></div>`;
            } else {
                bodyHtml += `<div><p class="text-sm text-text-light">כתובת</p><p class="font-semibold">${order['כתובת'] || 'לא צוין'}</p></div>`;
                bodyHtml += `<div><p class="text-sm text-text-light">סוג פעולה</p><p class="font-semibold">${order['סוג פעולה'] || 'לא צוין'}</p></div>`;
            }
            bodyHtml += `</div>`;
            
            document.getElementById('modal-body').innerHTML = bodyHtml;
            document.getElementById('modal-save-btn').onclick = () => saveModalChanges(orderId);

            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.add('opacity-100');
                modalContent.classList.add('opacity-100', 'translate-y-0');
            }, 10);
        }

        function closeModal() {
            modal.classList.remove('opacity-100');
            modalContent.classList.remove('opacity-100', 'translate-y-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function saveModalChanges(orderId) {
            const newStatus = document.getElementById('modal-status-select').value;
            const order = ordersData.find(o => o.id === orderId);
            if (order && order['סטטוס'] !== newStatus) {
                const collectionName = order.type === 'חומרי בניין' ? 'הזמנות חומרי בניין' : 'הזמנות מכולות';
                db.collection(collectionName).doc(orderId).update({ 'סטטוס': newStatus })
                    .then(closeModal)
                    .catch(err => console.error("Error updating status: ", err));
            } else {
                closeModal();
            }
        }

        // --- CHART LOGIC ---
        function initCharts() {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'top' } },
                animation: { duration: 1000, easing: 'easeOutQuart' }
            };

            ordersByTypeChart = new Chart(document.getElementById('ordersByTypeChart'), {
                type: 'doughnut',
                data: { labels: [], datasets: [{ data: [], backgroundColor: ['#0c5b9e', '#ff9900'] }] },
                options: { ...chartOptions, plugins: { ...chartOptions.plugins, title: { display: true, text: 'הזמנות לפי סוג' } } }
            });

            dailyOrdersChart = new Chart(document.getElementById('dailyOrdersChart'), {
                type: 'bar',
                data: { labels: [], datasets: [{ label: 'הזמנות', data: [], backgroundColor: '#0c5b9e' }] },
                options: { ...chartOptions, plugins: { ...chartOptions.plugins, title: { display: true, text: 'הזמנות יומיות (7 ימים אחרונים)' } } }
            });
        }

        function updateCharts() {
            // Doughnut Chart Data
            const typeCounts = ordersData.reduce((acc, order) => {
                const type = order.type || 'לא ידוע';
                acc[type] = (acc[type] || 0) + 1;
                return acc;
            }, {});
            ordersByTypeChart.data.labels = Object.keys(typeCounts);
            ordersByTypeChart.data.datasets[0].data = Object.values(typeCounts);
            ordersByTypeChart.update();

            // Bar Chart Data
            const last7Days = {};
            for(let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                last7Days[d.toLocaleDateString('he-IL')] = 0;
            }
            ordersData.forEach(order => {
                const orderDate = (order['תאריך קליטה'] || order['תאריך הזמנה'])?.toDate ? (order['תאריך קליטה'] || order['תאריך הזמנה']).toDate().toLocaleDateString('he-IL') : null;
                if(orderDate && last7Days.hasOwnProperty(orderDate)) {
                    last7Days[orderDate]++;
                }
            });
            dailyOrdersChart.data.labels = Object.keys(last7Days);
            dailyOrdersChart.data.datasets[0].data = Object.values(last7Days);
            dailyOrdersChart.update();
        }

    </script>
</body>
</html>
