<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saban 360 | מערכת ניהול מתקדמת</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', system-ui, sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
        .nav-item.active { background-color: #e0f2fe; color: #0284c7; border-right: 4px solid #0284c7; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        /* Animations */
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useRef, useMemo } = React;
        const { createRoot } = ReactDOM;

        // --- Firebase Logic ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, setDoc, addDoc, updateDoc, deleteDoc, serverTimestamp, query, orderBy, where, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo", 
          authDomain: "saban94-78949.firebaseapp.com", 
          projectId: "saban94-78949", 
          storageBucket: "saban94-78949.firebasestorage.app", 
          messagingSenderId: "41553157903", 
          appId: "1:41553157903:web:cc33d252cff023be97a87a",
          measurementId: "G-XV6RZDESSB"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- THE MALSHINON (Logger Service) ---
        const logAction = async (user, action, details, type = 'INFO') => {
            if (!user) return;
            try {
                await addDoc(collection(db, 'audit_logs'), {
                    executorId: user.uid,
                    executorName: user.email, // Or display name
                    action: action,
                    details: details,
                    type: type, // INFO, WARNING, DANGER
                    timestamp: serverTimestamp(),
                    userAgent: navigator.userAgent
                });
            } catch (e) { console.error("Log failed", e); }
        };

        // --- Login Component ---
        function LoginScreen({ onLogin }) {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true); setError('');
                try {
                    const cred = await signInWithEmailAndPassword(auth, email.includes('@') ? email : `${email}@saban.com`, password);
                    // Log the login
                    logAction(cred.user, 'LOGIN', 'מנהל נכנס למערכת');
                } catch (err) {
                    setError("פרטי גישה שגויים");
                }
                setLoading(false);
            };

            return (
                <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md fade-in">
                        <div className="text-center mb-8">
                            <div className="w-16 h-16 bg-blue-600 text-white rounded-xl mx-auto flex items-center justify-center text-2xl shadow-lg mb-4">
                                <i className="fa-solid fa-shield-halved"></i>
                            </div>
                            <h1 className="text-2xl font-bold text-slate-800">Saban 360</h1>
                            <p className="text-slate-500">פורטל ניהול מרכזי</p>
                        </div>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <input type="text" placeholder="שם משתמש / אימייל" value={email} onChange={e=>setEmail(e.target.value)} className="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
                            <input type="password" placeholder="סיסמה" value={password} onChange={e=>setPassword(e.target.value)} className="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
                            {error && <p className="text-red-500 text-sm text-center bg-red-50 p-2 rounded">{error}</p>}
                            <button disabled={loading} className="w-full bg-slate-900 text-white py-3 rounded-lg font-bold hover:bg-slate-800 transition-all">{loading ? 'מאמת נתונים...' : 'כניסה מאובטחת'}</button>
                        </form>
                    </div>
                </div>
            );
        }

        // --- Dashboard Widgets ---
        function StatCard({ title, value, icon, color, trend }) {
            return (
                <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex items-start justify-between hover:shadow-md transition-shadow">
                    <div>
                        <p className="text-slate-500 text-sm font-medium mb-1">{title}</p>
                        <h3 className="text-3xl font-bold text-slate-800">{value}</h3>
                        {trend && <span className="text-xs text-green-600 font-bold bg-green-50 px-2 py-1 rounded-full mt-2 inline-block">{trend} <i className="fa-solid fa-arrow-trend-up"></i></span>}
                    </div>
                    <div className={`w-12 h-12 rounded-lg flex items-center justify-center text-xl text-white shadow-lg ${color}`}>
                        <i className={`fa-solid ${icon}`}></i>
                    </div>
                </div>
            );
        }

        function AnalyticsChart({ data }) {
            const canvasRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if (!canvasRef.current) return;
                if (chartInstance.current) chartInstance.current.destroy();

                const ctx = canvasRef.current.getContext('2d');
                chartInstance.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['ינו', 'פבר', 'מרץ', 'אפר', 'מאי', 'יונ'],
                        datasets: [{
                            label: 'פעילות מערכת',
                            data: [12, 19, 3, 5, 2, 3], // Mock data - replace with real logs count if needed
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });

                return () => { if (chartInstance.current) chartInstance.current.destroy(); };
            }, []);

            return <div className="h-64 w-full"><canvas ref={canvasRef}></canvas></div>;
        }

        // --- CRM: Clients & Projects ---
        function CRMPanel({ user }) {
            const [clients, setClients] = useState([]);
            const [selectedClient, setSelectedClient] = useState(null);
            const [isEditing, setIsEditing] = useState(false);

            useEffect(() => {
                // Fetch only customers
                const q = query(collection(db, 'customers'), orderBy('createdAt', 'desc'));
                const unsub = onSnapshot(q, (snap) => {
                    setClients(snap.docs.map(d => ({id: d.id, ...d.data()})));
                });
                return () => unsub();
            }, []);

            const handleAddClient = async (e) => {
                e.preventDefault();
                const name = e.target.cName.value;
                const email = e.target.cEmail.value;
                const phone = e.target.cPhone.value;

                // Create Document Only (Auth requires separate process or cloud function)
                await addDoc(collection(db, 'customers'), {
                    name, email, phone, role: 'client', createdAt: serverTimestamp(), projects: []
                });
                logAction(user, 'CREATE_CLIENT', `נוצר לקוח חדש: ${name}`);
                e.target.reset();
            };

            const addProject = async (clientId, clientData) => {
                const projectName = prompt("שם הפרויקט:");
                if (!projectName) return;
                const address = prompt("כתובת האתר:");
                
                const newProject = {
                    projectId: 'proj_' + Date.now(),
                    name: projectName,
                    address: address || '',
                    status: 'active',
                    createdAt: new Date().toISOString()
                };

                const updatedProjects = [...(clientData.projects || []), newProject];
                
                await updateDoc(doc(db, 'customers', clientId), { projects: updatedProjects });
                logAction(user, 'ADD_PROJECT', `נוסף פרויקט ${projectName} ללקוח ${clientData.name}`);
                // Update local state to reflect immediately if selected
                if(selectedClient && selectedClient.id === clientId) {
                    setSelectedClient({...selectedClient, projects: updatedProjects});
                }
            };

            return (
                <div className="grid grid-cols-12 gap-6 h-full">
                    {/* רשימת לקוחות */}
                    <div className="col-span-4 bg-white rounded-xl shadow-sm overflow-hidden flex flex-col border border-slate-200">
                        <div className="p-4 border-b bg-slate-50 flex justify-between items-center">
                            <h3 className="font-bold text-slate-700">לקוחות ({clients.length})</h3>
                            <button onClick={()=>setIsEditing(true)} className="text-blue-600 text-sm hover:underline">+ חדש</button>
                        </div>
                        <div className="overflow-y-auto flex-1">
                            {clients.map(c => (
                                <div key={c.id} onClick={()=>setSelectedClient(c)} 
                                     className={`p-4 border-b cursor-pointer hover:bg-blue-50 transition-colors ${selectedClient?.id === c.id ? 'bg-blue-50 border-r-4 border-blue-600' : ''}`}>
                                    <div className="font-bold text-slate-800">{c.name}</div>
                                    <div className="text-xs text-slate-500">{c.email}</div>
                                    <div className="text-xs text-slate-400 mt-1">{c.projects?.length || 0} פרויקטים פעילים</div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* פרטי לקוח נבחר */}
                    <div className="col-span-8 flex flex-col gap-6">
                        {isEditing && (
                            <div className="bg-white p-6 rounded-xl shadow-sm border border-blue-200 fade-in">
                                <h4 className="font-bold mb-4">הוספת לקוח חדש</h4>
                                <form onSubmit={handleAddClient} className="grid grid-cols-2 gap-4">
                                    <input name="cName" placeholder="שם הלקוח / חברה" className="p-2 border rounded" required />
                                    <input name="cEmail" placeholder="אימייל" className="p-2 border rounded" required />
                                    <input name="cPhone" placeholder="טלפון" className="p-2 border rounded" />
                                    <div className="col-span-2 flex justify-end gap-2">
                                        <button type="button" onClick={()=>setIsEditing(false)} className="text-slate-500 px-4">ביטול</button>
                                        <button className="bg-blue-600 text-white px-6 py-2 rounded font-bold">שמור לקוח</button>
                                    </div>
                                </form>
                                <div className="mt-2 text-xs text-orange-500"><i className="fa-solid fa-triangle-exclamation"></i> שים לב: יצירת המשתמש מייצרת כרטיס CRM. כדי לאפשר לו להתחבר, יש ליצור לו משתמש ב-Auth.</div>
                            </div>
                        )}

                        {selectedClient ? (
                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex-1 overflow-y-auto fade-in">
                                <div className="flex justify-between items-start mb-6">
                                    <div>
                                        <h2 className="text-2xl font-bold text-slate-800">{selectedClient.name}</h2>
                                        <div className="flex gap-4 text-sm text-slate-500 mt-1">
                                            <span><i className="fa-regular fa-envelope ml-1"></i> {selectedClient.email}</span>
                                            <span><i className="fa-solid fa-phone ml-1"></i> {selectedClient.phone}</span>
                                        </div>
                                    </div>
                                    <div className="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold">פעיל</div>
                                </div>

                                <div className="border-t pt-6">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="font-bold text-lg">פרויקטים ואתרים</h3>
                                        <button onClick={()=>addProject(selectedClient.id, selectedClient)} className="bg-slate-800 text-white text-xs px-3 py-2 rounded hover:bg-slate-700">
                                            <i className="fa-solid fa-plus ml-1"></i> הוסף פרויקט
                                        </button>
                                    </div>
                                    
                                    {(!selectedClient.projects || selectedClient.projects.length === 0) ? (
                                        <div className="text-center py-10 bg-slate-50 rounded border border-dashed text-slate-400">אין פרויקטים משויכים</div>
                                    ) : (
                                        <div className="grid grid-cols-2 gap-4">
                                            {selectedClient.projects.map((p, idx) => (
                                                <div key={idx} className="border p-4 rounded-lg hover:shadow-md transition-shadow bg-slate-50">
                                                    <div className="font-bold text-blue-700 mb-1">{p.name}</div>
                                                    <div className="text-sm text-slate-600"><i className="fa-solid fa-location-dot ml-1"></i> {p.address}</div>
                                                    <div className="mt-3 flex justify-between items-center">
                                                        <span className="text-xs bg-white border px-2 py-1 rounded">ID: {p.projectId}</span>
                                                        <button className="text-slate-400 hover:text-blue-600"><i className="fa-solid fa-arrow-left"></i></button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        ) : (
                            <div className="flex-1 flex items-center justify-center text-slate-400 flex-col">
                                <i className="fa-regular fa-address-book text-4xl mb-2"></i>
                                <p>בחר לקוח לצפייה וניהול</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // --- The "Malshinon" (Audit Log Viewer) ---
        function AuditLogPanel() {
            const [logs, setLogs] = useState([]);

            useEffect(() => {
                const q = query(collection(db, 'audit_logs'), orderBy('timestamp', 'desc'), where('timestamp', '>', new Date(Date.now() - 86400000 * 7))); // Last 7 days
                const unsub = onSnapshot(q, (snap) => {
                    setLogs(snap.docs.map(d => ({id: d.id, ...d.data()})));
                });
                return () => unsub();
            }, []);

            const getIcon = (type) => {
                if(type === 'DANGER') return 'fa-triangle-exclamation text-red-500';
                if(type === 'WARNING') return 'fa-circle-exclamation text-orange-500';
                return 'fa-circle-info text-blue-500';
            };

            return (
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div className="p-4 border-b bg-slate-50">
                        <h3 className="font-bold"><i className="fa-solid fa-eye ml-2"></i>המלשינון - יומן פעילות (7 ימים אחרונים)</h3>
                    </div>
                    <div className="overflow-auto max-h-[calc(100vh-200px)]">
                        <table className="w-full text-sm text-right">
                            <thead className="bg-slate-50 text-slate-500 sticky top-0">
                                <tr>
                                    <th className="p-3">זמן</th>
                                    <th className="p-3">משתמש</th>
                                    <th className="p-3">פעולה</th>
                                    <th className="p-3">פרטים</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {logs.map(log => (
                                    <tr key={log.id} className="hover:bg-slate-50">
                                        <td className="p-3 text-slate-500" dir="ltr">
                                            {log.timestamp ? new Date(log.timestamp.seconds * 1000).toLocaleString('he-IL') : '...'}
                                        </td>
                                        <td className="p-3 font-medium">{log.executorName}</td>
                                        <td className="p-3">
                                            <span className={`px-2 py-1 rounded-full text-xs font-bold ${log.type === 'DANGER' ? 'bg-red-100 text-red-700' : 'bg-blue-50 text-blue-700'}`}>
                                                {log.action}
                                            </span>
                                        </td>
                                        <td className="p-3 text-slate-600 flex items-center gap-2">
                                            <i className={`fa-solid ${getIcon(log.type)}`}></i>
                                            {log.details}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        // --- Catalog Panel (Reusing Logic) ---
        function CatalogPanel({ user }) {
            const [products, setProducts] = useState([]);
            
            useEffect(() => {
                const unsub = onSnapshot(collection(db, 'products'), (snap) => {
                    setProducts(snap.docs.map(d => ({id: d.id, ...d.data()})));
                });
                return () => unsub();
            }, []);

            const updateStock = async (id, current, change) => {
                const newVal = Number(current) + change;
                await updateDoc(doc(db, 'products', id), { stock: newVal });
                logAction(user, 'UPDATE_STOCK', `שינוי מלאי מוצר ${id}: ${change > 0 ? '+' : ''}${change}`);
            };

            return (
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <h3 className="font-bold text-xl mb-4">ניהול קטלוג ומלאי</h3>
                    <div className="overflow-x-auto">
                        <table className="w-full text-right">
                            <thead className="bg-slate-50 text-slate-500 text-xs uppercase">
                                <tr><th>מוצר</th><th>מחיר</th><th>מלאי</th><th>פעולות</th></tr>
                            </thead>
                            <tbody className="divide-y">
                                {products.map(p => (
                                    <tr key={p.id}>
                                        <td className="p-3">
                                            <div className="font-bold text-slate-800">{p.name}</div>
                                            <div className="text-xs text-slate-500">{p.sku}</div>
                                        </td>
                                        <td className="p-3">{p.price} ₪</td>
                                        <td className="p-3">
                                            <span className={`font-bold ${p.stock < 10 ? 'text-red-500' : 'text-green-600'}`}>{p.stock || 0}</span>
                                        </td>
                                        <td className="p-3 flex gap-2">
                                            <button onClick={()=>updateStock(p.id, p.stock||0, 1)} className="bg-green-100 text-green-700 w-8 h-8 rounded hover:bg-green-200">+</button>
                                            <button onClick={()=>updateStock(p.id, p.stock||0, -1)} className="bg-red-100 text-red-700 w-8 h-8 rounded hover:bg-red-200">-</button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        // --- Main App Shell ---
        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('dashboard'); // dashboard, crm, catalog, staff, logs
            const [stats, setStats] = useState({clients: 0, products: 0, revenue: 0});

            useEffect(() => {
                const unsub = onAuthStateChanged(auth, (u) => setUser(u));
                return () => unsub();
            }, []);

            // Fetch stats
            useEffect(() => {
                if(!user) return;
                // Real apps would use aggregation queries or counters
                const unsub1 = onSnapshot(collection(db, 'customers'), s => setStats(prev => ({...prev, clients: s.size})));
                const unsub2 = onSnapshot(collection(db, 'products'), s => setStats(prev => ({...prev, products: s.size})));
                return () => { unsub1(); unsub2(); };
            }, [user]);

            if (!user) return <LoginScreen />;

            const navItems = [
                { id: 'dashboard', icon: 'fa-chart-pie', label: 'דשבורד' },
                { id: 'crm', icon: 'fa-users', label: 'לקוחות ופרויקטים' },
                { id: 'catalog', icon: 'fa-boxes-stacked', label: 'קטלוג מוצרים' },
                { id: 'logs', icon: 'fa-eye', label: 'תיעוד ובקרה' },
            ];

            return (
                <div className="flex h-screen overflow-hidden bg-[#f8f9fa]">
                    {/* Sidebar */}
                    <aside className="w-64 bg-white shadow-xl border-l border-slate-200 flex flex-col z-10">
                        <div className="p-6 border-b border-slate-100">
                            <h1 className="text-2xl font-black text-slate-800 tracking-tight">Saban<span className="text-blue-600">360</span></h1>
                            <div className="text-xs text-slate-400 mt-1">ניהול ארגוני מתקדם</div>
                        </div>
                        
                        <nav className="flex-1 p-4 space-y-2">
                            {navItems.map(item => (
                                <button key={item.id} onClick={() => setView(item.id)} 
                                    className={`nav-item w-full text-right px-4 py-3 rounded-lg flex items-center gap-3 font-medium transition-all ${view === item.id ? 'active shadow-sm' : 'text-slate-500 hover:bg-slate-50'}`}>
                                    <i className={`fa-solid ${item.icon} w-6 text-center`}></i>
                                    {item.label}
                                </button>
                            ))}
                        </nav>

                        <div className="p-4 border-t bg-slate-50">
                            <div className="flex items-center gap-3 mb-3">
                                <div className="w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold text-lg">
                                    {user.email[0].toUpperCase()}
                                </div>
                                <div className="overflow-hidden">
                                    <div className="font-bold text-sm truncate text-slate-800">Admin</div>
                                    <div className="text-xs text-slate-500 truncate">{user.email}</div>
                                </div>
                            </div>
                            <button onClick={() => { logAction(user, 'LOGOUT', 'יציאה מהמערכת'); signOut(auth); }} className="w-full text-red-500 text-sm font-bold hover:bg-red-50 py-2 rounded transition-colors">
                                <i className="fa-solid fa-arrow-right-from-bracket ml-2"></i> התנתק
                            </button>
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-1 overflow-y-auto p-8">
                        <header className="flex justify-between items-center mb-8">
                            <div>
                                <h2 className="text-2xl font-bold text-slate-800">{navItems.find(n => n.id === view)?.label}</h2>
                                <p className="text-slate-500 text-sm">יום {new Date().toLocaleDateString('he-IL', {weekday: 'long', day: 'numeric', month: 'long'})}</p>
                            </div>
                            <div className="flex gap-3">
                                <button className="bg-white p-2 rounded-full shadow-sm text-slate-400 hover:text-blue-600"><i className="fa-solid fa-bell"></i></button>
                                <button className="bg-white p-2 rounded-full shadow-sm text-slate-400 hover:text-blue-600"><i className="fa-solid fa-gear"></i></button>
                            </div>
                        </header>

                        {/* Views Switcher */}
                        <div className="fade-in">
                            {view === 'dashboard' && (
                                <div className="space-y-6">
                                    <div className="grid grid-cols-3 gap-6">
                                        <StatCard title="סה״כ לקוחות" value={stats.clients} icon="fa-users" color="bg-blue-500" trend="+12%" />
                                        <StatCard title="מוצרים בקטלוג" value={stats.products} icon="fa-box-open" color="bg-purple-500" />
                                        <StatCard title="התראות מערכת" value="3" icon="fa-bell" color="bg-orange-500" />
                                    </div>
                                    <div className="grid grid-cols-2 gap-6">
                                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                                            <h3 className="font-bold mb-4 text-slate-700">מגמת פעילות</h3>
                                            <AnalyticsChart />
                                        </div>
                                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                                            <h3 className="font-bold mb-4 text-slate-700">פעולות אחרונות</h3>
                                            <AuditLogPanel />
                                        </div>
                                    </div>
                                </div>
                            )}

                            {view === 'crm' && <CRMPanel user={user} />}
                            {view === 'catalog' && <CatalogPanel user={user} />}
                            {view === 'logs' && <AuditLogPanel />}
                        </div>
                    </main>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
