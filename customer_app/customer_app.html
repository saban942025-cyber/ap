<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>. 住 | 驻专 拽转</title>
    
    <!-- 注转 住驻专转 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Manifest -->
    <link rel="manifest" href='data:application/manifest+json;charset=utf-8,%7B%22name%22%3A%22%D7%97.%20%D7%A1%D7%91%D7%9F%20%D7%97%D7%95%D7%9E%D7%A8%D7%99%20%D7%91%D7%A0%D7%99%D7%99%D7%9F%22%2C%22short_name%22%3A%22%D7%97.%20%D7%A1%D7%91%D7%9F%22%2C%22start_url%22%3A%22%2Fcustomer_app.html%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23f3f4f6%22%2C%22theme_color%22%3A%22%232563eb%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22https%3A%2F%2Fi.postimg.cc%2FryPT3r29%2Fhwrdh.png%22%2C%22sizes%22%3A%22192x192%22%2C%22type%22%3A%22image%2Fpng%22%7D%2C%7B%22src%22%3A%22https%3A%2F%2Fi.postimg.cc%2FryPT3r29%2Fhwrdh.png%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image%2Fpng%22%7D%5D%7D'>
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; background-color: #f0f2f5; overscroll-behavior: none; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        
        /* 爪转 */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        
        /* 拽 驻注转 */
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .recording-pulse { animation: pulse-red 1.5s infinite; background-color: #ef4444 !important; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useRef, useMemo } = React;
        const { createRoot } = ReactDOM;
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, query, orderBy, where, getDoc, addDoc, serverTimestamp, limit, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // *** -URL 砖 住拽专驻 砖 ***
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycby7qKICvRYStFkcDPLtGhGPaNqyYt-G8dZqBJfGm7vpmOG6Kf_n3f29V8oyUW9PjBUj7A/exec";

        const firebaseConfig = {
          apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo", 
          authDomain: "saban94-78949.firebaseapp.com", 
          projectId: "saban94-78949", 
          storageBucket: "saban94-78949.firebasestorage.app", 
          messagingSenderId: "41553157903", 
          appId: "1:41553157903:web:cc33d252cff023be97a87a",
          measurementId: "G-XV6RZDESSB"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Icons ---
        const Icon = ({ name, className, size=24 }) => {
            const icons = {
                MessageSquare: <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>,
                BookOpen: <><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></>,
                User: <><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>,
                LogOut: <><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></>,
                ArrowRight: <><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></>,
                Send: <><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></>,
                Search: <><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></>,
                Bell: <><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></>,
                Check: <polyline points="20 6 9 17 4 12"/>,
                Loader: <><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/></>,
                Plus: <><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></>,
                Mic: <><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></>,
                MapPin: <><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></>,
                Camera: <><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></>,
                FileText: <><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></>,
                X: <><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>,
                StopCircle: <><circle cx="12" cy="12" r="10"/><rect x="9" y="9" width="6" height="6"/></>
            };
            return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{icons[name]}</svg>;
        };

        // --- Toast ---
        function Toast({ message, visible, onHide }) {
            useEffect(() => { if (visible) { const t = setTimeout(onHide, 3000); return () => clearTimeout(t); } }, [visible, onHide]);
            if (!visible) return null;
            return <div className="fixed top-24 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-2xl z-50 flex items-center space-x-3 space-x-reverse animate-fade-in"><Icon name="Loader" className="animate-spin w-5 h-5 text-blue-400" /><span className="font-medium text-sm">{message}</span></div>;
        }

        // --- Mobile Status Bar ---
        function MobileStatusBar() {
            const [time, setTime] = useState(new Date());
            useEffect(() => { const t = setInterval(() => setTime(new Date()), 60000); return () => clearInterval(t); }, []);
            return (
                <div className="bg-gray-900 text-white px-4 py-1 flex justify-between items-center text-xs font-medium select-none">
                    <div className="flex items-center gap-2"><span>{time.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' })}</span></div>
                    <div className="flex items-center gap-2"><div className="w-3 h-3 bg-green-500 rounded-full"></div></div>
                </div>
            );
        }

        // --- Auth Screen ---
        function AuthScreen() {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleLogin = async (e) => {
                e.preventDefault(); setLoading(true); setError('');
                try { await setPersistence(auth, browserLocalPersistence); await signInWithEmailAndPassword(auth, email, password); } 
                catch (err) { setError("驻专 转专转 砖."); }
                setLoading(false);
            };
            return (
                <div className="flex items-center justify-center min-h-screen bg-gray-100 p-4">
                    <div className="w-full max-w-md bg-white p-8 rounded-3xl shadow-xl border border-gray-100 text-center">
                        <div className="w-20 h-20 bg-white rounded-2xl mx-auto flex items-center justify-center shadow-lg mb-4 overflow-hidden border border-gray-100"><img src="https://i.postimg.cc/ryPT3r29/hwrdh.png" className="w-full h-full object-contain p-2" /></div>
                        <h2 className="text-2xl font-bold text-gray-800">. 住 专 </h2>
                        <p className="text-gray-500 text-sm mt-1 mb-6">驻专 转 转拽</p>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <input type="email" placeholder="" value={email} onChange={e=>setEmail(e.target.value)} className="w-full p-3 border rounded-xl" required />
                            <input type="password" placeholder="住住" value={password} onChange={e=>setPassword(e.target.value)} className="w-full p-3 border rounded-xl" required />
                            {error && <p className="text-red-500 text-sm">{error}</p>}
                            <button disabled={loading} className="w-full p-4 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700">{loading ? "转专..." : "住 注专转"}</button>
                        </form>
                    </div>
                </div>
            );
        }

        // --- Chat Room (Google Drive Integration) ---
        function ChatRoom({ project, user, onBack, showToast }) {
            const [messages, setMessages] = useState([]);
            const [text, setText] = useState('');
            const [showMenu, setShowMenu] = useState(false);
            const [isRecording, setIsRecording] = useState(false);
            const [mediaRecorder, setMediaRecorder] = useState(null);
            
            const endRef = useRef(null);
            const fileInputRef = useRef(null);

            //  注转
            useEffect(() => {
                const q = query(collection(db, 'messages'), where('roomId', '==', project.projectId), orderBy('createdAt', 'asc'));
                const unsub = onSnapshot(q, snap => setMessages(snap.docs.map(d => ({id: d.id, ...d.data()}))));
                return () => unsub();
            }, [project.projectId]);

            useEffect(() => endRef.current?.scrollIntoView({ behavior: 'smooth' }), [messages]);

            // --- 注  专 专 Apps Script ---
            const uploadToDrive = async (fileBase64, fileName, mimeType) => {
                try {
                    const res = await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            fileData: fileBase64,
                            fileName: fileName,
                            mimeType: mimeType,
                            customerId: user.uid
                        })
                    });
                    const data = await res.json();
                    if(data.success) return data.url;
                    throw new Error(data.error);
                } catch (e) {
                    console.error("Drive upload failed", e);
                    throw e;
                }
            };

            const convertToBase64 = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = error => reject(error);
                });
            };

            // 砖转 注
            const sendMessage = async (type = 'TEXT', payload = null) => {
                let msg = {
                    roomId: project.projectId, senderId: user.uid, senderName: user.displayName || '拽',
                    type: type, createdAt: serverTimestamp(), replyTo: null
                };
                if (type === 'TEXT') { if (!text.trim()) return; msg.text = text.trim(); setText(''); }
                else if (['IMAGE','FILE','AUDIO'].includes(type)) { 
                    msg.mediaUrl = payload.url; 
                    msg.text = payload.name; // 砖 拽抓
                }
                else if (type === 'LOCATION') { msg.location = payload; msg.text = ' 拽 砖转驻'; }

                await addDoc(collection(db, 'messages'), msg);
                setShowMenu(false);
            };

            // 注转 拽抓
            const handleFileUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                showToast("注 专...");
                
                try {
                    const base64 = await convertToBase64(file);
                    // 注专: 砖砖 -Fetch 住拽专驻 爪 注 转拽 -CORS. 
                    // 砖砖 转 专砖 专 转 住拽专驻 -Web App 爪专转  砖转砖 -Proxy.
                    //   砖转砖 -no-cors 驻转专 ,   拽 URL 专 -client.
                    // 爪专 驻转专 爪 转专 专注,  砖转砖 拽 砖转 (住 专 -> 驻 -> Firebase Storage).
                    
                    // 砖 ,   砖拽抓 ** 注 注 砖转砖:
                    // 砖转砖 驻拽爪 砖 爪  住拽专驻 专 200, 专转 砖转砖 -Firebase .
                    
                    // 专注: 砖砖 -Firebase Storage 专专转  爪 (拽砖转 拽转 驻转专 砖注 )
                    //    住拽专驻 专  爪 砖专转.
                    // 砖转砖  -Firebase Storage   砖转/拽 爪 驻拽爪.
                    
                    // *** 砖砖 -Firebase Storage ( 爪 驻拽爪转 Client) ***
                    /*
                    const fileRef = ref(storage, `chat_files/${project.projectId}/${Date.now()}_${file.name}`);
                    await uploadBytes(fileRef, file);
                    const url = await getDownloadURL(fileRef);
                    */

                    // *** 住 砖砖 住拽专驻 专 (驻 砖拽砖转 注砖) ***
                    //  转 驻驻 (CORS), 砖 砖专 住拽专驻  注砖 住  专转 砖专转 专转.
                    //  爪注 砖 "注专转" (no-cors) 拽 ,  砖砖转砖 -Firebase Storage 砖专 专砖.
                    // 注 爪转:  砖专 转 Firebase Storage 驻转专 驻注 拽 , 
                    //    砖 拽转 URL 转拽 爪 转 爪'  砖专转 转.
                    
                    // --> 专 -Firebase Storage (驻转专 砖注 ) <--
                    const fileRef = ref(storage, `chat_files/${project.projectId}/${Date.now()}_${file.name}`);
                    await uploadBytes(fileRef, file);
                    const url = await getDownloadURL(fileRef);
                    
                    const type = file.type.startsWith('image/') ? 'IMAGE' : 'FILE';
                    await sendMessage(type, { url, name: file.name });
                    showToast("砖 爪!");
                } catch(err) { console.error(err); showToast("砖 注"); }
            };

            // 拽
            const handleLocation = () => {
                if (navigator.geolocation) {
                    showToast("转专 拽...");
                    navigator.geolocation.getCurrentPosition(pos => {
                        sendMessage('LOCATION', { lat: pos.coords.latitude, lon: pos.coords.longitude });
                    });
                }
            };

            // 拽
            const toggleRecording = async () => {
                if (isRecording) {
                    mediaRecorder.stop();
                    setIsRecording(false);
                } else {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        const recorder = new MediaRecorder(stream);
                        const chunks = [];
                        recorder.ondataavailable = e => chunks.push(e.data);
                        recorder.onstop = async () => {
                            const blob = new Blob(chunks, { type: 'audio/webm' });
                            const file = new File([blob], "voice.webm", { type: "audio/webm" });
                            
                            showToast("注 拽...");
                            // 注 -Storage (爪)
                            const fileRef = ref(storage, `chat_audio/${project.projectId}/${Date.now()}.webm`);
                            await uploadBytes(fileRef, file);
                            const url = await getDownloadURL(fileRef);
                            await sendMessage('AUDIO', { url, name: '注 拽转' });
                        };
                        recorder.start();
                        setMediaRecorder(recorder);
                        setIsRecording(true);
                    } catch(err) { showToast(" 砖 拽专驻"); }
                }
            };

            return (
                <div className="flex flex-col h-full bg-[#e5ded8]">
                    <header className="bg-white p-3 flex items-center shadow-sm sticky top-0 z-20">
                        <button onClick={onBack} className="p-2 text-gray-600"><Icon name="ArrowRight" /></button>
                        <img src={project.avatarUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(project.name)}`} className="w-10 h-10 rounded-full object-cover ml-2 mr-1" />
                        <div className="flex-1"><div className="font-bold text-gray-800 text-sm">{project.name}</div></div>
                    </header>
                    
                    <div className="flex-1 overflow-y-auto p-4 space-y-3" style={{backgroundImage: "url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png')"}}>
                        {messages.map(m => (
                            <div key={m.id} className={`flex ${m.senderId === user.uid ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[80%] p-2 rounded-xl text-sm shadow-sm ${m.senderId === user.uid ? 'bg-[#d9fdd3] text-gray-800 rounded-br-none' : 'bg-white text-gray-800 rounded-bl-none'}`}>
                                    {m.type === 'IMAGE' && <img src={m.mediaUrl} className="rounded-lg mb-1 max-w-full" />}
                                    {m.type === 'FILE' && <a href={m.mediaUrl} target="_blank" className="flex items-center gap-2 text-blue-600 underline"><Icon name="FileText" size={16}/> {m.text}</a>}
                                    {m.type === 'LOCATION' && <a href={`https://waze.com/ul?ll=${m.location.lat},${m.location.lon}&navigate=yes`} target="_blank" className="flex items-center gap-2 text-blue-600"><Icon name="MapPin" size={16}/> </a>}
                                    {m.type === 'AUDIO' && <audio controls src={m.mediaUrl} className="w-48 h-8 mt-1" />}
                                    {m.type === 'TEXT' && <div>{m.text}</div>}
                                    <div className="text-[10px] text-gray-400 text-left mt-1">{m.createdAt?.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                                </div>
                            </div>
                        ))}
                        <div ref={endRef} />
                    </div>

                    <div className="p-2 bg-[#f0f2f5] flex items-center gap-2 pb-4 relative">
                        {showMenu && (
                            <div className="absolute bottom-16 right-4 bg-white rounded-xl shadow-xl p-2 flex flex-col gap-2 animate-fade-in z-30">
                                <button onClick={() => fileInputRef.current.click()} className="flex items-center gap-3 p-3 hover:bg-gray-100 rounded-lg text-gray-700"><Icon name="FileText" className="text-purple-500"/> 住/转</button>
                                <button onClick={handleLocation} className="flex items-center gap-3 p-3 hover:bg-gray-100 rounded-lg text-gray-700"><Icon name="MapPin" className="text-red-500"/> 拽</button>
                            </div>
                        )}
                        <input type="file" ref={fileInputRef} onChange={handleFileUpload} className="hidden" />
                        
                        <button onClick={() => setShowMenu(!showMenu)} className="p-2 bg-white rounded-full text-gray-500 shadow-sm"><Icon name={showMenu ? "X" : "Plus"} /></button>
                        <div className="flex-1 bg-white rounded-full flex items-center px-4 shadow-sm">
                            <input className="flex-1 py-3 bg-transparent border-none focus:ring-0 outline-none text-sm" placeholder="注" value={text} onChange={e=>setText(e.target.value)} />
                        </div>
                        {text ? (
                            <button onClick={() => sendMessage('TEXT')} className="p-3 bg-[#00a884] text-white rounded-full shadow-md"><Icon name="Send" size={20} /></button>
                        ) : (
                            <button onClick={toggleRecording} className={`p-3 text-white rounded-full shadow-md ${isRecording ? 'bg-red-500 recording-pulse' : 'bg-[#00a884]'}`}><Icon name={isRecording ? "StopCircle" : "Mic"} size={20} /></button>
                        )}
                    </div>
                </div>
            );
        }

        // --- Knowledge Page (Live Catalog) ---
        function KnowledgePage({ showToast }) {
            const [term, setTerm] = useState('');
            const [products, setProducts] = useState([]);

            // 砖驻  拽拽爪 转转
            useEffect(() => {
                return onSnapshot(collection(db, "products"), snap => setProducts(snap.docs.map(d => ({id: d.id, ...d.data()}))));
            }, []);

            const filtered = products.filter(p => p.name.includes(term) || p.sku?.includes(term));

            return (
                <div className="flex flex-col h-full">
                    <div className="bg-white p-4 shadow-sm sticky top-0 z-10 rounded-b-2xl">
                        <h2 className="text-2xl font-bold text-gray-800 mb-4">拽 爪专</h2>
                        <div className="relative"><input className="w-full p-3 pr-10 bg-gray-100 border-none rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="驻砖..." value={term} onChange={e=>setTerm(e.target.value)} /><div className="absolute top-3 right-3 text-gray-400"><Icon name="Search" /></div></div>
                    </div>
                    <div className="p-4 grid grid-cols-2 gap-4 pb-24 overflow-y-auto">
                        {filtered.length === 0 && <p className="col-span-2 text-center text-gray-500 mt-10"> 爪 爪专 拽.</p>}
                        {filtered.map(p => (
                            <div key={p.id} className="bg-white rounded-2xl shadow-sm overflow-hidden flex flex-col">
                                <div className="h-32 bg-gray-200 relative"><img src={p.image || 'https://via.placeholder.com/150'} className="w-full h-full object-cover" /><span className="absolute bottom-2 right-2 bg-black/70 text-white text-xs px-2 py-1 rounded-md font-bold">{p.price}</span></div>
                                <div className="p-3 flex-1 flex flex-col"><h3 className="font-bold text-gray-800 text-sm mb-1 line-clamp-2">{p.name}</h3><p className="text-xs text-gray-500 mb-3 flex-1">{p.sku}</p><button onClick={() => showToast(`住祝 : ${p.name}`)} className="w-full py-2 bg-blue-50 text-blue-600 rounded-lg text-xs font-bold hover:bg-blue-100">住祝</button></div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        function App() {
            const [user, setUser] = useState(null);
            const [profile, setProfile] = useState(null);
            const [loading, setLoading] = useState(true);
            const [page, setPage] = useState('chats'); 
            const [activeProject, setActiveProject] = useState(null);
            const [toast, setToast] = useState({ visible: false, message: '' });
            const [greeting, setGreeting] = useState('');

            useEffect(() => {
                return onAuthStateChanged(auth, async (u) => {
                    if (u) {
                        const snap = await getDoc(doc(db, 'customers', u.uid));
                        if (snap.exists()) {
                            setUser(u); setProfile({uid: u.uid, ...snap.data()});
                            const h = new Date().getHours();
                            setGreeting(h < 12 ? "拽专 " : h < 18 ? "爪专 " : "注专 ");
                        } else { signOut(auth); }
                    } else { setUser(null); setProfile(null); }
                    setLoading(false);
                });
            }, []);

            if (loading) return <div className="flex h-screen items-center justify-center text-blue-600 font-bold">注 Sidor...</div>;
            if (!user) return <AuthScreen />;

            return (
                <div className="flex flex-col h-screen bg-gray-100 max-w-md mx-auto shadow-2xl overflow-hidden border-x border-gray-200 relative">
                    <MobileStatusBar isConnected={true} />
                    <Toast message={toast.message} visible={toast.visible} onHide={() => setToast({ ...toast, visible: false })} />
                    
                    {activeProject ? (
                        <ChatRoom project={activeProject} user={user} onBack={() => setActiveProject(null)} showToast={(msg) => setToast({visible: true, message: msg})} />
                    ) : (
                        <>
                            <div className="flex-1 overflow-y-auto pb-20 scrollbar-hide">
                                {page === 'chats' && (
                                    <>
                                        <div className="bg-white p-6 pb-8 rounded-b-3xl shadow-sm mb-4">
                                            <h1 className="text-2xl font-bold text-gray-800">{greeting}, {profile?.name?.split(' ')[0]}</h1>
                                            <p className="text-gray-500 text-sm mt-1">祝 专转 转 砖 </p>
                                        </div>
                                        <div className="px-4">
                                            {(profile?.projects || []).map(p => (
                                                <div key={p.projectId} onClick={() => setActiveProject(p)} className="flex items-center p-4 bg-white rounded-2xl shadow-sm cursor-pointer mb-3">
                                                    <img src={p.avatarUrl || `https://ui-avatars.com/api/?name=${p.name}`} className="w-14 h-14 rounded-full object-cover ml-3" />
                                                    <div><h3 className="font-bold text-gray-800">{p.name}</h3><p className="text-sm text-gray-500">{p.address}</p></div>
                                                </div>
                                            ))}
                                        </div>
                                    </>
                                )}
                                {page === 'knowledge' && <KnowledgePage showToast={(msg) => setToast({visible: true, message: msg})} />}
                                {page === 'profile' && <div className="p-6 text-center"><h2 className="text-2xl font-bold">{profile.name}</h2><button onClick={()=>signOut(auth)} className="text-red-500 mt-4 flex items-center justify-center gap-2 w-full p-4 bg-red-50 rounded-xl"><Icon name="LogOut"/> 转转拽</button></div>}
                            </div>
                            <nav className="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t border-gray-200 flex justify-around p-2 pb-5 text-gray-400 z-20 max-w-md mx-auto shadow-lg">
                                <button onClick={()=>setPage('chats')} className={page==='chats'?'text-blue-600 scale-110':''}><Icon name="MessageSquare" className="mb-1"/><span className="text-[10px]">砖转</span></button>
                                <button onClick={()=>setPage('knowledge')} className={page==='knowledge'?'text-blue-600 scale-110':''}><Icon name="BookOpen" className="mb-1"/><span className="text-[10px]">拽</span></button>
                                <button onClick={()=>setPage('profile')} className={page==='profile'?'text-blue-600 scale-110':''}><Icon name="User" className="mb-1"/><span className="text-[10px]">驻专驻</span></button>
                            </nav>
                        </>
                    )}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
