<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saban 360 | מערכת ניהול הזמנות וקטלוג</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8fafc; font-family: 'Segoe UI', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .nav-item.active { background: #e0f2fe; color: #0369a1; border-right: 4px solid #0369a1; font-weight: bold; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect } = React;
        const { createRoot } = ReactDOM;

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, updateDoc, setDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo", 
          authDomain: "saban94-78949.firebaseapp.com", 
          projectId: "saban94-78949", 
          storageBucket: "saban94-78949.firebasestorage.app", 
          messagingSenderId: "41553157903", 
          appId: "1:41553157903:web:cc33d252cff023be97a87a"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Orders Panel (מותאם למבנה ששלחת) ---
        function OrdersPanel() {
            const [orders, setOrders] = useState([]);
            // הנחה: שם האוסף הוא 'orders' או 'shopping_carts'. נסה לשנות כאן אם לא עובד.
            // לפי הלוגיקה שלך זה כנראה 'orders'
            const COLLECTION_NAME = 'orders'; 

            useEffect(() => {
                const q = query(collection(db, COLLECTION_NAME), orderBy('timestamp', 'desc'));
                const unsub = onSnapshot(q, (snap) => {
                    setOrders(snap.docs.map(d => ({id: d.id, ...d.data()})));
                });
                return () => unsub();
            }, []);

            const updateStatus = async (id, newStatus) => {
                await updateDoc(doc(db, COLLECTION_NAME, id), { status: newStatus });
            };

            return (
                <div className="space-y-4 fade-in">
                    <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex justify-between items-center">
                        <h2 className="text-xl font-bold text-slate-800">ניהול הזמנות ({orders.length})</h2>
                    </div>

                    <div className="grid gap-4">
                        {orders.map(order => (
                            <div key={order.id} className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 hover:shadow-md transition-all">
                                <div className="flex justify-between items-start border-b pb-3 mb-3">
                                    <div>
                                        <div className="flex items-center gap-2">
                                            <span className="font-bold text-lg text-blue-700">#{order.final_order_id?.slice(-6) || order.id.slice(0,6)}</span>
                                            <span className={`text-xs px-2 py-1 rounded-full font-bold ${order.status === 'approved' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}`}>
                                                {order.status === 'approved' ? 'מאושר' : order.status}
                                            </span>
                                        </div>
                                        <div className="text-sm text-slate-500 mt-1">
                                            <i className="fa-regular fa-clock ml-1"></i>
                                            {order.timestamp?.seconds ? new Date(order.timestamp.seconds * 1000).toLocaleString('he-IL') : 'תאריך חסר'}
                                        </div>
                                    </div>
                                    <div className="text-left">
                                        <div className="font-bold text-slate-700">{order.project_name}</div>
                                        <div className="text-xs text-slate-500">{order.submitter_name} | {order.location_address}</div>
                                    </div>
                                </div>

                                {/* רשימת המוצרים מתוך cart_items */}
                                <div className="bg-slate-50 rounded-lg p-3">
                                    <h4 className="text-xs font-bold text-slate-500 mb-2">פריטים בהזמנה:</h4>
                                    <div className="space-y-2">
                                        {order.cart_items && Array.isArray(order.cart_items) ? order.cart_items.map((item, idx) => (
                                            <div key={idx} className="flex items-center justify-between text-sm bg-white p-2 rounded border border-slate-100">
                                                <div className="flex items-center gap-2">
                                                    <img src={item.image} className="w-8 h-8 rounded object-cover border" />
                                                    <span className="font-medium">{item.name}</span>
                                                    <span className="text-xs text-slate-400 font-mono">({item.sku})</span>
                                                </div>
                                                <div className="font-bold bg-blue-50 text-blue-600 px-2 py-1 rounded">x{item.quantity}</div>
                                            </div>
                                        )) : <div className="text-red-500 text-xs">פורמט סל לא תקין</div>}
                                    </div>
                                </div>

                                <div className="mt-3 flex justify-end gap-2">
                                    {order.status !== 'approved' && (
                                        <button onClick={()=>updateStatus(order.id, 'approved')} className="bg-green-600 text-white px-4 py-1.5 rounded-lg text-sm font-bold hover:bg-green-700">
                                            <i className="fa-solid fa-check ml-1"></i> אשר הזמנה
                                        </button>
                                    )}
                                    <button className="bg-slate-100 text-slate-600 px-3 py-1.5 rounded-lg text-sm font-bold hover:bg-slate-200">
                                        <i className="fa-solid fa-print ml-1"></i> הדפס
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        // --- Catalog Panel עם כפתור הקסם ---
        function CatalogPanel() {
            const [products, setProducts] = useState([]);
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                // קורא מהאוסף 'products'
                const unsub = onSnapshot(collection(db, 'products'), (snap) => {
                    setProducts(snap.docs.map(d => ({id: d.id, ...d.data()})));
                });
                return () => unsub();
            }, []);

            // --- פונקציית הקסם: חילוץ מוצרים מהזמנות ---
            const importFromOrders = async () => {
                if(!confirm("פעולה זו תסרוק את כל ההזמנות ותייצר קטלוג מוצרים מהפריטים שנמצאו. להמשיך?")) return;
                setLoading(true);
                try {
                    // 1. שליפת כל ההזמנות
                    const ordersSnap = await getDocs(collection(db, 'orders')); // וודא ששם האוסף הוא orders
                    const extractedProducts = {};

                    // 2. מעבר על כל הזמנה וכל פריט
                    ordersSnap.forEach(doc => {
                        const order = doc.data();
                        if (order.cart_items && Array.isArray(order.cart_items)) {
                            order.cart_items.forEach(item => {
                                if (item.sku) {
                                    // שמירה במילון למניעת כפילויות (האחרון קובע)
                                    extractedProducts[item.sku] = {
                                        sku: item.sku,
                                        name: item.name,
                                        image: item.image,
                                        price: item.price || 0, // אם אין מחיר בהזמנה, יהיה 0
                                        stock: 100 // ברירת מחדל
                                    };
                                }
                            });
                        }
                    });

                    // 3. שמירה לאוסף products
                    const promises = Object.values(extractedProducts).map(p => 
                        setDoc(doc(db, 'products', p.sku), p) // משתמש במק"ט כמזהה המסמך
                    );

                    await Promise.all(promises);
                    alert(`התהליך הסתיים! שוחזרו ${promises.length} מוצרים לקטלוג.`);

                } catch (e) {
                    alert("שגיאה: " + e.message);
                    console.error(e);
                }
                setLoading(false);
            };

            return (
                <div className="space-y-4 fade-in">
                    <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex justify-between items-center">
                        <h3 className="text-xl font-bold text-slate-800">קטלוג מוצרים ({products.length})</h3>
                        <button onClick={importFromOrders} disabled={loading} className="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-purple-700 shadow-lg flex items-center gap-2">
                            {loading ? <i className="fa-solid fa-spinner fa-spin"></i> : <i className="fa-solid fa-wand-magic-sparkles"></i>}
                            שחזר מוצרים מהזמנות
                        </button>
                    </div>

                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <table className="w-full text-right text-sm">
                            <thead className="bg-slate-50 text-slate-500"><tr><th className="p-3">תמונה</th><th className="p-3">מק"ט</th><th className="p-3">שם</th><th className="p-3">מלאי</th></tr></thead>
                            <tbody>
                                {products.map(p => (
                                    <tr key={p.id} className="border-b hover:bg-slate-50">
                                        <td className="p-2"><img src={p.image} className="w-10 h-10 rounded border bg-white object-cover"/></td>
                                        <td className="p-3 font-mono">{p.sku}</td>
                                        <td className="p-3 font-bold">{p.name}</td>
                                        <td className="p-3">{p.stock}</td>
                                    </tr>
                                ))}
                                {products.length === 0 && <tr><td colSpan="4" className="p-8 text-center text-slate-400">הקטלוג ריק. לחץ על הכפתור הסגול למעלה כדי לייבא מוצרים מההזמנות הקיימות.</td></tr>}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        // --- App Shell ---
        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('orders'); // ברירת מחדל: הזמנות
            const [login, setLogin] = useState({email:'', pass:''});

            useEffect(() => onAuthStateChanged(auth, setUser), []);

            const doLogin = (e) => {
                e.preventDefault();
                signInWithEmailAndPassword(auth, login.email.includes('@')?login.email:login.email+'@saban.com', login.pass)
                .catch(()=>alert("שגיאה בהתחברות"));
            };

            if (!user) return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <form onSubmit={doLogin} className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md text-center space-y-4">
                        <h1 className="text-2xl font-black text-blue-900">Saban 360</h1>
                        <input className="w-full p-3 border rounded" placeholder="אימייל" onChange={e=>setLogin({...login, email:e.target.value})} />
                        <input type="password" className="w-full p-3 border rounded" placeholder="סיסמה" onChange={e=>setLogin({...login, pass:e.target.value})} />
                        <button className="w-full bg-blue-900 text-white py-3 rounded font-bold">כניסה</button>
                    </form>
                </div>
            );

            return (
                <div className="flex h-screen overflow-hidden">
                    <aside className="w-64 bg-white border-l flex flex-col shadow-xl z-10">
                        <div className="p-6 border-b text-center"><h1 className="text-2xl font-black text-slate-800">Saban<span className="text-blue-600">360</span></h1></div>
                        <nav className="flex-1 p-4 space-y-2">
                            <button onClick={()=>setView('orders')} className={`nav-item w-full text-right px-4 py-3 rounded flex gap-3 ${view==='orders'?'active':'text-slate-500'}`}><i className="fa-solid fa-cart-shopping w-6"></i> הזמנות</button>
                            <button onClick={()=>setView('catalog')} className={`nav-item w-full text-right px-4 py-3 rounded flex gap-3 ${view==='catalog'?'active':'text-slate-500'}`}><i className="fa-solid fa-box-open w-6"></i> קטלוג</button>
                        </nav>
                        <div className="p-4 border-t text-center">
                            <div className="text-xs font-bold mb-2">{user.email}</div>
                            <button onClick={()=>signOut(auth)} className="text-red-500 font-bold text-sm">יציאה</button>
                        </div>
                    </aside>
                    <main className="flex-1 overflow-y-auto p-8 bg-slate-50">
                        {view === 'orders' && <OrdersPanel />}
                        {view === 'catalog' && <CatalogPanel />}
                    </main>
                </div>
            );
        }

        createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
