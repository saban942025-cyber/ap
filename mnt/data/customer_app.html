<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>×—. ×¡×‘×Ÿ | ×¤×•×¨×˜×œ ×œ×§×•×—×•×ª</title>
    <link rel="manifest" href="manifest.json">
    
    <!-- OneSignal -->
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        try {
            await OneSignal.init({
              appId: "de3834d3-1e11-40af-96d2-b25eda821c8f",
              safari_web_id: "web.onesignal.auto.00000000-0000-0000-0000-000000000000",
              notifyButton: { enable: false },
              allowLocalhostAsSecureOrigin: true 
            });
        } catch (e) { console.warn("Push Init Warn:", e); }
      });
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #e5ded8; overscroll-behavior: none; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .hit-area { min-height: 44px; min-width: 44px; display: flex; align-items: center; justify-content: center; cursor: pointer; user-select: none; -webkit-tap-highlight-color: transparent; }
        .wa-bg { background-color: #e5ded8; background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png"); background-repeat: repeat; background-attachment: fixed; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.2s ease-out forwards; }
        @keyframes pop { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .animate-pop { animation: pop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    </style>
</head>
<body>
    <div id="root"></div>
    <audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3" preload="auto"></audio>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useRef } = React;
        const { createRoot } = ReactDOM;
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, query, orderBy, where, getDoc, addDoc, serverTimestamp, limit, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        
        const firebaseConfig = {
          apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo", 
          authDomain: "saban94-78949.firebaseapp.com", 
          projectId: "saban94-78949", 
          storageBucket: "saban94-78949.firebasestorage.app", 
          messagingSenderId: "41553157903", 
          appId: "1:41553157903:web:cc33d252cff023be97a87a"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Icons ---
        const Icon = ({ name, className, size=24 }) => {
            const icons = {
                ArrowRight: <><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></>,
                Send: <><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></>,
                Plus: <><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></>,
                Camera: <><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></>,
                Image: <><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></>,
                MapPin: <><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></>,
                File: <><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></>,
                ShoppingCart: <><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></>,
                X: <><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>,
                Check: <polyline points="20 6 9 17 4 12"/>,
                CheckAll: <><polyline points="20 6 9 17 4 12"/><polyline points="20 12 9 23 4 18"/></>,
                Mic: <><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></>
            };
            return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{icons[name]}</svg>;
        };

        const PRODUCTS = [
            { id: 1, name: '×œ×•×— ×’×‘×¡', price: '38 â‚ª', desc: '×œ×•×— ×’×‘×¡ ××™×›×•×ª×™ ×œ×‘× ×™×™×” 120x240', img: 'https://placehold.co/300?text=Gevs' },
            { id: 2, name: '××¡×œ×•×œ 70', price: '16 â‚ª', desc: '××¡×œ×•×œ ××ª×›×ª ××’×•×œ×•×•×Ÿ', img: 'https://placehold.co/300?text=Maslul' },
            { id: 3, name: '×©×¤×›×˜×œ ×××¨×™×§××™', price: '65 â‚ª', desc: '×¤×— 28 ×§"×’', img: 'https://placehold.co/300?text=Putty' },
            { id: 4, name: '×¦×‘×¢ ××§×¨×™×œ×™', price: '120 â‚ª', desc: '×“×œ×™ 18 ×œ×™×˜×¨', img: 'https://placehold.co/300?text=Paint' },
        ];

        function AuthScreen() {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const handleLogin = async (e) => {
                e.preventDefault();
                try { await setPersistence(auth, browserLocalPersistence); await signInWithEmailAndPassword(auth, email, password); } catch (err) { alert("×©×’×™××”"); }
            };
            return (
                <div className="flex flex-col items-center justify-center min-h-screen bg-[#111b21] text-white p-6">
                    <h2 className="text-2xl font-light mb-8">×—. ×¡×‘×Ÿ | ×”×ª×—×‘×¨×•×ª</h2>
                    <form onSubmit={handleLogin} className="w-full max-w-sm space-y-4">
                        <input type="email" placeholder="××™××™×™×œ" value={email} onChange={e=>setEmail(e.target.value)} className="w-full p-4 bg-[#202c33] border border-[#2a3942] rounded-lg text-white" />
                        <input type="password" placeholder="×¡×™×¡××”" value={password} onChange={e=>setPassword(e.target.value)} className="w-full p-4 bg-[#202c33] border border-[#2a3942] rounded-lg text-white" />
                        <button className="w-full p-4 bg-[#00a884] text-black font-bold rounded-lg hit-area">×”×ª×—×‘×¨</button>
                    </form>
                </div>
            );
        }

        function ProductModal({ product, onClose, onSend }) {
            const [qty, setQty] = useState(1);
            if (!product) return null;
            return (
                <div className="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4 animate-pop">
                    <div className="bg-white rounded-xl w-full max-w-sm overflow-hidden shadow-2xl">
                        <div className="h-48 bg-gray-200 relative">
                            <img src={product.img} className="w-full h-full object-cover" />
                            <button onClick={onClose} className="absolute top-2 right-2 bg-white/80 rounded-full p-2 hit-area"><Icon name="X" /></button>
                        </div>
                        <div className="p-4">
                            <h3 className="text-xl font-bold text-gray-800">{product.name}</h3>
                            <p className="text-blue-600 text-lg font-bold">{product.price}</p>
                            <p className="text-gray-500 text-sm mt-2">{product.desc}</p>
                            <div className="flex items-center justify-center gap-4 my-6 bg-gray-100 rounded-lg p-2">
                                <button onClick={()=>setQty(Math.max(1,qty-1))} className="hit-area w-8 h-8 bg-white rounded shadow">-</button>
                                <span className="text-xl font-bold">{qty}</span>
                                <button onClick={()=>setQty(qty+1)} className="hit-area w-8 h-8 bg-white rounded shadow">+</button>
                            </div>
                            <button onClick={() => onSend({items:[{...product, qty}], total:qty})} className="w-full bg-[#00a884] text-white py-3 rounded-lg font-bold shadow-lg hit-area">×©×œ×— ×”×–×× ×”</button>
                        </div>
                    </div>
                </div>
            );
        }

        function ChatRoom({ project, user, onBack }) {
            const [messages, setMessages] = useState([]);
            const [text, setText] = useState('');
            const [showMenu, setShowMenu] = useState(false);
            const [modalProduct, setModalProduct] = useState(null);
            const endRef = useRef(null);
            const fileInputRef = useRef(null);

            // *** NEW: Profile Logic ***
            // ×™×¦×™×¨×ª Avatar URL ×× ×œ× ×§×™×™×
            const userAvatar = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || 'Customer')}&background=random`;

            useEffect(() => {
                if (!project?.projectId) return;

                // *** UPDATE: ×©×•××¨ ×’× avatarUrl ×‘-presence ***
                const userRef = doc(db, 'customers', user.uid);
                updateDoc(userRef, { 
                    isOnline: true, 
                    lastSeen: serverTimestamp(),
                    avatarUrl: userAvatar // ×¢×“×›×•×Ÿ ×ª××•× ×”
                }).catch(console.error);
                
                window.addEventListener('beforeunload', () => updateDoc(userRef, { isOnline: false }));

                const q = query(collection(db, 'messages'), where('roomId', '==', project.projectId), orderBy('createdAt', 'asc'));
                return onSnapshot(q, (snap) => {
                    const msgs = snap.docs.map(d => {
                        const m = d.data();
                        if(m.readByWorker) m.status = 'read';
                        return {id: d.id, ...m};
                    });
                    setMessages(msgs);
                    
                    const last = msgs[msgs.length-1];
                    if(last && last.senderId !== user.uid) {
                        const audio = document.getElementById('notif-sound');
                        if(audio) audio.play().catch(()=>{});
                    }
                }, (error) => {
                    console.error("Firestore Error (Check Console for Index Link):", error);
                    if(error.code === 'failed-precondition') {
                        alert("×—×¡×¨ ××™× ×“×§×¡ ×‘-Firebase. ×‘×“×•×§ ××ª ×”×§×•× ×¡×•×œ ×œ×™×¦×™×¨×” ××•×˜×•××˜×™×ª.");
                    }
                });
            }, [project?.projectId]);

            useEffect(() => endRef.current?.scrollIntoView({ behavior: 'auto' }), [messages]);

            const handleSend = async (type, payload) => {
                if (!project?.projectId) return alert("×©×’×™××”: ××™×Ÿ ×¤×¨×•×™×§×˜ ××©×•×™×š");

                // *** UPDATE: ×©×œ×™×—×ª ×¤×¨×˜×™ ×©×•×œ×— ××œ××™× ***
                let msg = {
                    roomId: project.projectId, 
                    senderId: user.uid, 
                    senderName: user.displayName || '×œ×§×•×—',
                    senderAvatar: userAvatar, // ×”×•×¡×¤×ª ×ª××•× ×”
                    type, 
                    createdAt: serverTimestamp(), 
                    readByWorker: false, 
                    status: 'sent'
                };
                
                if(type === 'TEXT') { msg.text = text; setText(''); }
                else if(type === 'ORDER') { msg.text = 'ğŸ›’ ×”×–×× ×”'; msg.orderPayload = payload; msg.orderStatus = 'new'; }
                else if(type === 'IMAGE') { msg.text = 'ğŸ“· ×ª××•× ×”'; msg.mediaUrl = payload; }
                else if(type === 'LOCATION') { msg.text = 'ğŸ“ ××™×§×•×'; msg.location = payload; }

                setShowMenu(false);
                setModalProduct(null);

                try {
                    await addDoc(collection(db, 'messages'), msg);
                } catch (e) {
                    console.error("Send Error:", e);
                    alert("×©×’×™××” ×‘×©×œ×™×—×”");
                }
            };

            const handleFile = (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => handleSend('IMAGE', ev.target.result); // Demo: Base64
                reader.readAsDataURL(file);
            };

            const handleLocation = () => {
                if(navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(pos => {
                        handleSend('LOCATION', {lat: pos.coords.latitude, lon: pos.coords.longitude});
                    });
                }
            };

            return (
                <div className="flex flex-col h-full wa-bg page-enter relative">
                    <div className="bg-[#008069] p-2 flex items-center text-white shadow-md sticky top-0 z-20">
                        <button onClick={onBack} className="p-2 mr-1 hit-area"><Icon name="ArrowRight" /></button>
                        <div className="font-bold">{project.name}</div>
                    </div>

                    <div className="flex-1 overflow-y-auto p-3 space-y-2 pb-24">
                        {messages.map(m => {
                            const isMe = m.senderId === user.uid;
                            return (
                                <div key={m.id} className={`flex ${isMe ? 'justify-end' : 'justify-start'} msg-pop`}>
                                    <div className={`max-w-[80%] p-2 rounded-lg shadow-sm text-sm ${isMe ? 'bg-[#d9fdd3]' : 'bg-white'}`}>
                                        {m.type === 'ORDER' && <div className="font-bold text-green-700">ğŸ›’ ×”×–×× ×”: {m.orderPayload.total} ×¤×¨×™×˜×™×</div>}
                                        {m.type === 'IMAGE' && <img src={m.mediaUrl} className="rounded max-h-48"/>}
                                        {m.type === 'LOCATION' && <div className="text-blue-600 flex gap-1 items-center"><Icon name="MapPin" size={16}/> ××™×§×•× ×©×™×ª×•×¤×™</div>}
                                        {m.text && <div className="mt-1">{m.text}</div>}
                                        
                                        <div className="text-[9px] text-gray-500 flex justify-end gap-1 mt-1">
                                            {m.createdAt?.toDate ? m.createdAt.toDate().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : '...'}
                                            {isMe && (
                                                <span className={m.status==='read' ? 'text-blue-500' : 'text-gray-400'}>
                                                    {m.status === 'read' ? <Icon name="CheckAll" size={14}/> : <Icon name="Check" size={14}/>}
                                                </span>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                        <div ref={endRef} />
                    </div>

                    {/* Attachments Menu */}
                    {showMenu && (
                        <div className="absolute bottom-16 left-4 bg-white rounded-xl shadow-xl p-4 grid grid-cols-3 gap-4 z-30 animate-pop">
                            <button onClick={()=>fileInputRef.current.click()} className="flex flex-col items-center gap-1 text-purple-600 hit-area"><div className="p-3 bg-purple-100 rounded-full"><Icon name="Image"/></div><span className="text-xs">×’×œ×¨×™×”</span></button>
                            <button onClick={()=>fileInputRef.current.click()} className="flex flex-col items-center gap-1 text-pink-600 hit-area"><div className="p-3 bg-pink-100 rounded-full"><Icon name="Camera"/></div><span className="text-xs">××¦×œ××”</span></button>
                            <button onClick={handleLocation} className="flex flex-col items-center gap-1 text-green-600 hit-area"><div className="p-3 bg-green-100 rounded-full"><Icon name="MapPin"/></div><span className="text-xs">××™×§×•×</span></button>
                            {PRODUCTS.map(p => (
                                <button key={p.id} onClick={()=>setModalProduct(p)} className="flex flex-col items-center gap-1 text-blue-600 hit-area">
                                    <div className="p-3 bg-blue-100 rounded-full"><Icon name="ShoppingCart"/></div>
                                    <span className="text-xs truncate w-16">{p.name}</span>
                                </button>
                            ))}
                        </div>
                    )}

                    {/* Input */}
                    <div className="fixed bottom-0 left-0 right-0 bg-[#f0f2f5] p-2 flex items-center gap-2 z-20">
                        <button onClick={()=>setShowMenu(!showMenu)} className={`p-2 rounded-full hit-area transition ${showMenu?'rotate-45 bg-gray-300':''}`}><Icon name="Plus"/></button>
                        <input type="file" ref={fileInputRef} accept="image/*" className="hidden" onChange={handleFile}/>
                        <div className="flex-1 bg-white rounded-full px-4 py-2 shadow-sm">
                            <input className="w-full bg-transparent outline-none text-sm h-6" placeholder="×”×•×“×¢×”" value={text} onChange={e=>setText(e.target.value)} onKeyDown={e=>e.key==='Enter'&&handleSend('TEXT')}/>
                        </div>
                        <button onClick={()=>handleSend('TEXT')} className="p-3 bg-[#00a884] text-white rounded-full shadow hit-area"><Icon name="Send"/></button>
                    </div>

                    <ProductModal product={modalProduct} onClose={()=>setModalProduct(null)} onSend={(payload)=>handleSend('ORDER', payload)} />
                </div>
            );
        }

        function App() {
            const [user, setUser] = useState(null);
            const [project, setProject] = useState(null);

            useEffect(() => onAuthStateChanged(auth, async u => {
                if(u) {
                    if(window.OneSignalDeferred) window.OneSignalDeferred.push(OS => OS.login(u.uid));
                    const snap = await getDoc(doc(db, 'customers', u.uid));
                    if(snap.exists()) {
                        const data = snap.data();
                        setProject(data.projects?.[0]);
                        // ×¢×“×›×•×Ÿ ××• ×™×¦×™×¨×” ×©×œ avatar ×‘-Customer Doc
                        if(!data.avatarUrl) {
                             const avatarUrl = u.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(u.displayName || 'User')}&background=random`;
                             updateDoc(doc(db, 'customers', u.uid), { avatarUrl });
                        }
                    }
                    setUser(u);
                } else setUser(null);
            }), []);

            if (!user) return <AuthScreen />;
            if (project) return <ChatRoom project={project} user={user} onBack={()=>{}} />;
            return <div className="p-10 text-center">×˜×•×¢×Ÿ ×¤×¨×•×™×§×˜×™×... (×•×“× ×©×™×© ×¤×¨×•×™×§×˜ ×‘-Firestore)</div>;
        }

        createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
