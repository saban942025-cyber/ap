<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>. 住 | 转 爪'</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { font-family: 'Heebo', sans-serif; background-color: #f0f2f5; overflow: hidden; touch-action: manipulation; }
        .scroll-hide::-webkit-scrollbar { display: none; }
        .wa-bg { background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png"); background-repeat: repeat; background-attachment: fixed; }
        .slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div id="root"></div>
    <audio id="msg-sound" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3" preload="auto"></audio>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useRef } = React;
        const { createRoot } = ReactDOM;
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, query, orderBy, where, addDoc, serverTimestamp, updateDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo", 
          authDomain: "saban94-78949.firebaseapp.com", 
          projectId: "saban94-78949", 
          storageBucket: "saban94-78949.firebasestorage.app", 
          messagingSenderId: "41553157903", 
          appId: "1:41553157903:web:cc33d252cff023be97a87a"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- 砖专 专砖 ---
        const Dashboard = ({ user, profile, onNavigate }) => {
            const [lastOrder, setLastOrder] = useState(null);
            
            useEffect(() => {
                //   转  专 ()
                setLastOrder({ id: '1234', status: '驻', date: ', 10:30', items: '拽 20, ' });
            }, []);

            return (
                <div className="flex flex-col h-full bg-gray-50 fade-in">
                    {/* Header */}
                    <div className="bg-[#008069] p-6 pt-12 text-white rounded-b-3xl shadow-lg relative overflow-hidden">
                        <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-10 -mt-10 blur-2xl"></div>
                        <div className="flex justify-between items-start relative z-10">
                            <div>
                                <h1 className="text-2xl font-bold">砖, {profile?.name || '拽 拽专'}</h1>
                                <p className="text-green-100 text-sm">专  驻专 住</p>
                            </div>
                            <div className="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center text-xl font-bold border-2 border-white/30">
                                {profile?.name?.[0] || 'S'}
                            </div>
                        </div>
                        
                        {/* 住住  专 */}
                        <div className="mt-6 bg-white/10 backdrop-blur-md border border-white/20 p-4 rounded-xl flex justify-between items-center">
                            <div>
                                <p className="text-xs text-green-100 mb-1"> 专 #{lastOrder?.id}</p>
                                <div className="font-bold text-lg">{lastOrder?.status}</div>
                            </div>
                            <div className="h-10 w-10 bg-white text-[#008069] rounded-full flex items-center justify-center shadow-lg">
                                <i data-lucide="truck" width="20"></i>
                            </div>
                        </div>
                    </div>

                    {/* 驻注转 专转 */}
                    <div className="p-6 grid grid-cols-2 gap-4 -mt-4 relative z-20">
                        <button onClick={()=>onNavigate('catalog')} className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center gap-2 active:scale-95 transition">
                            <div className="bg-blue-50 p-3 rounded-full text-blue-600"><i data-lucide="shopping-bag"></i></div>
                            <span className="font-bold text-gray-700"> 砖</span>
                        </button>
                        <button onClick={()=>onNavigate('chat')} className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center gap-2 active:scale-95 transition">
                            <div className="bg-green-50 p-3 rounded-full text-green-600"><i data-lucide="message-circle"></i></div>
                            <span className="font-bold text-gray-700">爪' 注 爪</span>
                        </button>
                        <button onClick={()=>onNavigate('projects')} className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center gap-2 active:scale-95 transition">
                            <div className="bg-purple-50 p-3 rounded-full text-purple-600"><i data-lucide="briefcase"></i></div>
                            <span className="font-bold text-gray-700">驻专拽 砖</span>
                        </button>
                        <button className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center gap-2 active:scale-95 transition">
                            <div className="bg-orange-50 p-3 rounded-full text-orange-600"><i data-lucide="file-text"></i></div>
                            <span className="font-bold text-gray-700">砖转</span>
                        </button>
                    </div>

                    {/* 注 专 */}
                    <div className="px-6 flex-1 overflow-y-auto">
                        <h3 className="font-bold text-gray-800 mb-3">注 专</h3>
                        <div className="space-y-3 pb-20">
                            <div className="bg-white p-3 rounded-xl flex items-center gap-3 border border-gray-100">
                                <div className="bg-gray-100 p-2 rounded-lg text-gray-500"><i data-lucide="info"></i></div>
                                <div>
                                    <div className="text-sm font-bold">爪注 注 爪注</div>
                                    <div className="text-xs text-gray-500"> 拽 专 -15% </div>
                                </div>
                            </div>
                            <div className="bg-white p-3 rounded-xl flex items-center gap-3 border border-gray-100">
                                <div className="bg-blue-100 p-2 rounded-lg text-blue-600"><i data-lucide="check"></i></div>
                                <div>
                                    <div className="text-sm font-bold"> #1230 住驻拽</div>
                                    <div className="text-xs text-gray-500">转, 14:00</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 拽  ---
        const Catalog = ({ onBack, onSendOrder }) => {
            const [cart, setCart] = useState([]);
            const products = [
                { id: 1, name: "拽 20 (砖)", price: 320, img: "https://placehold.co/100?text=Block" },
                { id: 2, name: " 砖专 (砖拽)", price: 28, img: "https://placehold.co/100?text=Cement" },
                { id: 3, name: "  ()", price: 150, img: "https://placehold.co/100?text=Tit" },
                { id: 4, name: "  ()", price: 140, img: "https://placehold.co/100?text=Sand" },
            ];

            const addToCart = (p) => setCart(prev => [...prev, p]);

            return (
                <div className="flex flex-col h-full bg-white slide-up fixed inset-0 z-50">
                    <div className="bg-[#008069] p-4 text-white flex items-center gap-3 shadow-md">
                        <button onClick={onBack}><i data-lucide="arrow-right"></i></button>
                        <h2 className="font-bold text-lg">拽 爪专</h2>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto p-4 pb-24">
                        <div className="grid grid-cols-2 gap-4">
                            {products.map(p => (
                                <div key={p.id} onClick={()=>addToCart(p)} className="border rounded-xl p-3 flex flex-col items-center text-center active:border-green-500 transition">
                                    <img src={p.img} className="rounded-lg mb-2 h-24 object-cover w-full"/>
                                    <div className="font-bold text-sm">{p.name}</div>
                                    <div className="text-green-600 font-bold">{p.price}</div>
                                    <button className="mt-2 bg-green-50 text-green-700 text-xs px-3 py-1 rounded-full">+ 住祝</button>
                                </div>
                            ))}
                        </div>
                    </div>

                    {cart.length > 0 && (
                        <div className="absolute bottom-0 w-full bg-white border-t p-4 shadow-lg">
                            <div className="flex justify-between items-center mb-3">
                                <span className="font-bold text-gray-700">{cart.length} 驻专 注</span>
                                <span className="font-bold text-green-600">{cart.reduce((a,b)=>a+b.price,0)}</span>
                            </div>
                            <button onClick={()=>onSendOrder(cart)} className="w-full bg-[#008069] text-white py-3 rounded-xl font-bold shadow flex justify-center gap-2">
                                砖  <i data-lucide="send"></i>
                            </button>
                        </div>
                    )}
                </div>
            );
        };

        // --- 住 爪'  ---
        const Chat = ({ user, room, onBack }) => {
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');
            const [menuOpen, setMenuOpen] = useState(false);
            const [showCatalog, setShowCatalog] = useState(false);

            // Listener
            useEffect(() => {
                const q = query(collection(db, 'messages'), where('roomId', '==', room.projectId), orderBy('createdAt', 'asc'));
                return onSnapshot(q, snap => {
                    setMessages(snap.docs.map(d => d.data()));
                });
            }, [room]);

            const send = async (text, type='TEXT', payload=null) => {
                await addDoc(collection(db, 'messages'), {
                    roomId: room.projectId, senderId: user.uid, text, type,
                    orderPayload: payload, createdAt: serverTimestamp(), readByWorker: false
                });
                setInput(''); setShowCatalog(false);
            };

            return (
                <div className="flex flex-col h-full wa-bg fixed inset-0 z-40">
                    <div className="wa-header p-3 flex items-center gap-3 shadow">
                        <button onClick={onBack}><i data-lucide="arrow-right"></i></button>
                        <div className="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center text-white font-bold">{room.name[0]}</div>
                        <div className="flex-1">
                            <div className="font-bold text-sm">{room.name}</div>
                            <div className="text-xs opacity-80">专</div>
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 space-y-2">
                        {messages.map((m, i) => {
                            const isMe = m.senderId === user.uid;
                            return (
                                <div key={i} className={`flex ${isMe ? 'justify-end' : 'justify-start'}`}>
                                    <div className={`max-w-[80%] p-2 px-3 shadow-sm text-sm ${isMe ? 'bg-[#d9fdd3] rounded-l-lg rounded-br-lg' : 'bg-white rounded-r-lg rounded-bl-lg'}`}>
                                        {m.type === 'ORDER' && <div className="font-bold text-green-700 mb-1">  砖</div>}
                                        {m.text}
                                        <div className="text-[10px] text-gray-400 text-end mt-1 flex justify-end gap-1">
                                            10:00 {isMe && <i data-lucide="check-check" width="12"></i>}
                                        </div>
                                    </div>
                                </div>
                            )
                        })}
                    </div>

                    <div className="bg-[#f0f2f5] p-2 flex items-center gap-2">
                        <button onClick={()=>setMenuOpen(!menuOpen)} className="p-2 text-gray-500"><i data-lucide="plus"></i></button>
                        <div className="flex-1 bg-white rounded-full px-4 py-2 flex items-center shadow-sm">
                            <input value={input} onChange={e=>setInput(e.target.value)} className="w-full bg-transparent text-sm" placeholder="注" />
                        </div>
                        <button onClick={()=>send(input)} className="p-3 bg-[#008069] text-white rounded-full shadow"><i data-lucide="send" width="18"></i></button>
                    </div>

                    {menuOpen && (
                        <div className="absolute bottom-16 left-4 bg-white p-4 rounded-xl shadow-xl grid grid-cols-3 gap-4 pop-up">
                            <div onClick={()=>setShowCatalog(true)} className="flex flex-col items-center gap-1"><div className="p-3 bg-purple-100 text-purple-600 rounded-full"><i data-lucide="shopping-bag"></i></div><span className="text-xs">拽</span></div>
                            <div className="flex flex-col items-center gap-1"><div className="p-3 bg-blue-100 text-blue-600 rounded-full"><i data-lucide="image"></i></div><span className="text-xs">专</span></div>
                            <div className="flex flex-col items-center gap-1"><div className="p-3 bg-orange-100 text-orange-600"><i data-lucide="map-pin"></i></div><span className="text-xs">拽</span></div>
                        </div>
                    )}

                    {showCatalog && <Catalog onBack={()=>setShowCatalog(false)} onSendOrder={(cart)=>send(' 砖', 'ORDER', {items: cart})} />}
                </div>
            );
        };

        // --- 住 转专转 ---
        const LoginScreen = ({ onLogin }) => {
            const [email, setEmail] = useState('');
            const [pass, setPass] = useState('');
            return (
                <div className="flex h-screen items-center justify-center bg-[#111b21] p-4">
                    <div className="bg-white p-8 rounded-2xl w-full max-w-sm text-center shadow-xl">
                        <div className="w-20 h-20 bg-[#00a884] rounded-full mx-auto mb-6 flex items-center justify-center"><i data-lucide="message-circle" className="text-white w-10 h-10"></i></div>
                        <h2 className="text-2xl font-bold mb-6 text-gray-800">住转 拽转</h2>
                        <form onSubmit={(e)=>{e.preventDefault(); onLogin(email,pass)}} className="space-y-4">
                            <input type="email" placeholder="" className="w-full p-3 border rounded-lg bg-gray-50" value={email} onChange={e=>setEmail(e.target.value)} required/>
                            <input type="password" placeholder="住住" className="w-full p-3 border rounded-lg bg-gray-50" value={pass} onChange={e=>setPass(e.target.value)} required/>
                            <button className="w-full p-3 bg-[#00a884] text-white rounded-lg font-bold hover:bg-[#008f6f]">转专</button>
                        </form>
                    </div>
                </div>
            );
        };

        // --- App Main ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('dashboard'); // dashboard, chat, catalog
            const [profile, setProfile] = useState(null);
            const [room, setRoom] = useState(null);

            useEffect(() => {
                onAuthStateChanged(auth, async u => {
                    if(u) {
                        const snap = await getDoc(doc(db, 'customers', u.uid));
                        if(snap.exists()) {
                            const data = snap.data();
                            setProfile(data);
                            setRoom(data.projects?.[0] || { projectId: 'room_'+u.uid, name: '驻专拽 专砖' });
                        }
                        setUser(u);
                    }
                });
            }, []);

            const handleLogin = async (email, password) => {
                try {
                    await setPersistence(auth, browserLocalPersistence);
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (e) { alert("砖: " + e.message); }
            };

            if(!user) return <LoginScreen onLogin={handleLogin} />;
            
            if(view === 'dashboard') return <Dashboard user={user} profile={profile} onNavigate={setView} />;
            if(view === 'chat') return <Chat user={user} room={room} onBack={()=>setView('dashboard')} />;
            if(view === 'catalog') return <Catalog onBack={()=>setView('dashboard')} onSendOrder={(c)=>alert(' 砖!')} />; // Demo connection
            
            return <div>注...</div>;
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
        
        // Icon Init
        setInterval(() => { if(window.lucide) window.lucide.createIcons(); }, 1000);
    </script>
</body>
</html>
