<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ח. סבן | צ'אט והזמנות</title>
    <link rel="manifest" href="manifest.json">
    
    <!-- OneSignal -->
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        try {
            await OneSignal.init({
              appId: "de3834d3-1e11-40af-96d2-b25eda821c8f",
              safari_web_id: "web.onesignal.auto.00000000-0000-0000-0000-000000000000",
              notifyButton: { enable: false },
              allowLocalhostAsSecureOrigin: true 
            });
        } catch (e) { console.warn("Push Init:", e); }
      });
    </script>

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Heebo', sans-serif; background-color: #e5ded8; overflow: hidden; touch-action: manipulation; }
        
        /* WhatsApp Styles */
        .wa-header { background-color: #008069; color: white; }
        .wa-bg { background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png"); background-repeat: repeat; background-attachment: fixed; }
        .wa-bubble-out { background-color: #d9fdd3; border-radius: 7.5px; border-top-left-radius: 0; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); }
        .wa-bubble-in { background-color: #ffffff; border-radius: 7.5px; border-top-right-radius: 0; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); }
        
        /* Animations */
        .slide-in { animation: slideIn 0.2s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .pop-up { animation: popUp 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popUp { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        /* Utils */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .hit-area { min-height: 44px; min-width: 44px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        input:focus { outline: none; }
    </style>
</head>
<body>
    <div id="root"></div>
    <audio id="msg-sound" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3" preload="auto"></audio>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useRef } = React;
        const { createRoot } = ReactDOM;
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, query, orderBy, where, addDoc, serverTimestamp, updateDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo", 
          authDomain: "saban94-78949.firebaseapp.com", 
          projectId: "saban94-78949", 
          storageBucket: "saban94-78949.firebasestorage.app", 
          messagingSenderId: "41553157903", 
          appId: "1:41553157903:web:cc33d252cff023be97a87a"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- Components ---

        const Icon = ({ name, size=20, color="currentColor", className }) => {
            useEffect(() => lucide.createIcons(), [name]);
            return <i data-lucide={name} width={size} height={size} stroke={color} className={className}></i>;
        };

        const LoginScreen = ({ onLogin }) => {
            const [email, setEmail] = useState('');
            const [pass, setPass] = useState('');
            return (
                <div className="flex h-screen items-center justify-center bg-[#111b21] p-4">
                    <div className="bg-white p-8 rounded-2xl w-full max-w-sm text-center shadow-xl">
                        <div className="w-20 h-20 bg-[#00a884] rounded-full mx-auto mb-6 flex items-center justify-center"><i data-lucide="message-circle" className="text-white w-10 h-10"></i></div>
                        <h2 className="text-2xl font-bold mb-6 text-gray-800">כניסת לקוחות</h2>
                        <form onSubmit={(e)=>{e.preventDefault(); onLogin(email,pass)}} className="space-y-4">
                            <input type="email" placeholder="אימייל" className="w-full p-3 border rounded-lg bg-gray-50" value={email} onChange={e=>setEmail(e.target.value)} required/>
                            <input type="password" placeholder="סיסמה" className="w-full p-3 border rounded-lg bg-gray-50" value={pass} onChange={e=>setPass(e.target.value)} required/>
                            <button className="w-full p-3 bg-[#00a884] text-white rounded-lg font-bold hover:bg-[#008f6f]">התחבר</button>
                        </form>
                    </div>
                </div>
            );
        };

        const ProductCatalog = ({ onSelect }) => {
            const products = [
                { id: 1, name: "בלוק 20", price: "₪320 / משטח", img: "https://placehold.co/100x100?text=Block" },
                { id: 2, name: "מלט שחור", price: "₪28 / שק", img: "https://placehold.co/100x100?text=Cement" },
                { id: 3, name: "חול ים (בלה)", price: "₪150", img: "https://placehold.co/100x100?text=Sand" },
                { id: 4, name: "טיט מוכן", price: "₪25", img: "https://placehold.co/100x100?text=Tit" },
            ];
            return (
                <div className="p-4 grid grid-cols-2 gap-3 bg-[#e5ded8] h-full overflow-y-auto pb-20">
                    {products.map(p => (
                        <div key={p.id} className="bg-white p-3 rounded-xl shadow-sm flex flex-col items-center text-center" onClick={()=>onSelect(p)}>
                            <img src={p.img} className="rounded-lg mb-2 w-full h-24 object-cover"/>
                            <h4 className="font-bold text-sm">{p.name}</h4>
                            <p className="text-xs text-gray-500">{p.price}</p>
                            <button className="mt-2 bg-[#00a884] text-white text-xs px-4 py-1 rounded-full">שלח</button>
                        </div>
                    ))}
                </div>
            );
        };

        const ChatScreen = ({ user, profile, room }) => {
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');
            const [menuOpen, setMenuOpen] = useState(false);
            const [showCatalog, setShowCatalog] = useState(false);
            const [isRecording, setIsRecording] = useState(false);
            const bottomRef = useRef(null);
            const fileInput = useRef(null);

            useEffect(() => {
                const q = query(collection(db, 'messages'), where('roomId', '==', room.projectId), orderBy('createdAt', 'asc'));
                const unsub = onSnapshot(q, (snap) => {
                    const msgs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    setMessages(msgs);
                    if (msgs.length > 0) {
                        const last = msgs[msgs.length - 1];
                        if (last.senderId !== user.uid) {
                             const audio = document.getElementById('msg-sound');
                             if(audio) audio.play().catch(()=>{});
                        }
                    }
                });
                return () => unsub();
            }, [room]);

            useEffect(() => bottomRef.current?.scrollIntoView({ behavior: 'smooth' }), [messages]);

            const sendMessage = async (type = 'TEXT', payload = null) => {
                const msg = {
                    roomId: room.projectId,
                    senderId: user.uid,
                    senderName: profile.name || 'לקוח',
                    senderAvatar: profile.avatarUrl || '',
                    type,
                    createdAt: serverTimestamp(),
                    readByWorker: false,
                    status: 'sent'
                };

                if (type === 'TEXT') { if(!input.trim()) return; msg.text = input; setInput(''); }
                else if (type === 'ORDER') { msg.text = 'הזמנה חדשה'; msg.orderPayload = payload; msg.orderStatus = 'new'; }
                else if (type === 'IMAGE') { msg.text = 'תמונה'; msg.mediaUrl = payload; }
                else if (type === 'AUDIO') { msg.text = 'הודעה קולית'; msg.mediaUrl = payload; }
                else if (type === 'LOCATION') { msg.text = 'מיקום'; msg.location = payload; }

                setShowCatalog(false);
                setMenuOpen(false);
                await addDoc(collection(db, 'messages'), msg);
                
                // Trigger Push (Stub)
                if(window.OneSignalDeferred) window.OneSignalDeferred.push(OS => console.log("Push sent logic"));
            };

            const handleFile = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => sendMessage('IMAGE', ev.target.result); // Base64 for demo
                reader.readAsDataURL(file);
            };

            const handleLocation = () => {
                navigator.geolocation.getCurrentPosition(pos => {
                    sendMessage('LOCATION', { lat: pos.coords.latitude, lon: pos.coords.longitude });
                });
            };

            const renderMessage = (m) => {
                const isMe = m.senderId === user.uid;
                const time = m.createdAt ? new Date(m.createdAt.seconds * 1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';
                
                let content = <span className="text-sm">{m.text}</span>;
                
                if (m.type === 'ORDER') {
                    content = (
                        <div className="bg-green-50 p-2 rounded border border-green-100 -mx-1 -mt-1 mb-1">
                            <div className="font-bold text-xs text-green-800 flex items-center gap-1"><i data-lucide="shopping-cart" width="12"></i> הזמנה</div>
                            <div className="text-sm font-medium">{m.orderPayload.name}</div>
                            <div className="text-xs text-gray-500">{m.orderPayload.price}</div>
                        </div>
                    );
                } else if (m.type === 'IMAGE') {
                    content = <img src={m.mediaUrl} className="rounded-lg max-w-[200px]" />;
                } else if (m.type === 'LOCATION') {
                    content = (
                        <div>
                            <div className="font-bold text-blue-600 text-xs flex items-center gap-1"><i data-lucide="map-pin" width="12"></i> מיקום</div>
                            <a href={`https://waze.com/ul?ll=${m.location.lat},${m.location.lon}&navigate=yes`} target="_blank" className="text-xs underline mt-1 block">פתח ב-Waze</a>
                        </div>
                    );
                }

                return (
                    <div key={m.id} className={`flex mb-2 ${isMe ? 'justify-start' : 'justify-end'}`}>
                        <div className={`max-w-[80%] p-2 px-3 rounded-lg shadow-sm relative ${isMe ? 'wa-bubble-out rounded-tr-none' : 'wa-bubble-in rounded-tl-none'}`}>
                            {content}
                            <div className="flex justify-end items-center gap-1 mt-1">
                                <span className="text-[10px] text-gray-500">{time}</span>
                                {isMe && (
                                    <span className={m.status === 'read' ? 'text-blue-500' : 'text-gray-400'}>
                                        <i data-lucide="check-check" width="14" height="14"></i>
                                    </span>
                                )}
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="flex flex-col h-full wa-bg">
                    <div className="wa-header p-3 flex items-center shadow-sm z-10">
                        <div className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center mr-3">
                            <i data-lucide="user" className="text-white"></i>
                        </div>
                        <div className="flex-1">
                            <div className="font-bold text-sm">{room.name}</div>
                            <div className="text-xs opacity-80">מחובר כעת</div>
                        </div>
                        <button onClick={()=>window.location.reload()}><i data-lucide="refresh-ccw" className="text-white"></i></button>
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 relative">
                        {showCatalog ? <ProductCatalog onSelect={(p)=>sendMessage('ORDER', p)} /> : messages.map(renderMessage)}
                        <div ref={bottomRef}></div>
                    </div>

                    {/* Attachment Menu */}
                    {menuOpen && (
                        <div className="absolute bottom-16 left-4 right-4 bg-white rounded-xl shadow-xl p-4 grid grid-cols-4 gap-4 z-20 pop-up">
                            <div onClick={()=>setShowCatalog(true)} className="flex flex-col items-center gap-1"><div className="p-3 bg-purple-100 rounded-full text-purple-600"><i data-lucide="shopping-bag"></i></div><span className="text-xs">קטלוג</span></div>
                            <div onClick={()=>fileInput.current.click()} className="flex flex-col items-center gap-1"><div className="p-3 bg-pink-100 rounded-full text-pink-600"><i data-lucide="image"></i></div><span className="text-xs">גלריה</span></div>
                            <div onClick={handleLocation} className="flex flex-col items-center gap-1"><div className="p-3 bg-green-100 rounded-full text-green-600"><i data-lucide="map-pin"></i></div><span className="text-xs">מיקום</span></div>
                            <div className="flex flex-col items-center gap-1"><div className="p-3 bg-blue-100 rounded-full text-blue-600"><i data-lucide="file-text"></i></div><span className="text-xs">מסמך</span></div>
                        </div>
                    )}

                    {/* Input Bar */}
                    <div className="bg-[#f0f2f5] p-2 flex items-center gap-2 z-20">
                        <button onClick={()=>setMenuOpen(!menuOpen)} className={`p-2 rounded-full transition ${menuOpen?'rotate-45 bg-gray-300':''}`}><i data-lucide="plus" className="text-gray-500"></i></button>
                        <input type="file" ref={fileInput} className="hidden" accept="image/*" onChange={handleFile}/>
                        
                        <div className="flex-1 bg-white rounded-2xl px-4 py-2 shadow-sm flex items-center">
                            <input 
                                className="w-full bg-transparent text-sm" 
                                placeholder="הודעה" 
                                value={input} 
                                onChange={e=>setInput(e.target.value)}
                                onKeyDown={e=>e.key==='Enter'&&sendMessage('TEXT')}
                            />
                        </div>
                        
                        {input ? (
                            <button onClick={()=>sendMessage('TEXT')} className="p-3 bg-[#008069] text-white rounded-full shadow-md hit-area"><i data-lucide="send" width="18"></i></button>
                        ) : (
                            <button className="p-3 bg-[#008069] text-white rounded-full shadow-md hit-area"><i data-lucide="mic" width="18"></i></button>
                        )}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [profile, setProfile] = useState(null);
            const [project, setProject] = useState(null);

            useEffect(() => {
                onAuthStateChanged(auth, async (u) => {
                    if (u) {
                        if(window.OneSignalDeferred) window.OneSignalDeferred.push(OS => OS.login(u.uid));
                        const snap = await getDoc(doc(db, 'customers', u.uid));
                        if (snap.exists()) {
                            const data = snap.data();
                            setProfile(data);
                            setProject(data.projects?.[0] || { projectId: 'new_room', name: 'חדר כללי' });
                        } else {
                            // Create default profile
                            const def = { name: u.displayName || 'אורח', projects: [{ projectId: 'room_'+u.uid, name: 'פרויקט ראשי' }] };
                            await setDoc(doc(db, 'customers', u.uid), def);
                            setProfile(def);
                            setProject(def.projects[0]);
                        }
                        setUser(u);
                    } else {
                        setUser(null);
                    }
                });
            }, []);

            const handleLogin = async (email, password) => {
                try {
                    await setPersistence(auth, browserLocalPersistence);
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (e) { alert("שגיאה: " + e.message); }
            };

            if (!user) return <LoginScreen onLogin={handleLogin} />;
            if (!project) return <div className="text-center mt-20">טוען נתונים...</div>;

            return <ChatScreen user={user} profile={profile} room={project} />;
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
