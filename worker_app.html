<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sidor Pro | </title>
    <link rel="manifest" href="manifest.json">
    
    <!-- OneSignal -->
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        try {
            await OneSignal.init({
              appId: "de3834d3-1e11-40af-96d2-b25eda821c8f",
              safari_web_id: "web.onesignal.auto.00000000-0000-0000-0000-000000000000",
              notifyButton: { enable: true },
              allowLocalhostAsSecureOrigin: true 
            });
            OneSignal.User.addTag("role", "worker");
        } catch (e) { console.warn("OS Warn:", e); }
      });
    </script>

    <!-- Tailwind & Icons -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Rubik', sans-serif; background-color: #f3f4f6; overflow: hidden; }
        
        /* SLA Animations */
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .sla-critical { animation: pulse-red 1.5s infinite; border-right: 4px solid #ef4444; background: #fef2f2; }
        
        .chat-item { transition: all 0.2s; border-bottom: 1px solid #f3f4f6; cursor: pointer; }
        .chat-item:hover { background-color: #f9fafb; }
        .chat-item.active { background-color: #eff6ff; border-right: 4px solid #3b82f6; }
        
        .scroll-touch { -webkit-overflow-scrolling: touch; scrollbar-width: thin; }
        .avatar { object-fit: cover; border-radius: 50%; }
    </style>
</head>
<body>
    <audio id="alert-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>
    <audio id="sla-sound" src="https://assets.mixkit.co/active_storage/sfx/2868/2868-preview.mp3" preload="auto"></audio>

    <div id="app" class="h-screen flex flex-col md:flex-row">
        
        <!-- 1. Sidebar / Navigation -->
        <nav class="bg-white w-full md:w-20 border-l flex md:flex-col items-center justify-between md:justify-start p-4 z-20 shadow-lg">
            <div class="bg-blue-600 w-10 h-10 rounded-xl flex items-center justify-center text-white font-bold shadow-blue-300 mb-0 md:mb-8">S</div>
            
            <div class="flex md:flex-col gap-6">
                <button onclick="ui.switchTab('dashboard')" id="btn-dash" class="p-3 rounded-xl text-blue-600 bg-blue-50 transition"><i data-lucide="layout-grid"></i></button>
                <button onclick="ui.switchTab('chats')" id="btn-chats" class="p-3 rounded-xl text-gray-400 hover:bg-gray-50 relative">
                    <i data-lucide="message-circle"></i>
                    <span id="global-badge" class="absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full border-2 border-white hidden"></span>
                </button>
            </div>
            <button onclick="logic.logout()" class="text-red-400 p-3 mt-auto"><i data-lucide="log-out"></i></button>
        </nav>

        <!-- 2. Content Area -->
        <main class="flex-1 flex overflow-hidden relative bg-[#f0f2f5]">
            
            <!-- DASHBOARD VIEW -->
            <div id="view-dashboard" class="w-full p-6 overflow-y-auto">
                <header class="flex justify-between items-center mb-8">
                    <h1 class="text-2xl font-bold text-gray-800">砖专  转</h1>
                    <div class="flex items-center gap-2 bg-white px-3 py-1 rounded-full shadow-sm border text-sm font-bold text-green-600"><span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> 注专转 </div>
                </header>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                        <div class="text-xs font-bold text-gray-400 uppercase">转 </div>
                        <div class="text-2xl font-bold text-blue-600" id="stat-orders">0</div>
                    </div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                        <div class="text-xs font-bold text-gray-400 uppercase">注转 砖 拽专</div>
                        <div class="text-2xl font-bold text-orange-500" id="stat-unread">0</div>
                    </div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                        <div class="text-xs font-bold text-gray-400 uppercase"> 注 (ART)</div>
                        <div class="text-2xl font-bold text-purple-600" id="stat-art">--:--</div>
                    </div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                        <div class="text-xs font-bold text-gray-400 uppercase">拽转 专</div>
                        <div class="text-2xl font-bold text-green-600" id="stat-online">0</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-2xl shadow-sm p-6 h-[400px] overflow-hidden flex flex-col">
                        <h3 class="font-bold text-lg mb-4 flex items-center gap-2"><i data-lucide="clock" class="text-blue-500 w-5"></i> SLA Monitor (驻转 转)</h3>
                        <div id="sla-list" class="flex-1 overflow-y-auto space-y-2"></div>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm p-6 h-[400px] overflow-hidden flex flex-col">
                        <h3 class="font-bold text-lg mb-4"> 驻注转</h3>
                        <div id="activity-log" class="flex-1 overflow-y-auto space-y-3"></div>
                    </div>
                </div>
            </div>

            <!-- CHATS VIEW -->
            <div id="view-chats" class="hidden w-full h-full flex bg-white">
                <!-- List -->
                <div class="w-full md:w-96 border-l bg-white flex flex-col z-10" id="chat-list-panel">
                    <div class="p-4 border-b flex justify-between items-center">
                        <h2 class="font-bold text-xl">拽转</h2>
                        <span class="bg-blue-100 text-blue-600 text-xs font-bold px-2 py-1 rounded-full" id="list-count">0</span>
                    </div>
                    <div id="chat-list" class="flex-1 overflow-y-auto scroll-touch"></div>
                </div>

                <!-- Chat Window -->
                <div class="hidden md:flex flex-1 flex-col bg-[#efeae2] relative" id="chat-window">
                    <div class="absolute inset-0 opacity-10 z-0" style="background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');"></div>
                    
                    <!-- Header -->
                    <div class="bg-[#f0f2f5] p-3 flex justify-between items-center border-b z-10 relative shadow-sm">
                        <div class="flex items-center gap-3">
                            <button class="md:hidden p-2" onclick="ui.closeChat()"><i data-lucide="arrow-right"></i></button>
                            <img id="header-avatar" class="w-10 h-10 rounded-full bg-gray-300">
                            <div>
                                <h3 class="font-bold text-gray-800 leading-tight" id="header-name"></h3>
                                <p class="text-xs text-gray-500" id="header-info"></p>
                            </div>
                        </div>
                        <button onclick="logic.stopSound()" class="p-2 bg-red-50 text-red-500 rounded-full"><i data-lucide="volume-x" width="18"></i></button>
                    </div>

                    <!-- Messages -->
                    <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-2 relative z-10 scroll-touch"></div>

                    <!-- Input -->
                    <form id="chat-form" class="p-3 bg-[#f0f2f5] flex items-center gap-2 z-10 border-t relative">
                        <input id="msg-input" type="text" placeholder="拽 注..." class="flex-1 p-3 rounded-xl border-none bg-white shadow-sm text-sm focus:outline-none" autocomplete="off">
                        <button type="submit" class="p-3 bg-[#00a884] text-white rounded-full shadow hover:scale-105 transition"><i data-lucide="send" width="18"></i></button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, query, where, orderBy, onSnapshot, addDoc, serverTimestamp, doc, updateDoc, limit } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // Initialize Icons
        lucide.createIcons();

        const firebaseConfig = {
            apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo",
            authDomain: "saban94-78949.firebaseapp.com",
            projectId: "saban94-78949",
            storageBucket: "saban94-78949.firebasestorage.app",
            messagingSenderId: "41553157903",
            appId: "1:41553157903:web:cc33d252cff023be97a87a"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- State ---
        const state = {
            user: null,
            rooms: {},
            activeRoom: null,
            unsubChat: null,
            art: []
        };

        // --- UI Functions ---
        window.ui = {
            switchTab: (tab) => {
                document.getElementById('view-dashboard').classList.add('hidden');
                document.getElementById('view-chats').classList.add('hidden');
                document.getElementById(`view-${tab}`).classList.remove('hidden');
                
                // Flex fix for chats view
                if(tab === 'chats') document.getElementById(`view-chats`).classList.add('flex');
                
                document.getElementById('btn-dash').className = tab === 'dashboard' ? 'p-3 rounded-xl text-blue-600 bg-blue-50' : 'p-3 rounded-xl text-gray-400';
                document.getElementById('btn-chats').className = tab === 'chats' ? 'p-3 rounded-xl text-blue-600 bg-blue-50' : 'p-3 rounded-xl text-gray-400';
            },

            openChat: (id, name, avatar) => {
                // 1. UI
                if(window.innerWidth < 768) { // Mobile
                    document.getElementById('chat-list-panel').classList.add('hidden');
                    document.getElementById('chat-window').classList.remove('hidden');
                    document.getElementById('chat-window').classList.add('flex');
                }
                document.getElementById('header-name').innerText = name;
                document.getElementById('header-avatar').src = avatar;
                document.getElementById('messages').innerHTML = '';
                
                state.activeRoom = id;
                window.logic.stopSound(); // Stop ringing

                // 2. Listener
                if(state.unsubChat) state.unsubChat();
                const q = query(collection(db, 'messages'), where('roomId', '==', id), orderBy('createdAt', 'asc'));
                
                state.unsubChat = onSnapshot(q, snap => {
                    const area = document.getElementById('messages');
                    snap.docChanges().forEach(change => {
                        if(change.type === 'added') {
                            const m = change.doc.data();
                            // Mark Read
                            if(m.senderId !== state.user.uid && !m.readByWorker) {
                                updateDoc(change.doc.ref, { readByWorker: true, readAt: serverTimestamp(), status: 'read' });
                            }
                            area.innerHTML += window.ui.createMessageBubble(m);
                        }
                    });
                    area.scrollTop = area.scrollHeight;
                    lucide.createIcons();
                });
            },
            
            closeChat: () => {
                document.getElementById('chat-list-panel').classList.remove('hidden');
                document.getElementById('chat-window').classList.add('hidden');
                state.activeRoom = null;
                if(state.unsubChat) state.unsubChat();
            },

            createMessageBubble: (m) => {
                const isMe = m.senderId === state.user.uid;
                const align = isMe ? 'items-end' : 'items-start';
                const bg = isMe ? 'bg-[#d9fdd3]' : 'bg-white';
                const time = m.createdAt ? new Date(m.createdAt.seconds * 1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : '';
                
                let content = `<div class="text-sm">${m.text}</div>`;
                if(m.type === 'ORDER') content = `<div class="font-bold text-green-700 text-xs">  砖</div><div class="text-xs bg-gray-50 p-2 rounded mt-1">${m.orderPayload?.items?.map(i=>`${i.name} x${i.qty}`).join(', ')}</div>`;
                if(m.type === 'LOCATION') content = `<a href="https://waze.com/ul?ll=${m.location.lat},${m.location.lon}&navigate=yes" target="_blank" class="flex items-center gap-1 text-blue-600 text-xs font-bold"><i data-lucide="map-pin" width="14"></i>  -Waze</a>`;

                return `
                <div class="flex flex-col ${align} mb-2 w-full slide-in">
                    <div class="max-w-[80%] p-2 px-3 rounded-lg shadow-sm ${bg} relative">
                        ${content}
                        <div class="text-[9px] text-gray-400 text-left mt-1 flex justify-end items-center gap-1">
                            ${time} ${isMe ? '<i data-lucide="check" width="12"></i>' : ''}
                        </div>
                    </div>
                </div>`;
            },

            renderList: () => {
                const list = document.getElementById('chat-list');
                const sorted = Object.values(state.rooms).sort((a,b) => (b.unread - a.unread) || (b.time - a.time));
                
                document.getElementById('list-count').innerText = sorted.length;
                
                list.innerHTML = sorted.map(r => `
                    <div onclick="window.ui.openChat('${r.id}', '${r.name}', '${r.avatar}')" class="chat-item p-4 flex items-center gap-3 ${r.unread>0 ? 'unread-active' : ''}">
                        <div class="relative">
                            <img src="${r.avatar}" class="w-12 h-12 rounded-full object-cover bg-gray-200">
                            ${r.isOnline ? '<div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div>' : ''}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between mb-1">
                                <h3 class="font-bold text-sm truncate">${r.name}</h3>
                                ${r.unread > 0 ? `<span class="bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full">${r.unread}</span>` : ''}
                            </div>
                            <p class="text-xs text-gray-500 truncate">${r.lastMsg}</p>
                        </div>
                    </div>
                `).join('');
            },
            
            renderSLA: () => {
                const el = document.getElementById('sla-list');
                let html = '';
                let breach = false;
                
                Object.values(state.rooms).forEach(r => {
                    if(r.unread > 0 && r.time > 0) {
                        const mins = Math.floor((Date.now() - r.time) / 60000);
                        let color = 'bg-green-100 text-green-800';
                        if(mins >= 1) color = 'bg-yellow-100 text-yellow-800';
                        if(mins >= 3) { color = 'bg-red-100 text-red-800 sla-critical'; breach = true; }
                        
                        html += `
                            <div class="flex justify-between items-center p-3 bg-white border rounded-lg">
                                <div class="flex items-center gap-2">
                                    <img src="${r.avatar}" class="w-6 h-6 rounded-full">
                                    <span class="font-bold text-sm">${r.name}</span>
                                </div>
                                <span class="px-2 py-1 rounded text-xs font-bold ${color}">${mins} 拽'</span>
                            </div>`;
                    }
                });
                
                el.innerHTML = html || '<div class="text-center text-gray-400 py-8"> 驻转 转转</div>';
                if(breach) document.getElementById('sla-sound').play().catch(()=>{});
            }
        };

        // --- Business Logic ---
        window.logic = {
            init: () => {
                // 1. Messages Listener
                const q = query(collection(db, 'messages'), orderBy('createdAt', 'desc'), limit(200));
                onSnapshot(q, snap => {
                    let unread = 0, orders = 0;
                    const activity = [];
                    let newMsg = false;

                    // Process Snap
                    snap.docs.forEach(d => {
                        const m = d.data();
                        if(!m.roomId) return;
                        
                        // Init Room
                        if(!state.rooms[m.roomId]) state.rooms[m.roomId] = { id: m.roomId, name: m.senderName||'拽', avatar: m.senderAvatar, unread: 0, time: 0, lastMsg: '' };
                        const r = state.rooms[m.roomId];

                        // Update Room
                        const time = m.createdAt ? m.createdAt.toMillis() : Date.now();
                        if(time > r.time) {
                            r.time = time;
                            r.lastMsg = m.text || (m.type==='ORDER'?'':m.type);
                            if(m.senderAvatar) r.avatar = m.senderAvatar; // Prefer message avatar
                        }

                        if(!m.readByWorker && m.senderId !== state.user.uid) {
                            r.unread++;
                            unread++;
                            // Check if new
                            if(snap.docChanges().some(c => c.doc.id === d.id && c.type === 'added')) newMsg = true;
                        }

                        if(m.type === 'ORDER') orders++;
                        if(activity.length < 6) activity.push({ text: r.lastMsg, name: r.name, time });
                    });

                    // Alerts
                    if(newMsg) {
                        document.getElementById('alert-sound').play().catch(()=>{});
                        document.title = " 注 砖!";
                    } else if (unread === 0) {
                        document.title = "Sidor Pro";
                    }

                    // Update Stats
                    document.getElementById('stat-unread').innerText = unread;
                    document.getElementById('stat-orders').innerText = orders;
                    document.getElementById('global-badge').classList.toggle('hidden', unread === 0);

                    // Activity Log
                    document.getElementById('activity-log').innerHTML = activity.map(a => 
                        `<div class="text-sm p-2 border-b border-gray-50 flex justify-between"><span><b>${a.name}</b>: ${a.text.substring(0,20)}</span><span class="text-gray-400 text-xs">${new Date(a.time).toLocaleTimeString()}</span></div>`
                    ).join('');

                    ui.renderList();
                    ui.renderSLA();
                });
            },

            logout: () => auth.signOut(),
            stopSound: () => {
                ['alert-sound', 'sla-sound'].forEach(id => { const a = document.getElementById(id); if(a) { a.pause(); a.currentTime=0; } });
            }
        };

        // Auth
        onAuthStateChanged(auth, u => {
            if (u) {
                state.user = u;
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('shell-wrapper').classList.remove('hidden');
                document.getElementById('admin-name').innerText = u.displayName || '爪转';
                window.logic.init();
                
                // Polling for SLA
                setInterval(ui.renderSLA, 10000);
            } else {
                signInAnonymously(auth).catch(e => alert("Login Error: " + e.message));
            }
        });

        // Form
        document.getElementById('chat-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('msg-input');
            if(!input.value.trim() || !state.activeRoom) return;
            
            await addDoc(collection(db, 'messages'), {
                roomId: state.activeRoom,
                senderId: state.user.uid,
                senderName: '爪',
                type: 'TEXT',
                createdAt: serverTimestamp(),
                text: input.value,
                readByWorker: true
            });
            input.value = '';
        });

    </script>
</body>
</html>
```

### 3. `manifest.json`
```json
{
  "name": "Sidor Logistics",
  "short_name": "Sidor",
  "start_url": ".",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#2563eb",
  "icons": [
    {
      "src": "https://ui-avatars.com/api/?name=Sidor&background=2563eb&color=fff&size=192",
      "sizes": "192x192",
      "type": "image/png"
    }
  ]
}
```

### 4. `service-worker.js`
```javascript
self.addEventListener('install', (e) => self.skipWaiting());
self.addEventListener('activate', (e) => e.waitUntil(self.clients.claim()));
self.addEventListener('push', (e) => {
    const data = e.data.json();
    self.registration.showNotification(data.title, {
        body: data.body,
        icon: 'https://ui-avatars.com/api/?name=S'
    });
});
