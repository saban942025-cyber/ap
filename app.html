<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>×—. ×¡×‘×Ÿ | ×¤×•×¨×˜×œ ×œ×§×•×—×•×ª</title>
    
    <!-- ×˜×¢×™× ×ª ×¡×¤×¨×™×•×ª -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; background-color: #f0f2f5; overscroll-behavior: none; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        
        /* ×× ×™××¦×™×•×ª */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useRef, useMemo } = React;
        const { createRoot } = ReactDOM;
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, query, orderBy, where, getDoc, addDoc, serverTimestamp, limit, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        // *** ×”×’×“×¨×•×ª ***
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycby7qKICvRYStFkcDPLtGhGPaNqyYt-G8dZqBJfGm7vpmOG6Kf_n3f29V8oyUW9PjBUj7A/exec";

        const firebaseConfig = {
          apiKey: "AIzaSyDq0oVwS6zbEfsgrYBRkeBq80dDUKMedzo", 
          authDomain: "saban94-78949.firebaseapp.com", 
          projectId: "saban94-78949", 
          storageBucket: "saban94-78949.firebasestorage.app", 
          messagingSenderId: "41553157903", 
          appId: "1:41553157903:web:cc33d252cff023be97a87a",
          measurementId: "G-XV6RZDESSB"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- Icons ---
        const Icon = ({ name, className, size=24 }) => {
            const icons = {
                MessageSquare: <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>,
                BookOpen: <><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></>,
                User: <><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>,
                LogOut: <><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></>,
                ArrowRight: <><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></>,
                ArrowLeft: <><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></>,
                Send: <><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></>,
                Search: <><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></>,
                Bell: <><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></>,
                Check: <polyline points="20 6 9 17 4 12"/>,
                Loader: <><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/></>,
                Plus: <><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></>,
                Minus: <line x1="5" y1="12" x2="19" y2="12"/>,
                Mic: <><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></>,
                MapPin: <><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></>,
                Camera: <><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></>,
                FileText: <><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></>,
                X: <><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>,
                ShoppingCart: <><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></>,
                Trash: <><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></>
            };
            return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{icons[name]}</svg>;
        };

        // --- ×§×˜×œ×•×’ ××•×¦×¨×™× (Hardcoded + Live) ---
        const DEFAULT_PRODUCTS = [
            { id: "p-101", sku: "10-101", name: "×œ×•×— ×’×‘×¡ ×œ×‘×Ÿ (×¡×˜× ×“×¨×˜×™)", image: "https://placehold.co/400x300/e0e7ff/3730a3?text=Gypsum", spec: "120x260 ×¡\"× | 12.5 ×\"×", description: "×œ×•×— ×’×‘×¡ ××™×›×•×ª×™ ×œ×§×™×¨×•×ª ×¤× ×™×.", price: "â‚ª38.00" },
            { id: "p-102", sku: "10-102", name: "× ×™×¦×‘ 70 ×\"×", image: "https://placehold.co/400x300/e0e7ff/3730a3?text=Stud", spec: "300 ×¡\"× | ×¤×— ××’×•×œ×•×•×Ÿ", description: "×¤×¨×•×¤×™×œ ×× ×›×™ ×œ×§×•× ×¡×˜×¨×•×§×¦×™×”.", price: "â‚ª18.50" },
            { id: "p-103", sku: "10-103", name: "××¡×œ×•×œ 70 ×\"×", image: "https://placehold.co/400x300/e0e7ff/3730a3?text=Track", spec: "300 ×¡\"× | ×¤×— ××’×•×œ×•×•×Ÿ", description: "××¡×™×œ×” ×œ×¨×¦×¤×”/×ª×§×¨×”.", price: "â‚ª16.90" },
            { id: "p-201", sku: "20-201", name: "×©×¤×›×˜×œ ×××¨×™×§××™", image: "https://placehold.co/400x300/e0e7ff/3730a3?text=Putty", spec: "28 ×§\"×’ | ×“×œ×™", description: "×—×•××¨ ×œ×”×—×œ×§×ª ×§×™×¨×•×ª.", price: "â‚ª65.00" }
        ];

        const KnowledgeBase = {
            search: function(term, liveProducts) {
                const allProducts = [...DEFAULT_PRODUCTS, ...liveProducts];
                if (!term) return allProducts;
                return allProducts.filter(p => p.name.includes(term) || p.sku?.includes(term));
            }
        };

        // --- Toast ---
        function Toast({ message, visible, onHide }) {
            useEffect(() => { if (visible) { const t = setTimeout(onHide, 3000); return () => clearTimeout(t); } }, [visible, onHide]);
            if (!visible) return null;
            return <div className="fixed top-24 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-2xl z-50 flex items-center space-x-3 space-x-reverse animate-fade-in"><Icon name="Loader" className="animate-spin w-5 h-5 text-blue-400" /><span className="font-medium text-sm">{message}</span></div>;
        }

        // --- Auth Screen ---
        function AuthScreen() {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleLogin = async (e) => {
                e.preventDefault(); setLoading(true); setError('');
                try { await setPersistence(auth, browserLocalPersistence); await signInWithEmailAndPassword(auth, email, password); } 
                catch (err) { setError("×¤×¨×˜×™ ×”×ª×—×‘×¨×•×ª ×©×’×•×™×™×."); }
                setLoading(false);
            };
            return (
                <div className="flex items-center justify-center min-h-screen bg-gray-100 p-4">
                    <div className="w-full max-w-md bg-white p-8 rounded-3xl shadow-xl border border-gray-100 text-center">
                        <div className="w-20 h-20 bg-white rounded-2xl mx-auto flex items-center justify-center shadow-lg mb-4 overflow-hidden border border-gray-100"><img src="https://i.postimg.cc/ryPT3r29/hwrdh.png" className="w-full h-full object-contain p-2" /></div>
                        <h2 className="text-2xl font-bold text-gray-800">×—. ×¡×‘×Ÿ ×—×•××¨×™ ×‘× ×™×™×Ÿ</h2>
                        <p className="text-gray-500 text-sm mt-1 mb-6">×¤×•×¨×˜×œ ×”×–×× ×•×ª ××ª×§×“×</p>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <input type="email" placeholder="××™××™×™×œ" value={email} onChange={e=>setEmail(e.target.value)} className="w-full p-3 border rounded-xl" required />
                            <input type="password" placeholder="×¡×™×¡××”" value={password} onChange={e=>setPassword(e.target.value)} className="w-full p-3 border rounded-xl" required />
                            {error && <p className="text-red-500 text-sm">{error}</p>}
                            <button disabled={loading} className="w-full p-4 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700">{loading ? "××ª×—×‘×¨..." : "×›× ×™×¡×” ×œ××¢×¨×›×ª"}</button>
                        </form>
                    </div>
                </div>
            );
        }

        // --- Chat Room ---
        function ChatRoom({ project, user, onBack, showToast, initialMessage }) {
            const [messages, setMessages] = useState([]);
            const [text, setText] = useState(initialMessage || '');
            const [showMenu, setShowMenu] = useState(false);
            const endRef = useRef(null);
            const fileInputRef = useRef(null);

            useEffect(() => {
                const q = query(collection(db, 'messages'), where('roomId', '==', project.projectId), orderBy('createdAt', 'asc'));
                const unsub = onSnapshot(q, snap => setMessages(snap.docs.map(d => ({id: d.id, ...d.data()}))));
                return () => unsub();
            }, [project.projectId]);

            useEffect(() => endRef.current?.scrollIntoView({ behavior: 'smooth' }), [messages]);

            const sendMessage = async (type = 'TEXT', payload = null) => {
                let msg = {
                    roomId: project.projectId, senderId: user.uid, senderName: user.displayName || '×œ×§×•×—',
                    type: type, createdAt: serverTimestamp(), replyTo: null
                };
                if (type === 'TEXT') { if (!text.trim()) return; msg.text = text.trim(); setText(''); }
                else if (type === 'ORDER') { msg.orderPayload = payload; msg.text = `×”×–×× ×” ×—×“×©×”: ${payload.items.length} ×¤×¨×™×˜×™×`; }
                else if (['IMAGE','FILE','AUDIO'].includes(type)) { msg.mediaUrl = payload.url; msg.text = payload.name; }
                else if (type === 'LOCATION') { msg.location = payload; msg.text = 'ğŸ“ ××™×§×•× ×©×™×ª×•×¤×™'; }

                await addDoc(collection(db, 'messages'), msg);
                setShowMenu(false);
            };

            // ×”×¢×œ××”
            const handleFileUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                showToast("××¢×œ×”...");
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = async () => {
                    // Fallback to Firebase (Stable) as discussed
                    try {
                        const fileRef = ref(storage, `chat_files/${project.projectId}/${Date.now()}_${file.name}`);
                        await uploadBytes(fileRef, file);
                        const url = await getDownloadURL(fileRef);
                        const type = file.type.startsWith('image/') ? 'IMAGE' : 'FILE';
                        await sendMessage(type, { url, name: file.name });
                        showToast("× ×©×œ×—!");
                    } catch(err) { showToast("×©×’×™××” ×‘×”×¢×œ××”"); }
                };
            };
            
            const handleLocation = () => {
                if (navigator.geolocation) {
                    showToast("×××ª×¨...");
                    navigator.geolocation.getCurrentPosition(pos => sendMessage('LOCATION', { lat: pos.coords.latitude, lon: pos.coords.longitude }));
                }
            };

            return (
                <div className="flex flex-col h-full bg-[#e5ded8]">
                    <header className="bg-white p-3 flex items-center shadow-sm sticky top-0 z-20">
                        <button onClick={onBack} className="p-2 text-gray-600"><Icon name="ArrowRight" /></button>
                        <div className="flex-1 mr-2"><div className="font-bold text-gray-800 text-sm">{project.name}</div></div>
                    </header>
                    
                    <div className="flex-1 overflow-y-auto p-4 space-y-3">
                        {messages.map(m => (
                            <div key={m.id} className={`flex ${m.senderId === user.uid ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[85%] p-2 rounded-xl text-sm shadow-sm ${m.senderId === user.uid ? 'bg-[#d9fdd3]' : 'bg-white'}`}>
                                    {m.type === 'ORDER' && (
                                        <div className="bg-white/50 p-2 rounded border border-green-200 mb-1">
                                            <p className="font-bold text-green-800 border-b border-green-200 pb-1 mb-1">ğŸ›’ ×”×–×× ×” ×—×“×©×”</p>
                                            {m.orderPayload.items.map((item, i) => (
                                                <div key={i} className="flex justify-between text-xs text-gray-700 py-0.5">
                                                    <span>{item.name}</span>
                                                    <span className="font-bold">x{item.qty}</span>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                    {m.type === 'IMAGE' && <img src={m.mediaUrl} className="rounded-lg mb-1 max-w-full" />}
                                    {m.type === 'FILE' && <a href={m.mediaUrl} target="_blank" className="flex gap-2 text-blue-600 underline"><Icon name="FileText" size={16}/> {m.text}</a>}
                                    {m.type === 'LOCATION' && <a href={`https://waze.com/ul?ll=${m.location.lat},${m.location.lon}&navigate=yes`} target="_blank" className="flex gap-2 text-blue-600"><Icon name="MapPin" size={16}/> × ×™×•×•×˜</a>}
                                    {m.type === 'TEXT' && <div>{m.text}</div>}
                                    <div className="text-[10px] text-gray-400 text-left mt-1">{m.createdAt?.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                                </div>
                            </div>
                        ))}
                        <div ref={endRef} />
                    </div>

                    <div className="p-2 bg-[#f0f2f5] flex items-center gap-2 pb-4 relative">
                        {showMenu && (
                            <div className="absolute bottom-16 right-4 bg-white rounded-xl shadow-xl p-3 flex flex-col gap-3 animate-fade-in z-30">
                                <button onClick={() => fileInputRef.current.click()} className="flex items-center gap-3 text-gray-700"><Icon name="FileText" className="text-purple-500"/> ××¡××š/×ª××•× ×”</button>
                                <button onClick={handleLocation} className="flex items-center gap-3 text-gray-700"><Icon name="MapPin" className="text-red-500"/> ××™×§×•×</button>
                            </div>
                        )}
                        <input type="file" ref={fileInputRef} onChange={handleFileUpload} className="hidden" />
                        <button onClick={() => setShowMenu(!showMenu)} className="p-2 text-gray-500"><Icon name="Plus" /></button>
                        <div className="flex-1 bg-white rounded-full flex items-center px-4 shadow-sm">
                            <input className="flex-1 py-3 bg-transparent border-none focus:ring-0 outline-none text-sm" placeholder="×”×•×“×¢×”" value={text} onChange={e=>setText(e.target.value)} />
                        </div>
                        <button onClick={() => sendMessage('TEXT')} className="p-3 bg-[#00a884] text-white rounded-full shadow-md"><Icon name="Send" size={20} /></button>
                    </div>
                </div>
            );
        }

        // --- Cart Page (New) ---
        function CartPage({ cart, onUpdateQty, onRemove, onSendOrder, onBack }) {
            const totalItems = cart.reduce((acc, item) => acc + item.qty, 0);
            const totalPrice = cart.reduce((acc, item) => acc + (parseFloat(item.price.replace('â‚ª', '')) * item.qty), 0);

            return (
                <div className="flex flex-col h-full bg-gray-50 animate-slide-up fixed inset-0 z-50">
                    <header className="bg-white p-4 shadow-sm flex items-center">
                        <button onClick={onBack}><Icon name="ArrowRight" className="text-gray-600" /></button>
                        <h2 className="text-xl font-bold mr-4 flex-1">×¡×œ ×”×–×× ×” ({totalItems})</h2>
                        <button onClick={() => { if(confirm('×œ×¨×•×§×Ÿ ×¡×œ?')) cart.forEach(i => onRemove(i.id)); }} className="text-red-500"><Icon name="Trash" /></button>
                    </header>
                    
                    <div className="flex-1 overflow-y-auto p-4 space-y-4">
                        {cart.length === 0 ? (
                            <div className="text-center mt-20 text-gray-500">×”×¢×’×œ×” ×¨×™×§×” ğŸ›’</div>
                        ) : (
                            cart.map(item => (
                                <div key={item.id} className="bg-white p-3 rounded-xl shadow-sm flex gap-3 items-center">
                                    <img src={item.image} className="w-16 h-16 object-cover rounded-lg" />
                                    <div className="flex-1">
                                        <h4 className="font-bold text-gray-800 line-clamp-1">{item.name}</h4>
                                        <p className="text-sm text-blue-600 font-bold">{item.price}</p>
                                    </div>
                                    <div className="flex items-center gap-3 bg-gray-100 rounded-lg p-1">
                                        <button onClick={() => onUpdateQty(item.id, -1)} className="p-1 hover:bg-white rounded"><Icon name="Minus" size={16}/></button>
                                        <span className="font-bold w-4 text-center">{item.qty}</span>
                                        <button onClick={() => onUpdateQty(item.id, 1)} className="p-1 hover:bg-white rounded"><Icon name="Plus" size={16}/></button>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>

                    {cart.length > 0 && (
                        <div className="p-4 bg-white border-t shadow-lg pb-8">
                            <div className="flex justify-between mb-4 font-bold text-lg">
                                <span>×¡×”"×› ××©×•×¢×¨:</span>
                                <span>â‚ª{totalPrice.toFixed(2)}</span>
                            </div>
                            <button onClick={onSendOrder} className="w-full py-4 bg-blue-600 text-white rounded-xl font-bold text-lg shadow-lg hover:bg-blue-700 active:scale-95 transition-transform flex items-center justify-center gap-2">
                                <Icon name="Send" /> ×©×œ×— ×”×–×× ×”
                            </button>
                        </div>
                    )}
                </div>
            );
        }

        // --- Product Page (Details) ---
        function ProductPage({ product, onBack, onAddToCart, onAsk }) {
            const [qty, setQty] = useState(1);
            
            return (
                <div className="flex flex-col h-full bg-white animate-slide-up fixed inset-0 z-40 overflow-y-auto">
                    <div className="relative h-64 bg-gray-100">
                        <img src={product.image} className="w-full h-full object-cover" />
                        <button onClick={onBack} className="absolute top-4 right-4 bg-white/80 p-2 rounded-full shadow-md backdrop-blur"><Icon name="ArrowRight" /></button>
                    </div>
                    
                    <div className="p-6 flex-1">
                        <div className="flex justify-between items-start mb-2">
                            <h1 className="text-2xl font-bold text-gray-900">{product.name}</h1>
                            <span className="text-xl font-bold text-blue-600">{product.price}</span>
                        </div>
                        <p className="text-gray-500 mb-6">{product.sku} | {product.spec}</p>
                        
                        <div className="bg-blue-50 p-4 rounded-xl mb-6 border border-blue-100">
                            <h3 className="font-bold text-blue-800 mb-2">×ª×™××•×¨</h3>
                            <p className="text-blue-900/80 text-sm leading-relaxed">{product.description}</p>
                        </div>

                        <div className="flex gap-4 mb-20">
                             <button onClick={onAsk} className="flex-1 py-3 border-2 border-gray-200 text-gray-600 rounded-xl font-bold hover:bg-gray-50 flex justify-center items-center gap-2">
                                <Icon name="MessageSquare" size={20} /> ×©××œ × ×¦×™×’
                            </button>
                        </div>
                    </div>

                    <div className="fixed bottom-0 left-0 right-0 p-4 bg-white border-t flex gap-4 items-center pb-8">
                        <div className="flex items-center bg-gray-100 rounded-xl p-1">
                            <button onClick={() => setQty(Math.max(1, qty-1))} className="p-3 hover:bg-white rounded-lg"><Icon name="Minus" /></button>
                            <span className="w-8 text-center font-bold text-lg">{qty}</span>
                            <button onClick={() => setQty(qty+1)} className="p-3 hover:bg-white rounded-lg"><Icon name="Plus" /></button>
                        </div>
                        <button onClick={() => onAddToCart(product, qty)} className="flex-1 py-4 bg-blue-600 text-white rounded-xl font-bold shadow-lg flex justify-center gap-2 active:scale-95 transition-transform">
                            ×”×•×¡×£ ×œ×¢×’×œ×” <Icon name="ShoppingCart" />
                        </button>
                    </div>
                </div>
            );
        }

        // --- Main Catalog (Live) ---
        function CatalogPage({ showToast, onOpenProduct, cartCount, onOpenCart }) {
            const [term, setTerm] = useState('');
            const [products, setProducts] = useState([]);

            useEffect(() => {
                return onSnapshot(collection(db, "products"), snap => setProducts(snap.docs.map(d => ({id: d.id, ...d.data()}))));
            }, []);

            const filtered = [...DEFAULT_PRODUCTS, ...products].filter(p => p.name.includes(term) || p.sku?.includes(term));

            return (
                <div className="flex flex-col h-full">
                    <div className="bg-white p-4 shadow-sm sticky top-0 z-10">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-2xl font-bold text-gray-800">×§×˜×œ×•×’</h2>
                            <button onClick={onOpenCart} className="relative p-2 bg-blue-50 text-blue-600 rounded-full">
                                <Icon name="ShoppingCart" />
                                {cartCount > 0 && <span className="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full border-2 border-white">{cartCount}</span>}
                            </button>
                        </div>
                        <div className="relative"><input className="w-full p-3 pr-10 bg-gray-100 border-none rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="×—×¤×©..." value={term} onChange={e=>setTerm(e.target.value)} /><div className="absolute top-3 right-3 text-gray-400"><Icon name="Search" /></div></div>
                    </div>
                    <div className="p-4 grid grid-cols-2 gap-4 pb-24 overflow-y-auto">
                        {filtered.map(p => (
                            <div key={p.id} onClick={() => onOpenProduct(p)} className="bg-white rounded-2xl shadow-sm overflow-hidden flex flex-col cursor-pointer active:scale-95 transition-transform border border-transparent hover:border-blue-200">
                                <div className="h-32 bg-gray-200 relative"><img src={p.image} className="w-full h-full object-cover" /><span className="absolute bottom-2 right-2 bg-black/70 text-white text-xs px-2 py-1 rounded-md font-bold">{p.price}</span></div>
                                <div className="p-3 flex-1"><h3 className="font-bold text-gray-800 text-sm mb-1 line-clamp-2">{p.name}</h3><p className="text-xs text-gray-500">{p.sku}</p></div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        // --- App Orchestrator ---
        function App() {
            const [user, setUser] = useState(null);
            const [profile, setProfile] = useState(null);
            const [page, setPage] = useState('chats');
            const [activeProject, setActiveProject] = useState(null);
            const [selectedProduct, setSelectedProduct] = useState(null);
            const [cart, setCart] = useState([]);
            const [showCart, setShowCart] = useState(false);
            const [toast, setToast] = useState({ visible: false, message: '' });
            const [chatDraft, setChatDraft] = useState('');

            const showToastMsg = (msg) => setToast({ visible: true, message: msg });

            useEffect(() => onAuthStateChanged(auth, async (u) => {
                if (u) {
                    const snap = await getDoc(doc(db, 'customers', u.uid));
                    if (snap.exists()) { setUser(u); setProfile({uid: u.uid, ...snap.data()}); } else signOut(auth);
                } else { setUser(null); setProfile(null); }
            }), []);

            // Cart Logic
            const addToCart = (product, qty) => {
                setCart(prev => {
                    const existing = prev.find(i => i.id === product.id);
                    if (existing) return prev.map(i => i.id === product.id ? { ...i, qty: i.qty + qty } : i);
                    return [...prev, { ...product, qty }];
                });
                showToastMsg("× ×•×¡×£ ×œ×¢×’×œ×”!");
                setSelectedProduct(null); // Close product page
            };

            const updateCartQty = (id, delta) => {
                setCart(prev => prev.map(i => i.id === id ? { ...i, qty: Math.max(0, i.qty + delta) } : i).filter(i => i.qty > 0));
            };

            const sendOrder = async () => {
                if (cart.length === 0) return;
                if (!profile.projects || profile.projects.length === 0) { alert("××™×Ÿ ×¤×¨×•×™×§×˜ ×œ×©×™×•×š ×”×”×–×× ×”"); return; }
                
                // ×× ××™×Ÿ ×¤×¨×•×™×§×˜ ×¤×¢×™×œ, × ×‘×—×¨ ××ª ×”×¨××©×•×Ÿ ×›×‘×¨×™×¨×ª ××—×“×œ ××• × ×‘×§×© (×›××Ÿ × ×‘×—×¨ ×¨××©×•×Ÿ ×œ×¤×©×˜×•×ª)
                const targetProject = activeProject || profile.projects[0];
                
                const orderMsg = {
                    roomId: targetProject.projectId, senderId: user.uid, senderName: user.displayName || '×œ×§×•×—',
                    type: 'ORDER', orderPayload: { items: cart, total: cart.length },
                    createdAt: serverTimestamp(), replyTo: null
                };

                await addDoc(collection(db, 'messages'), orderMsg);
                setCart([]);
                setShowCart(false);
                setActiveProject(targetProject); // Move to chat to see order
                showToastMsg("×”×–×× ×” × ×©×œ×—×” ×‘×”×¦×œ×—×”!");
            };
            
            const askAboutProduct = (product) => {
                setSelectedProduct(null);
                if (!profile.projects || profile.projects.length === 0) return;
                setActiveProject(profile.projects[0]); // Go to first project chat
                setChatDraft(`×”×™×™, ××©××— ×œ×¤×¨×˜×™× × ×•×¡×¤×™× ×¢×œ ${product.name} (${product.sku})`);
            };

            if (!user) return <AuthScreen />;

            return (
                <div className="flex flex-col h-screen bg-gray-100 max-w-md mx-auto shadow-2xl overflow-hidden border-x border-gray-200 relative">
                    <Toast message={toast.message} visible={toast.visible} onHide={() => setToast({ ...toast, visible: false })} />
                    
                    {/* Main Views */}
                    {activeProject ? (
                        <ChatRoom project={activeProject} user={user} onBack={() => setActiveProject(null)} showToast={showToastMsg} initialMessage={chatDraft} />
                    ) : (
                        <div className="flex-1 overflow-y-auto pb-20 scrollbar-hide">
                            {page === 'chats' && <div className="px-4 pt-6"><h2 className="text-2xl font-bold mb-4">×¤×¨×•×™×§×˜×™×</h2><ChatList profile={profile} onSelect={setActiveProject} /></div>}
                            
                            {page === 'catalog' && <CatalogPage showToast={showToastMsg} onOpenProduct={setSelectedProduct} cartCount={cart.reduce((a,b)=>a+b.qty,0)} onOpenCart={()=>setShowCart(true)} />}
                            
                            {page === 'profile' && <div className="p-6 text-center"><h2 className="font-bold text-xl">{profile.name}</h2><button onClick={()=>signOut(auth)} className="text-red-500 mt-4">×”×ª× ×ª×§</button></div>}
                        </div>
                    )}

                    {/* Nav Bar */}
                    {!activeProject && (
                        <nav className="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around p-2 pb-5 text-gray-400 z-20 max-w-md mx-auto">
                            <button onClick={()=>setPage('chats')} className={page==='chats'?'text-blue-600':''}><Icon name="MessageSquare" className="mb-1 mx-auto"/><span className="text-[10px]">×©×™×—×•×ª</span></button>
                            <button onClick={()=>setPage('catalog')} className={page==='catalog'?'text-blue-600':''}><Icon name="BookOpen" className="mb-1 mx-auto"/><span className="text-[10px]">×—× ×•×ª</span></button>
                            <button onClick={()=>setPage('profile')} className={page==='profile'?'text-blue-600':''}><Icon name="User" className="mb-1 mx-auto"/><span className="text-[10px]">×¤×¨×•×¤×™×œ</span></button>
                        </nav>
                    )}

                    {/* Overlays */}
                    {selectedProduct && <ProductPage product={selectedProduct} onBack={()=>setSelectedProduct(null)} onAddToCart={addToCart} onAsk={()=>askAboutProduct(selectedProduct)} />}
                    {showCart && <CartPage cart={cart} onUpdateQty={updateCartQty} onRemove={(id)=>updateCartQty(id, -100)} onSendOrder={sendOrder} onBack={()=>setShowCart(false)} />}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
